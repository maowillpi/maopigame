<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com">
        // ğŸ“± é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± [ç”Ÿå‘½å‘¨æœŸ] é¡µé¢åŠ è½½å®Œæˆ');
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ğŸ“± [ç”Ÿå‘½å‘¨æœŸ] é¡µé¢éšè—ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°');
                stopAutoRefresh();
            } else {
                console.log('ğŸ“± [ç”Ÿå‘½å‘¨æœŸ] é¡µé¢æ˜¾ç¤ºï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
                if (gameState.account) {
                    startAutoRefresh();
                    setTimeout(updateBalance, 500);
                }
            }
        });
        
        // ğŸš¨ é”™è¯¯æ¢å¤æœºåˆ¶
        window.addEventListener('error', function(event) {
            console.error('ğŸš¨ [é”™è¯¯æ¢å¤] å…¨å±€é”™è¯¯:', event.error);
            
            // å¦‚æœæ˜¯ä½™é¢ç›¸å…³é”™è¯¯ï¼Œå°è¯•æ¢å¤
            if (event.error && event.error.message && 
                (event.error.message.includes('balance') || 
                 event.error.message.includes('provider'))) {
                
                console.log('ğŸ”„ [é”™è¯¯æ¢å¤] æ£€æµ‹åˆ°ä½™é¢é”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                balanceUpdateInProgress = false;
                setTimeout(() => {
                    if (gameState.account) {
                        updateBalance();
                    }
                }, 3000);
            }
        });
        
        // ğŸ”„ Promiseé”™è¯¯æ¢å¤
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ğŸš¨ [é”™è¯¯æ¢å¤] Promiseé”™è¯¯:', event.reason);
            event.preventDefault();
            
            balanceUpdateInProgress = false;
            
            // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œé‡ç½®çŠ¶æ€
            if (event.reason && event.reason.message && 
                event.reason.message.includes('network')) {
                setTimeout(() => {
                    if (gameState.account) {
                        updateBalance();
                    }
                }, 5000);
            }
        });
    
        // ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šé¡µé¢åŠ è½½æ—¶ç«‹å³ä¿®å¤ä½™é¢æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥ä¿®å¤...');
            
            // ä¿®å¤å¯èƒ½çš„HTMLç»“æ„é—®é¢˜
            setTimeout(() => {
                try {
                    // ç¡®ä¿MAOä½™é¢æ˜¾ç¤ºæ­£ç¡®
                    const maoBalance = document.getElementById('maoBalance');
                    if (maoBalance && maoBalance.textContent.includes('PI:')) {
                        maoBalance.textContent = '0';
                        console.log('âœ… ä¿®å¤MAOä½™é¢æ˜¾ç¤º');
                    }
                    
                    // ç¡®ä¿PIä½™é¢æ˜¾ç¤ºæ­£ç¡®
                    const piBalance = document.getElementById('piBalance');
                    if (piBalance && piBalance.textContent.includes('åŠ è½½ä¸­')) {
                        piBalance.textContent = '0';
                        console.log('âœ… ä¿®å¤PIä½™é¢æ˜¾ç¤º');
                    }
                    
                    // æ¸…ç†å¯èƒ½çš„é‡å¤å…ƒç´ 
                    const allElements = document.querySelectorAll('*');
                    allElements.forEach(element => {
                        if (element.textContent && element.textContent.includes('PI: åŠ è½½ä¸­') && 
                            !element.id.includes('totalBurned')) {
                            element.style.display = 'none';
                            console.log('âœ… éšè—é‡å¤çš„PIåŠ è½½ä¸­å…ƒç´ ');
                        }
                    });
                    
                } catch (error) {
                    console.error('âŒ ç´§æ€¥ä¿®å¤å¤±è´¥:', error);
                }
            }, 100);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        .wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 208.8deg,    /* è°¢è°¢æƒ é¡¾ 58% */
                #4ECDC4 208.8deg 288deg,  /* å°å¥– 22% */
                #45B7D1 288deg 331.2deg, /* ä¸­å¥– 12% */
                #96CEB4 331.2deg 352.8deg, /* å¤§å¥– 6% */
                #FFEAA7 352.8deg 358.2deg, /* è¶…çº§å¤§å¥– 1.5% */
                #DDA0DD 358.2deg 360deg  /* ç»ˆæå¤§å¥– 0.5% */
            );
            border: 8px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        
        .spin-btn {
            background: radial-gradient(circle, #FFD700, #FFA500);
            border: 4px solid white;
            transition: all 0.3s ease;
        }
        
        .spin-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-lg">
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">ğŸ° MAOè½¬ç›˜æ¸¸æˆ</h1>
            <p class="text-blue-200">ç®€å•ç‰ˆæœ¬ - ä¸“æ³¨æ¸¸æˆä½“éªŒ</p>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="bg-white/10 rounded-xl p-4 mb-6">
            <div class="text-center">
                <button id="connectBtn" onclick="connectWallet()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl">
                    ğŸ”— è¿æ¥é’±åŒ…
                </button>
                <div id="walletInfo" class="mt-3 text-sm text-blue-200" style="display:none;">
                    é’±åŒ…: <span id="address" class="text-white"></span>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div id="gameArea" style="display:none;">
            
            <!-- ä»£å¸é€‰æ‹© -->
            <div class="bg-white/10 rounded-xl p-4 mb-4">
                <h3 class="text-white font-bold text-center mb-3">é€‰æ‹©ä»£å¸</h3>
                <div class="flex gap-3">
                    <button id="maoBtn" onclick="selectToken('MAO')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">
                        MAO (100)
                    </button>
                    <button id="piBtn" onclick="selectToken('PI')" class="flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold">
                        PI (10,000)
                    </button>
                </div>
            </div>

            <!-- æˆæƒ -->
            <div class="bg-white/10 rounded-xl p-4 mb-4">
                <button id="approveBtn" onclick="approve()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl">
                    ğŸ”“ æˆæƒ MAO
                </button>
                <div class="text-center mt-2">
                    <span id="approveStatus" class="text-sm text-blue-200">éœ€è¦æˆæƒæ‰èƒ½æ¸¸æˆ</span>
                </div>
            </div>

            <!-- è½¬ç›˜ -->
            <div class="bg-white/10 rounded-xl p-6">
                <div class="text-center">
                    <div class="relative inline-block">
                        <div id="wheel" class="w-56 h-56 rounded-full wheel mx-auto relative">
                            <!-- æŒ‡é’ˆ -->
                            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2">
                                <div class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-yellow-400"></div>
                            </div>
                            <!-- ä¸­å¿ƒ -->
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full flex items-center justify-center font-bold text-lg">
                                MAO
                            </div>
                        </div>
                        
                        <!-- æ¸¸æˆæŒ‰é’® -->
                        <div class="mt-6">
                            <button id="spinBtn" onclick="spin()" disabled class="spin-btn w-20 h-20 rounded-full text-white font-bold disabled:opacity-50">
                                <div class="text-lg">ğŸ²</div>
                                <div class="text-xs">å¼€å§‹</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p id="gameStatus" class="text-white">è¯·è¿æ¥é’±åŒ…å¹¶æˆæƒ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONTRACTS = {
            WHEEL_GAME: '0xB677DBcA76061E6301272c83179c8243A4eeB6A5',
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };

        // å…¨å±€å˜é‡
        let provider, signer, account;
        let selectedToken = 'MAO';
        let contracts = {};
        let isSpinning = false;
        let approvalStatus = { MAO: false, PI: false };

        // ABI
        const WHEEL_ABI = ["function playMAOGame() external", "function playPIGame() external"];
        const TOKEN_ABI = ["function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner, address spender) view returns (uint256)"];

        // è¿æ¥é’±åŒ… - ç®€åŒ–ç‰ˆ
        
        // ğŸ”¥ å…¨æ–°ä½™é¢æ›´æ–°ç³»ç»Ÿ - ç»ˆæç‰ˆæœ¬
        let balanceUpdateInProgress = false;
        let balanceUpdateRetryCount = 0;
        const MAX_BALANCE_RETRIES = 3;
        
        // ä½™é¢ç¼“å­˜ç³»ç»Ÿ
        const balanceCache = {
            MAO: { value: '0', timestamp: 0, isLoading: false },
            PI: { value: '0', timestamp: 0, isLoading: false }
        };
        
        // ğŸ¯ æ™ºèƒ½ä½™é¢æ›´æ–°å‡½æ•°
        async function updateBalance() {
            console.log('ğŸ”„ [ä½™é¢æ›´æ–°] å¼€å§‹æ›´æ–°ä½™é¢...');
            
            // é˜²æ­¢é‡å¤æ‰§è¡Œ
            if (balanceUpdateInProgress) {
                console.log('âš ï¸ [ä½™é¢æ›´æ–°] å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡');
                return;
            }
            
            balanceUpdateInProgress = true;
            
            try {
                if (!gameState.account || !gameState.provider) {
                    console.log('âš ï¸ [ä½™é¢æ›´æ–°] è´¦æˆ·æœªè¿æ¥');
                    setBalanceDisplay('MAO', 'æœªè¿æ¥');
                    setBalanceDisplay('PI', 'æœªè¿æ¥');
                    return;
                }
                
                console.log('ğŸ“Š [ä½™é¢æ›´æ–°] è´¦æˆ·:', gameState.account);
                
                // å¹¶è¡ŒæŸ¥è¯¢ä¸¤ä¸ªä»£å¸ä½™é¢
                const promises = [
                    queryTokenBalance('MAO', CONFIG.CONTRACTS.MAO_TOKEN),
                    queryTokenBalance('PI', CONFIG.CONTRACTS.PI_TOKEN)
                ];
                
                // è®¾ç½®åŠ è½½çŠ¶æ€
                setBalanceDisplay('MAO', 'æŸ¥è¯¢ä¸­...');
                setBalanceDisplay('PI', 'æŸ¥è¯¢ä¸­...');
                
                const results = await Promise.allSettled(promises);
                
                // å¤„ç†MAOç»“æœ
                if (results[0].status === 'fulfilled') {
                    const maoBalance = results[0].value;
                    balanceCache.MAO = { value: maoBalance, timestamp: Date.now(), isLoading: false };
                    setBalanceDisplay('MAO', maoBalance);
                    console.log('âœ… [ä½™é¢æ›´æ–°] MAOä½™é¢:', maoBalance);
                } else {
                    console.error('âŒ [ä½™é¢æ›´æ–°] MAOæŸ¥è¯¢å¤±è´¥:', results[0].reason);
                    setBalanceDisplay('MAO', 'æŸ¥è¯¢å¤±è´¥');
                }
                
                // å¤„ç†PIç»“æœ
                if (results[1].status === 'fulfilled') {
                    const piBalance = results[1].value;
                    balanceCache.PI = { value: piBalance, timestamp: Date.now(), isLoading: false };
                    setBalanceDisplay('PI', piBalance);
                    console.log('âœ… [ä½™é¢æ›´æ–°] PIä½™é¢:', piBalance);
                } else {
                    console.error('âŒ [ä½™é¢æ›´æ–°] PIæŸ¥è¯¢å¤±è´¥:', results[1].reason);
                    setBalanceDisplay('PI', 'æŸ¥è¯¢å¤±è´¥');
                }
                
                balanceUpdateRetryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
                
            } catch (error) {
                console.error('âŒ [ä½™é¢æ›´æ–°] æ•´ä½“å¤±è´¥:', error);
                
                balanceUpdateRetryCount++;
                if (balanceUpdateRetryCount < MAX_BALANCE_RETRIES) {
                    console.log(`ğŸ”„ [ä½™é¢æ›´æ–°] ${balanceUpdateRetryCount}/${MAX_BALANCE_RETRIES} æ¬¡é‡è¯•...`);
                    setTimeout(() => {
                        balanceUpdateInProgress = false;
                        updateBalance();
                    }, 2000);
                    return;
                } else {
                    setBalanceDisplay('MAO', 'é‡è¯•å¤±è´¥');
                    setBalanceDisplay('PI', 'é‡è¯•å¤±è´¥');
                }
            } finally {
                balanceUpdateInProgress = false;
            }
        }
        
        // ğŸ¯ æŸ¥è¯¢å•ä¸ªä»£å¸ä½™é¢
        async function queryTokenBalance(tokenName, contractAddress) {
            console.log(`ğŸ“Š [ä½™é¢æŸ¥è¯¢] æŸ¥è¯¢${tokenName}ä½™é¢...`);
            
            try {
                const contract = new ethers.Contract(
                    contractAddress,
                    ["function balanceOf(address owner) view returns (uint256)"],
                    gameState.provider
                );
                
                const balanceWei = await contract.balanceOf(gameState.account);
                const balance = parseFloat(ethers.formatEther(balanceWei)).toFixed(2);
                
                console.log(`âœ… [ä½™é¢æŸ¥è¯¢] ${tokenName}ä½™é¢æŸ¥è¯¢æˆåŠŸ: ${balance}`);
                return balance;
                
            } catch (error) {
                console.error(`âŒ [ä½™é¢æŸ¥è¯¢] ${tokenName}ä½™é¢æŸ¥è¯¢å¤±è´¥:`, error);
                throw error;
            }
        }
        
        // ğŸ¯ è®¾ç½®ä½™é¢æ˜¾ç¤º
        function setBalanceDisplay(tokenName, value) {
            try {
                console.log(`ğŸ–¼ï¸ [æ˜¾ç¤ºæ›´æ–°] æ›´æ–°${tokenName}æ˜¾ç¤º: ${value}`);
                
                // å¤šç§é€‰æ‹©å™¨ç­–ç•¥
                const selectors = [
                    `#${tokenName.toLowerCase()}Balance`,
                    `.${tokenName.toLowerCase()}-balance`,
                    `[data-token="${tokenName}"]`,
                    `#${tokenName}Amount`,
                    `.balance-${tokenName.toLowerCase()}`
                ];
                
                let found = false;
                
                for (const selector of selectors) {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > 0) {
                        elements.forEach(element => {
                            element.textContent = value;
                            found = true;
                        });
                    }
                }
                
                // æ™ºèƒ½æ–‡æœ¬æœç´¢æ›´æ–°
                if (!found) {
                    const allElements = document.querySelectorAll('*');
                    for (const element of allElements) {
                        if (element.textContent) {
                            // åŒ¹é… "MAOä½™é¢" æˆ– "PIä½™é¢" æˆ– "MAO: xxx" æˆ– "PI: xxx"
                            const patterns = [
                                new RegExp(`${tokenName}ä½™é¢[\s\S]*?$`),
                                new RegExp(`${tokenName}:[^\n]*$`),
                                new RegExp(`${tokenName}[\s]*åŠ è½½ä¸­`),
                                new RegExp(`${tokenName}[\s]*æŸ¥è¯¢ä¸­`)
                            ];
                            
                            for (const pattern of patterns) {
                                if (pattern.test(element.textContent)) {
                                    // æ‰¾åˆ°åŒ…å«ä½™é¢ä¿¡æ¯çš„å…ƒç´ 
                                    const parent = element.closest('div, span, p');
                                    if (parent) {
                                        // æŸ¥æ‰¾æ•°å€¼æ˜¾ç¤ºåŒºåŸŸ
                                        const valueElements = parent.querySelectorAll('.balance-amount, .amount, .value, .number');
                                        if (valueElements.length > 0) {
                                            valueElements[0].textContent = value;
                                            found = true;
                                            break;
                                        } else {
                                            // ç›´æ¥æ›¿æ¢æ–‡æœ¬å†…å®¹
                                            element.textContent = element.textContent.replace(
                                                /(åŠ è½½ä¸­|æŸ¥è¯¢ä¸­|æŸ¥è¯¢å¤±è´¥|æœªè¿æ¥|é‡è¯•å¤±è´¥)[\d\.]*/, 
                                                value
                                            );
                                            found = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (found) break;
                        }
                    }
                }
                
                if (found) {
                    console.log(`âœ… [æ˜¾ç¤ºæ›´æ–°] ${tokenName}æ˜¾ç¤ºæ›´æ–°æˆåŠŸ`);
                } else {
                    console.log(`âš ï¸ [æ˜¾ç¤ºæ›´æ–°] æœªæ‰¾åˆ°${tokenName}æ˜¾ç¤ºå…ƒç´ `);
                }
                
            } catch (error) {
                console.error(`âŒ [æ˜¾ç¤ºæ›´æ–°] ${tokenName}æ˜¾ç¤ºæ›´æ–°å¤±è´¥:`, error);
            }
        }
        
        // ğŸ”„ è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
        let autoRefreshInterval;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                if (gameState.account && gameState.provider && !balanceUpdateInProgress) {
                    console.log('ğŸ”„ [è‡ªåŠ¨åˆ·æ–°] å®šæ—¶æ›´æ–°ä½™é¢...');
                    updateBalance();
                }
            }, 15000); // æ¯15ç§’è‡ªåŠ¨åˆ·æ–°
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        async function connectWallet() {
            try {
                const btn = document.getElementById('connectBtn');
                btn.textContent = 'è¿æ¥ä¸­...';
                btn.disabled = true;

                if (!window.ethereum) {
                    alert('è¯·ä½¿ç”¨Web3é’±åŒ…ï¼\næ¨èï¼šTPé’±åŒ…ã€Trust Walletã€MetaMask');
                    resetConnectButton();
                    return;
                }

                // è¯·æ±‚è¿æ¥
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts.length) {
                    throw new Error('æ²¡æœ‰è´¦æˆ·');
                }

                account = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 3797) {
                    await switchNetwork();
                }

                // åˆå§‹åŒ–åˆçº¦
                contracts = {
                    wheel: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_ABI, signer),
                    mao: new ethers.Contract(CONTRACTS.MAO_TOKEN, TOKEN_ABI, signer),
                    pi: new ethers.Contract(CONTRACTS.PI_TOKEN, TOKEN_ABI, signer)
                };

                // æ˜¾ç¤ºè¿æ¥æˆåŠŸ
                document.getElementById('address').textContent = account.slice(0, 8) + '...';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('gameArea').style.display = 'block';
                btn.style.display = 'none';

                // æ£€æŸ¥æˆæƒ
                await checkApproval();

                console.log('âœ… è¿æ¥æˆåŠŸ');

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                alert('è¿æ¥å¤±è´¥: ' + error.message);
                resetConnectButton();
            }
        }

        // é‡ç½®è¿æ¥æŒ‰é’®
        function resetConnectButton() {
            const btn = document.getElementById('connectBtn');
            btn.textContent = 'ğŸ”— è¿æ¥é’±åŒ…';
            btn.disabled = false;
        }

        // åˆ‡æ¢ç½‘ç»œ
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xED5' }]
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0xED5',
                            chainName: 'AlveyChain Mainnet',
                            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
                            rpcUrls: ['https://elves-core1.alvey.io'],
                            blockExplorerUrls: ['https://alveyscan.com']
                        }]
                    });
                }
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            selectedToken = token;
            
            // æ›´æ–°æŒ‰é’®
            document.getElementById('maoBtn').className = token === 'MAO' ? 
                'flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold' : 
                'flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold';
            document.getElementById('piBtn').className = token === 'PI' ? 
                'flex-1 bg-purple-600 text-white py-2 rounded-lg font-bold' : 
                'flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold';

            // æ›´æ–°æˆæƒæŒ‰é’®
            document.getElementById('approveBtn').innerHTML = `ğŸ”“ æˆæƒ ${token}`;
            
            // æ›´æ–°è½¬ç›˜ä¸­å¿ƒæ˜¾ç¤º
            document.querySelector('#wheel .absolute.top-1\\/2').textContent = token;
            
            // é‡æ–°æ£€æŸ¥æˆæƒ
            if (contracts.mao && contracts.pi) {
                checkApproval();
            }
        }

        // æ£€æŸ¥æˆæƒ
        async function checkApproval() {
            try {
                const contract = selectedToken === 'MAO' ? contracts.mao : contracts.pi;
                const allowance = await contract.allowance(account, CONTRACTS.WHEEL_GAME);
                
                const required = selectedToken === 'MAO' ? 
                    ethers.utils.parseUnits('100', 18) : 
                    ethers.utils.parseUnits('10000', 18);

                const approved = allowance.gte(required);
                approvalStatus[selectedToken] = approved;
                
                updateApprovalStatus(approved);

            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', error);
                approvalStatus[selectedToken] = false;
                updateApprovalStatus(false);
            }
        }

        // æ›´æ–°æˆæƒçŠ¶æ€
        function updateApprovalStatus(approved) {
            const approveBtn = document.getElementById('approveBtn');
            const spinBtn = document.getElementById('spinBtn');
            const status = document.getElementById('approveStatus');
            const gameStatus = document.getElementById('gameStatus');

            if (approved) {
                approveBtn.textContent = `âœ… ${selectedToken} å·²æˆæƒ`;
                approveBtn.disabled = true;
                approveBtn.className = 'w-full bg-green-600 text-white font-bold py-3 rounded-xl cursor-not-allowed';
                
                spinBtn.disabled = false;
                spinBtn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold';
                status.textContent = 'âœ… å·²æˆæƒï¼Œå¯ä»¥æ¸¸æˆ';
                gameStatus.textContent = 'ğŸ¯ ç‚¹å‡»å¼€å§‹æ¸¸æˆï¼';
            } else {
                approveBtn.textContent = `ğŸ”“ æˆæƒ ${selectedToken}`;
                approveBtn.disabled = false;
                approveBtn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl';
                
                spinBtn.disabled = true;
                spinBtn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold disabled:opacity-50';
                status.textContent = 'âŒ éœ€è¦æˆæƒ';
                gameStatus.textContent = 'è¯·å…ˆæˆæƒä»£å¸';
            }
        }

        // æˆæƒ
        async function approve() {
            try {
                const btn = document.getElementById('approveBtn');
                const originalText = btn.textContent;
                btn.textContent = 'æˆæƒä¸­...';
                btn.disabled = true;

                const contract = selectedToken === 'MAO' ? contracts.mao : contracts.pi;
                const tx = await contract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                
                document.getElementById('approveStatus').textContent = 'â³ ç­‰å¾…ç¡®è®¤...';
                await tx.wait();

                alert(`${selectedToken} æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼`);
                await checkApproval();

            } catch (error) {
                console.error('æˆæƒå¤±è´¥:', error);
                alert('æˆæƒå¤±è´¥: ' + error.message);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const btn = document.getElementById('approveBtn');
                btn.textContent = `ğŸ”“ æˆæƒ ${selectedToken}`;
                btn.disabled = false;
                btn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl';
            }
        }

        // å¼€å§‹æ¸¸æˆ
        async function spin() {
            if (isSpinning) return;

            try {
                // æ£€æŸ¥æˆæƒçŠ¶æ€
                if (!approvalStatus[selectedToken]) {
                    alert('è¯·å…ˆæˆæƒä»£å¸ï¼');
                    return;
                }

                isSpinning = true;
                const wheel = document.getElementById('wheel');
                const btn = document.getElementById('spinBtn');
                const status = document.getElementById('gameStatus');

                // æŒ‰é’®çŠ¶æ€
                btn.innerHTML = '<div class="text-lg">â³</div><div class="text-xs">æ¸¸æˆä¸­</div>';
                btn.disabled = true;
                status.textContent = 'ğŸ° è½¬ç›˜æ—‹è½¬ä¸­...';

                // è½¬ç›˜åŠ¨ç”»
                const rotation = 1800 + Math.random() * 1800;
                wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                wheel.style.transform = `rotate(${rotation}deg)`;

                // è°ƒç”¨åˆçº¦
                const method = selectedToken === 'MAO' ? 'playMAOGame' : 'playPIGame';
                const tx = await contracts.wheel[method]();

                status.textContent = 'â³ ç­‰å¾…åŒºå—ç¡®è®¤...';
                const receipt = await tx.wait();

                // æ¸¸æˆå®Œæˆ
                alert('ğŸ‰ æ¸¸æˆå®Œæˆï¼è¯·æŸ¥çœ‹æ‚¨çš„é’±åŒ…ä½™é¢å˜åŒ–ã€‚');
                status.textContent = 'ğŸ¯ æ¸¸æˆå®Œæˆï¼Œå¯ä»¥ç»§ç»­ï¼';

                console.log('æ¸¸æˆå®Œæˆ:', receipt.transactionHash);

            } catch (error) {
                console.error('æ¸¸æˆå¤±è´¥:', error);
                let errorMsg = 'æ¸¸æˆå¤±è´¥: ';
                if (error.message.includes('insufficient funds')) {
                    errorMsg += 'ä»£å¸ä½™é¢ä¸è¶³';
                } else if (error.message.includes('user rejected')) {
                    errorMsg += 'ç”¨æˆ·å–æ¶ˆäº¤æ˜“';
                } else {
                    errorMsg += error.message;
                }
                alert(errorMsg);
            } finally {
                isSpinning = false;
                // æ¢å¤æŒ‰é’®çŠ¶æ€ - æ£€æŸ¥æˆæƒçŠ¶æ€
                if (approvalStatus[selectedToken]) {
                    const btn = document.getElementById('spinBtn');
                    btn.innerHTML = '<div class="text-lg">ğŸ²</div><div class="text-xs">å¼€å§‹</div>';
                    btn.disabled = false;
                    btn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold';
                    if (document.getElementById('gameStatus').textContent.includes('æ¸¸æˆä¸­') || document.getElementById('gameStatus').textContent.includes('ç­‰å¾…')) {
                        document.getElementById('gameStatus').textContent = 'ğŸ¯ ç‚¹å‡»å¼€å§‹æ¸¸æˆï¼';
                    }
                } else {
                    // å¦‚æœæˆæƒçŠ¶æ€æœ‰é—®é¢˜ï¼Œé‡æ–°æ£€æŸ¥
                    await checkApproval();
                }
            }
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else if (accounts[0] !== account) {
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æ˜¯å¦å·²è¿æ¥
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        // æ£€æµ‹åˆ°å·²è¿æ¥çš„è´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥
                        setTimeout(connectWallet, 500);
                    }
                } catch (error) {
                    console.log('è‡ªåŠ¨è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                }
            }
        });
    </script>

    <!-- ğŸ”¥ é”€æ¯æ€»é‡æ˜¾ç¤º -->
    <div class="burn-total-display" style="
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #ff4757, #ffa726);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
        backdrop-filter: blur(10px);
        z-index: 1000;
        display: flex;
        gap: 10px;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    ">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span>ğŸ”¥</span>
            <span>æ€»é”€æ¯</span>
        </div>
        <div style="display: flex; gap: 8px; font-size: 11px;">
            <div>
                <span style="color: #ffeb3b;">MAO:</span>
                <span id="totalBurnedMAO" style="color: white; font-weight: bold;">åŠ è½½ä¸­...</span>
            </div>
            <div>
                <span style="color: #ffeb3b;">PI:</span>
                <span id="totalBurnedPI" style="color: white; font-weight: bold;">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
</body>
</html> 