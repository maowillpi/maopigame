<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        .wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 208.8deg,    /* è°¢è°¢æƒ é¡¾ 58% */
                #4ECDC4 208.8deg 288deg,  /* å°å¥– 22% */
                #45B7D1 288deg 331.2deg, /* ä¸­å¥– 12% */
                #96CEB4 331.2deg 352.8deg, /* å¤§å¥– 6% */
                #FFEAA7 352.8deg 358.2deg, /* è¶…çº§å¤§å¥– 1.5% */
                #DDA0DD 358.2deg 360deg  /* ç»ˆæå¤§å¥– 0.5% */
            );
            border: 8px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        
        .spin-btn {
            background: radial-gradient(circle, #FFD700, #FFA500);
            border: 4px solid white;
            transition: all 0.3s ease;
        }
        
        .spin-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-lg">
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">ğŸ° MAOè½¬ç›˜æ¸¸æˆ</h1>
            <p class="text-blue-200">ç®€å•ç‰ˆæœ¬ - ä¸“æ³¨æ¸¸æˆä½“éªŒ</p>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="bg-white/10 rounded-xl p-4 mb-6">
            <div class="text-center">
                <button id="connectBtn" onclick="connectWallet()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl">
                    ğŸ”— è¿æ¥é’±åŒ…
                </button>
                <div id="walletInfo" class="mt-3 text-sm text-blue-200" style="display:none;">
                    é’±åŒ…: <span id="address" class="text-white"></span>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div id="gameArea" style="display:none;">
            
            <!-- ä»£å¸é€‰æ‹© -->
            <div class="bg-white/10 rounded-xl p-4 mb-4">
                <h3 class="text-white font-bold text-center mb-3">é€‰æ‹©ä»£å¸</h3>
                <div class="flex gap-3">
                    <button id="maoBtn" onclick="selectToken('MAO')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">
                        MAO (100)
                    </button>
                    <button id="piBtn" onclick="selectToken('PI')" class="flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold">
                        PI (10,000)
                    </button>
                </div>
            </div>

            <!-- æˆæƒ -->
            <div class="bg-white/10 rounded-xl p-4 mb-4">
                <button id="approveBtn" onclick="approve()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl">
                    ğŸ”“ æˆæƒ MAO
                </button>
                <div class="text-center mt-2">
                    <span id="approveStatus" class="text-sm text-blue-200">éœ€è¦æˆæƒæ‰èƒ½æ¸¸æˆ</span>
                </div>
            </div>

            <!-- è½¬ç›˜ -->
            <div class="bg-white/10 rounded-xl p-6">
                <div class="text-center">
                    <div class="relative inline-block">
                        <div id="wheel" class="w-56 h-56 rounded-full wheel mx-auto relative">
                            <!-- æŒ‡é’ˆ -->
                            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2">
                                <div class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-yellow-400"></div>
                            </div>
                            <!-- ä¸­å¿ƒ -->
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full flex items-center justify-center font-bold text-lg">
                                MAO
                            </div>
                        </div>
                        
                        <!-- æ¸¸æˆæŒ‰é’® -->
                        <div class="mt-6">
                            <button id="spinBtn" onclick="spin()" disabled class="spin-btn w-20 h-20 rounded-full text-white font-bold disabled:opacity-50">
                                <div class="text-lg">ğŸ²</div>
                                <div class="text-xs">å¼€å§‹</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p id="gameStatus" class="text-white">è¯·è¿æ¥é’±åŒ…å¹¶æˆæƒ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONTRACTS = {
            WHEEL_GAME: '0xA9E4FD96B29e4f512a0a75E402C156B04D6E6c35',
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };

        // å…¨å±€å˜é‡
        let provider, signer, account;
        let selectedToken = 'MAO';
        let contracts = {};
        let isSpinning = false;
        let approvalStatus = { MAO: false, PI: false };

        // ABI
        const WHEEL_ABI = ["function playMAOGame() external", "function playPIGame() external"];
        const TOKEN_ABI = ["function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner, address spender) view returns (uint256)"];

        // è¿æ¥é’±åŒ… - ç®€åŒ–ç‰ˆ
        async function connectWallet() {
            try {
                const btn = document.getElementById('connectBtn');
                btn.textContent = 'è¿æ¥ä¸­...';
                btn.disabled = true;

                if (!window.ethereum) {
                    alert('è¯·ä½¿ç”¨Web3é’±åŒ…ï¼\næ¨èï¼šTPé’±åŒ…ã€Trust Walletã€MetaMask');
                    resetConnectButton();
                    return;
                }

                // è¯·æ±‚è¿æ¥
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts.length) {
                    throw new Error('æ²¡æœ‰è´¦æˆ·');
                }

                account = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 3797) {
                    await switchNetwork();
                }

                // åˆå§‹åŒ–åˆçº¦
                contracts = {
                    wheel: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_ABI, signer),
                    mao: new ethers.Contract(CONTRACTS.MAO_TOKEN, TOKEN_ABI, signer),
                    pi: new ethers.Contract(CONTRACTS.PI_TOKEN, TOKEN_ABI, signer)
                };

                // æ˜¾ç¤ºè¿æ¥æˆåŠŸ
                document.getElementById('address').textContent = account.slice(0, 8) + '...';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('gameArea').style.display = 'block';
                btn.style.display = 'none';

                // æ£€æŸ¥æˆæƒ
                await checkApproval();

                console.log('âœ… è¿æ¥æˆåŠŸ');

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                alert('è¿æ¥å¤±è´¥: ' + error.message);
                resetConnectButton();
            }
        }

        // é‡ç½®è¿æ¥æŒ‰é’®
        function resetConnectButton() {
            const btn = document.getElementById('connectBtn');
            btn.textContent = 'ğŸ”— è¿æ¥é’±åŒ…';
            btn.disabled = false;
        }

        // åˆ‡æ¢ç½‘ç»œ
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xED5' }]
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0xED5',
                            chainName: 'AlveyChain Mainnet',
                            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
                            rpcUrls: ['https://elves-core1.alvey.io'],
                            blockExplorerUrls: ['https://alveyscan.com']
                        }]
                    });
                }
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            selectedToken = token;
            
            // æ›´æ–°æŒ‰é’®
            document.getElementById('maoBtn').className = token === 'MAO' ? 
                'flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold' : 
                'flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold';
            document.getElementById('piBtn').className = token === 'PI' ? 
                'flex-1 bg-purple-600 text-white py-2 rounded-lg font-bold' : 
                'flex-1 bg-gray-600 text-white py-2 rounded-lg font-bold';

            // æ›´æ–°æˆæƒæŒ‰é’®
            document.getElementById('approveBtn').innerHTML = `ğŸ”“ æˆæƒ ${token}`;
            
            // æ›´æ–°è½¬ç›˜ä¸­å¿ƒæ˜¾ç¤º
            document.querySelector('#wheel .absolute.top-1\\/2').textContent = token;
            
            // é‡æ–°æ£€æŸ¥æˆæƒ
            if (contracts.mao && contracts.pi) {
                checkApproval();
            }
        }

        // æ£€æŸ¥æˆæƒ
        async function checkApproval() {
            try {
                const contract = selectedToken === 'MAO' ? contracts.mao : contracts.pi;
                const allowance = await contract.allowance(account, CONTRACTS.WHEEL_GAME);
                
                const required = selectedToken === 'MAO' ? 
                    ethers.utils.parseUnits('100', 18) : 
                    ethers.utils.parseUnits('10000', 18);

                const approved = allowance.gte(required);
                approvalStatus[selectedToken] = approved;
                
                updateApprovalStatus(approved);

            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', error);
                approvalStatus[selectedToken] = false;
                updateApprovalStatus(false);
            }
        }

        // æ›´æ–°æˆæƒçŠ¶æ€
        function updateApprovalStatus(approved) {
            const approveBtn = document.getElementById('approveBtn');
            const spinBtn = document.getElementById('spinBtn');
            const status = document.getElementById('approveStatus');
            const gameStatus = document.getElementById('gameStatus');

            if (approved) {
                approveBtn.textContent = `âœ… ${selectedToken} å·²æˆæƒ`;
                approveBtn.disabled = true;
                approveBtn.className = 'w-full bg-green-600 text-white font-bold py-3 rounded-xl cursor-not-allowed';
                
                spinBtn.disabled = false;
                spinBtn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold';
                status.textContent = 'âœ… å·²æˆæƒï¼Œå¯ä»¥æ¸¸æˆ';
                gameStatus.textContent = 'ğŸ¯ ç‚¹å‡»å¼€å§‹æ¸¸æˆï¼';
            } else {
                approveBtn.textContent = `ğŸ”“ æˆæƒ ${selectedToken}`;
                approveBtn.disabled = false;
                approveBtn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl';
                
                spinBtn.disabled = true;
                spinBtn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold disabled:opacity-50';
                status.textContent = 'âŒ éœ€è¦æˆæƒ';
                gameStatus.textContent = 'è¯·å…ˆæˆæƒä»£å¸';
            }
        }

        // æˆæƒ
        async function approve() {
            try {
                const btn = document.getElementById('approveBtn');
                const originalText = btn.textContent;
                btn.textContent = 'æˆæƒä¸­...';
                btn.disabled = true;

                const contract = selectedToken === 'MAO' ? contracts.mao : contracts.pi;
                const tx = await contract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                
                document.getElementById('approveStatus').textContent = 'â³ ç­‰å¾…ç¡®è®¤...';
                await tx.wait();

                alert(`${selectedToken} æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼`);
                await checkApproval();

            } catch (error) {
                console.error('æˆæƒå¤±è´¥:', error);
                alert('æˆæƒå¤±è´¥: ' + error.message);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const btn = document.getElementById('approveBtn');
                btn.textContent = `ğŸ”“ æˆæƒ ${selectedToken}`;
                btn.disabled = false;
                btn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl';
            }
        }

        // å¼€å§‹æ¸¸æˆ
        async function spin() {
            if (isSpinning) return;

            try {
                // æ£€æŸ¥æˆæƒçŠ¶æ€
                if (!approvalStatus[selectedToken]) {
                    alert('è¯·å…ˆæˆæƒä»£å¸ï¼');
                    return;
                }

                isSpinning = true;
                const wheel = document.getElementById('wheel');
                const btn = document.getElementById('spinBtn');
                const status = document.getElementById('gameStatus');

                // æŒ‰é’®çŠ¶æ€
                btn.innerHTML = '<div class="text-lg">â³</div><div class="text-xs">æ¸¸æˆä¸­</div>';
                btn.disabled = true;
                status.textContent = 'ğŸ° è½¬ç›˜æ—‹è½¬ä¸­...';

                // è½¬ç›˜åŠ¨ç”»
                const rotation = 1800 + Math.random() * 1800;
                wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                wheel.style.transform = `rotate(${rotation}deg)`;

                // è°ƒç”¨åˆçº¦
                const method = selectedToken === 'MAO' ? 'playMAOGame' : 'playPIGame';
                const tx = await contracts.wheel[method]();

                status.textContent = 'â³ ç­‰å¾…åŒºå—ç¡®è®¤...';
                const receipt = await tx.wait();

                // æ¸¸æˆå®Œæˆ
                alert('ğŸ‰ æ¸¸æˆå®Œæˆï¼è¯·æŸ¥çœ‹æ‚¨çš„é’±åŒ…ä½™é¢å˜åŒ–ã€‚');
                status.textContent = 'ğŸ¯ æ¸¸æˆå®Œæˆï¼Œå¯ä»¥ç»§ç»­ï¼';

                console.log('æ¸¸æˆå®Œæˆ:', receipt.transactionHash);

            } catch (error) {
                console.error('æ¸¸æˆå¤±è´¥:', error);
                let errorMsg = 'æ¸¸æˆå¤±è´¥: ';
                if (error.message.includes('insufficient funds')) {
                    errorMsg += 'ä»£å¸ä½™é¢ä¸è¶³';
                } else if (error.message.includes('user rejected')) {
                    errorMsg += 'ç”¨æˆ·å–æ¶ˆäº¤æ˜“';
                } else {
                    errorMsg += error.message;
                }
                alert(errorMsg);
            } finally {
                isSpinning = false;
                // æ¢å¤æŒ‰é’®çŠ¶æ€ - æ£€æŸ¥æˆæƒçŠ¶æ€
                if (approvalStatus[selectedToken]) {
                    const btn = document.getElementById('spinBtn');
                    btn.innerHTML = '<div class="text-lg">ğŸ²</div><div class="text-xs">å¼€å§‹</div>';
                    btn.disabled = false;
                    btn.className = 'spin-btn w-20 h-20 rounded-full text-white font-bold';
                    if (document.getElementById('gameStatus').textContent.includes('æ¸¸æˆä¸­') || document.getElementById('gameStatus').textContent.includes('ç­‰å¾…')) {
                        document.getElementById('gameStatus').textContent = 'ğŸ¯ ç‚¹å‡»å¼€å§‹æ¸¸æˆï¼';
                    }
                } else {
                    // å¦‚æœæˆæƒçŠ¶æ€æœ‰é—®é¢˜ï¼Œé‡æ–°æ£€æŸ¥
                    await checkApproval();
                }
            }
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else if (accounts[0] !== account) {
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æ˜¯å¦å·²è¿æ¥
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        // æ£€æµ‹åˆ°å·²è¿æ¥çš„è´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥
                        setTimeout(connectWallet, 500);
                    }
                } catch (error) {
                    console.log('è‡ªåŠ¨è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                }
            }
        });
    </script>
</body>
</html> 