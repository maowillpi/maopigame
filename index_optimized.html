<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ - ä¼˜åŒ–ç‰ˆ v4.1.0</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        /* ä¸“ä¸šè½¬ç›˜è®¾è®¡ */
        .professional-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 208.8deg,    /* è°¢è°¢æƒ é¡¾ 58% */
                #4ECDC4 208.8deg 288deg,  /* å°å¥– 22% */
                #45B7D1 288deg 331.2deg, /* ä¸­å¥– 12% */
                #96CEB4 331.2deg 352.8deg, /* å¤§å¥– 6% */
                #FFEAA7 352.8deg 358.2deg, /* è¶…çº§å¤§å¥– 1.5% */
                #DDA0DD 358.2deg 360deg  /* ç»ˆæå¤§å¥– 0.5% */
            );
            border: 12px solid #FFD700;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.9),
                inset 0 0 40px rgba(0, 0, 0, 0.3),
                0 0 120px rgba(255, 215, 0, 0.7);
            position: relative;
            animation: wheelGlow 4s ease-in-out infinite alternate;
            transform-style: preserve-3d;
        }
        
        @keyframes wheelGlow {
            0% { 
                box-shadow: 
                    0 0 60px rgba(255, 215, 0, 0.9),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 120px rgba(255, 215, 0, 0.7);
            }
            100% { 
                box-shadow: 
                    0 0 100px rgba(255, 215, 0, 1),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 160px rgba(255, 215, 0, 0.9);
            }
        }
        
        .wheel-animation {
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* è½¬ç›˜æŒ‡é’ˆ */
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 50px solid #FFD700;
            z-index: 30;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8));
        }
        
        .wheel-pointer::before {
            content: '';
            position: absolute;
            top: -48px;
            left: -15px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(255, 215, 0, 1);
        }
        
        /* è½¬ç›˜åŒºåŸŸ */
        .wheel-section {
            position: absolute;
            z-index: 10;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 6px;
            transition: all 0.3s ease;
        }
        
        .wheel-emoji {
            font-size: 24px;
            margin-bottom: 2px;
            display: block;
        }
        
        .probability-text {
            font-size: 9px;
            color: #FFD700;
            font-weight: bold;
        }
        
        .reward-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 1px 4px;
            border-radius: 8px;
            margin-top: 1px;
        }
        
        /* ä¸­å¿ƒLogo */
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.4);
            border: 4px solid rgba(255, 255, 255, 0.8);
            z-index: 20;
        }
        
        /* æ¸¸æˆæŒ‰é’® */
        .game-button {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border: 5px solid white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }
        
        .game-button:hover {
            transform: scale(1.1);
            box-shadow: 
                0 16px 32px rgba(0, 0, 0, 0.8),
                inset 0 4px 8px rgba(255, 255, 255, 0.6);
        }
        
        /* é’±åŒ…è¿æ¥ç•Œé¢ */
        .wallet-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .wallet-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* æˆæƒçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .approval-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .status-dot.approved {
            background: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
        }
        
        .status-dot.not-approved {
            background: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ä»£å¸é€‰æ‹©æŒ‰é’® */
        .token-button {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .token-button.selected {
            background: linear-gradient(135deg, #10B981, #059669);
            border-color: #10B981;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .token-button.unselected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* æˆæƒæŒ‰é’® */
        .approve-button {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            transition: all 0.3s ease;
        }
        
        .approve-button:hover {
            background: linear-gradient(135deg, #FBBF24, #F59E0B);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        .approve-button.approved {
            background: linear-gradient(135deg, #10B981, #059669);
            cursor: default;
        }
        
        /* è¿æ¥è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1.5px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            border-radius: 1.5px;
            transition: width 0.3s ease;
        }
        
        /* ç»ç’ƒæ•ˆæœ */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    
    <!-- é¡µé¢å®¹å™¨ -->
    <div class="container mx-auto px-4 py-2 max-w-md">
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-white mb-2">
                ğŸ° MAOè½¬ç›˜æ¸¸æˆ
            </h1>
            <p class="text-blue-200 text-sm">
                AlveyChain åŒºå—é“¾æ¸¸æˆ - ä¼˜åŒ–ç‰ˆ v4.1.0
            </p>
            <div class="text-xs text-green-400 mt-1">
                âœ¨ åˆ†ç¦»æˆæƒ Â· ä¸“ä¸šè½¬ç›˜ Â· ä¼˜åŒ–è¿æ¥
            </div>
        </div>

        <!-- è¿æ¥è¿›åº¦ -->
        <div id="connectionProgress" class="hidden mb-4">
            <div class="wallet-card rounded-xl p-4">
                <div class="text-center">
                    <div class="text-white font-semibold mb-2" id="progressText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-blue-200 text-sm mt-2" id="progressSubtext">è¯·ç¨å€™...</div>
                </div>
            </div>
        </div>

        <!-- é’±åŒ…è¿æ¥ç•Œé¢ -->
        <div id="walletConnect" class="space-y-4">
            <div class="wallet-card rounded-xl p-6">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">ğŸ”—</div>
                    <h2 class="text-xl font-bold text-white mb-2">è¿æ¥Web3é’±åŒ…</h2>
                    <p class="text-blue-200 text-sm">
                        è¯·ä½¿ç”¨æ”¯æŒAlveyChainçš„é’±åŒ…è¿æ¥æ¸¸æˆ
                    </p>
                </div>
                
                <!-- æ¨èé’±åŒ… -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-3 text-sm">ğŸ“± æ¨èé’±åŒ…</h3>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">ğŸ”µ</div>
                            <div class="text-white font-semibold">TPé’±åŒ…</div>
                            <div class="text-blue-200">æœ€å—æ¬¢è¿</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">ğŸ›¡ï¸</div>
                            <div class="text-white font-semibold">Trust Wallet</div>
                            <div class="text-blue-200">å¸å®‰å®˜æ–¹</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">ğŸ¦Š</div>
                            <div class="text-white font-semibold">MetaMask</div>
                            <div class="text-blue-200">æ¡Œé¢é¦–é€‰</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">ğŸ“±</div>
                            <div class="text-white font-semibold">å…¶ä»–é’±åŒ…</div>
                            <div class="text-blue-200">Web3å…¼å®¹</div>
                        </div>
                    </div>
                </div>
                
                <!-- è¿æ¥æŒ‰é’® -->
                <button 
                    id="connectBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                    ğŸ”— è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ
                </button>
            </div>
            
            <!-- æ¸¸æˆç‰¹è‰² -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">ğŸ® æ¸¸æˆç‰¹è‰²</h3>
                <ul class="text-blue-200 text-sm space-y-2">
                    <li>â€¢ 42%è¶…é«˜ä¸­å¥–ç‡ï¼Œå°å¥–æœ‰ç›ˆåˆ©æ„Ÿ</li>
                    <li>â€¢ åˆ†ç¦»ä»£å¸æˆæƒï¼Œæ“ä½œæ›´å®‰å…¨</li>
                    <li>â€¢ ä¸“ä¸šè½¬ç›˜è®¾è®¡ï¼Œä½“éªŒæ›´æµç•…</li>
                    <li>â€¢ æ™ºèƒ½åˆçº¦ä¿éšœï¼Œå®Œå…¨é€æ˜</li>
                    <li>â€¢ å³æ—¶åˆ°è´¦å¥–åŠ±ï¼Œæ— éœ€ç­‰å¾…</li>
                </ul>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameInterface" class="space-y-4" style="display: none;">
            
            <!-- é’±åŒ…çŠ¶æ€ -->
            <div class="wallet-card rounded-xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-blue-200 text-xs">é’±åŒ…åœ°å€</p>
                        <p class="text-white text-sm font-mono" id="userAddress">æœªè¿æ¥</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-200 text-xs">ç½‘ç»œçŠ¶æ€</p>
                        <p class="text-green-400 font-bold text-sm">âœ… AlveyChain</p>
                    </div>
                </div>
                
                <button 
                    id="refreshBtn"
                    class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200"
                    onclick="refreshAllData()"
                >
                    ğŸ”„ åˆ·æ–°ä½™é¢å’ŒæˆæƒçŠ¶æ€
                </button>
            </div>

            <!-- ä»£å¸ç®¡ç† -->
            <div class="wallet-card rounded-xl p-4">
                <h3 class="text-white font-semibold mb-4 text-center">ğŸ’° ä»£å¸ç®¡ç†</h3>
                
                <!-- MAOä»£å¸ -->
                <div class="mb-4">
                    <div class="glass-effect rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="maoSelectBtn" 
                                    class="token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected"
                                    onclick="selectToken('MAO')"
                                >
                                    MAO
                                </button>
                                <div>
                                    <div class="text-white font-semibold">MAO Token</div>
                                    <div class="text-blue-200 text-xs">100 MAO/æ¬¡</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-sm" id="maoBalance">ä½™é¢: 0</div>
                                <div class="approval-status mt-1">
                                    <span class="status-dot not-approved" id="maoStatusDot"></span>
                                    <span class="text-xs text-blue-200" id="maoStatusText">éœ€è¦æˆæƒ</span>
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            id="maoApproveBtn"
                            class="w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200"
                            onclick="approveToken('MAO')"
                        >
                            ğŸ”“ æˆæƒ MAO ä»£å¸
                        </button>
                    </div>
                </div>
                
                <!-- PIä»£å¸ -->
                <div class="mb-4">
                    <div class="glass-effect rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="piSelectBtn" 
                                    class="token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected"
                                    onclick="selectToken('PI')"
                                >
                                    PI
                                </button>
                                <div>
                                    <div class="text-white font-semibold">PI Token</div>
                                    <div class="text-blue-200 text-xs">10,000 PI/æ¬¡</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-sm" id="piBalance">ä½™é¢: 0</div>
                                <div class="approval-status mt-1">
                                    <span class="status-dot not-approved" id="piStatusDot"></span>
                                    <span class="text-xs text-blue-200" id="piStatusText">éœ€è¦æˆæƒ</span>
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            id="piApproveBtn"
                            class="w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200"
                            onclick="approveToken('PI')"
                        >
                            ğŸ”“ æˆæƒ PI ä»£å¸
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä¸“ä¸šè½¬ç›˜ -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-white font-bold text-center mb-4 text-lg">ğŸ° ä¸“ä¸šå¹¸è¿è½¬ç›˜</h3>
                
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div 
                            id="wheel"
                            class="w-72 h-72 rounded-full professional-wheel wheel-animation shadow-2xl relative"
                        >
                            <!-- è½¬ç›˜åŒºåŸŸ -->
                            <!-- è°¢è°¢æƒ é¡¾ 58% -->
                            <div class="wheel-section" style="top: 15px; left: 50%; transform: translateX(-50%);">
                                <div class="wheel-emoji">ğŸ˜Š</div>
                                <div class="text-xs font-bold">è°¢è°¢æƒ é¡¾</div>
                                <div class="probability-text">58%</div>
                                <div class="reward-badge">0</div>
                            </div>
                            
                            <!-- å°å¥– 22% -->
                            <div class="wheel-section" style="top: 25px; right: 25px;">
                                <div class="wheel-emoji">ğŸ</div>
                                <div class="text-xs font-bold">å°å¥–</div>
                                <div class="probability-text">22%</div>
                                <div class="reward-badge" id="smallReward">150</div>
                            </div>
                            
                            <!-- ä¸­å¥– 12% -->
                            <div class="wheel-section" style="bottom: 25px; right: 25px;">
                                <div class="wheel-emoji">ğŸ†</div>
                                <div class="text-xs font-bold">ä¸­å¥–</div>
                                <div class="probability-text">12%</div>
                                <div class="reward-badge" id="mediumReward">400</div>
                            </div>
                            
                            <!-- å¤§å¥– 6% -->
                            <div class="wheel-section" style="bottom: 15px; left: 50%; transform: translateX(-50%);">
                                <div class="wheel-emoji">ğŸ’</div>
                                <div class="text-xs font-bold">å¤§å¥–</div>
                                <div class="probability-text">6%</div>
                                <div class="reward-badge" id="bigReward">800</div>
                            </div>
                            
                            <!-- è¶…çº§å¤§å¥– 1.5% -->
                            <div class="wheel-section" style="bottom: 25px; left: 25px;">
                                <div class="wheel-emoji">ğŸŒŸ</div>
                                <div class="text-xs font-bold">è¶…çº§</div>
                                <div class="probability-text">1.5%</div>
                                <div class="reward-badge" id="superReward">1500</div>
                            </div>
                            
                            <!-- ç»ˆæå¤§å¥– 0.5% -->
                            <div class="wheel-section" style="top: 25px; left: 25px;">
                                <div class="wheel-emoji">ğŸ’°</div>
                                <div class="text-xs font-bold">ç»ˆæ</div>
                                <div class="probability-text">0.5%</div>
                                <div class="reward-badge" id="ultimateReward">3000</div>
                            </div>
                            
                            <!-- ä¸­å¿ƒLogo -->
                            <div class="wheel-center">
                                MAO
                            </div>
                        </div>
                        
                        <!-- æŒ‡é’ˆ -->
                        <div class="wheel-pointer"></div>
                        
                        <!-- æ¸¸æˆæŒ‰é’® -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 translate-y-16 z-30">
                            <button
                                id="spinBtn"
                                class="game-button font-bold text-white"
                                onclick="startGame()"
                            >
                                <div class="text-2xl mb-1">ğŸ²</div>
                                <div class="text-xs font-bold">å¼€å§‹æ¸¸æˆ</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆçŠ¶æ€ -->
                <div class="glass-effect rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <p class="text-blue-200 text-sm mb-2">
                            æœ¬è½®æŠ•æ³¨: <span class="text-yellow-400 font-bold text-lg" id="betAmount">100 MAO</span>
                        </p>
                        <div id="gameStatus" class="text-white text-sm">
                            è¯·é€‰æ‹©ä»£å¸å¹¶å®Œæˆæˆæƒåå¼€å§‹æ¸¸æˆ
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆå†å² -->
                <div class="glass-effect rounded-lg p-3">
                    <h4 class="text-white font-semibold mb-2 text-sm">ğŸ¯ æ¸¸æˆè®°å½•</h4>
                    <div id="gameHistory" class="space-y-1 max-h-24 overflow-y-auto">
                        <div class="text-blue-200 text-xs text-center py-2">æš‚æ— æ¸¸æˆè®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // é…ç½®å¸¸é‡
        const ALVEY_NETWORK = {
            chainId: '0xED5', // 3797
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: ['https://elves-core1.alvey.io'],
            blockExplorerUrls: ['https://alveyscan.com'],
        };

        const CONTRACTS = {
            WHEEL_GAME: '0x621DF9e0DE6b4e7EDC5Dc22Cd7c0F883c3F56966',
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };

        // å…¨å±€å˜é‡
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let contracts = {};
        let selectedToken = 'MAO';
        let balances = { MAO: '0', PI: '0' };
        let approvalStatus = { MAO: false, PI: false };
        let isSpinning = false;

        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const walletConnect = document.getElementById('walletConnect');
        const gameInterface = document.getElementById('gameInterface');
        const connectionProgress = document.getElementById('connectionProgress');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const userAddress = document.getElementById('userAddress');
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const betAmount = document.getElementById('betAmount');
        const gameStatus = document.getElementById('gameStatus');

        // æ™ºèƒ½åˆçº¦ABI
        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "event GamePlayed(address indexed player, uint8 tokenType, uint256 betAmount, uint256 rewardAmount, uint8 rewardLevel, uint256 randomSeed)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // è¿æ¥è¿›åº¦
        function showProgress(text, percentage, subtext = '') {
            connectionProgress.classList.remove('hidden');
            progressText.textContent = text;
            progressBar.style.width = percentage + '%';
            if (subtext) {
                document.getElementById('progressSubtext').textContent = subtext;
            }
        }

        function hideProgress() {
            connectionProgress.classList.add('hidden');
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                showProgress('æ£€æŸ¥Web3ç¯å¢ƒ...', 10);

                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.jsåº“æœªåŠ è½½');
                }

                if (!window.ethereum) {
                    hideProgress();
                    alert('è¯·ä½¿ç”¨æ”¯æŒWeb3çš„é’±åŒ…æµè§ˆå™¨ï¼\næ¨èï¼šTPé’±åŒ…ã€Trust Walletã€MetaMask');
                    return;
                }

                showProgress('æ£€æŸ¥ç½‘ç»œé…ç½®...', 30);

                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== ALVEY_NETWORK.chainId) {
                    showProgress('åˆ‡æ¢åˆ°AlveyChainç½‘ç»œ...', 50);
                    await switchToAlveyNetwork();
                }

                showProgress('è¯·æ±‚è´¦æˆ·æˆæƒ...', 70);

                // è¯·æ±‚è´¦æˆ·
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts',
                });

                if (accounts.length === 0) {
                    throw new Error('æœªè·å¾—è´¦æˆ·æˆæƒ');
                }

                showProgress('åˆå§‹åŒ–åŒºå—é“¾è¿æ¥...', 90);

                // åˆå§‹åŒ–
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = accounts[0];

                await initializeContracts();
                await refreshAllData();

                showProgress('è¿æ¥å®Œæˆï¼', 100);

                // æ›´æ–°UI
                updateUI();
                setTimeout(hideProgress, 500);

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…é”™è¯¯:', error);
                hideProgress();
                alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢ç½‘ç»œ
        async function switchToAlveyNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ALVEY_NETWORK.chainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [ALVEY_NETWORK],
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // åˆå§‹åŒ–åˆçº¦
        async function initializeContracts() {
            contracts = {
                wheelGame: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, signer),
                maoToken: new ethers.Contract(CONTRACTS.MAO_TOKEN, TOKEN_ABI, signer),
                piToken: new ethers.Contract(CONTRACTS.PI_TOKEN, TOKEN_ABI, signer)
            };
        }

        // åŠ è½½ä½™é¢
        async function loadBalances() {
            try {
                const [maoBalance, piBalance] = await Promise.all([
                    contracts.maoToken.balanceOf(currentAccount),
                    contracts.piToken.balanceOf(currentAccount)
                ]);

                // æ ¼å¼åŒ–ä½™é¢ï¼ˆ9ä½å°æ•°ï¼‰
                balances.MAO = ethers.utils.formatUnits(maoBalance, 9);
                balances.PI = ethers.utils.formatUnits(piBalance, 9);

                updateBalanceDisplay();
            } catch (error) {
                console.error('åŠ è½½ä½™é¢é”™è¯¯:', error);
            }
        }

        // æ£€æŸ¥æˆæƒçŠ¶æ€
        async function checkApprovals() {
            try {
                const [maoAllowance, piAllowance] = await Promise.all([
                    contracts.maoToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME),
                    contracts.piToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME)
                ]);

                // æ£€æŸ¥æˆæƒï¼ˆåˆçº¦ä½¿ç”¨18ä½å°æ•°ï¼‰
                const maoRequired = ethers.utils.parseUnits('100', 18);
                const piRequired = ethers.utils.parseUnits('10000', 18);

                approvalStatus.MAO = maoAllowance.gte(maoRequired);
                approvalStatus.PI = piAllowance.gte(piRequired);

                updateApprovalDisplay();
            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒé”™è¯¯:', error);
            }
        }

        // æˆæƒä»£å¸
        async function approveToken(tokenType) {
            try {
                const btn = document.getElementById(`${tokenType.toLowerCase()}ApproveBtn`);
                const contract = tokenType === 'MAO' ? contracts.maoToken : contracts.piToken;

                btn.textContent = `æˆæƒ${tokenType}ä¸­...`;
                btn.disabled = true;

                const tx = await contract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                await tx.wait();

                approvalStatus[tokenType] = true;
                updateApprovalDisplay();

                alert(`${tokenType}ä»£å¸æˆæƒæˆåŠŸï¼`);
            } catch (error) {
                console.error(`æˆæƒ${tokenType}é”™è¯¯:`, error);
                alert(`æˆæƒ${tokenType}å¤±è´¥: ` + error.message);
            } finally {
                updateApprovalButtons();
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            if (isSpinning) {
                alert('æ¸¸æˆè¿›è¡Œä¸­ï¼Œè¯·ç¨åå†åˆ‡æ¢ï¼');
                return;
            }
            
            selectedToken = token;
            updateTokenSelection();
            updateBetAmount();
            updateRewardDisplay();
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (isSpinning) return;
            
            try {
                // æ£€æŸ¥æˆæƒ
                if (!approvalStatus[selectedToken]) {
                    alert(`è¯·å…ˆæˆæƒ${selectedToken}ä»£å¸ï¼`);
                    return;
                }

                // æ£€æŸ¥ä½™é¢
                const balance = parseFloat(balances[selectedToken]);
                const required = selectedToken === 'MAO' ? 100 : 10000;
                
                if (balance < required) {
                    alert(`${selectedToken}ä½™é¢ä¸è¶³ï¼éœ€è¦${required}ä¸ª${selectedToken}`);
                    return;
                }

                isSpinning = true;
                updateGameStatus('æ¸¸æˆä¸­...');
                startWheelAnimation();
                
                // è°ƒç”¨æ™ºèƒ½åˆçº¦
                const method = selectedToken === 'MAO' ? 'playMAOGame' : 'playPIGame';
                const tx = await contracts.wheelGame[method]();
                
                updateGameStatus('äº¤æ˜“ç¡®è®¤ä¸­...');
                const receipt = await tx.wait();
                
                // è§£æç»“æœ
                const result = await parseGameResult(receipt);
                await showGameResult(result);
                
                // åˆ·æ–°æ•°æ®
                await refreshAllData();
                
            } catch (error) {
                console.error('æ¸¸æˆé”™è¯¯:', error);
                alert('æ¸¸æˆå¤±è´¥: ' + error.message);
            } finally {
                isSpinning = false;
                updateGameStatus('å‡†å¤‡å°±ç»ª');
                stopWheelAnimation();
            }
        }

        // è½¬ç›˜åŠ¨ç”»
        function startWheelAnimation() {
            const randomRotation = 1800 + Math.random() * 1800;
            wheel.style.transform = `rotate(${randomRotation}deg)`;
            spinBtn.disabled = true;
            spinBtn.innerHTML = '<div class="text-xl mb-1">â³</div><div class="text-xs">æ¸¸æˆä¸­</div>';
        }

        function stopWheelAnimation() {
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<div class="text-2xl mb-1">ğŸ²</div><div class="text-xs">å¼€å§‹æ¸¸æˆ</div>';
        }

        // è§£ææ¸¸æˆç»“æœ
        async function parseGameResult(receipt) {
            const iface = new ethers.utils.Interface(WHEEL_GAME_ABI);
            
            for (let log of receipt.logs) {
                try {
                    const parsed = iface.parseLog(log);
                    if (parsed.name === 'GamePlayed') {
                        return {
                            tokenType: parsed.args.tokenType,
                            rewardLevel: parsed.args.rewardLevel,
                            rewardAmount: parsed.args.rewardAmount
                        };
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            }
            
            throw new Error('æ— æ³•è§£ææ¸¸æˆç»“æœ');
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æœ
        async function showGameResult(result) {
            const rewards = [
                { name: 'è°¢è°¢æƒ é¡¾', emoji: 'ğŸ˜Š' },
                { name: 'å°å¥–', emoji: 'ğŸ' },
                { name: 'ä¸­å¥–', emoji: 'ğŸ†' },
                { name: 'å¤§å¥–', emoji: 'ğŸ’' },
                { name: 'è¶…çº§å¤§å¥–', emoji: 'ğŸŒŸ' },
                { name: 'ç»ˆæå¤§å¥–', emoji: 'ğŸ’°' }
            ];
            
            const rewardInfo = rewards[result.rewardLevel];
            const rewardAmount = ethers.utils.formatUnits(result.rewardAmount, 9);
            
            let message = `${rewardInfo.emoji} ${rewardInfo.name}ï¼\n`;
            
            if (result.rewardLevel > 0) {
                message += `æ­å–œè·å¾— ${rewardAmount} ${selectedToken}ï¼`;
                createCelebration();
            } else {
                message += 'å†æ¥å†å‰ï¼';
            }
            
            alert(message);
            addToHistory(rewardInfo, rewardAmount);
        }

        // åº†ç¥æ•ˆæœ
        function createCelebration() {
            document.body.style.background = 'linear-gradient(45deg, #FFD700, #FFA500, #FFD700)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
        }

        // æ›´æ–°UIå‡½æ•°
        function updateUI() {
            walletConnect.style.display = 'none';
            gameInterface.style.display = 'block';
            userAddress.textContent = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
        }

        function updateBalanceDisplay() {
            document.getElementById('maoBalance').textContent = `ä½™é¢: ${parseFloat(balances.MAO).toFixed(2)}`;
            document.getElementById('piBalance').textContent = `ä½™é¢: ${parseFloat(balances.PI).toFixed(2)}`;
        }

        function updateApprovalDisplay() {
            // MAOçŠ¶æ€
            const maoStatusDot = document.getElementById('maoStatusDot');
            const maoStatusText = document.getElementById('maoStatusText');
            
            if (approvalStatus.MAO) {
                maoStatusDot.className = 'status-dot approved';
                maoStatusText.textContent = 'å·²æˆæƒ';
            } else {
                maoStatusDot.className = 'status-dot not-approved';
                maoStatusText.textContent = 'éœ€è¦æˆæƒ';
            }
            
            // PIçŠ¶æ€
            const piStatusDot = document.getElementById('piStatusDot');
            const piStatusText = document.getElementById('piStatusText');
            
            if (approvalStatus.PI) {
                piStatusDot.className = 'status-dot approved';
                piStatusText.textContent = 'å·²æˆæƒ';
            } else {
                piStatusDot.className = 'status-dot not-approved';
                piStatusText.textContent = 'éœ€è¦æˆæƒ';
            }
            
            updateApprovalButtons();
        }

        function updateApprovalButtons() {
            // MAOæˆæƒæŒ‰é’®
            const maoBtn = document.getElementById('maoApproveBtn');
            if (approvalStatus.MAO) {
                maoBtn.textContent = 'âœ… MAOå·²æˆæƒ';
                maoBtn.className = 'w-full approve-button approved text-white font-bold py-3 px-4 rounded-lg';
                maoBtn.disabled = true;
            } else {
                maoBtn.textContent = 'ğŸ”“ æˆæƒ MAO ä»£å¸';
                maoBtn.className = 'w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200';
                maoBtn.disabled = false;
            }
            
            // PIæˆæƒæŒ‰é’®
            const piBtn = document.getElementById('piApproveBtn');
            if (approvalStatus.PI) {
                piBtn.textContent = 'âœ… PIå·²æˆæƒ';
                piBtn.className = 'w-full approve-button approved text-white font-bold py-3 px-4 rounded-lg';
                piBtn.disabled = true;
            } else {
                piBtn.textContent = 'ğŸ”“ æˆæƒ PI ä»£å¸';
                piBtn.className = 'w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200';
                piBtn.disabled = false;
            }
        }

        function updateTokenSelection() {
            const maoSelect = document.getElementById('maoSelectBtn');
            const piSelect = document.getElementById('piSelectBtn');
            
            if (selectedToken === 'MAO') {
                maoSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected';
                piSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected';
            } else {
                maoSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected';
                piSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected';
            }
        }

        function updateBetAmount() {
            betAmount.textContent = selectedToken === 'MAO' ? '100 MAO' : '10,000 PI';
        }

        function updateRewardDisplay() {
            // æ›´æ–°è½¬ç›˜å¥–åŠ±æ˜¾ç¤º
            const maoRewards = [0, 150, 400, 800, 1500, 3000];
            const piRewards = [0, 15000, 40000, 80000, 150000, 300000];
            const rewards = selectedToken === 'MAO' ? maoRewards : piRewards;
            
            const rewardElements = ['smallReward', 'mediumReward', 'bigReward', 'superReward', 'ultimateReward'];
            rewardElements.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = rewards[index + 1];
                }
            });
        }

        function updateGameStatus(status) {
            gameStatus.textContent = status;
        }

        function addToHistory(rewardInfo, amount) {
            const historyContainer = document.getElementById('gameHistory');
            const entry = document.createElement('div');
            entry.className = 'text-xs text-blue-200 py-1 border-b border-white/10';
            entry.innerHTML = `
                <span class="text-yellow-400">${new Date().toLocaleTimeString()}</span>
                <span class="mx-1">${rewardInfo.emoji}</span>
                <span>${rewardInfo.name}</span>
                ${amount > 0 ? `<span class="text-green-400 ml-1">+${amount} ${selectedToken}</span>` : ''}
            `;
            
            // æ’å…¥åˆ°é¡¶éƒ¨
            if (historyContainer.firstChild && historyContainer.firstChild.textContent.includes('æš‚æ— ')) {
                historyContainer.innerHTML = '';
            }
            historyContainer.insertBefore(entry, historyContainer.firstChild);
            
            // ä¿æŒæœ€å¤š8æ¡è®°å½•
            while (historyContainer.children.length > 8) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
                btn.disabled = true;
                
                await Promise.all([
                    loadBalances(),
                    checkApprovals()
                ]);
                
                btn.textContent = 'âœ… åˆ·æ–°å®Œæˆ';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('åˆ·æ–°é”™è¯¯:', error);
                btn.textContent = 'âŒ åˆ·æ–°å¤±è´¥';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // äº‹ä»¶ç›‘å¬
        connectBtn.addEventListener('click', connectWallet);

        // è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', async () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('ğŸš€ æ£€æµ‹åˆ°å·²è¿æ¥è´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥ä¸­...');
                        setTimeout(connectWallet, 1000);
                    }
                } catch (error) {
                    console.log('è‡ªåŠ¨è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                }
            }
        });

        // ç›‘å¬é’±åŒ…å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else if (accounts[0] !== currentAccount) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                location.reload();
            });
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        updateTokenSelection();
        updateBetAmount();
        updateRewardDisplay();
    </script>
</body>
</html> 