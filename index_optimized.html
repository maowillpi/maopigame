<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>🎰 MAO转盘游戏 - 优化版 v4.1.0</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        /* 专业转盘设计 */
        .professional-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 208.8deg,    /* 谢谢惠顾 58% */
                #4ECDC4 208.8deg 288deg,  /* 小奖 22% */
                #45B7D1 288deg 331.2deg, /* 中奖 12% */
                #96CEB4 331.2deg 352.8deg, /* 大奖 6% */
                #FFEAA7 352.8deg 358.2deg, /* 超级大奖 1.5% */
                #DDA0DD 358.2deg 360deg  /* 终极大奖 0.5% */
            );
            border: 12px solid #FFD700;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.9),
                inset 0 0 40px rgba(0, 0, 0, 0.3),
                0 0 120px rgba(255, 215, 0, 0.7);
            position: relative;
            animation: wheelGlow 4s ease-in-out infinite alternate;
            transform-style: preserve-3d;
        }
        
        @keyframes wheelGlow {
            0% { 
                box-shadow: 
                    0 0 60px rgba(255, 215, 0, 0.9),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 120px rgba(255, 215, 0, 0.7);
            }
            100% { 
                box-shadow: 
                    0 0 100px rgba(255, 215, 0, 1),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 160px rgba(255, 215, 0, 0.9);
            }
        }
        
        .wheel-animation {
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 转盘指针 */
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 50px solid #FFD700;
            z-index: 30;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8));
        }
        
        .wheel-pointer::before {
            content: '';
            position: absolute;
            top: -48px;
            left: -15px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(255, 215, 0, 1);
        }
        
        /* 转盘区域 */
        .wheel-section {
            position: absolute;
            z-index: 10;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 6px;
            transition: all 0.3s ease;
        }
        
        .wheel-emoji {
            font-size: 24px;
            margin-bottom: 2px;
            display: block;
        }
        
        .probability-text {
            font-size: 9px;
            color: #FFD700;
            font-weight: bold;
        }
        
        .reward-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 1px 4px;
            border-radius: 8px;
            margin-top: 1px;
        }
        
        /* 中心Logo */
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.4);
            border: 4px solid rgba(255, 255, 255, 0.8);
            z-index: 20;
        }
        
        /* 游戏按钮 */
        .game-button {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border: 5px solid white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }
        
        .game-button:hover {
            transform: scale(1.1);
            box-shadow: 
                0 16px 32px rgba(0, 0, 0, 0.8),
                inset 0 4px 8px rgba(255, 255, 255, 0.6);
        }
        
        /* 钱包连接界面 */
        .wallet-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .wallet-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* 授权状态指示器 */
        .approval-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .status-dot.approved {
            background: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
        }
        
        .status-dot.not-approved {
            background: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 代币选择按钮 */
        .token-button {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .token-button.selected {
            background: linear-gradient(135deg, #10B981, #059669);
            border-color: #10B981;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .token-button.unselected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 授权按钮 */
        .approve-button {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            transition: all 0.3s ease;
        }
        
        .approve-button:hover {
            background: linear-gradient(135deg, #FBBF24, #F59E0B);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        .approve-button.approved {
            background: linear-gradient(135deg, #10B981, #059669);
            cursor: default;
        }
        
        /* 连接进度条 */
        .progress-container {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1.5px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            border-radius: 1.5px;
            transition: width 0.3s ease;
        }
        
        /* 玻璃效果 */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    
    <!-- 页面容器 -->
    <div class="container mx-auto px-4 py-2 max-w-md">
        
        <!-- 标题 -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-white mb-2">
                🎰 MAO转盘游戏
            </h1>
            <p class="text-blue-200 text-sm">
                AlveyChain 区块链游戏 - 优化版 v4.1.0
            </p>
            <div class="text-xs text-green-400 mt-1">
                ✨ 分离授权 · 专业转盘 · 优化连接
            </div>
        </div>

        <!-- 连接进度 -->
        <div id="connectionProgress" class="hidden mb-4">
            <div class="wallet-card rounded-xl p-4">
                <div class="text-center">
                    <div class="text-white font-semibold mb-2" id="progressText">正在连接钱包...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-blue-200 text-sm mt-2" id="progressSubtext">请稍候...</div>
                </div>
            </div>
        </div>

        <!-- 钱包连接界面 -->
        <div id="walletConnect" class="space-y-4">
            <div class="wallet-card rounded-xl p-6">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🔗</div>
                    <h2 class="text-xl font-bold text-white mb-2">连接Web3钱包</h2>
                    <p class="text-blue-200 text-sm">
                        请使用支持AlveyChain的钱包连接游戏
                    </p>
                </div>
                
                <!-- 推荐钱包 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-3 text-sm">📱 推荐钱包</h3>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🔵</div>
                            <div class="text-white font-semibold">TP钱包</div>
                            <div class="text-blue-200">最受欢迎</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🛡️</div>
                            <div class="text-white font-semibold">Trust Wallet</div>
                            <div class="text-blue-200">币安官方</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🦊</div>
                            <div class="text-white font-semibold">MetaMask</div>
                            <div class="text-blue-200">桌面首选</div>
                        </div>
                        <div class="glass-effect rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">📱</div>
                            <div class="text-white font-semibold">其他钱包</div>
                            <div class="text-blue-200">Web3兼容</div>
                        </div>
                    </div>
                </div>
                
                <!-- 连接按钮 -->
                <button 
                    id="connectBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                    🔗 连接钱包开始游戏
                </button>
            </div>
            
            <!-- 游戏特色 -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">🎮 游戏特色</h3>
                <ul class="text-blue-200 text-sm space-y-2">
                    <li>• 42%超高中奖率，小奖有盈利感</li>
                    <li>• 分离代币授权，操作更安全</li>
                    <li>• 专业转盘设计，体验更流畅</li>
                    <li>• 智能合约保障，完全透明</li>
                    <li>• 即时到账奖励，无需等待</li>
                </ul>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div id="gameInterface" class="space-y-4" style="display: none;">
            
            <!-- 钱包状态 -->
            <div class="wallet-card rounded-xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-blue-200 text-xs">钱包地址</p>
                        <p class="text-white text-sm font-mono" id="userAddress">未连接</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-200 text-xs">网络状态</p>
                        <p class="text-green-400 font-bold text-sm">✅ AlveyChain</p>
                    </div>
                </div>
                
                <button 
                    id="refreshBtn"
                    class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200"
                    onclick="refreshAllData()"
                >
                    🔄 刷新余额和授权状态
                </button>
            </div>

            <!-- 代币管理 -->
            <div class="wallet-card rounded-xl p-4">
                <h3 class="text-white font-semibold mb-4 text-center">💰 代币管理</h3>
                
                <!-- MAO代币 -->
                <div class="mb-4">
                    <div class="glass-effect rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="maoSelectBtn" 
                                    class="token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected"
                                    onclick="selectToken('MAO')"
                                >
                                    MAO
                                </button>
                                <div>
                                    <div class="text-white font-semibold">MAO Token</div>
                                    <div class="text-blue-200 text-xs">100 MAO/次</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-sm" id="maoBalance">余额: 0</div>
                                <div class="approval-status mt-1">
                                    <span class="status-dot not-approved" id="maoStatusDot"></span>
                                    <span class="text-xs text-blue-200" id="maoStatusText">需要授权</span>
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            id="maoApproveBtn"
                            class="w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200"
                            onclick="approveToken('MAO')"
                        >
                            🔓 授权 MAO 代币
                        </button>
                    </div>
                </div>
                
                <!-- PI代币 -->
                <div class="mb-4">
                    <div class="glass-effect rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="piSelectBtn" 
                                    class="token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected"
                                    onclick="selectToken('PI')"
                                >
                                    PI
                                </button>
                                <div>
                                    <div class="text-white font-semibold">PI Token</div>
                                    <div class="text-blue-200 text-xs">10,000 PI/次</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-sm" id="piBalance">余额: 0</div>
                                <div class="approval-status mt-1">
                                    <span class="status-dot not-approved" id="piStatusDot"></span>
                                    <span class="text-xs text-blue-200" id="piStatusText">需要授权</span>
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            id="piApproveBtn"
                            class="w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200"
                            onclick="approveToken('PI')"
                        >
                            🔓 授权 PI 代币
                        </button>
                    </div>
                </div>
            </div>

            <!-- 专业转盘 -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-white font-bold text-center mb-4 text-lg">🎰 专业幸运转盘</h3>
                
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div 
                            id="wheel"
                            class="w-72 h-72 rounded-full professional-wheel wheel-animation shadow-2xl relative"
                        >
                            <!-- 转盘区域 -->
                            <!-- 谢谢惠顾 58% -->
                            <div class="wheel-section" style="top: 15px; left: 50%; transform: translateX(-50%);">
                                <div class="wheel-emoji">😊</div>
                                <div class="text-xs font-bold">谢谢惠顾</div>
                                <div class="probability-text">58%</div>
                                <div class="reward-badge">0</div>
                            </div>
                            
                            <!-- 小奖 22% -->
                            <div class="wheel-section" style="top: 25px; right: 25px;">
                                <div class="wheel-emoji">🎁</div>
                                <div class="text-xs font-bold">小奖</div>
                                <div class="probability-text">22%</div>
                                <div class="reward-badge" id="smallReward">150</div>
                            </div>
                            
                            <!-- 中奖 12% -->
                            <div class="wheel-section" style="bottom: 25px; right: 25px;">
                                <div class="wheel-emoji">🏆</div>
                                <div class="text-xs font-bold">中奖</div>
                                <div class="probability-text">12%</div>
                                <div class="reward-badge" id="mediumReward">400</div>
                            </div>
                            
                            <!-- 大奖 6% -->
                            <div class="wheel-section" style="bottom: 15px; left: 50%; transform: translateX(-50%);">
                                <div class="wheel-emoji">💎</div>
                                <div class="text-xs font-bold">大奖</div>
                                <div class="probability-text">6%</div>
                                <div class="reward-badge" id="bigReward">800</div>
                            </div>
                            
                            <!-- 超级大奖 1.5% -->
                            <div class="wheel-section" style="bottom: 25px; left: 25px;">
                                <div class="wheel-emoji">🌟</div>
                                <div class="text-xs font-bold">超级</div>
                                <div class="probability-text">1.5%</div>
                                <div class="reward-badge" id="superReward">1500</div>
                            </div>
                            
                            <!-- 终极大奖 0.5% -->
                            <div class="wheel-section" style="top: 25px; left: 25px;">
                                <div class="wheel-emoji">💰</div>
                                <div class="text-xs font-bold">终极</div>
                                <div class="probability-text">0.5%</div>
                                <div class="reward-badge" id="ultimateReward">3000</div>
                            </div>
                            
                            <!-- 中心Logo -->
                            <div class="wheel-center">
                                MAO
                            </div>
                        </div>
                        
                        <!-- 指针 -->
                        <div class="wheel-pointer"></div>
                        
                        <!-- 游戏按钮 -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 translate-y-16 z-30">
                            <button
                                id="spinBtn"
                                class="game-button font-bold text-white"
                                onclick="startGame()"
                            >
                                <div class="text-2xl mb-1">🎲</div>
                                <div class="text-xs font-bold">开始游戏</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 游戏状态 -->
                <div class="glass-effect rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <p class="text-blue-200 text-sm mb-2">
                            本轮投注: <span class="text-yellow-400 font-bold text-lg" id="betAmount">100 MAO</span>
                        </p>
                        <div id="gameStatus" class="text-white text-sm">
                            请选择代币并完成授权后开始游戏
                        </div>
                    </div>
                </div>

                <!-- 游戏历史 -->
                <div class="glass-effect rounded-lg p-3">
                    <h4 class="text-white font-semibold mb-2 text-sm">🎯 游戏记录</h4>
                    <div id="gameHistory" class="space-y-1 max-h-24 overflow-y-auto">
                        <div class="text-blue-200 text-xs text-center py-2">暂无游戏记录</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 配置常量
        const ALVEY_NETWORK = {
            chainId: '0xED5', // 3797
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: ['https://elves-core1.alvey.io'],
            blockExplorerUrls: ['https://alveyscan.com'],
        };

        const CONTRACTS = {
            WHEEL_GAME: '0x621DF9e0DE6b4e7EDC5Dc22Cd7c0F883c3F56966',
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };

        // 全局变量
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let contracts = {};
        let selectedToken = 'MAO';
        let balances = { MAO: '0', PI: '0' };
        let approvalStatus = { MAO: false, PI: false };
        let isSpinning = false;

        // DOM元素
        const connectBtn = document.getElementById('connectBtn');
        const walletConnect = document.getElementById('walletConnect');
        const gameInterface = document.getElementById('gameInterface');
        const connectionProgress = document.getElementById('connectionProgress');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const userAddress = document.getElementById('userAddress');
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const betAmount = document.getElementById('betAmount');
        const gameStatus = document.getElementById('gameStatus');

        // 智能合约ABI
        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "event GamePlayed(address indexed player, uint8 tokenType, uint256 betAmount, uint256 rewardAmount, uint8 rewardLevel, uint256 randomSeed)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // 连接进度
        function showProgress(text, percentage, subtext = '') {
            connectionProgress.classList.remove('hidden');
            progressText.textContent = text;
            progressBar.style.width = percentage + '%';
            if (subtext) {
                document.getElementById('progressSubtext').textContent = subtext;
            }
        }

        function hideProgress() {
            connectionProgress.classList.add('hidden');
        }

        // 连接钱包
        async function connectWallet() {
            try {
                showProgress('检查Web3环境...', 10);

                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js库未加载');
                }

                if (!window.ethereum) {
                    hideProgress();
                    alert('请使用支持Web3的钱包浏览器！\n推荐：TP钱包、Trust Wallet、MetaMask');
                    return;
                }

                showProgress('检查网络配置...', 30);

                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== ALVEY_NETWORK.chainId) {
                    showProgress('切换到AlveyChain网络...', 50);
                    await switchToAlveyNetwork();
                }

                showProgress('请求账户授权...', 70);

                // 请求账户
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts',
                });

                if (accounts.length === 0) {
                    throw new Error('未获得账户授权');
                }

                showProgress('初始化区块链连接...', 90);

                // 初始化
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = accounts[0];

                await initializeContracts();
                await refreshAllData();

                showProgress('连接完成！', 100);

                // 更新UI
                updateUI();
                setTimeout(hideProgress, 500);

            } catch (error) {
                console.error('连接钱包错误:', error);
                hideProgress();
                alert('连接钱包失败: ' + error.message);
            }
        }

        // 切换网络
        async function switchToAlveyNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ALVEY_NETWORK.chainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [ALVEY_NETWORK],
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // 初始化合约
        async function initializeContracts() {
            contracts = {
                wheelGame: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, signer),
                maoToken: new ethers.Contract(CONTRACTS.MAO_TOKEN, TOKEN_ABI, signer),
                piToken: new ethers.Contract(CONTRACTS.PI_TOKEN, TOKEN_ABI, signer)
            };
        }

        // 加载余额
        async function loadBalances() {
            try {
                const [maoBalance, piBalance] = await Promise.all([
                    contracts.maoToken.balanceOf(currentAccount),
                    contracts.piToken.balanceOf(currentAccount)
                ]);

                // 格式化余额（9位小数）
                balances.MAO = ethers.utils.formatUnits(maoBalance, 9);
                balances.PI = ethers.utils.formatUnits(piBalance, 9);

                updateBalanceDisplay();
            } catch (error) {
                console.error('加载余额错误:', error);
            }
        }

        // 检查授权状态
        async function checkApprovals() {
            try {
                const [maoAllowance, piAllowance] = await Promise.all([
                    contracts.maoToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME),
                    contracts.piToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME)
                ]);

                // 检查授权（合约使用18位小数）
                const maoRequired = ethers.utils.parseUnits('100', 18);
                const piRequired = ethers.utils.parseUnits('10000', 18);

                approvalStatus.MAO = maoAllowance.gte(maoRequired);
                approvalStatus.PI = piAllowance.gte(piRequired);

                updateApprovalDisplay();
            } catch (error) {
                console.error('检查授权错误:', error);
            }
        }

        // 授权代币
        async function approveToken(tokenType) {
            try {
                const btn = document.getElementById(`${tokenType.toLowerCase()}ApproveBtn`);
                const contract = tokenType === 'MAO' ? contracts.maoToken : contracts.piToken;

                btn.textContent = `授权${tokenType}中...`;
                btn.disabled = true;

                const tx = await contract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                await tx.wait();

                approvalStatus[tokenType] = true;
                updateApprovalDisplay();

                alert(`${tokenType}代币授权成功！`);
            } catch (error) {
                console.error(`授权${tokenType}错误:`, error);
                alert(`授权${tokenType}失败: ` + error.message);
            } finally {
                updateApprovalButtons();
            }
        }

        // 选择代币
        function selectToken(token) {
            if (isSpinning) {
                alert('游戏进行中，请稍后再切换！');
                return;
            }
            
            selectedToken = token;
            updateTokenSelection();
            updateBetAmount();
            updateRewardDisplay();
        }

        // 开始游戏
        async function startGame() {
            if (isSpinning) return;
            
            try {
                // 检查授权
                if (!approvalStatus[selectedToken]) {
                    alert(`请先授权${selectedToken}代币！`);
                    return;
                }

                // 检查余额
                const balance = parseFloat(balances[selectedToken]);
                const required = selectedToken === 'MAO' ? 100 : 10000;
                
                if (balance < required) {
                    alert(`${selectedToken}余额不足！需要${required}个${selectedToken}`);
                    return;
                }

                isSpinning = true;
                updateGameStatus('游戏中...');
                startWheelAnimation();
                
                // 调用智能合约
                const method = selectedToken === 'MAO' ? 'playMAOGame' : 'playPIGame';
                const tx = await contracts.wheelGame[method]();
                
                updateGameStatus('交易确认中...');
                const receipt = await tx.wait();
                
                // 解析结果
                const result = await parseGameResult(receipt);
                await showGameResult(result);
                
                // 刷新数据
                await refreshAllData();
                
            } catch (error) {
                console.error('游戏错误:', error);
                alert('游戏失败: ' + error.message);
            } finally {
                isSpinning = false;
                updateGameStatus('准备就绪');
                stopWheelAnimation();
            }
        }

        // 转盘动画
        function startWheelAnimation() {
            const randomRotation = 1800 + Math.random() * 1800;
            wheel.style.transform = `rotate(${randomRotation}deg)`;
            spinBtn.disabled = true;
            spinBtn.innerHTML = '<div class="text-xl mb-1">⏳</div><div class="text-xs">游戏中</div>';
        }

        function stopWheelAnimation() {
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<div class="text-2xl mb-1">🎲</div><div class="text-xs">开始游戏</div>';
        }

        // 解析游戏结果
        async function parseGameResult(receipt) {
            const iface = new ethers.utils.Interface(WHEEL_GAME_ABI);
            
            for (let log of receipt.logs) {
                try {
                    const parsed = iface.parseLog(log);
                    if (parsed.name === 'GamePlayed') {
                        return {
                            tokenType: parsed.args.tokenType,
                            rewardLevel: parsed.args.rewardLevel,
                            rewardAmount: parsed.args.rewardAmount
                        };
                    }
                } catch (e) {
                    // 忽略解析错误
                }
            }
            
            throw new Error('无法解析游戏结果');
        }

        // 显示游戏结果
        async function showGameResult(result) {
            const rewards = [
                { name: '谢谢惠顾', emoji: '😊' },
                { name: '小奖', emoji: '🎁' },
                { name: '中奖', emoji: '🏆' },
                { name: '大奖', emoji: '💎' },
                { name: '超级大奖', emoji: '🌟' },
                { name: '终极大奖', emoji: '💰' }
            ];
            
            const rewardInfo = rewards[result.rewardLevel];
            const rewardAmount = ethers.utils.formatUnits(result.rewardAmount, 9);
            
            let message = `${rewardInfo.emoji} ${rewardInfo.name}！\n`;
            
            if (result.rewardLevel > 0) {
                message += `恭喜获得 ${rewardAmount} ${selectedToken}！`;
                createCelebration();
            } else {
                message += '再接再厉！';
            }
            
            alert(message);
            addToHistory(rewardInfo, rewardAmount);
        }

        // 庆祝效果
        function createCelebration() {
            document.body.style.background = 'linear-gradient(45deg, #FFD700, #FFA500, #FFD700)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
        }

        // 更新UI函数
        function updateUI() {
            walletConnect.style.display = 'none';
            gameInterface.style.display = 'block';
            userAddress.textContent = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
        }

        function updateBalanceDisplay() {
            document.getElementById('maoBalance').textContent = `余额: ${parseFloat(balances.MAO).toFixed(2)}`;
            document.getElementById('piBalance').textContent = `余额: ${parseFloat(balances.PI).toFixed(2)}`;
        }

        function updateApprovalDisplay() {
            // MAO状态
            const maoStatusDot = document.getElementById('maoStatusDot');
            const maoStatusText = document.getElementById('maoStatusText');
            
            if (approvalStatus.MAO) {
                maoStatusDot.className = 'status-dot approved';
                maoStatusText.textContent = '已授权';
            } else {
                maoStatusDot.className = 'status-dot not-approved';
                maoStatusText.textContent = '需要授权';
            }
            
            // PI状态
            const piStatusDot = document.getElementById('piStatusDot');
            const piStatusText = document.getElementById('piStatusText');
            
            if (approvalStatus.PI) {
                piStatusDot.className = 'status-dot approved';
                piStatusText.textContent = '已授权';
            } else {
                piStatusDot.className = 'status-dot not-approved';
                piStatusText.textContent = '需要授权';
            }
            
            updateApprovalButtons();
        }

        function updateApprovalButtons() {
            // MAO授权按钮
            const maoBtn = document.getElementById('maoApproveBtn');
            if (approvalStatus.MAO) {
                maoBtn.textContent = '✅ MAO已授权';
                maoBtn.className = 'w-full approve-button approved text-white font-bold py-3 px-4 rounded-lg';
                maoBtn.disabled = true;
            } else {
                maoBtn.textContent = '🔓 授权 MAO 代币';
                maoBtn.className = 'w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200';
                maoBtn.disabled = false;
            }
            
            // PI授权按钮
            const piBtn = document.getElementById('piApproveBtn');
            if (approvalStatus.PI) {
                piBtn.textContent = '✅ PI已授权';
                piBtn.className = 'w-full approve-button approved text-white font-bold py-3 px-4 rounded-lg';
                piBtn.disabled = true;
            } else {
                piBtn.textContent = '🔓 授权 PI 代币';
                piBtn.className = 'w-full approve-button text-white font-bold py-3 px-4 rounded-lg transition-all duration-200';
                piBtn.disabled = false;
            }
        }

        function updateTokenSelection() {
            const maoSelect = document.getElementById('maoSelectBtn');
            const piSelect = document.getElementById('piSelectBtn');
            
            if (selectedToken === 'MAO') {
                maoSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected';
                piSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected';
            } else {
                maoSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 unselected';
                piSelect.className = 'token-button py-2 px-3 rounded-lg font-semibold text-sm mr-3 selected';
            }
        }

        function updateBetAmount() {
            betAmount.textContent = selectedToken === 'MAO' ? '100 MAO' : '10,000 PI';
        }

        function updateRewardDisplay() {
            // 更新转盘奖励显示
            const maoRewards = [0, 150, 400, 800, 1500, 3000];
            const piRewards = [0, 15000, 40000, 80000, 150000, 300000];
            const rewards = selectedToken === 'MAO' ? maoRewards : piRewards;
            
            const rewardElements = ['smallReward', 'mediumReward', 'bigReward', 'superReward', 'ultimateReward'];
            rewardElements.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = rewards[index + 1];
                }
            });
        }

        function updateGameStatus(status) {
            gameStatus.textContent = status;
        }

        function addToHistory(rewardInfo, amount) {
            const historyContainer = document.getElementById('gameHistory');
            const entry = document.createElement('div');
            entry.className = 'text-xs text-blue-200 py-1 border-b border-white/10';
            entry.innerHTML = `
                <span class="text-yellow-400">${new Date().toLocaleTimeString()}</span>
                <span class="mx-1">${rewardInfo.emoji}</span>
                <span>${rewardInfo.name}</span>
                ${amount > 0 ? `<span class="text-green-400 ml-1">+${amount} ${selectedToken}</span>` : ''}
            `;
            
            // 插入到顶部
            if (historyContainer.firstChild && historyContainer.firstChild.textContent.includes('暂无')) {
                historyContainer.innerHTML = '';
            }
            historyContainer.insertBefore(entry, historyContainer.firstChild);
            
            // 保持最多8条记录
            while (historyContainer.children.length > 8) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // 刷新所有数据
        async function refreshAllData() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '🔄 刷新中...';
                btn.disabled = true;
                
                await Promise.all([
                    loadBalances(),
                    checkApprovals()
                ]);
                
                btn.textContent = '✅ 刷新完成';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('刷新错误:', error);
                btn.textContent = '❌ 刷新失败';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // 事件监听
        connectBtn.addEventListener('click', connectWallet);

        // 自动连接
        window.addEventListener('load', async () => {
            console.log('🚀 页面加载完成');
            
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('🚀 检测到已连接账户，自动连接中...');
                        setTimeout(connectWallet, 1000);
                    }
                } catch (error) {
                    console.log('自动连接检查失败:', error);
                }
            }
        });

        // 监听钱包变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else if (accounts[0] !== currentAccount) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                location.reload();
            });
        }

        // 初始化显示
        updateTokenSelection();
        updateBetAmount();
        updateRewardDisplay();
    </script>
</body>
</html> 