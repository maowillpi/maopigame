<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>🎰 MAO转盘游戏 - AlveyChain 区块链游戏 v4.1.0 营销钱包版</title>
    
    <!-- 强制缓存清除 v4.1.0 营销钱包版 -->
    <script>
        const CACHE_VERSION = 'v4.1.0-marketing-' + Date.now();
        console.log('🚀 MAO转盘游戏 v4.1.0 营销钱包版 - 强制更新');
        console.log('📅 缓存版本:', CACHE_VERSION);
        console.log('🎯 部署时间:', new Date().toLocaleString('zh-CN'));
        
        // 强制清除所有旧缓存
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                    console.log('🗑️ 清除Service Worker');
                }
            });
        }
        
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    caches.delete(name);
                    console.log('🗑️ 清除缓存:', name);
                });
            });
        }
        
        // 页面版本检查
        const lastVersion = localStorage.getItem('mao_game_version');
        if (lastVersion !== CACHE_VERSION) {
            console.log('🔄 检测到v4.1.0营销钱包版本，强制更新缓存');
            localStorage.setItem('mao_game_version', CACHE_VERSION);
            
            // 显示版本信息
            console.log('✅ 已更新到MAO转盘游戏v4.1.0营销钱包版本！');
            console.log('🌟 新功能: 分离代币授权 + 优化钱包连接 + 专业转盘界面');
        }
        
        // 强制禁用缓存
        if (window.location.search.indexOf('nocache') === -1) {
            const separator = window.location.search ? '&' : '?';
            const newUrl = window.location.href + separator + 'nocache=' + Date.now();
            if (lastVersion && lastVersion !== CACHE_VERSION) {
                console.log('🔄 强制刷新页面清除缓存');
                window.location.replace(newUrl);
            }
        }
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN - 使用更稳定的版本 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .wheel-animation {
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .bounce-animation {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -30px, 0); }
            70% { transform: translate3d(0, -15px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }
        
        .bg-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 🎰 超级专业转盘设计 */
        .super-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 210.24deg,    /* 谢谢惠顾 58% */
                #4ECDC4 210.24deg 289.44deg,  /* 小奖 22% */
                #45B7D1 289.44deg 332.64deg, /* 中奖 12% */
                #96CEB4 332.64deg 354.24deg, /* 大奖 6% */
                #FFEAA7 354.24deg 359.64deg, /* 超级大奖 1.5% */
                #DDA0DD 359.64deg 360deg  /* 终极大奖 0.5% */
            );
            border: 15px solid #FFD700;
            box-shadow: 
                0 0 80px rgba(255, 215, 0, 0.9),
                inset 0 0 50px rgba(0, 0, 0, 0.3),
                0 0 150px rgba(255, 215, 0, 0.7),
                0 0 250px rgba(255, 255, 255, 0.2);
            position: relative;
            animation: wheelGlow 5s ease-in-out infinite alternate;
            transform-style: preserve-3d;
        }
        
        @keyframes wheelGlow {
            0% { 
                box-shadow: 
                    0 0 80px rgba(255, 215, 0, 0.9),
                    inset 0 0 50px rgba(0, 0, 0, 0.3),
                    0 0 150px rgba(255, 215, 0, 0.7);
                transform: rotateX(0deg) scale(1);
            }
            100% { 
                box-shadow: 
                    0 0 120px rgba(255, 215, 0, 1),
                    inset 0 0 50px rgba(0, 0, 0, 0.3),
                    0 0 200px rgba(255, 215, 0, 0.9);
                transform: rotateX(3deg) scale(1.02);
            }
        }
        
        /* 转盘内圈装饰 */
        .super-wheel::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 25px;
            right: 25px;
            bottom: 25px;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.7);
            z-index: 1;
            box-shadow: 
                inset 0 0 40px rgba(255, 255, 255, 0.4),
                0 0 30px rgba(255, 255, 255, 0.6);
            animation: innerRing 4s ease-in-out infinite alternate;
        }

        @keyframes innerRing {
            0% { 
                border-color: rgba(255, 255, 255, 0.7);
                box-shadow: inset 0 0 40px rgba(255, 255, 255, 0.4);
            }
            100% { 
                border-color: rgba(255, 255, 255, 1);
                box-shadow: inset 0 0 60px rgba(255, 255, 255, 0.6);
            }
        }
        
        /* 专业转盘区域 */
        .super-wheel-section {
            position: absolute;
            z-index: 10;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .super-emoji {
            font-size: 32px;
            margin-bottom: 4px;
            display: block;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .probability-display {
            font-size: 10px;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .super-reward-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 11px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 12px;
            margin-top: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        /* 超级MAO Logo设计 */
        .super-mao-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #ff6b9d);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 900;
            color: white;
            text-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.8),
                0 0 25px rgba(102, 126, 234, 1),
                0 0 35px rgba(255, 107, 157, 0.8);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.4),
                0 0 50px rgba(102, 126, 234, 0.8);
            border: 5px solid rgba(255, 255, 255, 0.8);
            z-index: 20;
            animation: logoFloat 8s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 0 25px rgba(102, 126, 234, 1);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05) rotate(5deg);
                text-shadow: 0 6px 12px rgba(0, 0, 0, 0.8), 0 0 35px rgba(255, 107, 157, 1);
            }
        }
        
        /* 超级指针设计 */
        .super-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 60px solid #FFD700;
            z-index: 30;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            animation: pointerGlow 3s ease-in-out infinite alternate;
        }
        
        .super-pointer::before {
            content: '';
            position: absolute;
            top: -58px;
            left: -20px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 1),
                inset 0 2px 4px rgba(255, 255, 255, 0.7);
        }
        
        @keyframes pointerGlow {
            0% { 
                filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8)) drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            }
            100% { 
                filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8)) drop-shadow(0 0 30px rgba(255, 215, 0, 1));
            }
        }
        
        /* 超级游戏按钮 */
        .super-spin-btn {
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, #FFD700, #FFA500, #FF8C00);
            border: 6px solid white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.6),
                inset 0 4px 8px rgba(255, 255, 255, 0.6),
                0 0 40px rgba(255, 215, 0, 0.8);
            animation: spinBtnGlow 2s ease-in-out infinite alternate;
        }
        
        .super-spin-btn:hover {
            transform: scale(1.1);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.8),
                inset 0 4px 8px rgba(255, 255, 255, 0.6),
                0 0 60px rgba(255, 215, 0, 1);
        }
        
        @keyframes spinBtnGlow {
            0% { 
                box-shadow: 
                    0 15px 30px rgba(0, 0, 0, 0.6),
                    inset 0 4px 8px rgba(255, 255, 255, 0.6),
                    0 0 40px rgba(255, 215, 0, 0.8);
            }
            100% { 
                box-shadow: 
                    0 15px 30px rgba(0, 0, 0, 0.6),
                    inset 0 4px 8px rgba(255, 255, 255, 0.6),
                    0 0 60px rgba(255, 215, 0, 1);
            }
        }
        
        /* 钱包连接优化界面 */
        .wallet-connect-container {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.2), 
                rgba(118, 75, 162, 0.2),
                rgba(240, 147, 251, 0.2)
            );
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .wallet-status-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .wallet-status-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* 授权状态指示器 */
        .approval-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: all 0.3s ease;
        }
        
        .approval-indicator.approved {
            background: #10B981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        }
        
        .approval-indicator.not-approved {
            background: #EF4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
            animation: pulse 2s infinite;
        }
        
        /* 代币按钮优化 */
        .token-select-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .token-select-btn.selected {
            background: linear-gradient(135deg, #10B981, #059669);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }
        
        .token-select-btn.unselected {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        
        /* 授权按钮动画 */
        .approve-btn {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .approve-btn:hover {
            background: linear-gradient(135deg, #FBBF24, #F59E0B);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }
        
        .approve-btn.approved {
            background: linear-gradient(135deg, #10B981, #059669);
            cursor: default;
        }
        
        /* 连接进度条 */
        .connection-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .connection-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    
    <!-- 页面容器 -->
    <div class="container mx-auto px-4 py-2 max-w-md">
        
        <!-- 标题 -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-white mb-2">
                🎰 MAO转盘游戏
            </h1>
            <p class="text-blue-200 text-sm">
                AlveyChain 区块链游戏 v4.1.0 营销钱包版
            </p>
            <div class="text-xs text-green-400 mt-1">
                ✨ 分离授权 · 专业转盘 · 优化体验
            </div>
        </div>

        <!-- 连接进度指示器 -->
        <div id="connectionProgress" class="hidden mb-4">
            <div class="wallet-connect-container rounded-xl p-4">
                <div class="text-center">
                    <div class="text-white font-semibold mb-2" id="progressText">正在连接钱包...</div>
                    <div class="connection-progress">
                        <div class="connection-progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-blue-200 text-sm mt-2" id="progressSubtext">请稍候...</div>
                </div>
            </div>
        </div>

        <!-- 钱包连接界面 -->
        <div id="walletConnect" class="space-y-4">
            <div class="wallet-connect-container rounded-xl p-6">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-3">🔗</div>
                    <h2 class="text-xl font-bold text-white mb-2">连接Web3钱包</h2>
                    <p class="text-blue-200 text-sm mb-4">
                        请使用支持AlveyChain的钱包连接
                    </p>
                </div>
                
                <!-- 推荐钱包 -->
                <div class="mb-4">
                    <h3 class="text-white font-semibold mb-3 text-sm">📱 推荐钱包</h3>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="wallet-status-card rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🔵</div>
                            <div class="text-white font-semibold">TP钱包</div>
                            <div class="text-blue-200">推荐使用</div>
                        </div>
                        <div class="wallet-status-card rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🛡️</div>
                            <div class="text-white font-semibold">Trust Wallet</div>
                            <div class="text-blue-200">币安官方</div>
                        </div>
                        <div class="wallet-status-card rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">🦊</div>
                            <div class="text-white font-semibold">MetaMask</div>
                            <div class="text-blue-200">桌面浏览器</div>
                        </div>
                        <div class="wallet-status-card rounded-lg p-3 text-center">
                            <div class="text-lg mb-1">📱</div>
                            <div class="text-white font-semibold">其他钱包</div>
                            <div class="text-blue-200">兼容Web3</div>
                        </div>
                    </div>
                </div>
                
                <!-- 连接按钮 -->
                <button 
                    id="connectBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                    🔗 连接钱包开始游戏
                </button>
            </div>
            
            <!-- 奖励预览 -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">💰 专业奖励系统</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">🎁</div>
                        <div class="text-yellow-400 font-bold">小奖 22%</div>
                        <div class="text-white text-xs">105 MAO</div>
                        <div class="text-green-400 text-xs">有盈利！</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">🏆</div>
                        <div class="text-yellow-400 font-bold">中奖 12%</div>
                        <div class="text-white text-xs">150 MAO</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">💎</div>
                        <div class="text-yellow-400 font-bold">大奖 6%</div>
                        <div class="text-white text-xs">250 MAO</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">💰</div>
                        <div class="text-yellow-400 font-bold">终极大奖</div>
                        <div class="text-white text-xs">700 MAO</div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <p class="text-xs text-green-300">
                        🎉 42%超高中奖率 · 小奖有盈利 · 即时到账！
                    </p>
                </div>
            </div>

            <!-- 游戏说明 -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">📖 游戏说明</h3>
                <ul class="text-blue-200 text-sm space-y-2">
                    <li>• 每次游戏消耗 100 MAO 或 1,000 PI</li>
                    <li>• 真实合约奖励系统，42%中奖率</li>
                    <li>• 小奖有盈利感，最高奖励7倍（700 MAO / 7K PI）</li>
                    <li>• 基于AlveyChain智能合约，公平透明</li>
                    <li>• 支持TP钱包、Trust Wallet等主流钱包</li>
                    <li>• 奖励自动转账，即时到账</li>
                </ul>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div id="gameInterface" class="space-y-4" style="display: none;">
            
            <!-- 钱包状态卡片 -->
            <div class="wallet-connect-container rounded-xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-blue-200 text-xs">钱包地址</p>
                        <p class="text-white text-sm font-mono" id="userAddress">未连接</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-200 text-xs">网络状态</p>
                        <p class="text-green-400 font-bold text-sm">✅ AlveyChain</p>
                    </div>
                </div>
                
                <!-- 余额刷新按钮 -->
                <button 
                    id="refreshBalanceBtn"
                    class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200 transform hover:scale-105"
                    onclick="refreshBalanceManually()"
                >
                    🔄 刷新余额和授权状态
                </button>
            </div>

            <!-- 代币选择和授权 -->
            <div class="wallet-connect-container rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">💰 代币选择与授权</h3>
                
                <!-- MAO代币卡片 -->
                <div class="mb-4">
                    <div class="wallet-status-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="maoBtn" 
                                    class="token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 selected"
                                    data-token="MAO"
                                >
                                    MAO
                                </button>
                                <div>
                                    <div class="text-white font-semibold">MAO Token</div>
                                    <div class="text-blue-200 text-sm">100 MAO/次</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold" id="maoBalance">余额: 0</div>
                                <div class="flex items-center justify-end mt-1">
                                    <span class="approval-indicator not-approved" id="maoApprovalIndicator"></span>
                                    <span class="text-xs text-blue-200" id="maoApprovalStatus">需要授权</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MAO授权按钮 -->
                        <button 
                            id="maoApproveBtn"
                            class="w-full approve-btn text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105"
                        >
                            🔓 授权 MAO 代币
                        </button>
                    </div>
                </div>
                
                <!-- PI代币卡片 -->
                <div class="mb-4">
                    <div class="wallet-status-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                <button 
                                    id="piBtn" 
                                    class="token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 unselected"
                                    data-token="PI"
                                >
                                    PI
                                </button>
                                <div>
                                    <div class="text-white font-semibold">PI Token</div>
                                    <div class="text-blue-200 text-sm">1,000 PI/次</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold" id="piBalance">余额: 0</div>
                                <div class="flex items-center justify-end mt-1">
                                    <span class="approval-indicator not-approved" id="piApprovalIndicator"></span>
                                    <span class="text-xs text-blue-200" id="piApprovalStatus">需要授权</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PI授权按钮 -->
                        <button 
                            id="piApproveBtn"
                            class="w-full approve-btn text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105"
                        >
                            🔓 授权 PI 代币
                        </button>
                    </div>
                </div>
            </div>

            <!-- 专业转盘游戏 -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-white font-bold text-center mb-4 text-lg">🎰 专业幸运转盘</h3>
                
                <!-- 专业转盘设计 -->
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div 
                            id="wheel"
                            class="w-80 h-80 rounded-full super-wheel wheel-animation shadow-2xl relative overflow-hidden"
                        >
                            <!-- 转盘奖项区域 - 专业版 -->
                            <!-- 区域1: 谢谢惠顾 (0-210.24度, 58%) -->
                            <div class="super-wheel-section" style="top: 20px; left: 50%; transform: translateX(-50%);">
                                <div class="super-emoji">😊</div>
                                <div class="text-xs font-bold mb-1">谢谢惠顾</div>
                                <div class="probability-display">58%</div>
                                <div class="super-reward-badge">0</div>
                            </div>
                            
                            <!-- 区域2: 小奖 (210.24-289.44度, 22%) -->
                            <div class="super-wheel-section" style="top: 30px; right: 30px;">
                                <div class="super-emoji">🎁</div>
                                <div class="text-xs font-bold mb-1">小奖</div>
                                <div class="probability-display">22%</div>
                                <div class="super-reward-badge" id="reward1">105</div>
                            </div>
                            
                            <!-- 区域3: 中奖 (289.44-332.64度, 12%) -->
                            <div class="super-wheel-section" style="top: 60%; right: 15px;">
                                <div class="super-emoji">🏆</div>
                                <div class="text-xs font-bold mb-1">中奖</div>
                                <div class="probability-display">12%</div>
                                <div class="super-reward-badge" id="reward2">150</div>
                            </div>
                            
                            <!-- 区域4: 大奖 (332.64-354.24度, 6%) -->
                            <div class="super-wheel-section" style="bottom: 30px; left: 50%; transform: translateX(-50%);">
                                <div class="super-emoji">💎</div>
                                <div class="text-xs font-bold mb-1">大奖</div>
                                <div class="probability-display">6%</div>
                                <div class="super-reward-badge" id="reward3">250</div>
                            </div>
                            
                            <!-- 区域5: 超级大奖 (354.24-359.64度, 1.5%) -->
                            <div class="super-wheel-section" style="bottom: 30px; left: 30px;">
                                <div class="super-emoji">🌟</div>
                                <div class="text-xs font-bold mb-1">超级</div>
                                <div class="probability-display">1.5%</div>
                                <div class="super-reward-badge" id="reward4">400</div>
                            </div>
                            
                            <!-- 区域6: 终极大奖 (359.64-360度, 0.5%) -->
                            <div class="super-wheel-section" style="top: 30px; left: 30px;">
                                <div class="super-emoji">💰</div>
                                <div class="text-xs font-bold mb-1">终极</div>
                                <div class="probability-display">0.5%</div>
                                <div class="super-reward-badge" id="reward5">700</div>
                            </div>
                            
                            <!-- 专业MAO Logo -->
                            <div class="super-mao-logo">
                                MAO
                            </div>
                        </div>
                        
                        <!-- 专业指针 -->
                        <div class="super-pointer"></div>
                        
                        <!-- 专业游戏控制按钮 -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 translate-y-20 z-30">
                            <button
                                id="spinBtn"
                                class="super-spin-btn font-bold text-lg transition-all duration-300 transform hover:scale-110 text-white"
                            >
                                <div class="relative z-10">
                                    <div class="text-3xl mb-1">🎲</div>
                                    <div class="text-sm font-bold">开始游戏</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 游戏状态 -->
                <div class="glass-effect rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <p class="text-blue-200 text-sm mb-2">
                            本轮投注: <span class="text-yellow-400 font-bold text-lg" id="betAmount">100 MAO</span>
                        </p>
                        <div id="gameStatus" class="text-white text-sm">
                            准备就绪，选择代币并授权后即可开始游戏！
                        </div>
                    </div>
                </div>

                <!-- 游戏历史 -->
                <div class="glass-effect rounded-lg p-3">
                    <h4 class="text-white font-semibold mb-2 text-sm">🎯 最近游戏记录</h4>
                    <div id="gameHistory" class="space-y-1 max-h-32 overflow-y-auto">
                        <div class="text-blue-200 text-xs text-center py-4">暂无游戏记录</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本部分 -->
    <script>
        // 配置常量
        const ALVEY_NETWORK = {
            chainId: '0xED5', // 3797
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: ['https://elves-core1.alvey.io'],
            blockExplorerUrls: ['https://alveyscan.com'],
        };

        const CONTRACTS = {
            WHEEL_GAME: '0xB677DBcA76061E6301272c83179c8243A4eeB6A5',
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };

        // 全局变量
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let contracts = {};
        let selectedToken = 'MAO';
        let balances = { MAO: '0', PI: '0' };
        let approvalStatus = { MAO: false, PI: false };
        let isSpinning = false;
        let isContinuousMode = false; // 新增：连续游戏模式

        // DOM元素
        const connectBtn = document.getElementById('connectBtn');
        const walletConnect = document.getElementById('walletConnect');
        const gameInterface = document.getElementById('gameInterface');
        const connectionProgress = document.getElementById('connectionProgress');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const progressSubtext = document.getElementById('progressSubtext');
        const userAddress = document.getElementById('userAddress');
        const maoBtn = document.getElementById('maoBtn');
        const piBtn = document.getElementById('piBtn');
        const maoApproveBtn = document.getElementById('maoApproveBtn');
        const piApproveBtn = document.getElementById('piApproveBtn');
        const spinBtn = document.getElementById('spinBtn');
        const maoBalance = document.getElementById('maoBalance');
        const piBalance = document.getElementById('piBalance');
        const betAmount = document.getElementById('betAmount');
        const gameStatus = document.getElementById('gameStatus');
        const wheel = document.getElementById('wheel');

        // 智能合约ABI（简化版）
        const WHEEL_GAME_ABI = [
            "function playGame(address token) external",
            "function getGameResult(uint256 gameId) external view returns (uint8, uint256)",
            "function gameCounter() external view returns (uint256)",
            "function rewardAmounts(uint8 level) external view returns (uint256)",
            "event GamePlayed(address indexed player, address indexed token, uint8 result, uint256 rewardAmount, uint256 gameId)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // 连接进度显示
        function showConnectionProgress() {
            connectionProgress.classList.remove('hidden');
            updateProgress('开始连接...', 0);
        }

        function hideConnectionProgress() {
            connectionProgress.classList.add('hidden');
        }

        function updateProgress(text, percentage, subtext = '') {
            progressText.textContent = text;
            progressBar.style.width = percentage + '%';
            if (subtext) {
                progressSubtext.textContent = subtext;
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                showConnectionProgress();
                updateProgress('检查Web3环境...', 10);

                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js库未加载');
                }

                if (!window.ethereum) {
                    hideConnectionProgress();
                    alert('请使用支持Web3的钱包浏览器！\n推荐使用：TP钱包、Trust Wallet、MetaMask等');
                    return;
                }

                updateProgress('检查网络配置...', 30);

                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== ALVEY_NETWORK.chainId) {
                    updateProgress('切换到AlveyChain网络...', 50);
                    await switchToAlveyNetwork();
                }

                updateProgress('请求账户授权...', 70);

                // 请求账户
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts',
                });

                if (accounts.length === 0) {
                    throw new Error('未获得账户授权');
                }

                updateProgress('初始化区块链连接...', 90);

                // 初始化提供者
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = accounts[0];

                // 初始化合约
                await initializeContracts();

                updateProgress('加载用户数据...', 95);

                // 加载数据
                await Promise.all([
                    loadBalances(),
                    checkAllApprovals()
                ]);

                updateProgress('连接完成！', 100);

                // 更新UI
                updateUI();

                setTimeout(() => {
                    hideConnectionProgress();
                }, 500);

            } catch (error) {
                console.error('连接钱包错误:', error);
                hideConnectionProgress();
                alert('连接钱包失败: ' + error.message);
            }
        }

        // 切换网络
        async function switchToAlveyNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ALVEY_NETWORK.chainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [ALVEY_NETWORK],
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // 初始化合约
        async function initializeContracts() {
            contracts = {
                wheelGame: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, signer),
                maoToken: new ethers.Contract(CONTRACTS.MAO_TOKEN, TOKEN_ABI, signer),
                piToken: new ethers.Contract(CONTRACTS.PI_TOKEN, TOKEN_ABI, signer)
            };
        }

        // 加载余额
        async function loadBalances() {
            try {
                const [maoBalance, piBalance] = await Promise.all([
                    contracts.maoToken.balanceOf(currentAccount),
                    contracts.piToken.balanceOf(currentAccount)
                ]);

                // MAO是9位小数，PI是9位小数
                balances.MAO = ethers.utils.formatUnits(maoBalance, 9);
                balances.PI = ethers.utils.formatUnits(piBalance, 9);

                updateBalanceDisplay();
            } catch (error) {
                console.error('加载余额错误:', error);
            }
        }

        // 检查所有授权
        async function checkAllApprovals() {
            try {
                const [maoAllowance, piAllowance] = await Promise.all([
                    contracts.maoToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME),
                    contracts.piToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME)
                ]);

                // 检查是否有足够的授权（需要的是18位小数格式）
                const maoRequired = ethers.utils.parseUnits('100', 18);
                const piRequired = ethers.utils.parseUnits('1000', 18);

                approvalStatus.MAO = maoAllowance.gte(maoRequired);
                approvalStatus.PI = piAllowance.gte(piRequired);

                updateApprovalDisplay();
            } catch (error) {
                console.error('检查授权错误:', error);
            }
        }

        // 授权特定代币
        async function approveToken(tokenType) {
            try {
                const btn = tokenType === 'MAO' ? maoApproveBtn : piApproveBtn;
                const contract = tokenType === 'MAO' ? contracts.maoToken : contracts.piToken;

                btn.textContent = `授权${tokenType}中...`;
                btn.disabled = true;

                const tx = await contract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                await tx.wait();

                approvalStatus[tokenType] = true;
                updateApprovalDisplay();

                alert(`${tokenType}代币授权成功！`);
            } catch (error) {
                console.error(`授权${tokenType}错误:`, error);
                alert(`授权${tokenType}失败: ` + error.message);
            } finally {
                updateApprovalButtons();
            }
        }

        // 选择代币
        function selectToken(token) {
            if (isContinuousMode) {
                alert('请先停止连续游戏模式再切换代币！');
                return;
            }
            
            selectedToken = token;
            
            // 更新按钮样式
            maoBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 ' + 
                (token === 'MAO' ? 'selected' : 'unselected');
            piBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 ' + 
                (token === 'PI' ? 'selected' : 'unselected');
            
            // 更新投注金额显示 - 保持正确的PI投注金额
            betAmount.textContent = token === 'MAO' ? '100 MAO' : '10,000 PI';
            
            // 更新转盘奖励显示
            updateWheelRewards();
            
            // 更新余额显示
            updateCurrentBalance();
                    
            // 重新检查授权状态 - 分离检查MAO和PI
            if (currentAccount) {
                checkSeparateApproval(token);
            }
        }

        // 分离的授权检查函数
        async function checkSeparateApproval(tokenType) {
            try {
                if (!contracts.maoToken || !contracts.piToken) return;
                
                let tokenContract, requiredAmount;
                
                if (tokenType === 'MAO') {
                    tokenContract = contracts.maoToken;
                    // 合约期望18位小数，但代币实际是9位小数，授权需要18位
                    requiredAmount = ethers.utils.parseUnits('100', 18);
                } else {
                    tokenContract = contracts.piToken;
                    // PI授权修复：使用正确的18位小数格式
                    requiredAmount = ethers.utils.parseUnits('10000', 18);
                }
                
                const allowance = await tokenContract.allowance(currentAccount, CONTRACTS.WHEEL_GAME);
                const isApproved = allowance.gte(requiredAmount);
                
                // 更新特定代币的授权状态
                if (tokenType === 'MAO') {
                    maoApprovalStatus = isApproved;
                } else {
                    piApprovalStatus = isApproved;
                }
                
                updateSeparateApprovalButtons();
                
            } catch (error) {
                console.error(`检查${tokenType}授权错误:`, error);
            }
        }

        // 分离的授权函数
        async function approveSeparateToken(tokenType) {
            try {
                let approveBtn = tokenType === 'MAO' ? maoApproveBtn : piApproveBtn;
                let tokenContract = tokenType === 'MAO' ? contracts.maoToken : contracts.piToken;
                
                approveBtn.textContent = `授权${tokenType}中...`;
                approveBtn.disabled = true;

                const tx = await tokenContract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                await tx.wait();

                // 更新授权状态
                if (tokenType === 'MAO') {
                    maoApprovalStatus = true;
                } else {
                    piApprovalStatus = true;
                }
                
                updateSeparateApprovalButtons();
                alert(`${tokenType}代币授权成功！现在可以进行${tokenType}游戏了。`);
                
            } catch (error) {
                console.error(`授权${tokenType}错误:`, error);
                alert(`授权${tokenType}失败: ` + error.message);
                
                let approveBtn = tokenType === 'MAO' ? maoApproveBtn : piApproveBtn;
                approveBtn.textContent = `🔓 授权 ${tokenType} 代币`;
                approveBtn.disabled = false;
            }
        }

        // 更新分离的授权按钮状态
        function updateSeparateApprovalButtons() {
            // MAO授权按钮状态
            if (maoApproveBtn) {
                if (maoApprovalStatus) {
                    maoApproveBtn.style.display = 'none';
                } else {
                    maoApproveBtn.style.display = 'block';
                    maoApproveBtn.textContent = '🔓 授权 MAO 代币';
                    maoApproveBtn.disabled = false;
                }
            }
            
            // PI授权按钮状态
            if (piApproveBtn) {
                if (piApprovalStatus) {
                    piApproveBtn.style.display = 'none';
                } else {
                    piApproveBtn.style.display = 'block';
                    piApproveBtn.textContent = '🔓 授权 PI 代币';
                    piApproveBtn.disabled = false;
                }
            }
            
            // 更新游戏按钮状态
            updateGameButtonStatus();
        }

        // 更新游戏按钮状态
        function updateGameButtonStatus() {
            const canPlay = (selectedToken === 'MAO' && maoApprovalStatus) || 
                           (selectedToken === 'PI' && piApprovalStatus);
                           
            if (spinBtn) { // 确保spinBtn存在
                if (canPlay) {
                    spinBtn.disabled = false;
                    spinBtn.innerHTML = '<div class="text-2xl">🎲</div><div class="text-[10px]">开始游戏</div>';
                } else {
                    spinBtn.disabled = true;
                    spinBtn.innerHTML = '<div class="text-2xl">🔒</div><div class="text-[10px]">需要授权</div>';
                }
            }
        }

        // 修复的检查授权函数
        async function checkApproval() {
            try {
                // 分别检查MAO和PI的授权状态
                await Promise.all([
                    checkSeparateApproval('MAO'),
                    checkSeparateApproval('PI')
                ]);
                
            } catch (error) {
                console.error('检查授权错误:', error);
            }
        }

        // 优化的授权代币函数 - 改为分离授权
        async function approveTokens() {
            // 这个函数现在改为检查当前选择的代币进行授权
            await approveSeparateToken(selectedToken);
        }

        // 添加全局变量用于分离的授权状态
        let maoApprovalStatus = false;
        let piApprovalStatus = false;
        let maoApproveBtn, piApproveBtn;

        // 在页面加载时初始化分离的授权按钮（如果存在）
        window.addEventListener('DOMContentLoaded', function() {
            maoApproveBtn = document.getElementById('maoApproveBtn');
            piApproveBtn = document.getElementById('piApproveBtn');
            
            // 添加分离的授权按钮事件监听（如果按钮存在）
            if (maoApproveBtn) {
                maoApproveBtn.addEventListener('click', () => approveSeparateToken('MAO'));
            }
            if (piApproveBtn) {
                piApproveBtn.addEventListener('click', () => approveSeparateToken('PI'));
            }
        });

        // 开始游戏
        async function startGame() {
            if (isSpinning) return;
            
            try {
                // 检查授权
                if (!approvalStatus[selectedToken]) {
                    alert(`请先授权${selectedToken}代币！`);
                    return;
                }

                // 检查余额
                const balance = parseFloat(balances[selectedToken]);
                const required = selectedToken === 'MAO' ? 100 : 1000;
                
                if (balance < required) {
                    alert(`${selectedToken}余额不足！需要${required}个${selectedToken}`);
                    return;
                }

                isSpinning = true;
                updateGameStatus('游戏中...');
                
                // 开始转盘动画
                startWheelAnimation();
                
                // 调用智能合约
                const tokenContract = selectedToken === 'MAO' ? CONTRACTS.MAO_TOKEN : CONTRACTS.PI_TOKEN;
                const tx = await contracts.wheelGame.playGame(tokenContract);
                
                updateGameStatus('交易确认中...');
                const receipt = await tx.wait();
                
                // 解析游戏结果
                const gameResult = await parseGameResult(receipt);
                
                // 显示结果
                await showGameResult(gameResult);
                
                // 刷新数据
                await Promise.all([
                    loadBalances(),
                    checkAllApprovals()
                ]);
                
            } catch (error) {
                console.error('游戏错误:', error);
                alert('游戏失败: ' + error.message);
            } finally {
                isSpinning = false;
                updateGameStatus('准备就绪');
                stopWheelAnimation();
            }
        }

        // 转盘动画
        function startWheelAnimation() {
            const randomRotation = 1800 + Math.random() * 1800; // 5-10圈
            wheel.style.transform = `rotate(${randomRotation}deg)`;
            spinBtn.disabled = true;
            spinBtn.innerHTML = '<div class="text-2xl">⏳</div><div class="text-[10px]">游戏中</div>';
        }

        function stopWheelAnimation() {
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<div class="text-2xl">🎲</div><div class="text-[10px]">开始游戏</div>';
        }

        // 解析游戏结果
        async function parseGameResult(receipt) {
            // 从交易回执中解析GamePlayed事件
            const iface = new ethers.utils.Interface(WHEEL_GAME_ABI);
            
            for (let log of receipt.logs) {
                try {
                    const parsed = iface.parseLog(log);
                    if (parsed.name === 'GamePlayed') {
                        return {
                            result: parsed.args.result,
                            rewardAmount: parsed.args.rewardAmount,
                            gameId: parsed.args.gameId
                        };
                    }
                } catch (e) {
                    // 忽略解析错误
                }
            }
            
            throw new Error('无法解析游戏结果');
        }

        // 显示游戏结果
        async function showGameResult(result) {
            const rewards = [
                { name: '谢谢惠顾', emoji: '😊', multiplier: 0 },
                { name: '小奖', emoji: '🎁', multiplier: 1.05 },
                { name: '中奖', emoji: '🏆', multiplier: 1.5 },
                { name: '大奖', emoji: '💎', multiplier: 2.5 },
                { name: '超级大奖', emoji: '🌟', multiplier: 4 },
                { name: '终极大奖', emoji: '💰', multiplier: 7 }
            ];
            
            const rewardInfo = rewards[result.result];
            const rewardAmount = ethers.utils.formatUnits(result.rewardAmount, 9);
            
            let message = `${rewardInfo.emoji} ${rewardInfo.name}！\n`;
            
            if (result.result > 0) {
                message += `恭喜获得 ${rewardAmount} ${selectedToken}！`;
                // 庆祝动画
                createCelebrationEffect();
            } else {
                message += '再接再厉！';
            }
            
            alert(message);
            
            // 更新游戏历史
            addToGameHistory(rewardInfo, rewardAmount);
        }

        // 庆祝效果
        function createCelebrationEffect() {
            // 简单的庆祝效果
            document.body.style.background = 'linear-gradient(45deg, #FFD700, #FFA500, #FFD700)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
        }

        // 更新UI函数
        function updateUI() {
            walletConnect.style.display = 'none';
            gameInterface.style.display = 'block';
            userAddress.textContent = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
        }

        function updateBalanceDisplay() {
            maoBalance.textContent = `余额: ${parseFloat(balances.MAO).toFixed(2)}`;
            piBalance.textContent = `余额: ${parseFloat(balances.PI).toFixed(2)}`;
        }

        function updateApprovalDisplay() {
            // MAO授权状态
            const maoIndicator = document.getElementById('maoApprovalIndicator');
            const maoStatus = document.getElementById('maoApprovalStatus');
            
            if (approvalStatus.MAO) {
                maoIndicator.className = 'approval-indicator approved';
                maoStatus.textContent = '已授权';
            } else {
                maoIndicator.className = 'approval-indicator not-approved';
                maoStatus.textContent = '需要授权';
            }
            
            // PI授权状态
            const piIndicator = document.getElementById('piApprovalIndicator');
            const piStatus = document.getElementById('piApprovalStatus');
            
            if (approvalStatus.PI) {
                piIndicator.className = 'approval-indicator approved';
                piStatus.textContent = '已授权';
            } else {
                piIndicator.className = 'approval-indicator not-approved';
                piStatus.textContent = '需要授权';
            }
            
            updateApprovalButtons();
        }

        function updateApprovalButtons() {
            // MAO授权按钮
            if (approvalStatus.MAO) {
                maoApproveBtn.textContent = '✅ MAO已授权';
                maoApproveBtn.className = 'w-full approve-btn approved text-white font-bold py-3 px-4 rounded-lg';
                maoApproveBtn.disabled = true;
            } else {
                maoApproveBtn.textContent = '🔓 授权 MAO 代币';
                maoApproveBtn.className = 'w-full approve-btn text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105';
                maoApproveBtn.disabled = false;
            }
            
            // PI授权按钮
            if (approvalStatus.PI) {
                piApproveBtn.textContent = '✅ PI已授权';
                piApproveBtn.className = 'w-full approve-btn approved text-white font-bold py-3 px-4 rounded-lg';
                piApproveBtn.disabled = true;
            } else {
                piApproveBtn.textContent = '🔓 授权 PI 代币';
                piApproveBtn.className = 'w-full approve-btn text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105';
                piApproveBtn.disabled = false;
            }
        }

        function updateTokenSelection() {
            // 更新按钮样式
            if (selectedToken === 'MAO') {
                maoBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 selected';
                piBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 unselected';
            } else {
                maoBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 unselected';
                piBtn.className = 'token-select-btn py-3 px-4 rounded-lg font-semibold text-lg mr-3 selected';
            }
            
            updateRewardDisplay();
        }

        function updateBetAmount() {
            betAmount.textContent = selectedToken === 'MAO' ? '100 MAO' : '10,000 PI';
        }

        function updateRewardDisplay() {
            // 更新转盘上的奖励显示
            const multipliers = selectedToken === 'MAO' ? 
                [0, 105, 150, 250, 400, 700] : 
                [0, 1050, 1500, 2500, 4000, 7000];
            
            for (let i = 1; i <= 5; i++) {
                const element = document.getElementById(`reward${i}`);
                if (element) {
                    element.textContent = multipliers[i];
                }
            }
        }

        function updateGameStatus(status) {
            gameStatus.textContent = status;
        }

        function addToGameHistory(rewardInfo, amount) {
            const historyContainer = document.getElementById('gameHistory');
            const entry = document.createElement('div');
            entry.className = 'text-xs text-blue-200 py-1 border-b border-white/10';
            entry.innerHTML = `
                <span class="text-yellow-400">${new Date().toLocaleTimeString()}</span>
                <span class="mx-2">${rewardInfo.emoji}</span>
                <span>${rewardInfo.name}</span>
                ${amount > 0 ? `<span class="text-green-400 ml-2">+${amount} ${selectedToken}</span>` : ''}
            `;
            
            historyContainer.insertBefore(entry, historyContainer.firstChild);
            
            // 保持最多10条记录
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // 手动刷新功能
        async function refreshBalanceManually() {
            const btn = document.getElementById('refreshBalanceBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '🔄 刷新中...';
                btn.disabled = true;
                
                await Promise.all([
                    loadBalances(),
                    checkAllApprovals()
                ]);
                
                btn.textContent = '✅ 刷新完成';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('刷新错误:', error);
                btn.textContent = '❌ 刷新失败';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // 事件监听
        connectBtn.addEventListener('click', connectWallet);
        maoApproveBtn.addEventListener('click', () => approveToken('MAO'));
        piApproveBtn.addEventListener('click', () => approveToken('PI'));
        maoBtn.addEventListener('click', () => selectToken('MAO'));
        piBtn.addEventListener('click', () => selectToken('PI'));
        spinBtn.addEventListener('click', startGame);

        // 自动连接已连接的钱包
        window.addEventListener('load', async () => {
            console.log('🚀 页面加载完成，检查钱包连接');
            
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('🚀 检测到已连接账户，自动连接中...');
                        setTimeout(connectWallet, 1000);
                    }
                } catch (error) {
                    console.log('自动连接检查失败:', error);
                }
            }
        });

        // 监听账户和网络变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else if (accounts[0] !== currentAccount) {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                if (chainId !== ALVEY_NETWORK.chainId) {
                    location.reload();
                }
            });
        }

        // 初始化
        updateTokenSelection();
        updateBetAmount();
    </script>
</body>
</html> 