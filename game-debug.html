<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ MAOè½¬ç›˜æ¸¸æˆ - è°ƒè¯•ç‰ˆ</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            border: 1px solid #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .status {
            background: #003300;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .error {
            background: #330000;
            color: #ff6666;
        }
        .success {
            background: #003300;
            color: #66ff66;
        }
        .warning {
            background: #332200;
            color: #ffff66;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #666;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover {
            background: #555;
        }
        button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .balance {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #666;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ MAOè½¬ç›˜æ¸¸æˆè°ƒè¯•æ§åˆ¶å°</h1>
    
    <div class="section">
        <h3>ğŸ“Š ç½‘ç»œå’Œåˆçº¦çŠ¶æ€</h3>
        <div id="networkStatus" class="status">æ£€æŸ¥ä¸­...</div>
        <div id="contractStatus" class="status">ç­‰å¾…ç½‘ç»œè¿æ¥...</div>
        <button onclick="checkNetworkAndContracts()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="section">
        <h3>ğŸ’³ é’±åŒ…è¿æ¥</h3>
        <div id="walletStatus" class="status">æœªè¿æ¥</div>
        <button id="connectBtn" onclick="connectWallet()">ğŸ”— è¿æ¥é’±åŒ…</button>
        <button onclick="disconnectWallet()">âŒ æ–­å¼€è¿æ¥</button>
    </div>

    <div class="section">
        <h3>ğŸ’° ä½™é¢ä¿¡æ¯</h3>
        <div class="balance">
            <strong>MAO:</strong> <span id="maoBalance">-</span><br>
            <strong>æˆæƒç»™æ¸¸æˆ:</strong> <span id="maoAllowance">-</span>
        </div>
        <div class="balance">
            <strong>PI:</strong> <span id="piBalance">-</span><br>
            <strong>æˆæƒç»™æ¸¸æˆ:</strong> <span id="piAllowance">-</span>
        </div>
        <button onclick="updateBalances()">ğŸ”„ åˆ·æ–°ä½™é¢</button>
        <button onclick="approveMAO()">âœ… æˆæƒMAO</button>
        <button onclick="approvePI()">âœ… æˆæƒPI</button>
    </div>

    <div class="section">
        <h3>ğŸ® æ¸¸æˆæµ‹è¯•</h3>
        <div id="gameStatus" class="status">ç­‰å¾…å‡†å¤‡...</div>
        <button id="playMAOBtn" onclick="testPlayMAO()" disabled>ğŸ¯ æµ‹è¯•MAOæ¸¸æˆ</button>
        <button id="playPIBtn" onclick="testPlayPI()" disabled>ğŸ¯ æµ‹è¯•PIæ¸¸æˆ</button>
        <button onclick="checkGameResults()">ğŸ“Š æŸ¥çœ‹æœ€è¿‘æ¸¸æˆç»“æœ</button>
    </div>

    <div class="section">
        <h3>ğŸ¦ è¥é”€é’±åŒ…ç›‘æ§</h3>
        <div id="marketingStatus" class="status">ç›‘æ§ä¸­...</div>
        <button onclick="checkMarketingWallet()">ğŸ’° æ£€æŸ¥è¥é”€é’±åŒ…</button>
        <button onclick="estimateBurnedTokens()">ğŸ”¥ ä¼°ç®—é”€æ¯ä»£å¸</button>
    </div>

    <div class="section">
        <h3>ğŸ“œ æ“ä½œæ—¥å¿—</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        <div id="debugLog" class="log">æ¸¸æˆè°ƒè¯•æ§åˆ¶å°å·²å¯åŠ¨...<br></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // åˆçº¦é…ç½®
        const GAME_CONTRACT_ADDRESS = '0x621DF9e0DE6b4e7EDC5Dc22Cd7c0F883c3F56966';
        const MAO_CONTRACT_ADDRESS = '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022';
        const PI_CONTRACT_ADDRESS = '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444';
        const MARKETING_WALLET = '0x861A48051eFaA1876D4B38904516C9F7bbCca36d';

        // RPCèŠ‚ç‚¹
        const RPC_URLS = [
            'https://elves-core1.alvey.io/',
            'https://elves-core2.alvey.io/',
            'https://elves-core3.alvey.io/'
        ];

        // æ¸¸æˆåˆçº¦ABI
        const GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "function prizePool() external view returns (uint256)",
            "function marketingWallet() external view returns (address)",
            "event GamePlayed(address indexed player, bool useMAO, uint256 amount, uint256 multiplier, uint256 reward)"
        ];

        // ERC20ä»£å¸ABI
        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let gameContract;
        let maoContract;
        let piContract;
        let userAddress;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const colors = {
                'info': '#00ff00',
                'error': '#ff6666',
                'warning': '#ffff66',
                'success': '#66ff66'
            };
            logElement.innerHTML += `<span style="color: ${colors[type] || '#00ff00'}">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = 'æ¸¸æˆè°ƒè¯•æ§åˆ¶å°å·²å¯åŠ¨...<br>';
        }

        // æ£€æŸ¥ç½‘ç»œå’Œåˆçº¦
        async function checkNetworkAndContracts() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥ç½‘ç»œå’Œåˆçº¦çŠ¶æ€...', 'info');
            
            try {
                // æµ‹è¯•RPCè¿æ¥
                for (let i = 0; i < RPC_URLS.length; i++) {
                    try {
                        const testProvider = new ethers.providers.JsonRpcProvider(RPC_URLS[i]);
                        const network = await testProvider.getNetwork();
                        log(`âœ… RPCèŠ‚ç‚¹ ${i + 1} è¿æ¥æˆåŠŸ: ${RPC_URLS[i]}`, 'success');
                        log(`   ç½‘ç»œID: ${network.chainId}, åç§°: ${network.name}`, 'info');
                        
                        // æµ‹è¯•åˆçº¦è¿æ¥
                        const testGameContract = new ethers.Contract(GAME_CONTRACT_ADDRESS, GAME_ABI, testProvider);
                        const marketingWallet = await testGameContract.marketingWallet();
                        log(`âœ… æ¸¸æˆåˆçº¦è¿æ¥æˆåŠŸ`, 'success');
                        log(`   è¥é”€é’±åŒ…: ${marketingWallet}`, 'info');
                        log(`   é…ç½®æ­£ç¡®: ${marketingWallet.toLowerCase() === MARKETING_WALLET.toLowerCase() ? 'æ˜¯' : 'å¦'}`, marketingWallet.toLowerCase() === MARKETING_WALLET.toLowerCase() ? 'success' : 'error');
                        
                        document.getElementById('networkStatus').textContent = `âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ (èŠ‚ç‚¹${i + 1})`;
                        document.getElementById('contractStatus').textContent = `âœ… åˆçº¦é…ç½®æ­£ç¡®`;
                        document.getElementById('networkStatus').className = 'status success';
                        document.getElementById('contractStatus').className = 'status success';
                        break;
                        
                    } catch (error) {
                        log(`âŒ RPCèŠ‚ç‚¹ ${i + 1} è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    }
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('networkStatus').textContent = 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥';
                document.getElementById('networkStatus').className = 'status error';
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                log('ğŸ”Œ å¼€å§‹è¿æ¥é’±åŒ…...', 'info');
                
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAddress = accounts[0];
                log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`, 'success');

                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`ğŸ“¡ å½“å‰ç½‘ç»œID: ${chainId}`, 'info');

                if (chainId !== '0xED5') {
                    log('âš ï¸ ç½‘ç»œä¸æ­£ç¡®ï¼Œå°è¯•åˆ‡æ¢...', 'warning');
                    await switchToAlveyNetwork();
                }

                // åˆå§‹åŒ–providerå’Œåˆçº¦
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                gameContract = new ethers.Contract(GAME_CONTRACT_ADDRESS, GAME_ABI, signer);
                maoContract = new ethers.Contract(MAO_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                piContract = new ethers.Contract(PI_CONTRACT_ADDRESS, TOKEN_ABI, signer);

                document.getElementById('walletStatus').textContent = `âœ… å·²è¿æ¥: ${userAddress.slice(0,8)}...`;
                document.getElementById('walletStatus').className = 'status success';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('playMAOBtn').disabled = false;
                document.getElementById('playPIBtn').disabled = false;

                await updateBalances();

            } catch (error) {
                log(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('walletStatus').textContent = 'âŒ è¿æ¥å¤±è´¥';
                document.getElementById('walletStatus').className = 'status error';
            }
        }

        // åˆ‡æ¢åˆ°Alveyç½‘ç»œ
        async function switchToAlveyNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xED5' }]
                });
                log('âœ… ç½‘ç»œåˆ‡æ¢æˆåŠŸ', 'success');
            } catch (error) {
                if (error.code === 4902) {
                    log('â• æ·»åŠ Alveyç½‘ç»œ...', 'info');
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0xED5',
                            chainName: 'AlveyChain',
                            nativeCurrency: {
                                name: 'ALV',
                                symbol: 'ALV',
                                decimals: 18
                            },
                            rpcUrls: RPC_URLS,
                            blockExplorerUrls: ['https://alveyscan.com/']
                        }]
                    });
                    log('âœ… Alveyç½‘ç»œæ·»åŠ æˆåŠŸ', 'success');
                } else {
                    throw error;
                }
            }
        }

        // æ›´æ–°ä½™é¢
        async function updateBalances() {
            if (!userAddress || !maoContract || !piContract) return;

            try {
                log('ğŸ“Š æ›´æ–°ä½™é¢ä¿¡æ¯...', 'info');

                // MAOä½™é¢å’Œæˆæƒ
                const maoBalance = await maoContract.balanceOf(userAddress);
                const maoAllowance = await maoContract.allowance(userAddress, GAME_CONTRACT_ADDRESS);
                document.getElementById('maoBalance').textContent = ethers.utils.formatEther(maoBalance);
                document.getElementById('maoAllowance').textContent = ethers.utils.formatEther(maoAllowance);

                // PIä½™é¢å’Œæˆæƒ
                const piBalance = await piContract.balanceOf(userAddress);
                const piAllowance = await piContract.allowance(userAddress, GAME_CONTRACT_ADDRESS);
                document.getElementById('piBalance').textContent = ethers.utils.formatEther(piBalance);
                document.getElementById('piAllowance').textContent = ethers.utils.formatEther(piAllowance);

                log(`ğŸ’° ä½™é¢æ›´æ–°å®Œæˆ - MAO: ${ethers.utils.formatEther(maoBalance)}, PI: ${ethers.utils.formatEther(piBalance)}`, 'success');

                // æ£€æŸ¥æ¸¸æˆå‡†å¤‡çŠ¶æ€
                const maoReady = parseFloat(ethers.utils.formatEther(maoBalance)) >= 100 && parseFloat(ethers.utils.formatEther(maoAllowance)) >= 100;
                const piReady = parseFloat(ethers.utils.formatEther(piBalance)) >= 1000 && parseFloat(ethers.utils.formatEther(piAllowance)) >= 1000;

                document.getElementById('gameStatus').textContent = `MAOæ¸¸æˆ: ${maoReady ? 'âœ…' : 'âŒ'} | PIæ¸¸æˆ: ${piReady ? 'âœ…' : 'âŒ'}`;
                document.getElementById('gameStatus').className = `status ${maoReady || piReady ? 'success' : 'warning'}`;

            } catch (error) {
                log(`âŒ ä½™é¢æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æˆæƒä»£å¸
        async function approveMAO() {
            try {
                log('âœ… å¼€å§‹æˆæƒMAOä»£å¸...', 'info');
                const tx = await maoContract.approve(GAME_CONTRACT_ADDRESS, ethers.utils.parseEther('1000'));
                log(`ğŸ“ äº¤æ˜“å·²æäº¤: ${tx.hash}`, 'info');
                await tx.wait();
                log('âœ… MAOæˆæƒæˆåŠŸ', 'success');
                await updateBalances();
            } catch (error) {
                log(`âŒ MAOæˆæƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function approvePI() {
            try {
                log('âœ… å¼€å§‹æˆæƒPIä»£å¸...', 'info');
                const tx = await piContract.approve(GAME_CONTRACT_ADDRESS, ethers.utils.parseEther('10000'));
                log(`ğŸ“ äº¤æ˜“å·²æäº¤: ${tx.hash}`, 'info');
                await tx.wait();
                log('âœ… PIæˆæƒæˆåŠŸ', 'success');
                await updateBalances();
            } catch (error) {
                log(`âŒ PIæˆæƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¸¸æˆ
        async function testPlayMAO() {
            try {
                log('ğŸ® å¼€å§‹MAOæ¸¸æˆæµ‹è¯•...', 'info');
                log('ğŸ’³ æ”¯ä»˜100 MAOæ¸¸æˆè´¹ç”¨...', 'info');
                
                const balanceBefore = await maoContract.balanceOf(userAddress);
                log(`ğŸ“Š æ¸¸æˆå‰MAOä½™é¢: ${ethers.utils.formatEther(balanceBefore)}`, 'info');
                
                const tx = await gameContract.playMAOGame();
                log(`ğŸ“ æ¸¸æˆäº¤æ˜“å·²æäº¤: ${tx.hash}`, 'info');
                log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'warning');
                
                const receipt = await tx.wait();
                log('âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸï¼', 'success');
                
                const balanceAfter = await maoContract.balanceOf(userAddress);
                log(`ğŸ“Š æ¸¸æˆåMAOä½™é¢: ${ethers.utils.formatEther(balanceAfter)}`, 'info');
                log(`ğŸ’¸ å®é™…æ‰£é™¤: ${ethers.utils.formatEther(balanceBefore.sub(balanceAfter))} MAO`, 'info');
                
                // è§£ææ¸¸æˆäº‹ä»¶
                const gameEvent = receipt.events?.find(e => e.event === 'GamePlayed');
                if (gameEvent) {
                    const { multiplier, reward } = gameEvent.args;
                    log(`ğŸ¯ æ¸¸æˆç»“æœ: ${ethers.utils.formatEther(multiplier)}å€`, multiplier.gt(0) ? 'success' : 'warning');
                    log(`ğŸ† è·å¾—å¥–åŠ±: ${ethers.utils.formatEther(reward)} MAO`, 'success');
                }
                
                await updateBalances();
                await checkMarketingWallet();
                
            } catch (error) {
                log(`âŒ MAOæ¸¸æˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPlayPI() {
            try {
                log('ğŸ® å¼€å§‹PIæ¸¸æˆæµ‹è¯•...', 'info');
                log('ğŸ’³ æ”¯ä»˜1000 PIæ¸¸æˆè´¹ç”¨...', 'info');
                
                const balanceBefore = await piContract.balanceOf(userAddress);
                log(`ğŸ“Š æ¸¸æˆå‰PIä½™é¢: ${ethers.utils.formatEther(balanceBefore)}`, 'info');
                
                const tx = await gameContract.playPIGame();
                log(`ğŸ“ æ¸¸æˆäº¤æ˜“å·²æäº¤: ${tx.hash}`, 'info');
                log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'warning');
                
                const receipt = await tx.wait();
                log('âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸï¼', 'success');
                
                const balanceAfter = await piContract.balanceOf(userAddress);
                log(`ğŸ“Š æ¸¸æˆåPIä½™é¢: ${ethers.utils.formatEther(balanceAfter)}`, 'info');
                log(`ğŸ’¸ å®é™…æ‰£é™¤: ${ethers.utils.formatEther(balanceBefore.sub(balanceAfter))} PI`, 'info');
                
                // è§£ææ¸¸æˆäº‹ä»¶
                const gameEvent = receipt.events?.find(e => e.event === 'GamePlayed');
                if (gameEvent) {
                    const { multiplier, reward } = gameEvent.args;
                    log(`ğŸ¯ æ¸¸æˆç»“æœ: ${ethers.utils.formatEther(multiplier)}å€`, multiplier.gt(0) ? 'success' : 'warning');
                    log(`ğŸ† è·å¾—å¥–åŠ±: ${ethers.utils.formatEther(reward)} PI`, 'success');
                }
                
                await updateBalances();
                await checkMarketingWallet();
                
            } catch (error) {
                log(`âŒ PIæ¸¸æˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥è¥é”€é’±åŒ…
        async function checkMarketingWallet() {
            try {
                log('ğŸ¦ æ£€æŸ¥è¥é”€é’±åŒ…çŠ¶æ€...', 'info');
                
                const maoBalance = await maoContract.balanceOf(MARKETING_WALLET);
                const piBalance = await piContract.balanceOf(MARKETING_WALLET);
                
                log(`ğŸ’° è¥é”€é’±åŒ…ä½™é¢:`, 'info');
                log(`   MAO: ${ethers.utils.formatEther(maoBalance)}`, 'info');
                log(`   PI: ${ethers.utils.formatEther(piBalance)}`, 'info');
                
                document.getElementById('marketingStatus').textContent = `MAO: ${ethers.utils.formatEther(maoBalance)} | PI: ${ethers.utils.formatEther(piBalance)}`;
                document.getElementById('marketingStatus').className = 'status success';
                
            } catch (error) {
                log(`âŒ è¥é”€é’±åŒ…æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¼°ç®—é”€æ¯ä»£å¸
        async function estimateBurnedTokens() {
            log('ğŸ”¥ ä¼°ç®—é”€æ¯ä»£å¸æ•°é‡...', 'info');
            log('âš ï¸ æ³¨æ„ï¼šé”€æ¯æœºåˆ¶éœ€è¦éªŒè¯æ˜¯å¦ä¸º15%', 'warning');
            log('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥åˆçº¦æ˜¯å¦æœ‰é”€æ¯åœ°å€æˆ–é”€æ¯äº‹ä»¶', 'info');
        }

        // æ£€æŸ¥æ¸¸æˆç»“æœ
        async function checkGameResults() {
            try {
                log('ğŸ“Š æŸ¥è¯¢æœ€è¿‘æ¸¸æˆç»“æœ...', 'info');
                
                const currentBlock = await provider.getBlockNumber();
                const fromBlock = Math.max(0, currentBlock - 100);
                
                const events = await gameContract.queryFilter(
                    gameContract.filters.GamePlayed(),
                    fromBlock,
                    currentBlock
                );
                
                log(`ğŸ“ˆ æœ€è¿‘${currentBlock - fromBlock}ä¸ªå—ä¸­æ‰¾åˆ°${events.length}æ¬¡æ¸¸æˆ`, 'info');
                
                events.slice(-5).forEach((event, index) => {
                    const { player, useMAO, amount, multiplier, reward } = event.args;
                    log(`${index + 1}. ${useMAO ? 'MAO' : 'PI'}æ¸¸æˆ - å€æ•°:${ethers.utils.formatEther(multiplier)} å¥–åŠ±:${ethers.utils.formatEther(reward)}`, 'info');
                });
                
            } catch (error) {
                log(`âŒ æ¸¸æˆç»“æœæŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function disconnectWallet() {
            userAddress = null;
            provider = null;
            signer = null;
            gameContract = null;
            maoContract = null;
            piContract = null;
            
            document.getElementById('walletStatus').textContent = 'æœªè¿æ¥';
            document.getElementById('walletStatus').className = 'status';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('playMAOBtn').disabled = true;
            document.getElementById('playPIBtn').disabled = true;
            
            log('ğŸ“µ é’±åŒ…å·²æ–­å¼€è¿æ¥', 'warning');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            checkNetworkAndContracts();
        });
    </script>
</body>
</html> 