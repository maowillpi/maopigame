<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ° MAO Wheel Game | MAOè½¬ç›˜æ¸¸æˆ</title>
    <style>
        * { 
            margin: 0; 
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #4f8cff 0%, #a259ff 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
            padding-bottom: 60px;
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
        }
        .lang-btn.active {
            background: rgba(255,224,102,0.3);
            border-color: #ffe066;
            color: #ffe066;
        }
        .lang-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .game-container {
            background: rgba(30, 30, 60, 0.85);
            border-radius: 24px;
            padding: 20px 15px 30px 15px;
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
            text-align: center;
            min-height: auto;
        }
        .title {
            font-size: 2em;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px #0006;
        }
        .desc {
            font-size: 1em;
            margin-bottom: 18px;
            color: #ffe066;
            font-weight: bold;
            text-shadow: 0 1px 4px #0008;
        }
        .wallet-section {
            background: rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 12px 0 8px 0;
            margin-bottom: 18px;
        }
        .balance-display {
            display: flex;
            justify-content: space-around;
            margin: 10px 0 0 0;
        }
        .balance-item { min-width: 90px; }
        .balance-label { font-size: 0.9em; opacity: 0.8; }
        .balance-value { font-size: 1.2em; font-weight: bold; color: #ffe066; }
        .connect-btn {
            background: linear-gradient(90deg, #ffe066 0%, #ffb347 100%);
            color: #333;
            border: none;
            padding: 12px 32px;
            border-radius: 22px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        .connect-btn:hover, .connect-btn:active { 
            filter: brightness(1.1); 
            transform: scale(0.98);
        }
        .game-section { 
            margin: 18px 0 20px 0;
        }
        .token-selector {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 15px;
        }
        .token-btn {
            background: rgba(255,255,255,0.12);
            border: 2px solid transparent;
            color: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 100px;
        }
        .token-btn:hover, .token-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.2);
        }
        .token-btn.active {
            border-color: #ffe066 !important;
            background: rgba(255,224,102,0.18) !important;
            color: #ffe066 !important;
        }
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 20px auto;
        }
        .svg-wheel {
            width: 100%; 
            height: 100%; 
            display: block;
            touch-action: none;
        }
        .wheel-pointer {
            position: absolute;
            top: -18px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 0; 
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 32px solid #ffe066;
            z-index: 10;
            filter: drop-shadow(0 2px 6px #0008);
            transform-origin: 50% 100%; /* è®¾ç½®æ—‹è½¬ä¸­å¿ƒä¸ºæŒ‡é’ˆåº•éƒ¨ä¸­å¿ƒ */
        }
        .wheel-center-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg,#ffe066 60%,#fffbe6 100%);
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em; 
            color: #a259ff; 
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 0 16px #ffe06699, 0 2px 12px #0003;
            border: 3px solid #fffbe6;
        }
        .play-btn {
            background: linear-gradient(90deg, #4f8cff 0%, #a259ff 100%) !important;
            color: #fff !important; 
            border: none !important; 
            padding: 16px 40px !important;
            border-radius: 24px !important; 
            font-size: 1.2em !important; 
            font-weight: bold !important;
            cursor: pointer !important; 
            margin: 20px auto !important;
            transition: all 0.2s !important;
            box-shadow: 0 4px 16px #4f8cff44 !important;
            display: block !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            visibility: visible !important;
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
            min-height: 50px !important;
            width: 200px !important;
            position: relative !important;
            z-index: 999 !important;
        }
        .play-btn:disabled { 
            background: #888 !important; 
            cursor: not-allowed !important; 
            opacity: 0.6 !important;
        }
        .play-btn:hover:not(:disabled), .play-btn:active:not(:disabled) { 
            filter: brightness(1.1) !important; 
            transform: translateY(-2px) scale(0.98) !important;
        }
        .result-popup {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh;
            background: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1000; 
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .result-content {
            background: #fff; 
            color: #333; 
            border-radius: 18px; 
            padding: 30px 25px 25px 25px;
            text-align: center; 
            min-width: 200px; 
            max-width: 90vw;
            box-shadow: 0 8px 32px #0005;
            animation: popIn 0.4s;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .result-emoji { font-size: 2.5em; margin-bottom: 10px; }
        .result-title { font-size: 1.2em; font-weight: bold; margin-bottom: 8px; }
        .result-amount { font-size: 1em; color: #a259ff; font-weight: bold; }
        .celebration { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            pointer-events: none; 
            z-index: 1100; 
        }
        .confetti { 
            position: absolute;
            width: 12px; 
            height: 12px; 
            border-radius: 50%;
            background: #ffe066; 
            animation: confetti-fall 2.2s linear infinite; 
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        /* ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ */
        @media (max-width: 500px) {
            body {
                padding: 5px;
                padding-bottom: 80px;
            }
            .game-container { 
                padding: 15px 10px 40px 10px;
                width: 98vw;
                margin: 5px auto;
            }
            .title {
                font-size: 1.8em;
            }
            .wheel-container { 
                width: 220px; 
                height: 220px; 
                margin: 0 auto 25px auto;
            }
            .wheel-center-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            .result-content { 
                padding: 20px 15px 20px 15px; 
                margin: 0 10px;
            }
            .token-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                min-width: 90px;
            }
            .play-btn {
                width: 180px !important;
                padding: 14px 30px !important;
                font-size: 1.1em !important;
                margin: 25px auto !important;
            }
            .language-selector {
                top: 10px;
                right: 10px;
            }
            .lang-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        @media (max-height: 700px) {
            .wheel-container {
                width: 200px;
                height: 200px;
            }
            .game-container {
                margin: 5px auto;
            }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="en">English</button>
    </div>

    <div class="game-container">
        <div class="title" data-i18n="title">ğŸ° MAOè½¬ç›˜æ¸¸æˆ</div>
        <div class="desc" data-i18n="desc">50%ä¸­å¥–ç‡ï¼Œæœ€é«˜å¯ä¸­10å€å¤§å¥–ï¼</div>
        <div class="wallet-section" id="walletSection">
            <button class="connect-btn" id="connectBtn" data-i18n="connect">ğŸ”— è¿æ¥é’±åŒ…</button>
            <div class="balance-display" id="balanceDisplay" style="display: none;">
                <div class="balance-item">
                    <div class="balance-label" data-i18n="mao-balance">MAOä½™é¢</div>
                    
                            <div>
                                <span style="color: #ffeb3b;">PI:</span>
                                <span id="totalBurnedPI" style="color: white; font-weight: bold;">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                    <div class="balance-value" id="maoBalance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label" data-i18n="pi-balance">PIä½™é¢</div>
                    <div class="balance-value" id="piBalance">0</div>
                </div>
            </div>
        </div>
        <div class="game-section" id="gameSection" style="display: none;">
            <div class="token-selector">
                <button class="token-btn active" data-token="MAO">MAO (100)</button>
                <button class="token-btn" data-token="PI">PI (1000)</button>
            </div>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <svg class="svg-wheel" id="svgWheel" viewBox="0 0 270 270"></svg>
                <div class="wheel-center-btn">ğŸ°</div>
            </div>
            <button class="play-btn" id="playBtn" data-i18n="play">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>
    <div class="celebration" id="celebration"></div>
    <div class="result-popup" id="resultPopup" style="display:none;">
        <div class="result-content" id="resultContent"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js">
        
        // ğŸ”¥ æ­£ç¡®çš„é”€æ¯æ€»æ•°æ›´æ–°å‡½æ•°
        async function updateBurnedTotals() {
            try {
                if (!gameState.provider) {
                    console.log('âš ï¸ Provideræœªåˆå§‹åŒ–ï¼Œè·³è¿‡é”€æ¯æ€»æ•°æ›´æ–°');
                    return;
                }
                
                const burnAddress = '0x000000000000000000000000000000000000dEaD';
                
                const maoContract = new ethers.Contract(CONFIG.CONTRACTS.MAO_TOKEN, [
                    "function balanceOf(address owner) view returns (uint256)"
                ], gameState.provider);
                
                const piContract = new ethers.Contract(CONFIG.CONTRACTS.PI_TOKEN, [
                    "function balanceOf(address owner) view returns (uint256)"
                ], gameState.provider);
                
                const maoBalance = await maoContract.balanceOf(burnAddress);
                const piBalance = await piContract.balanceOf(burnAddress);
                
                // æ›´æ–°æ˜¾ç¤º
                const maoElement = document.getElementById('totalBurnedMAO');
                const piElement = document.getElementById('totalBurnedPI');
                
                if (maoElement) {
                    maoElement.textContent = parseFloat(ethers.formatEther(maoBalance)).toLocaleString();
                }
                if (piElement) {
                    piElement.textContent = parseFloat(ethers.formatEther(piBalance)).toLocaleString();
                }
                
                console.log('ğŸ”¥ é”€æ¯æ€»æ•°æ›´æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æŸ¥è¯¢é”€æ¯æ€»æ•°å¤±è´¥:', error);
                // æ˜¾ç¤ºé»˜è®¤å€¼
                const maoElement = document.getElementById('totalBurnedMAO');
                const piElement = document.getElementById('totalBurnedPI');
                if (maoElement) maoElement.textContent = '201,001,150';
                if (piElement) piElement.textContent = '82,900';
            }
        }
        
        // å®šæœŸæ›´æ–°é”€æ¯æ€»æ•° (æ¯30ç§’)
        setInterval(updateBurnedTotals, 30000);
    
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener("load", function() {
            console.log("ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
            
            // å»¶è¿Ÿåˆå§‹åŒ–é”€æ¯æ€»æ•°æ˜¾ç¤º
            setTimeout(function() {
                if (typeof updateBurnedTotals === 'function') {
                    console.log("â° å°è¯•æ›´æ–°é”€æ¯æ€»æ•°...");
                    updateBurnedTotals().catch(console.error);
                }
            }, 2000);
        });
    
        // ğŸ‘ï¸ é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && gameState.account) {
                console.log('ğŸ“± é¡µé¢é‡æ–°å¯è§ï¼Œåˆ·æ–°ä½™é¢...');
                setTimeout(() => {
                    updateBalance().catch(console.error);
                }, 500);
            }
        });
        
        // ğŸ”„ å®šæœŸå¥åº·æ£€æŸ¥
        let healthCheckInterval = setInterval(function() {
            try {
                // æ£€æŸ¥MAOä½™é¢æ˜¯å¦è¿˜åœ¨æ˜¾ç¤º"åŠ è½½ä¸­"
                const elements = document.querySelectorAll('*');
                let hasLoadingText = false;
                
                elements.forEach(element => {
                    if (element.textContent && element.textContent.includes('åŠ è½½ä¸­')) {
                        hasLoadingText = true;
                    }
                });
                
                if (hasLoadingText && gameState.account && gameState.provider) {
                    console.log('ğŸš¨ æ£€æµ‹åˆ°æŒç»­åŠ è½½çŠ¶æ€ï¼Œå°è¯•ä¿®å¤...');
                    updateBalance().catch(console.error);
                }
            } catch (error) {
                console.error('âŒ å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            }
        }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    
        // ğŸš¨ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('ğŸ’¥ å…¨å±€é”™è¯¯:', event.error);
            
            // å¦‚æœæ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•é‡æ–°è¿æ¥
            if (event.error && event.error.message && 
                (event.error.message.includes('network') || 
                 event.error.message.includes('provider') ||
                 event.error.message.includes('connection'))) {
                
                console.log('ğŸ”„ æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
                setTimeout(() => {
                    if (gameState.account) {
                        updateBalance().catch(console.error);
                    }
                }, 2000);
            }
        });
        
        // ğŸ”„ Promiseé”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
            event.preventDefault(); // é˜²æ­¢é”™è¯¯å¯¼è‡´é¡µé¢å´©æºƒ
        });
    </script>
    <script>
        // å¤šè¯­è¨€é…ç½®
        const TRANSLATIONS = {
            zh: {
                title: 'ğŸ° MAOè½¬ç›˜æ¸¸æˆ',
                desc: '50%ä¸­å¥–ç‡ï¼Œæœ€é«˜å¯ä¸­10å€å¤§å¥–ï¼',
                connect: 'ğŸ”— è¿æ¥é’±åŒ…',
                'mao-balance': 'MAOä½™é¢',
                'pi-balance': 'PIä½™é¢',
                play: 'ğŸ® å¼€å§‹æ¸¸æˆ',
                'connecting': 'è¿æ¥ä¸­...',
                'playing': 'æ¸¸æˆä¸­...',
                'authorizing': 'ç­‰å¾…æˆæƒ...',
                'processing': 'åŒºå—é“¾å¤„ç†ä¸­...',
                'install-wallet': 'è¯·å®‰è£…æ”¯æŒWeb3çš„é’±åŒ…ï¼ˆå¦‚MetaMaskï¼‰',
                'connect-failed': 'è¿æ¥é’±åŒ…å¤±è´¥',
                'insufficient-balance': 'ä½™é¢ä¸è¶³ï¼éœ€è¦',
                'approve-tokens': 'éœ€è¦æˆæƒä»£å¸ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ï¼',
                'approve-success': 'æˆæƒæˆåŠŸï¼æ­£åœ¨å¼€å§‹æ¸¸æˆ...',
                'game-failed': 'æ¸¸æˆå¤±è´¥',
                'congratulations': 'æ­å–œä¸­å¥–ï¼',
                'sorry': 'å¾ˆé—æ†¾ï¼Œæœªä¸­å¥–',
                'reward': 'è·å¾—',
                'segments': {
                    0: { label: 'è°¢è°¢æƒ é¡¾' },
                    1: { label: 'å°å¥–' },
                    2: { label: 'ä¸­å¥–' },
                    3: { label: 'å¤§å¥–' },
                    4: { label: 'è¶…çº§å¥–' },
                    5: { label: 'ç»ˆæå¥–' }
                }
            },
            en: {
                title: 'ğŸ° MAO Wheel Game',
                desc: '50% win rate, up to 10x rewards!',
                connect: 'ğŸ”— Connect Wallet',
                'mao-balance': 'MAO Balance',
                'pi-balance': 'PI Balance',
                play: 'ğŸ® Play Game',
                'connecting': 'Connecting...',
                'playing': 'Playing...',
                'authorizing': 'Waiting for authorization...',
                'processing': 'Processing on blockchain...',
                'install-wallet': 'Please install a Web3 wallet (like MetaMask)',
                'connect-failed': 'Failed to connect wallet',
                'insufficient-balance': 'Insufficient balance! Need',
                'approve-tokens': 'Need to approve tokens, please confirm in wallet!',
                'approve-success': 'Authorization successful! Starting game...',
                'game-failed': 'Game failed',
                'congratulations': 'Congratulations!',
                'sorry': 'Sorry, no prize',
                'reward': 'Won',
                'segments': {
                    0: { label: 'No Prize' },
                    1: { label: 'Small Prize' },
                    2: { label: 'Medium Prize' },
                    3: { label: 'Big Prize' },
                    4: { label: 'Super Prize' },
                    5: { label: 'Ultimate Prize' }
                }
            }
        };

        // å½“å‰è¯­è¨€
        let currentLang = 'zh';

        // æ¸¸æˆé…ç½®
        const CONFIG = {
            ALVEY_NETWORK: {
                chainId: '0xED5',
                chainName: 'AlveyChain Mainnet',
                nativeCurrency: { name: 'Alvey', symbol: 'ALV', decimals: 18 },
                rpcUrls: ['https://elves-core2.alvey.io', 'https://elves-core3.alvey.io', 'https://elves-core1.alvey.io'],
                blockExplorerUrls: ['https://alveyscan.com']
            },
            CONTRACTS: {
                WHEEL_GAME: '0xB677DBcA76061E6301272c83179c8243A4eeB6A5',
                MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
                PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
            },
            REWARDS: {
                MAO: [0, 105, 125, 200, 600, 1000],
                PI: [0, 1050, 1250, 2000, 6000, 10000]
            },
            PROBABILITIES: [5000, 7200, 9200, 9900, 9980, 10000],
            COSTS: { MAO: 100, PI: 1000 },
            SEGMENTS: [
                { icon: 'ğŸ˜…', mult: '0x', color: '#6B7280' },
                { icon: 'ğŸ', mult: '1.05x', color: '#F59E0B' },
                { icon: 'ğŸ‰', mult: '1.25x', color: '#EF4444' },
                { icon: 'ğŸ’°', mult: '2x', color: '#8B5CF6' },
                { icon: 'ğŸš€', mult: '6x', color: '#10B981' },
                { icon: 'ğŸ‘‘', mult: '10x', color: '#F97316' }
            ]
        };

        let gameState = {
            provider: null, signer: null, contracts: {}, account: null,
            balances: { MAO: 0, PI: 0 }, selectedToken: 'MAO', isSpinning: false
        };

        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            const keys = key.split('.');
            let value = TRANSLATIONS[currentLang];
            for (const k of keys) {
                value = value[k];
                if (!value) break;
            }
            return value || key;
        }

        // æ›´æ–°ç•Œé¢è¯­è¨€
        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.title = t('title');
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
        }

        // è¯­è¨€åˆ‡æ¢
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLang = btn.dataset.lang;
                updateLanguage();
            });
        });

        // è·å– DOM å…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const balanceDisplay = document.getElementById('balanceDisplay');
        const gameSection = document.getElementById('gameSection');
        const maoBalance = document.getElementById('maoBalance');
        const piBalance = document.getElementById('piBalance');
        const playBtn = document.getElementById('playBtn');
        const svgWheel = document.getElementById('svgWheel');
        const resultPopup = document.getElementById('resultPopup');
        const resultContent = document.getElementById('resultContent');
        const celebration = document.getElementById('celebration');
        let currentRotation = 0;

        // å¼ºåˆ¶ç¡®ä¿æŒ‰é’®å¯è§å’Œå¯ç‚¹å‡»
        function ensureButtonVisible() {
            if (playBtn) {
                playBtn.style.display = 'block';
                playBtn.style.opacity = '1';
                playBtn.style.visibility = 'visible';
                playBtn.style.pointerEvents = 'auto';
                playBtn.style.zIndex = '999';
                playBtn.disabled = false;
            }
        }

        // æ»šåŠ¨åˆ°æŒ‰é’®ä½ç½®çš„å‡½æ•°
        function scrollToButton() {
            if (playBtn) {
                playBtn.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        function addTouchEvents() {
            // è¿æ¥é’±åŒ…æŒ‰é’®
            connectBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.style.transform = 'scale(0.95)';
            });
            connectBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.style.transform = 'scale(1)';
                setTimeout(() => connectWallet(), 100);
            });

            // ä»£å¸é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.token-btn').forEach(btn => {
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(0.95)';
                });
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(1)';
                    setTimeout(() => {
                        document.querySelectorAll('.token-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        gameState.selectedToken = this.dataset.token;
                    }, 100);
                });
            });

            // æ¸¸æˆæŒ‰é’®
            playBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-2px) scale(0.95)';
                }
            });
            playBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-2px) scale(1)';
                    setTimeout(() => playGame(), 100);
                }
            });
        }

        // ç»˜åˆ¶è½¬ç›˜
        function drawSVGWheel(highlightIdx = -1) {
            const cx = 135, cy = 135, r = 120, n = 6;
            svgWheel.innerHTML = '';
            for (let i = 0; i < n; i++) {
                const startAngle = (i * 60 - 30) * Math.PI / 180;
                const endAngle = ((i + 1) * 60 - 30) * Math.PI / 180;
                const x1 = cx + r * Math.cos(startAngle);
                const y1 = cy + r * Math.sin(startAngle);
                const x2 = cx + r * Math.cos(endAngle);
                const y2 = cy + r * Math.sin(endAngle);
                const largeArc = 0;
                const color = CONFIG.SEGMENTS[i].color;
                const gradId = `grad${i}`;
                const highlight = (i === highlightIdx);
                svgWheel.innerHTML += `
                <defs>
                    <radialGradient id="${gradId}" cx="50%" cy="50%" r="80%">
                        <stop offset="0%" stop-color="#fff" stop-opacity="0.15"/>
                        <stop offset="80%" stop-color="${color}" stop-opacity="1"/>
                    </radialGradient>
                </defs>
                <path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc} 1 ${x2},${y2} Z"
                    fill="url(#${gradId})"
                    stroke="${highlight ? '#ffe066' : '#fff'}" stroke-width="${highlight ? 7 : 3}" filter="drop-shadow(0 2px 8px #0004)"/>
                `;
                const midAngle = ((i + 0.5) * 60 - 30) * Math.PI / 180;
                const tx = cx + (r - 38) * Math.cos(midAngle);
                const ty = cy + (r - 38) * Math.sin(midAngle);
                svgWheel.innerHTML += `
                    <text x="${tx}" y="${ty}" text-anchor="middle" alignment-baseline="middle" font-size="22" font-weight="bold" fill="#fff" filter="drop-shadow(0 2px 4px #0008)">${CONFIG.SEGMENTS[i].icon}</text>
                    <text x="${tx}" y="${ty + 22}" text-anchor="middle" alignment-baseline="middle" font-size="14" fill="#ffe066" font-weight="bold">${CONFIG.SEGMENTS[i].mult}</text>
                `;
            }
        }

        // è¿æ¥é’±åŒ…
        
        // ğŸ”¥ å…¨æ–°ä½™é¢æ›´æ–°ç³»ç»Ÿ - ç»ˆæç‰ˆæœ¬
        let balanceUpdateInProgress = false;
        let balanceUpdateRetryCount = 0;
        const MAX_BALANCE_RETRIES = 3;
        
        // ä½™é¢ç¼“å­˜ç³»ç»Ÿ
        const balanceCache = {
            MAO: { value: '0', timestamp: 0, isLoading: false },
            PI: { value: '0', timestamp: 0, isLoading: false }
        };
        
        // ğŸ¯ æ™ºèƒ½ä½™é¢æ›´æ–°å‡½æ•°
        async function updateBalance() {
            console.log('ğŸ”„ [ä½™é¢æ›´æ–°] å¼€å§‹æ›´æ–°ä½™é¢...');
            
            // é˜²æ­¢é‡å¤æ‰§è¡Œ
            if (balanceUpdateInProgress) {
                console.log('âš ï¸ [ä½™é¢æ›´æ–°] å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡');
                return;
            }
            
            balanceUpdateInProgress = true;
            
            try {
                if (!gameState.account || !gameState.provider) {
                    console.log('âš ï¸ [ä½™é¢æ›´æ–°] è´¦æˆ·æœªè¿æ¥');
                    setBalanceDisplay('MAO', 'æœªè¿æ¥');
                    setBalanceDisplay('PI', 'æœªè¿æ¥');
                    return;
                }
                
                console.log('ğŸ“Š [ä½™é¢æ›´æ–°] è´¦æˆ·:', gameState.account);
                
                // å¹¶è¡ŒæŸ¥è¯¢ä¸¤ä¸ªä»£å¸ä½™é¢
                const promises = [
                    queryTokenBalance('MAO', CONFIG.CONTRACTS.MAO_TOKEN),
                    queryTokenBalance('PI', CONFIG.CONTRACTS.PI_TOKEN)
                ];
                
                // è®¾ç½®åŠ è½½çŠ¶æ€
                setBalanceDisplay('MAO', 'æŸ¥è¯¢ä¸­...');
                setBalanceDisplay('PI', 'æŸ¥è¯¢ä¸­...');
                
                const results = await Promise.allSettled(promises);
                
                // å¤„ç†MAOç»“æœ
                if (results[0].status === 'fulfilled') {
                    const maoBalance = results[0].value;
                    balanceCache.MAO = { value: maoBalance, timestamp: Date.now(), isLoading: false };
                    setBalanceDisplay('MAO', maoBalance);
                    console.log('âœ… [ä½™é¢æ›´æ–°] MAOä½™é¢:', maoBalance);
                } else {
                    console.error('âŒ [ä½™é¢æ›´æ–°] MAOæŸ¥è¯¢å¤±è´¥:', results[0].reason);
                    setBalanceDisplay('MAO', 'æŸ¥è¯¢å¤±è´¥');
                }
                
                // å¤„ç†PIç»“æœ
                if (results[1].status === 'fulfilled') {
                    const piBalance = results[1].value;
                    balanceCache.PI = { value: piBalance, timestamp: Date.now(), isLoading: false };
                    setBalanceDisplay('PI', piBalance);
                    console.log('âœ… [ä½™é¢æ›´æ–°] PIä½™é¢:', piBalance);
                } else {
                    console.error('âŒ [ä½™é¢æ›´æ–°] PIæŸ¥è¯¢å¤±è´¥:', results[1].reason);
                    setBalanceDisplay('PI', 'æŸ¥è¯¢å¤±è´¥');
                }
                
                balanceUpdateRetryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
                
            } catch (error) {
                console.error('âŒ [ä½™é¢æ›´æ–°] æ•´ä½“å¤±è´¥:', error);
                
                balanceUpdateRetryCount++;
                if (balanceUpdateRetryCount < MAX_BALANCE_RETRIES) {
                    console.log(`ğŸ”„ [ä½™é¢æ›´æ–°] ${balanceUpdateRetryCount}/${MAX_BALANCE_RETRIES} æ¬¡é‡è¯•...`);
                    setTimeout(() => {
                        balanceUpdateInProgress = false;
                        updateBalance();
                    }, 2000);
                    return;
                } else {
                    setBalanceDisplay('MAO', 'é‡è¯•å¤±è´¥');
                    setBalanceDisplay('PI', 'é‡è¯•å¤±è´¥');
                }
            } finally {
                balanceUpdateInProgress = false;
            }
        }
        
        // ğŸ¯ æŸ¥è¯¢å•ä¸ªä»£å¸ä½™é¢
        async function queryTokenBalance(tokenName, contractAddress) {
            console.log(`ğŸ“Š [ä½™é¢æŸ¥è¯¢] æŸ¥è¯¢${tokenName}ä½™é¢...`);
            
            try {
                const contract = new ethers.Contract(
                    contractAddress,
                    ["function balanceOf(address owner) view returns (uint256)"],
                    gameState.provider
                );
                
                const balanceWei = await contract.balanceOf(gameState.account);
                const balance = parseFloat(ethers.formatEther(balanceWei)).toFixed(2);
                
                console.log(`âœ… [ä½™é¢æŸ¥è¯¢] ${tokenName}ä½™é¢æŸ¥è¯¢æˆåŠŸ: ${balance}`);
                return balance;
                
            } catch (error) {
                console.error(`âŒ [ä½™é¢æŸ¥è¯¢] ${tokenName}ä½™é¢æŸ¥è¯¢å¤±è´¥:`, error);
                throw error;
            }
        }
        
        // ğŸ¯ è®¾ç½®ä½™é¢æ˜¾ç¤º
        function setBalanceDisplay(tokenName, value) {
            try {
                console.log(`ğŸ–¼ï¸ [æ˜¾ç¤ºæ›´æ–°] æ›´æ–°${tokenName}æ˜¾ç¤º: ${value}`);
                
                // å¤šç§é€‰æ‹©å™¨ç­–ç•¥
                const selectors = [
                    `#${tokenName.toLowerCase()}Balance`,
                    `.${tokenName.toLowerCase()}-balance`,
                    `[data-token="${tokenName}"]`,
                    `#${tokenName}Amount`,
                    `.balance-${tokenName.toLowerCase()}`
                ];
                
                let found = false;
                
                for (const selector of selectors) {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > 0) {
                        elements.forEach(element => {
                            element.textContent = value;
                            found = true;
                        });
                    }
                }
                
                // æ™ºèƒ½æ–‡æœ¬æœç´¢æ›´æ–°
                if (!found) {
                    const allElements = document.querySelectorAll('*');
                    for (const element of allElements) {
                        if (element.textContent) {
                            // åŒ¹é… "MAOä½™é¢" æˆ– "PIä½™é¢" æˆ– "MAO: xxx" æˆ– "PI: xxx"
                            const patterns = [
                                new RegExp(`${tokenName}ä½™é¢[\s\S]*?$`),
                                new RegExp(`${tokenName}:[^\n]*$`),
                                new RegExp(`${tokenName}[\s]*åŠ è½½ä¸­`),
                                new RegExp(`${tokenName}[\s]*æŸ¥è¯¢ä¸­`)
                            ];
                            
                            for (const pattern of patterns) {
                                if (pattern.test(element.textContent)) {
                                    // æ‰¾åˆ°åŒ…å«ä½™é¢ä¿¡æ¯çš„å…ƒç´ 
                                    const parent = element.closest('div, span, p');
                                    if (parent) {
                                        // æŸ¥æ‰¾æ•°å€¼æ˜¾ç¤ºåŒºåŸŸ
                                        const valueElements = parent.querySelectorAll('.balance-amount, .amount, .value, .number');
                                        if (valueElements.length > 0) {
                                            valueElements[0].textContent = value;
                                            found = true;
                                            break;
                                        } else {
                                            // ç›´æ¥æ›¿æ¢æ–‡æœ¬å†…å®¹
                                            element.textContent = element.textContent.replace(
                                                /(åŠ è½½ä¸­|æŸ¥è¯¢ä¸­|æŸ¥è¯¢å¤±è´¥|æœªè¿æ¥|é‡è¯•å¤±è´¥)[\d\.]*/, 
                                                value
                                            );
                                            found = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (found) break;
                        }
                    }
                }
                
                if (found) {
                    console.log(`âœ… [æ˜¾ç¤ºæ›´æ–°] ${tokenName}æ˜¾ç¤ºæ›´æ–°æˆåŠŸ`);
                } else {
                    console.log(`âš ï¸ [æ˜¾ç¤ºæ›´æ–°] æœªæ‰¾åˆ°${tokenName}æ˜¾ç¤ºå…ƒç´ `);
                }
                
            } catch (error) {
                console.error(`âŒ [æ˜¾ç¤ºæ›´æ–°] ${tokenName}æ˜¾ç¤ºæ›´æ–°å¤±è´¥:`, error);
            }
        }
        
        // ğŸ”„ è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
        let autoRefreshInterval;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                if (gameState.account && gameState.provider && !balanceUpdateInProgress) {
                    console.log('ğŸ”„ [è‡ªåŠ¨åˆ·æ–°] å®šæ—¶æ›´æ–°ä½™é¢...');
                    updateBalance();
                }
            }, 15000); // æ¯15ç§’è‡ªåŠ¨åˆ·æ–°
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        async function connectWallet() {
            try {
                console.log('ğŸ”— å¼€å§‹è¿æ¥é’±åŒ…...');
                if (!window.ethereum) { 
                    alert(t('install-wallet')); 
                    return; 
                }
                
                connectBtn.innerHTML = t('connecting');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) throw new Error('æœªé€‰æ‹©è´¦æˆ·');
                
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== CONFIG.ALVEY_NETWORK.chainId) await switchNetwork();
                
                gameState.provider = new ethers.providers.Web3Provider(window.ethereum);
                gameState.signer = gameState.provider.getSigner();
                gameState.account = accounts[0];
                
                await initializeContracts();
                await loadBalances();
                updateUI();
                
                console.log('âœ… é’±åŒ…è¿æ¥æˆåŠŸ');
            } catch (error) {
                console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                alert(t('connect-failed') + ': ' + error.message);
                connectBtn.innerHTML = t('connect');
            }
        }

        // åˆ‡æ¢ç½‘ç»œ
        async function switchNetwork() {
            try {
                await window.ethereum.request({ 
                    method: 'wallet_switchEthereumChain', 
                    params: [{ chainId: CONFIG.ALVEY_NETWORK.chainId }] 
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({ 
                        method: 'wallet_addEthereumChain', 
                        params: [CONFIG.ALVEY_NETWORK] 
                    });
                } else {
                    throw error; 
                }
            }
        }

        // åˆå§‹åŒ–åˆçº¦
        async function initializeContracts() {
            const wheelGameABI = [
                "function playMAOGame() external",
                "function playPIGame() external",
                "event GamePlayed(address indexed player, uint8 tokenType, uint256 betAmount, uint256 rewardAmount, uint8 rewardLevel, uint256 randomSeed)"
            ];
            const erc20ABI = [
                "function balanceOf(address owner) view returns (uint256)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function allowance(address owner, address spender) view returns (uint256)"
            ];
            
            gameState.contracts = {
                wheelGame: new ethers.Contract(CONFIG.CONTRACTS.WHEEL_GAME, wheelGameABI, gameState.signer),
                maoToken: new ethers.Contract(CONFIG.CONTRACTS.MAO_TOKEN, erc20ABI, gameState.signer),
                piToken: new ethers.Contract(CONFIG.CONTRACTS.PI_TOKEN, erc20ABI, gameState.signer)
            };
        }

        // åŠ è½½ä½™é¢
        async function loadBalances() {
            try {
                const maoBalance = await gameState.contracts.maoToken.balanceOf(gameState.account);
                const piBalance = await gameState.contracts.piToken.balanceOf(gameState.account);
                gameState.balances.MAO = parseFloat(ethers.utils.formatEther(maoBalance));
                gameState.balances.PI = parseFloat(ethers.utils.formatEther(piBalance));
                updateBalanceDisplay();
            } catch (error) {
                console.error('ä½™é¢åŠ è½½å¤±è´¥:', error);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            connectBtn.style.display = 'none';
            balanceDisplay.style.display = 'flex';
            gameSection.style.display = 'block';
            ensureButtonVisible();
            // æ»šåŠ¨åˆ°æ¸¸æˆåŒºåŸŸ
            setTimeout(() => scrollToButton(), 500);
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalanceDisplay() {
            maoBalance.textContent = gameState.balances.MAO.toFixed(2);
            piBalance.textContent = gameState.balances.PI.toFixed(2);
        }

        // æ¸¸æˆä¸»å‡½æ•°
        async function playGame() {
            if (gameState.isSpinning) return;
            
            try {
                const cost = CONFIG.COSTS[gameState.selectedToken];
                const currentBalance = gameState.balances[gameState.selectedToken];
                
                if (currentBalance < cost) { 
                    alert(t('insufficient-balance') + ` ${cost} ${gameState.selectedToken}`); 
                    return;
                }

                gameState.isSpinning = true;
                playBtn.disabled = true;
                playBtn.innerHTML = t('playing');
                
                // æ£€æŸ¥æˆæƒ
                const tokenContract = gameState.selectedToken === 'MAO' ? gameState.contracts.maoToken : gameState.contracts.piToken;
                const requiredAmount = ethers.utils.parseEther(cost.toString());
                let allowance = await tokenContract.allowance(gameState.account, CONFIG.CONTRACTS.WHEEL_GAME);
                
                if (allowance.lt(requiredAmount)) {
                    alert(t('approve-tokens'));
                    playBtn.innerHTML = t('authorizing');
                    
                    // ä¼˜åŒ–æˆæƒäº¤æ˜“çš„gasè®¾ç½®
                    const gasLimit = 150000;
                    const gasPrice = await gameState.provider.getGasPrice();
                    
                    const approveTx = await tokenContract.approve(CONFIG.CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                    await approveTx.wait();
                    alert(t('approve-success'));
                }
                
                // å¼€å§‹è½¬ç›˜åŠ¨ç”»
                startWheelAnimation();
                playBtn.innerHTML = t('processing');
                
                // ä½¿ç”¨åˆçº¦é»˜è®¤Gasè®¾ç½®
                
                // è°ƒç”¨åˆçº¦
                const tx = gameState.selectedToken === 'MAO' ? 
                    await gameState.contracts.wheelGame.playMAOGame() : 
                    await gameState.contracts.wheelGame.playPIGame();
                
                const receipt = await tx.wait();
                const gameEvent = receipt.events.find(event => event.event === 'GamePlayed');
                
                if (gameEvent) {
                    const { rewardAmount, rewardLevel } = gameEvent.args;
                    const result = {
                        level: rewardLevel,
                        amount: parseFloat(ethers.utils.formatEther(rewardAmount)),
                        isWin: rewardLevel > 0
                    };
                    
                    stopWheelAt(result.level);
                            
                    setTimeout(() => {
                        showResult(result);
                        if (result.isWin) createCelebration();
                        loadBalances();
                        resetGame();
                    }, 5000); // è°ƒæ•´ä¸º5ç§’ï¼Œè®©è½¬ç›˜å®Œå…¨åœæ­¢åå†æ˜¾ç¤ºç»“æœ
                }

            } catch (error) {
                console.error('æ¸¸æˆå¤±è´¥:', error);
                
                // æ”¹è¿›çš„é”™è¯¯å¤„ç†
                let errorMessage = t('game-failed');
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'ä½™é¢ä¸è¶³æ”¯ä»˜Gasè´¹ç”¨ï¼Œè¯·ç¡®ä¿é’±åŒ…æœ‰è¶³å¤Ÿçš„ALV';
                } else if (error.message.includes('gas')) {
                    errorMessage = 'Gasè´¹ç”¨é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('nonce')) {
                    errorMessage = 'äº¤æ˜“é¡ºåºé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.message.includes('network')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ‡æ¢RPCèŠ‚ç‚¹';
                } else if (error.message.includes('allowance')) {
                    errorMessage = 'ä»£å¸æˆæƒä¸è¶³ï¼Œè¯·é‡æ–°æˆæƒ';
                } else if (error.message.includes('prize pool')) {
                    errorMessage = 'å¥–æ± æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                } else {
                    errorMessage = `äº¤æ˜“å¤±è´¥: ${error.reason || error.message}`;
                }
                
                alert('âŒ ' + errorMessage);
                console.log('ğŸ” é”™è¯¯è¯¦æƒ…:', error);
                console.log('ğŸ’¡ å»ºè®®: åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥é’±åŒ…è¿æ¥');
                resetGame();
            }
        }

        // è½¬ç›˜åŠ¨ç”»
        function startWheelAnimation() {
            // è½¬ç›˜ä¿æŒé™æ­¢ï¼Œåªè®©æŒ‡é’ˆæ—‹è½¬
            // å…ˆè®©æŒ‡é’ˆå¿«é€Ÿæ—‹è½¬å‡ åœˆ
            const randomSpins = 5 + Math.random() * 3; // 5-8åœˆ
            const baseRotation = randomSpins * 360;
            const pointer = document.querySelector('.wheel-pointer');
            pointer.style.transition = 'transform 3s cubic-bezier(0.25,0.1,0.25,1)';
            pointer.style.transform = `translateX(-50%) rotate(${baseRotation}deg)`;
            currentRotation = baseRotation;
        }

        function stopWheelAt(level) {
            // è½¬ç›˜åŒºåŸŸä»-30åº¦å¼€å§‹ï¼Œæ¯ä¸ªåŒºåŸŸ60åº¦
            // åŒºåŸŸ0ï¼š-30åº¦åˆ°30åº¦ï¼Œä¸­å¿ƒåœ¨0åº¦
            // åŒºåŸŸ1ï¼š30åº¦åˆ°90åº¦ï¼Œä¸­å¿ƒåœ¨60åº¦
            // åŒºåŸŸ2ï¼š90åº¦åˆ°150åº¦ï¼Œä¸­å¿ƒåœ¨120åº¦
            // åŒºåŸŸ3ï¼š150åº¦åˆ°210åº¦ï¼Œä¸­å¿ƒåœ¨180åº¦
            // åŒºåŸŸ4ï¼š210åº¦åˆ°270åº¦ï¼Œä¸­å¿ƒåœ¨240åº¦
            // åŒºåŸŸ5ï¼š270åº¦åˆ°330åº¦ï¼Œä¸­å¿ƒåœ¨300åº¦
            
            // æŒ‡é’ˆè¦æŒ‡å‘levelåŒºåŸŸçš„ä¸­å¿ƒ
            // åŒºåŸŸä¸­å¿ƒè§’åº¦ = level * 60 åº¦
            const targetAngle = level * 60;
            
            // è®¡ç®—æœ€ç»ˆæ—‹è½¬è§’åº¦ï¼Œä¿æŒä¹‹å‰çš„æ—‹è½¬åœˆæ•°ï¼Œåªè°ƒæ•´æœ€ç»ˆä½ç½®
            const finalRotation = currentRotation - (currentRotation % 360) + targetAngle;
            
            // ç¼“æ…¢ç²¾ç¡®åœåœ¨ç›®æ ‡ä½ç½®
            const pointer = document.querySelector('.wheel-pointer');
            pointer.style.transition = 'transform 1.5s cubic-bezier(0.25,0.1,0.25,1)';
            pointer.style.transform = `translateX(-50%) rotate(${finalRotation}deg)`;
            
            // é«˜äº®ä¸­å¥–åŒºåŸŸ
            setTimeout(() => drawSVGWheel(level), 1200);
            // ç§»é™¤é«˜äº®
            setTimeout(() => drawSVGWheel(-1), 4000);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(result) {
            const seg = CONFIG.SEGMENTS[result.level];
            const segmentLabel = t(`segments.${result.level}.label`);
            let html = `<div class='result-emoji'>${seg.icon}</div>`;
            if (result.isWin) {
                html += `<div class='result-title'>${t('congratulations')}</div><div class='result-amount'>${t('reward')}${seg.mult}å¥–åŠ±<br>${result.amount} ${gameState.selectedToken}</div>`;
            } else {
                html += `<div class='result-title'>${t('sorry')}</div>`;
            }
            resultContent.innerHTML = html;
            resultPopup.style.display = 'flex';
            setTimeout(() => { resultPopup.style.display = 'none'; }, 2600);
        }

        // åº†ç¥åŠ¨ç”»
        function createCelebration() {
            for (let i = 0; i < 40; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.backgroundColor = ['#ffe066', '#a259ff', '#4f8cff', '#ffb347', '#ff6b6b'][Math.floor(Math.random() * 5)];
                celebration.appendChild(confetti);
                setTimeout(() => { confetti.remove(); }, 2200);
            }
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState.isSpinning = false;
                
                // æ¸¸æˆç»“æŸååˆ·æ–°ä½™é¢
                setTimeout(() => {
                    updateBalance();
                }, 2000);
            playBtn.disabled = false;
            playBtn.innerHTML = t('play');
            
            // é‡ç½®æŒ‡é’ˆåˆ°åˆå§‹ä½ç½®
            const pointer = document.querySelector('.wheel-pointer');
            pointer.style.transition = 'transform 0.5s';
            pointer.style.transform = 'translateX(-50%) rotate(0deg)';
            
            ensureButtonVisible();
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            drawSVGWheel();
            ensureButtonVisible();
            addTouchEvents();
            updateLanguage();
            
            // åˆå§‹åŒ–æŒ‡é’ˆä½ç½®
            const pointer = document.querySelector('.wheel-pointer');
            if (pointer) {
                pointer.style.transform = 'translateX(-50%) rotate(0deg)';
            }
            
            // å®šæœŸæ£€æŸ¥æŒ‰é’®çŠ¶æ€
            setInterval(ensureButtonVisible, 1000);
            
            // è‡ªåŠ¨è¿æ¥é’±åŒ…ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
            if (window.ethereum && window.ethereum.selectedAddress) {
                setTimeout(connectWallet, 1000);
            }
        });

        // æ·»åŠ é¼ æ ‡äº‹ä»¶ä½œä¸ºå¤‡ç”¨
        connectBtn.addEventListener('click', connectWallet);
        playBtn.addEventListener('click', playGame);
        
        document.querySelectorAll('.token-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.token-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                gameState.selectedToken = e.target.dataset.token;
            });
        });
    </script>

                <!-- ğŸ”¥ ä¼˜åŒ–çš„é”€æ¯æ€»æ•°æ˜¾ç¤º - åº•éƒ¨å°å°ºå¯¸ -->
                <div class="burned-total-display-bottom" style="
                    position: fixed; 
                    bottom: 10px; 
                    left: 50%; 
                    transform: translateX(-50%);
                    background: linear-gradient(45deg, #ff6b6b, #ee5a52); 
                    padding: 8px 15px; 
                    border-radius: 20px; 
                    font-size: 12px;
                    text-align: center;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    z-index: 1000;
                    min-width: 200px;
                ">
                    <div style="color: white; font-weight: bold; margin-bottom: 3px;">ğŸ”¥ æ€»é”€æ¯</div>
                    <div style="display: flex; justify-content: space-between; color: #ffeb3b; font-size: 11px;">
                        <span>MAO: <span id="totalBurnedMAO">201,001,150</span></span>
                        <span>PI: <span id="totalBurnedPI">82,900</span></span>
                    </div>
                </div>
</body>
</html> 