<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 强制新合约测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
        }
        .status-box {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        .error {
            border-left-color: #ff4757;
            background: #2c1810;
        }
        .success {
            border-left-color: #2ed573;
            background: #1a2f1a;
        }
        .warning {
            border-left-color: #ffa502;
            background: #2f2410;
        }
        .button {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-size: 1.1em;
        }
        .button:hover {
            background: #5a67d8;
        }
        .code {
            background: #111;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .balance-display {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .balance-item {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }
        .balance-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2ed573;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 强制新合约测试页面</h1>
        
        <div class="status-box warning">
            <h3>⚠️ 重要说明</h3>
            <p>这个页面强制使用新合约，用于测试营销钱包分配是否正常。</p>
            <p>如果您看到旧合约地址，说明浏览器缓存没有完全清除！</p>
        </div>
        
        <div class="status-box" id="contractStatus">
            <h3>📋 当前合约状态</h3>
            <div id="contractInfo">检查中...</div>
        </div>
        
        <div class="status-box" id="walletStatus">
            <h3>💰 营销钱包状态</h3>
            <div id="walletInfo">检查中...</div>
        </div>
        
        <div class="status-box">
            <h3>🎮 游戏测试</h3>
            <p>连接钱包后，点击下方按钮进行测试游戏：</p>
            <button class="button" onclick="connectWallet()">🔗 连接钱包</button>
            <button class="button" onclick="testMAOGame()" id="testMAOBtn" disabled>🎯 测试MAO游戏</button>
            <button class="button" onclick="testPIGame()" id="testPIBtn" disabled>🎯 测试PI游戏</button>
        </div>
        
        <div class="status-box" id="gameResult">
            <h3>📊 游戏结果</h3>
            <div id="resultInfo">等待游戏测试...</div>
        </div>
        
        <div class="status-box">
            <h3>🔧 缓存清除检查</h3>
            <p>时间戳: <span id="timestamp"></span></p>
            <p>页面加载时间: <span id="loadTime"></span></p>
            <button class="button" onclick="forceReload()">🔄 强制重新加载</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // 强制使用新合约地址
        const CONTRACTS = {
            WHEEL_GAME: '0xB677DBcA76061E6301272c83179c8243A4eeB6A5', // 新合约
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };
        
        const MARKETING_WALLET = '0x861A48051eFaA1876D4B38904516C9F7bbCca36d';
        
        let provider;
        let signer;
        let gameContract;
        let userAddress;
        
        // 页面加载时显示时间戳
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        document.getElementById('loadTime').textContent = Date.now();
        
        // 检查合约状态
        async function checkContractStatus() {
            try {
                const rpcUrl = 'https://elves-core2.alvey.io/';
                const tempProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                
                const gameABI = [
                    "function marketingWallet() view returns (address)",
                    "function prizePool() view returns (address)"
                ];
                
                const contract = new ethers.Contract(CONTRACTS.WHEEL_GAME, gameABI, tempProvider);
                const marketingWallet = await contract.marketingWallet();
                const prizePool = await contract.prizePool();
                
                const statusDiv = document.getElementById('contractStatus');
                const infoDiv = document.getElementById('contractInfo');
                
                let html = `
                    <div class="code">
                        合约地址: ${CONTRACTS.WHEEL_GAME}<br>
                        营销钱包: ${marketingWallet}<br>
                        奖金池: ${prizePool}
                    </div>
                `;
                
                if (marketingWallet.toLowerCase() === MARKETING_WALLET.toLowerCase()) {
                    statusDiv.className = 'status-box success';
                    html += '<p>✅ 营销钱包配置正确！</p>';
                } else {
                    statusDiv.className = 'status-box error';
                    html += '<p>❌ 营销钱包配置错误！</p>';
                }
                
                infoDiv.innerHTML = html;
                
            } catch (error) {
                const statusDiv = document.getElementById('contractStatus');
                const infoDiv = document.getElementById('contractInfo');
                statusDiv.className = 'status-box error';
                infoDiv.innerHTML = `<p>❌ 检查合约失败: ${error.message}</p>`;
            }
        }
        
        // 检查钱包余额
        async function checkWalletBalance() {
            try {
                const rpcUrl = 'https://elves-core2.alvey.io/';
                const tempProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                
                const ERC20_ABI = ["function balanceOf(address owner) view returns (uint256)"];
                
                const maoToken = new ethers.Contract(CONTRACTS.MAO_TOKEN, ERC20_ABI, tempProvider);
                const piToken = new ethers.Contract(CONTRACTS.PI_TOKEN, ERC20_ABI, tempProvider);
                
                const maoBalance = await maoToken.balanceOf(MARKETING_WALLET);
                const piBalance = await piToken.balanceOf(MARKETING_WALLET);
                
                const walletDiv = document.getElementById('walletInfo');
                walletDiv.innerHTML = `
                    <div class="balance-display">
                        <div class="balance-item">
                            <div>MAO余额</div>
                            <div class="balance-value">${ethers.utils.formatEther(maoBalance)}</div>
                        </div>
                        <div class="balance-item">
                            <div>PI余额</div>
                            <div class="balance-value">${ethers.utils.formatEther(piBalance)}</div>
                        </div>
                    </div>
                    <div class="code">营销钱包: ${MARKETING_WALLET}</div>
                `;
                
                // 存储初始余额用于比较
                window.initialMAO = parseFloat(ethers.utils.formatEther(maoBalance));
                window.initialPI = parseFloat(ethers.utils.formatEther(piBalance));
                
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `<p>❌ 检查余额失败: ${error.message}</p>`;
            }
        }
        
        // 连接钱包
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // 检查网络
                    const network = await provider.getNetwork();
                    if (network.chainId !== 3797) {
                        alert('请切换到AlveyChain网络 (Chain ID: 3797)');
                        return;
                    }
                    
                    // 创建合约实例
                    const gameABI = [
                        "function playGame(uint8 tokenType, uint256 betAmount) external",
                        "function marketingWallet() view returns (address)"
                    ];
                    
                    gameContract = new ethers.Contract(CONTRACTS.WHEEL_GAME, gameABI, signer);
                    
                    // 启用游戏按钮
                    document.getElementById('testMAOBtn').disabled = false;
                    document.getElementById('testPIBtn').disabled = false;
                    
                    alert(`✅ 钱包连接成功！\n地址: ${userAddress}\n网络: AlveyChain`);
                    
                } else {
                    alert('❌ 请安装MetaMask钱包');
                }
            } catch (error) {
                alert(`❌ 连接钱包失败: ${error.message}`);
            }
        }
        
        // 测试MAO游戏
        async function testMAOGame() {
            try {
                const resultDiv = document.getElementById('resultInfo');
                resultDiv.innerHTML = '<p>🎮 正在进行MAO游戏测试...</p>';
                
                const betAmount = ethers.utils.parseEther('100'); // 100 MAO
                const tx = await gameContract.playGame(0, betAmount); // 0 = MAO
                
                resultDiv.innerHTML = '<p>⏳ 等待交易确认...</p>';
                
                const receipt = await tx.wait();
                
                resultDiv.innerHTML = `
                    <p>✅ MAO游戏完成！</p>
                    <div class="code">
                        交易哈希: ${receipt.transactionHash}<br>
                        区块号: ${receipt.blockNumber}<br>
                        Gas使用: ${receipt.gasUsed.toString()}
                    </div>
                    <p>🔍 检查营销钱包余额是否增加了20 MAO...</p>
                `;
                
                // 等待几秒后检查余额
                setTimeout(checkWalletBalance, 3000);
                
            } catch (error) {
                document.getElementById('resultInfo').innerHTML = `<p>❌ MAO游戏失败: ${error.message}</p>`;
            }
        }
        
        // 测试PI游戏
        async function testPIGame() {
            try {
                const resultDiv = document.getElementById('resultInfo');
                resultDiv.innerHTML = '<p>🎮 正在进行PI游戏测试...</p>';
                
                const betAmount = ethers.utils.parseEther('1000'); // 1000 PI
                const tx = await gameContract.playGame(1, betAmount); // 1 = PI
                
                resultDiv.innerHTML = '<p>⏳ 等待交易确认...</p>';
                
                const receipt = await tx.wait();
                
                resultDiv.innerHTML = `
                    <p>✅ PI游戏完成！</p>
                    <div class="code">
                        交易哈希: ${receipt.transactionHash}<br>
                        区块号: ${receipt.blockNumber}<br>
                        Gas使用: ${receipt.gasUsed.toString()}
                    </div>
                    <p>🔍 检查营销钱包余额是否增加了200 PI...</p>
                `;
                
                // 等待几秒后检查余额
                setTimeout(checkWalletBalance, 3000);
                
            } catch (error) {
                document.getElementById('resultInfo').innerHTML = `<p>❌ PI游戏失败: ${error.message}</p>`;
            }
        }
        
        // 强制重新加载
        function forceReload() {
            // 清除所有缓存并重新加载
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // 添加时间戳强制刷新
            window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
        }
        
        // 页面加载时执行检查
        window.addEventListener('load', function() {
            checkContractStatus();
            checkWalletBalance();
            
            // 显示重要提醒
            setTimeout(function() {
                alert('🔍 重要提醒：\n\n' +
                      '1. 请确保您已经清除了浏览器缓存\n' +
                      '2. 检查合约地址是否为新合约\n' +
                      '3. 连接钱包后进行测试游戏\n' +
                      '4. 观察营销钱包余额变化\n\n' +
                      '新合约地址: 0xB677DBcA76061E6301272c83179c8243A4eeB6A5');
            }, 1000);
        });
    </script>
</body>
</html> 