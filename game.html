<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>🎰 MAO Ultimate Wheel Game - v6.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #FFE066;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, var(--accent), #FF6B9D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .wheel {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #FF6B6B 0deg 180deg,
                #4ECDC4 180deg 259.2deg,
                #45B7D1 259.2deg 331.2deg,
                #96CEB4 331.2deg 351.6deg,
                #FFEAA7 351.6deg 357.36deg,
                #DDA0DD 357.36deg 360deg
            );
            transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid var(--accent);
            z-index: 10;
        }
        
        .spinning {
            animation: spin 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1800deg); }
        }
        
        .token-btn {
            @apply px-6 py-3 rounded-lg font-semibold transition-all;
        }
        
        .token-btn.active {
            @apply bg-gradient-to-r from-yellow-500 to-orange-500 text-black;
        }
        
        .token-btn:not(.active) {
            @apply text-blue-200 hover:bg-white hover:bg-opacity-10;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">🎰</div>
                <h1 class="text-xl font-bold gradient-text">MAO Ultimate Wheel</h1>
                <span class="text-xs bg-yellow-400 text-black px-2 py-1 rounded-full font-semibold">v6.0</span>
            </div>
            <div id="networkStatus" class="text-sm flex items-center">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                AlveyChain
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 pt-20">
        <div class="grid lg:grid-cols-4 gap-6">
            
            <!-- Wallet Panel -->
            <div class="space-y-6">
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">💼 钱包</h2>
                    
                    <div id="walletDisconnected" class="text-center">
                        <button id="connectBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:opacity-90 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                            连接 MetaMask
                        </button>
                    </div>

                    <div id="walletConnected" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-green-300">已连接</span>
                            <button id="disconnectBtn" class="text-xs text-red-300 hover:text-red-200">断开</button>
                        </div>
                        <div class="bg-black bg-opacity-20 rounded-lg p-3">
                            <div id="walletAddress" class="text-sm font-mono text-white break-all"></div>
                        </div>
                    </div>
                </div>

                <!-- Balances -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">💰 余额</h2>
                    
                    <div class="space-y-4">
                        <div class="glass rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">MAO</div>
                                    <div id="maoBalance" class="text-2xl font-bold text-yellow-400">0</div>
                                </div>
                                <div class="text-3xl">🐱</div>
                            </div>
                        </div>

                        <div class="glass rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">PI</div>
                                    <div id="piBalance" class="text-2xl font-bold text-green-400">0</div>
                                </div>
                                <div class="text-3xl">🥧</div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="refreshBtn" class="w-full mt-4 glass hover:bg-white hover:bg-opacity-10 text-white py-2 px-4 rounded-lg text-sm transition-all">
                        🔄 刷新
                    </button>
                </div>

                <!-- Stats -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">📊 统计</h2>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-blue-400" id="totalGames">0</div>
                            <div class="text-xs text-blue-200">总局数</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-green-400" id="winCount">0</div>
                            <div class="text-xs text-blue-200">中奖数</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-yellow-400" id="winRate">0%</div>
                            <div class="text-xs text-blue-200">中奖率</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-purple-400" id="totalReward">0</div>
                            <div class="text-xs text-blue-200">总奖励</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Area -->
            <div class="lg:col-span-2 space-y-6">
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-white text-center gradient-text">🎰 终极转盘</h2>
                    
                    <!-- Token Selection -->
                    <div class="flex justify-center mb-8">
                        <div class="glass rounded-xl p-1 flex">
                            <button id="selectMao" class="token-btn active">🐱 MAO (100)</button>
                            <button id="selectPi" class="token-btn">🥧 PI (1000)</button>
                        </div>
                    </div>
                    
                    <!-- Wheel -->
                    <div class="relative mx-auto mb-8" style="width: 300px; height: 300px;">
                        <div class="wheel-pointer"></div>
                        <div id="wheel" class="wheel">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                                    <div class="text-2xl">🎯</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Button -->
                    <div class="text-center">
                        <button id="spinBtn" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 disabled:from-gray-500 disabled:to-gray-600 text-black font-bold py-4 px-8 rounded-xl text-xl transition-all">
                            🎲 开始游戏
                        </button>
                        
                        <div id="gameStatus" class="mt-4 text-sm text-blue-200">
                            选择代币类型，点击开始游戏
                        </div>
                    </div>
                </div>
                
                <!-- Prize Table -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">🏆 奖励表</h2>
                    
                    <div class="grid grid-cols-3 gap-3 text-sm">
                        <div class="glass rounded-lg p-3 text-center bg-red-500 bg-opacity-20">
                            <div class="text-red-300 font-semibold">未中奖</div>
                            <div class="text-white">50%</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center bg-teal-500 bg-opacity-20">
                            <div class="text-teal-300 font-semibold">小奖</div>
                            <div class="text-white">22%</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center bg-blue-500 bg-opacity-20">
                            <div class="text-blue-300 font-semibold">中奖</div>
                            <div class="text-white">20%</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center bg-green-500 bg-opacity-20">
                            <div class="text-green-300 font-semibold">大奖</div>
                            <div class="text-white">7%</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center bg-yellow-500 bg-opacity-20">
                            <div class="text-yellow-300 font-semibold">超级</div>
                            <div class="text-white">0.8%</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center bg-purple-500 bg-opacity-20">
                            <div class="text-purple-300 font-semibold">终极</div>
                            <div class="text-white">0.2%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Panel -->
            <div class="space-y-6">
                <!-- History -->
                <div class="glass rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">📋 记录</h2>
                        <button id="clearHistory" class="text-xs text-red-300 hover:text-red-200">清空</button>
                    </div>

                    <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-center py-8 text-blue-200">
                            <div class="text-4xl mb-2">🎮</div>
                            <div class="text-sm">暂无记录</div>
                        </div>
                    </div>
                </div>

                <!-- Help -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">❓ 说明</h2>
                    
                    <div class="space-y-3 text-sm text-blue-200">
                        <div>1. 连接 MetaMask 钱包</div>
                        <div>2. 选择代币 (MAO/PI)</div>
                        <div>3. 点击"开始游戏"</div>
                        <div>4. 等待转盘结果</div>
                    </div>

                    <div class="mt-4 p-3 bg-yellow-500 bg-opacity-20 rounded-lg">
                        <div class="text-yellow-300 text-xs font-semibold">💡 保护机制</div>
                        <div class="text-yellow-200 text-xs">连续失败5次将触发保护</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="notification hidden">
        <div class="glass rounded-lg p-4">
            <div class="flex items-start">
                <div id="notificationIcon" class="mr-3 text-xl"></div>
                <div>
                    <div id="notificationTitle" class="font-semibold text-white"></div>
                    <div id="notificationMessage" class="text-sm text-blue-200"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative h-full flex items-center justify-center p-4">
            <div class="glass rounded-2xl p-8 max-w-md w-full text-center">
                <div id="resultIcon" class="text-6xl mb-4"></div>
                <h3 id="resultTitle" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="resultMessage" class="text-blue-200 mb-6"></p>
                <div id="resultReward" class="text-3xl font-bold gradient-text mb-6"></div>
                <button id="closeModal" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:opacity-90 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                    继续游戏
                </button>
            </div>
        </div>
    </div>

    <script>
        // App State
        const AppState = {
            wallet: { connected: false, address: null, provider: null, signer: null },
            game: { selectedToken: 'MAO', isSpinning: false, history: {} },
            contracts: {
                addresses: {
                    WHEEL_GAME: "0xB677DBcA76061E6301272c83179c8243A4eeB6A5",
                    MAO_TOKEN: "0x22f49bcb3dad370a9268ba3fca33cb037ca3d022",
                    PI_TOKEN: "0xfd4680e25e05b3435c7f698668d1ce80d2a9f444"
                },
                instances: { game: null, mao: null, pi: null }
            }
        };

        // Constants
        const MAX_UINT256 = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "event GamePlayed(address indexed player, address indexed token, uint256 amount, uint256 randomNumber, uint256 multiplier, uint256 reward, bool isWin)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)"
        ];

        // Utils
        const Utils = {
            formatAddress: (addr) => `${addr.slice(0, 6)}...${addr.slice(-4)}`,
            formatNumber: (num) => Math.floor(num).toLocaleString(),
            showNotification: (title, message, type = 'info') => {
                const notification = document.getElementById('notification');
                const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
                
                document.getElementById('notificationIcon').textContent = icons[type];
                document.getElementById('notificationTitle').textContent = title;
                document.getElementById('notificationMessage').textContent = message;
                
                notification.classList.remove('hidden');
                setTimeout(() => notification.classList.add('hidden'), 5000);
            }
        };

        // Wallet Manager
        const WalletManager = {
            async connect() {
                try {
                    if (!window.ethereum) throw new Error('请安装 MetaMask');

                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (!accounts.length) return;

                    AppState.wallet.address = accounts[0];
                    AppState.wallet.provider = new ethers.providers.Web3Provider(window.ethereum);
                    AppState.wallet.signer = AppState.wallet.provider.getSigner();
                    AppState.wallet.connected = true;

                    this.initContracts();
                    this.updateUI();
                    await BalanceManager.update();

                    Utils.showNotification('成功', '钱包连接成功！', 'success');
                } catch (error) {
                    Utils.showNotification('错误', error.message, 'error');
                }
            },

            initContracts() {
                const { addresses } = AppState.contracts;
                AppState.contracts.instances = {
                    game: new ethers.Contract(addresses.WHEEL_GAME, WHEEL_GAME_ABI, AppState.wallet.signer),
                    mao: new ethers.Contract(addresses.MAO_TOKEN, ERC20_ABI, AppState.wallet.signer),
                    pi: new ethers.Contract(addresses.PI_TOKEN, ERC20_ABI, AppState.wallet.signer)
                };
            },

            updateUI() {
                const disconnected = document.getElementById('walletDisconnected');
                const connected = document.getElementById('walletConnected');
                
                if (AppState.wallet.connected) {
                    disconnected.classList.add('hidden');
                    connected.classList.remove('hidden');
                    document.getElementById('walletAddress').textContent = AppState.wallet.address;
                } else {
                    disconnected.classList.remove('hidden');
                    connected.classList.add('hidden');
                }
            },

            disconnect() {
                AppState.wallet = { connected: false, address: null, provider: null, signer: null };
                this.updateUI();
                BalanceManager.clear();
                Utils.showNotification('提示', '钱包已断开', 'info');
            }
        };

        // Balance Manager
        const BalanceManager = {
            async update() {
                if (!AppState.wallet.connected) return;

                try {
                    const { mao, pi } = AppState.contracts.instances;
                    const [maoBalance, piBalance] = await Promise.all([
                        mao.balanceOf(AppState.wallet.address),
                        pi.balanceOf(AppState.wallet.address)
                    ]);

                    document.getElementById('maoBalance').textContent = Utils.formatNumber(ethers.utils.formatEther(maoBalance));
                    document.getElementById('piBalance').textContent = Utils.formatNumber(ethers.utils.formatEther(piBalance));
                } catch (error) {
                    console.error('更新余额失败:', error);
                }
            },

            clear() {
                document.getElementById('maoBalance').textContent = '0';
                document.getElementById('piBalance').textContent = '0';
            }
        };

        // Game Manager
        const GameManager = {
            selectToken(token) {
                AppState.game.selectedToken = token;
                this.updateTokenSelection();
            },

            updateTokenSelection() {
                const maoBtn = document.getElementById('selectMao');
                const piBtn = document.getElementById('selectPi');

                if (AppState.game.selectedToken === 'MAO') {
                    maoBtn.className = 'token-btn active';
                    piBtn.className = 'token-btn';
                } else {
                    maoBtn.className = 'token-btn';
                    piBtn.className = 'token-btn active';
                }
            },

            async startGame() {
                if (!AppState.wallet.connected) {
                    Utils.showNotification('提示', '请先连接钱包', 'warning');
                    return;
                }

                if (AppState.game.isSpinning) return;

                try {
                    AppState.game.isSpinning = true;
                    this.updateGameUI(true);

                    const { selectedToken } = AppState.game;
                    const { game, mao, pi } = AppState.contracts.instances;
                    const tokenContract = selectedToken === 'MAO' ? mao : pi;
                    const amount = selectedToken === 'MAO' ? 
                        ethers.utils.parseEther('100') : 
                        ethers.utils.parseEther('1000');
                    
                    // Check balance
                    const balance = await tokenContract.balanceOf(AppState.wallet.address);
                    if (balance.lt(amount)) {
                        throw new Error(`${selectedToken}余额不足`);
                    }

                    // Check allowance and approve if needed
                    const allowance = await tokenContract.allowance(
                        AppState.wallet.address, 
                        AppState.contracts.addresses.WHEEL_GAME
                    );
                    
                    if (allowance.lt(amount)) {
                        this.setGameStatus('正在授权代币...', 'loading');
                        Utils.showNotification('授权', '正在进行无限授权，以后无需重复授权', 'info');
                        
                        // 使用最大值进行无限授权
                        const approveTx = await tokenContract.approve(
                            AppState.contracts.addresses.WHEEL_GAME, 
                            MAX_UINT256  // 无限授权
                        );
                        await approveTx.wait();
                        
                        Utils.showNotification('成功', '无限授权完成！', 'success');
                    }

                    // Start wheel animation
                    this.startWheelAnimation();
                    this.setGameStatus('转盘转动中...', 'loading');
                    
                    // Send transaction
                    const tx = selectedToken === 'MAO' ? 
                        await game.playMAOGame() : 
                        await game.playPIGame();
                    
                    const receipt = await tx.wait();
                    const gameEvent = receipt.events.find(e => e.event === 'GamePlayed');
                    
                    if (gameEvent) {
                        const { randomNumber, multiplier, reward, isWin } = gameEvent.args;
                        
                        setTimeout(() => {
                            this.showResult({
                                randomNumber: randomNumber.toNumber(),
                                multiplier: multiplier.toNumber(),
                                reward: ethers.utils.formatEther(reward),
                                isWin,
                                txHash: tx.hash
                            });
                        }, 4000);
                    }

                } catch (error) {
                    Utils.showNotification('游戏失败', error.message, 'error');
                    this.stopWheelAnimation();
                    AppState.game.isSpinning = false;
                    this.updateGameUI(false);
                }
            },

            setGameStatus(message, type = 'info') {
                const statusEl = document.getElementById('gameStatus');
                let iconHtml = '';
                
                switch (type) {
                    case 'loading':
                        iconHtml = '<div class="loading-spinner inline-block mr-2"></div>';
                        break;
                    case 'success':
                        iconHtml = '✅ ';
                        break;
                    case 'error':
                        iconHtml = '❌ ';
                        break;
                    default:
                        iconHtml = 'ℹ️ ';
                }
                
                statusEl.innerHTML = `${iconHtml}${message}`;
            },

            startWheelAnimation() {
                const wheel = document.getElementById('wheel');
                wheel.classList.add('spinning');
            },

            stopWheelAnimation() {
                const wheel = document.getElementById('wheel');
                wheel.classList.remove('spinning');
            },

            showResult(result) {
                this.stopWheelAnimation();
                AppState.game.isSpinning = false;
                this.updateGameUI(false);

                const modal = document.getElementById('resultModal');
                const icon = document.getElementById('resultIcon');
                const title = document.getElementById('resultTitle');
                const message = document.getElementById('resultMessage');
                const reward = document.getElementById('resultReward');

                if (result.isWin) {
                    icon.textContent = '🎉';
                    title.textContent = '恭喜中奖！';
                    message.textContent = `获得 ${result.multiplier}倍 奖励！`;
                    reward.textContent = `+${result.reward} ${AppState.game.selectedToken}`;
                } else {
                    icon.textContent = '😔';
                    title.textContent = '很遗憾';
                    message.textContent = '这次没有中奖';
                    reward.textContent = '未中奖';
                }

                modal.classList.remove('hidden');
                setTimeout(() => BalanceManager.update(), 1000);
            },

            updateGameUI(isPlaying) {
                const spinBtn = document.getElementById('spinBtn');
                if (isPlaying) {
                    spinBtn.disabled = true;
                    spinBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                } else {
                    spinBtn.disabled = false;
                    spinBtn.innerHTML = '🎲 开始游戏';
                }
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectBtn').addEventListener('click', WalletManager.connect);
            document.getElementById('disconnectBtn').addEventListener('click', WalletManager.disconnect);
            document.getElementById('selectMao').addEventListener('click', () => GameManager.selectToken('MAO'));
            document.getElementById('selectPi').addEventListener('click', () => GameManager.selectToken('PI'));
            document.getElementById('spinBtn').addEventListener('click', GameManager.startGame);
            document.getElementById('refreshBtn').addEventListener('click', BalanceManager.update);
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('resultModal').classList.add('hidden');
            });

            GameManager.updateTokenSelection();

            if (window.ethereum && window.ethereum.selectedAddress) {
                WalletManager.connect();
            }
        });
    </script>
</body>
</html> 