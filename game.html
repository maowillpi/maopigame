<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>🎰 MAO转盘游戏 - 修复版 v5.1</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #FFE066, #FF6B9D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .professional-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B6B 0deg 60deg,   /* 安慰奖 */
                #4ECDC4 60deg 120deg, /* 小奖 */
                #45B7D1 120deg 180deg, /* 中奖 */
                #96CEB4 180deg 240deg, /* 大奖 */
                #FFEAA7 240deg 300deg, /* 超级大奖 */
                #DDA0DD 300deg 360deg  /* 终极大奖 */
            );
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #FFE066;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .spinning {
            animation: spin 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1800deg); }
        }
        
        .transaction-item {
            transition: all 0.3s ease;
        }
        
        .transaction-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #FFE066;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div class="fixed top-0 left-0 right-0 z-50 glass-effect">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">🎰</div>
                <h1 class="text-xl font-bold gradient-text">MAO转盘游戏</h1>
            </div>
            <div class="flex items-center space-x-3">
                <div id="networkStatus" class="text-sm">
                    <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                    AlveyChain
                </div>
                <button id="settingsBtn" class="p-2 rounded-lg glass-effect hover:bg-white hover:bg-opacity-10 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 pt-20">
        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- 左侧：钱包和余额 -->
            <div class="space-y-6">
                <!-- 钱包连接 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">💼 钱包连接</h2>
                    
                    <div id="walletDisconnected" class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <button id="connectWalletBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105">
                            连接MetaMask钱包
                        </button>
                        <p class="text-sm text-blue-200 mt-3">
                            请确保已安装MetaMask钱包扩展
                        </p>
                    </div>

                    <div id="walletConnected" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                <span class="text-sm text-green-300">已连接</span>
                            </div>
                            <button id="disconnectBtn" class="text-xs text-red-300 hover:text-red-200">
                                断开连接
                            </button>
                        </div>
                        <div class="bg-black bg-opacity-20 rounded-lg p-3">
                            <div class="text-xs text-blue-200 mb-1">钱包地址</div>
                            <div id="walletAddress" class="text-sm font-mono text-white break-all"></div>
                        </div>
                    </div>
                </div>

                <!-- 代币余额 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">💰 代币余额</h2>
                    
                    <div class="space-y-4">
                        <div class="stats-card rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">MAO代币</div>
                                    <div id="maoBalance" class="text-2xl font-bold text-yellow-400">0</div>
                                </div>
                                <div class="text-3xl">🐱</div>
                            </div>
                            <div class="text-xs text-blue-300 mt-2">
                                游戏消耗：100 MAO
                            </div>
                        </div>

                        <div class="stats-card rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">PI代币</div>
                                    <div id="piBalance" class="text-2xl font-bold text-green-400">0</div>
                                </div>
                                <div class="text-3xl">🥧</div>
                            </div>
                            <div class="text-xs text-blue-300 mt-2">
                                游戏消耗：1000 PI
                            </div>
                        </div>
                    </div>

                    <button id="refreshBalanceBtn" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm transition-all">
                        🔄 刷新余额
                    </button>
                </div>

                <!-- 游戏统计 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">📊 游戏统计</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="totalGames">0</div>
                            <div class="text-xs text-blue-200">总游戏数</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400" id="winCount">0</div>
                            <div class="text-xs text-blue-200">中奖次数</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="winRate">0%</div>
                            <div class="text-xs text-blue-200">中奖率</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="totalReward">0</div>
                            <div class="text-xs text-blue-200">总奖励</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中间：游戏区域 -->
            <div class="space-y-6">
                <!-- 转盘游戏 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-6 text-white text-center">🎰 转盘游戏</h2>
                    
                    <!-- 代币选择 -->
                    <div class="flex justify-center mb-6">
                        <div class="bg-black bg-opacity-20 rounded-xl p-1 flex">
                            <button id="selectMaoBtn" class="token-btn active px-6 py-3 rounded-lg text-sm font-semibold transition-all">
                                🐱 MAO (100)
                            </button>
                            <button id="selectPiBtn" class="token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all">
                                🥧 PI (1000)
                            </button>
                        </div>
                    </div>

                    <!-- 转盘 -->
                    <div class="relative mx-auto mb-6" style="width: 300px; height: 300px;">
                        <div class="wheel-pointer"></div>
                        <div id="wheel" class="professional-wheel w-full h-full relative overflow-hidden">
                            <!-- 转盘扇形区域 -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
                                    <div class="text-2xl">🎯</div>
                                </div>
                            </div>
                            
                            <!-- 奖励标签 -->
                            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white">安慰奖</div>
                            <div class="absolute top-1/2 right-4 transform -translate-y-1/2 text-xs font-bold text-white">小奖</div>
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white">中奖</div>
                            <div class="absolute top-1/2 left-4 transform -translate-y-1/2 text-xs font-bold text-white">大奖</div>
                            <div class="absolute top-16 right-16 text-xs font-bold text-white">超级</div>
                            <div class="absolute top-16 left-16 text-xs font-bold text-white">终极</div>
                        </div>
                    </div>

                    <!-- 游戏按钮 -->
                    <div class="text-center">
                        <button id="spinBtn" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed">
                            🎲 开始游戏
                        </button>
                        
                        <div id="gameStatus" class="mt-4 text-center">
                            <div class="text-sm text-blue-200">
                                选择代币类型，点击开始游戏
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 奖励预览 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">🏆 奖励预览</h2>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-red-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-red-300 font-semibold">安慰奖 (10%)</div>
                            <div class="text-white" id="consolationReward">0.5倍</div>
                        </div>
                        <div class="bg-teal-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-teal-300 font-semibold">小奖 (25%)</div>
                            <div class="text-white" id="smallReward">1倍</div>
                        </div>
                        <div class="bg-blue-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-blue-300 font-semibold">中奖 (35%)</div>
                            <div class="text-white" id="mediumReward">2倍</div>
                        </div>
                        <div class="bg-green-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-green-300 font-semibold">大奖 (20%)</div>
                            <div class="text-white" id="bigReward">5倍</div>
                        </div>
                        <div class="bg-yellow-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-yellow-300 font-semibold">超级 (8%)</div>
                            <div class="text-white" id="superReward">10倍</div>
                        </div>
                        <div class="bg-purple-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-purple-300 font-semibold">终极 (2%)</div>
                            <div class="text-white" id="ultimateReward">50倍</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：交易记录 -->
            <div class="space-y-6">
                <!-- 交易记录 -->
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">📋 我的记录</h2>
                        <button id="clearHistoryBtn" class="text-xs text-red-300 hover:text-red-200">
                            清空记录
                        </button>
                    </div>
                    
                    <div id="transactionHistory" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                        <div class="text-center py-8 text-blue-200">
                            <div class="text-4xl mb-2">🎮</div>
                            <div class="text-sm">暂无游戏记录</div>
                            <div class="text-xs opacity-75 mt-1">开始您的第一次游戏吧！</div>
                        </div>
                    </div>
                </div>

                <!-- 最近活动 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">⚡ 实时活动</h2>
                    
                    <div id="recentActivity" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        <div class="text-center py-4 text-blue-200">
                            <div class="text-sm">暂无活动</div>
                        </div>
                    </div>
                </div>

                <!-- 帮助信息 -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">❓ 游戏说明</h2>
                    
                    <div class="space-y-3 text-sm text-blue-200">
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">1.</div>
                            <div>选择代币类型（MAO或PI）</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">2.</div>
                            <div>点击"开始游戏"按钮</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">3.</div>
                            <div>等待转盘停止获得奖励</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">4.</div>
                            <div>奖励自动发放到钱包</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-500 bg-opacity-20 rounded-lg">
                        <div class="text-yellow-300 text-xs font-semibold mb-1">💡 温馨提示</div>
                        <div class="text-yellow-200 text-xs">
                            连续失败5次将触发保护机制，确保下次中奖！
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="notification hidden">
        <div class="glass-effect rounded-lg p-4 max-w-sm">
            <div class="flex items-start">
                <div id="notificationIcon" class="mr-3 mt-0.5"></div>
                <div>
                    <div id="notificationTitle" class="font-semibold text-white"></div>
                    <div id="notificationMessage" class="text-sm text-blue-200 mt-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div id="resultModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-filter backdrop-blur-sm"></div>
        <div class="relative h-full flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-8 max-w-md w-full text-center slide-in">
                <div id="resultIcon" class="text-6xl mb-4"></div>
                <h3 id="resultTitle" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="resultMessage" class="text-blue-200 mb-6"></p>
                <div id="resultReward" class="text-3xl font-bold gradient-text mb-6"></div>
                <button id="closeModalBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                    继续游戏
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentAccount = null;
        let selectedToken = 'MAO';
        let provider = null;
        let signer = null;
        let gameContract = null;
        let maoContract = null;
        let piContract = null;
        let gameHistory = {}; // 改为对象，按钱包地址存储
        let isSpinning = false;

        // 智能合约配置
        const CONTRACTS = {
            WHEEL_GAME: "0xB677DBcA76061E6301272c83179c8243A4eeB6A5",
            MAO_TOKEN: "0x22f49bcb3dad370a9268ba3fca33cb037ca3d022",
            PI_TOKEN: "0xfd4680e25e05b3435c7f698668d1ce80d2a9f444"
        };

        const ALVEY_NETWORK = {
            chainId: '0xED5',
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: ['https://elves-core1.alvey.io/'],
            blockExplorerUrls: ['https://alveyscan.com/'],
        };

        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "function getConsecutiveLosses(address player) external view returns (uint256)",
            "event GamePlayed(address indexed player, address indexed token, uint256 amount, uint256 randomNumber, uint256 multiplier, uint256 reward, bool isWin)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)"
        ];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadGameHistory();
        });

        // 初始化应用
        async function initializeApp() {
            console.log('🚀 初始化专业版游戏界面...');
            
            // 检查钱包连接状态
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
            
            updateTokenSelection();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 钱包连接
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
            
            // 代币选择
            document.getElementById('selectMaoBtn').addEventListener('click', () => selectToken('MAO'));
            document.getElementById('selectPiBtn').addEventListener('click', () => selectToken('PI'));
            
            // 游戏按钮
            document.getElementById('spinBtn').addEventListener('click', startGame);
            
            // 其他按钮
            document.getElementById('refreshBalanceBtn').addEventListener('click', updateBalances);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            
            // 钱包账户变化监听
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showNotification('错误', '请安装MetaMask钱包', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) return;

                currentAccount = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // 检查网络
                const network = await provider.getNetwork();
                if (network.chainId !== 3797) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: ALVEY_NETWORK.chainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [ALVEY_NETWORK],
                            });
                        }
                    }
                }

                // 初始化合约
                gameContract = new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, signer);
                maoContract = new ethers.Contract(CONTRACTS.MAO_TOKEN, ERC20_ABI, signer);
                piContract = new ethers.Contract(CONTRACTS.PI_TOKEN, ERC20_ABI, signer);

                // 更新UI
                updateWalletUI();
                await updateBalances();
                loadGameHistory();

                showNotification('成功', '钱包连接成功！', 'success');
                addActivity('钱包已连接', `地址: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`);

            } catch (error) {
                console.error('连接钱包失败:', error);
                showNotification('错误', '连接钱包失败', 'error');
            }
        }

        // 断开钱包连接
        function disconnectWallet() {
            currentAccount = null;
            provider = null;
            signer = null;
            gameContract = null;
            maoContract = null;
            piContract = null;
            
            updateWalletUI();
            document.getElementById('maoBalance').textContent = '0';
            document.getElementById('piBalance').textContent = '0';
            clearStats();
            
            showNotification('提示', '钱包已断开连接', 'info');
        }

        // 处理账户变化
        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                await updateBalances();
                loadGameHistory();
                updateWalletUI();
                addActivity('账户切换', `新地址: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`);
            }
        }

        // 更新钱包UI
        function updateWalletUI() {
            const disconnected = document.getElementById('walletDisconnected');
            const connected = document.getElementById('walletConnected');
            const walletAddress = document.getElementById('walletAddress');

            if (currentAccount) {
                disconnected.classList.add('hidden');
                connected.classList.remove('hidden');
                walletAddress.textContent = currentAccount;
            } else {
                disconnected.classList.remove('hidden');
                connected.classList.add('hidden');
            }
        }

        // 选择代币
        function selectToken(token) {
            selectedToken = token;
            updateTokenSelection();
        }

        // 更新代币选择UI
        function updateTokenSelection() {
            const maoBtn = document.getElementById('selectMaoBtn');
            const piBtn = document.getElementById('selectPiBtn');

            maoBtn.classList.toggle('active', selectedToken === 'MAO');
            piBtn.classList.toggle('active', selectedToken === 'PI');

            // 更新按钮样式
            if (selectedToken === 'MAO') {
                maoBtn.className = 'token-btn active bg-yellow-600 text-white px-6 py-3 rounded-lg text-sm font-semibold transition-all';
                piBtn.className = 'token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all text-blue-200 hover:bg-white hover:bg-opacity-10';
            } else {
                piBtn.className = 'token-btn active bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-semibold transition-all';
                maoBtn.className = 'token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all text-blue-200 hover:bg-white hover:bg-opacity-10';
            }
        }

        // 更新余额
        async function updateBalances() {
            if (!currentAccount || !maoContract || !piContract) return;

            try {
                const maoBalance = await maoContract.balanceOf(currentAccount);
                const piBalance = await piContract.balanceOf(currentAccount);

                document.getElementById('maoBalance').textContent = Math.floor(ethers.utils.formatEther(maoBalance)).toLocaleString();
                document.getElementById('piBalance').textContent = Math.floor(ethers.utils.formatEther(piBalance)).toLocaleString();
            } catch (error) {
                console.error('更新余额失败:', error);
            }
        }

        // 开始游戏
        async function startGame() {
            if (!currentAccount) {
                showNotification('提示', '请先连接钱包', 'warning');
                return;
            }

            if (isSpinning) return;

            try {
                isSpinning = true;
                updateGameUI(true);

                const tokenContract = selectedToken === 'MAO' ? maoContract : piContract;
                const tokenAddress = selectedToken === 'MAO' ? CONTRACTS.MAO_TOKEN : CONTRACTS.PI_TOKEN;
                const amount = selectedToken === 'MAO' ? ethers.utils.parseEther('100') : ethers.utils.parseEther('1000');

                // 检查余额
                const balance = await tokenContract.balanceOf(currentAccount);
                if (balance.lt(amount)) {
                    throw new Error(`${selectedToken}余额不足`);
                }

                // 检查授权
                const allowance = await tokenContract.allowance(currentAccount, CONTRACTS.WHEEL_GAME);
                if (allowance.lt(amount)) {
                    showGameStatus('正在授权代币...', 'loading');
                    const approveTx = await tokenContract.approve(CONTRACTS.WHEEL_GAME, ethers.utils.parseEther('1000000'));
                    await approveTx.wait();
                }

                // 开始转盘动画
                startWheelAnimation();
                showGameStatus('转盘转动中...', 'loading');
                addActivity('游戏开始', `使用 ${selectedToken === 'MAO' ? '100 MAO' : '1000 PI'}`);

                // 发送游戏交易
                const tx = selectedToken === 'MAO' ? await gameContract.playMAOGame() : await gameContract.playPIGame();
                const receipt = await tx.wait();

                // 解析游戏结果
                const gameEvent = receipt.events.find(event => event.event === 'GamePlayed');
                if (gameEvent) {
                    const { randomNumber, multiplier, reward, isWin } = gameEvent.args;
                    
                    setTimeout(() => {
                        showGameResult({
                            randomNumber: randomNumber.toNumber(),
                            multiplier: multiplier.toNumber(),
                            reward: ethers.utils.formatEther(reward),
                            isWin,
                            txHash: tx.hash
                        });
                    }, 4000);
                } else {
                    throw new Error('无法获取游戏结果');
                }

            } catch (error) {
                console.error('游戏失败:', error);
                showNotification('游戏失败', error.message, 'error');
                stopWheelAnimation();
                isSpinning = false;
                updateGameUI(false);
            }
        }

        // 开始转盘动画
        function startWheelAnimation() {
            const wheel = document.getElementById('wheel');
            const randomRotation = 1800 + Math.random() * 1800; // 5-10圈
            wheel.style.transform = `rotate(${randomRotation}deg)`;
        }

        // 停止转盘动画
        function stopWheelAnimation() {
            const wheel = document.getElementById('wheel');
            wheel.style.transform = 'rotate(0deg)';
        }

        // 显示游戏结果
        function showGameResult(result) {
            stopWheelAnimation();
            isSpinning = false;
            updateGameUI(false);

            // 保存游戏记录
            saveGameRecord(result);

            // 显示结果模态框
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const reward = document.getElementById('resultReward');

            if (result.isWin) {
                icon.textContent = '🎉';
                title.textContent = '恭喜中奖！';
                message.textContent = `您获得了 ${result.multiplier}倍 奖励！`;
                reward.textContent = `+${result.reward} ${selectedToken}`;
                addActivity('游戏中奖', `获得 ${result.reward} ${selectedToken}`);
            } else {
                icon.textContent = '😔';
                title.textContent = '很遗憾';
                message.textContent = '这次没有中奖，下次一定会更好！';
                reward.textContent = '未中奖';
                addActivity('游戏结束', '未中奖');
            }

            modal.classList.remove('hidden');

            // 更新余额和统计
            setTimeout(() => {
                updateBalances();
                updateStats();
            }, 1000);
        }

        // 更新游戏UI状态
        function updateGameUI(isPlaying) {
            const spinBtn = document.getElementById('spinBtn');
            
            if (isPlaying) {
                spinBtn.disabled = true;
                spinBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            } else {
                spinBtn.disabled = false;
                spinBtn.innerHTML = '🎲 开始游戏';
            }
        }

        // 显示游戏状态
        function showGameStatus(message, type = 'info') {
            const statusEl = document.getElementById('gameStatus');
            let iconClass = '';
            
            switch (type) {
                case 'loading':
                    iconClass = '<div class="loading-spinner inline-block mr-2"></div>';
                    break;
                case 'success':
                    iconClass = '✅ ';
                    break;
                case 'error':
                    iconClass = '❌ ';
                    break;
                default:
                    iconClass = 'ℹ️ ';
            }
            
            statusEl.innerHTML = `<div class="text-sm text-blue-200">${iconClass}${message}</div>`;
        }

        // 加载游戏历史记录（按钱包地址）
        function loadGameHistory() {
            try {
                const savedHistory = localStorage.getItem('mao_game_history_v2');
                if (savedHistory) {
                    gameHistory = JSON.parse(savedHistory);
                } else {
                    gameHistory = {};
                }
            } catch (error) {
                console.error('加载游戏历史失败:', error);
                gameHistory = {};
            }
            
            updateHistoryDisplay();
            updateStats();
        }

        // 保存游戏记录（按钱包地址）
        function saveGameRecord(result) {
            if (!currentAccount) return;

            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-CN'),
                token: selectedToken,
                cost: selectedToken === 'MAO' ? 100 : 1000,
                multiplier: result.multiplier,
                reward: result.reward,
                isWin: result.isWin,
                txHash: result.txHash
            };

            // 为当前钱包地址创建记录数组
            if (!gameHistory[currentAccount]) {
                gameHistory[currentAccount] = [];
            }

            gameHistory[currentAccount].unshift(record);

            // 只保留最近50条记录
            if (gameHistory[currentAccount].length > 50) {
                gameHistory[currentAccount] = gameHistory[currentAccount].slice(0, 50);
            }

            // 保存到本地存储
            try {
                localStorage.setItem('mao_game_history_v2', JSON.stringify(gameHistory));
                updateHistoryDisplay();
                updateStats();
            } catch (error) {
                console.error('保存游戏历史失败:', error);
            }
        }

        // 更新历史记录显示（只显示当前钱包的记录）
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('transactionHistory');
            
            if (!currentAccount || !gameHistory[currentAccount] || gameHistory[currentAccount].length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-blue-200">
                        <div class="text-4xl mb-2">🎮</div>
                        <div class="text-sm">暂无游戏记录</div>
                        <div class="text-xs opacity-75 mt-1">开始您的第一次游戏吧！</div>
                    </div>
                `;
                return;
            }

            const records = gameHistory[currentAccount];
            historyContainer.innerHTML = records.map(record => {
                const resultClass = record.isWin ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400';
                const resultIcon = record.isWin ? '🎉' : '😔';
                const resultText = record.isWin ? 
                    `中奖 ${record.multiplier}倍，获得 ${record.reward} ${record.token}` : 
                    '未中奖';

                return `
                    <div class="transaction-item glass-effect rounded-lg p-3 ${resultClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${resultIcon}</span>
                                <div>
                                    <div class="text-sm font-semibold text-white">${record.token} 游戏</div>
                                    <div class="text-xs text-blue-300">${record.timestamp}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-yellow-400">-${record.cost}</div>
                                ${record.isWin ? `<div class="text-sm font-semibold text-green-400">+${record.reward}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-xs text-blue-200">${resultText}</div>
                        ${record.txHash ? `<div class="text-xs text-blue-400 mt-1 break-all">TX: ${record.txHash.slice(0, 10)}...${record.txHash.slice(-6)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // 更新统计数据（只统计当前钱包）
        function updateStats() {
            if (!currentAccount || !gameHistory[currentAccount]) {
                clearStats();
                return;
            }

            const records = gameHistory[currentAccount];
            const totalGames = records.length;
            const winCount = records.filter(record => record.isWin).length;
            const winRate = totalGames > 0 ? Math.round((winCount / totalGames) * 100) : 0;
            const totalReward = records
                .filter(record => record.isWin)
                .reduce((sum, record) => sum + parseFloat(record.reward), 0);

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('winCount').textContent = winCount;
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalReward').textContent = totalReward.toFixed(0);
        }

        // 清空统计数据
        function clearStats() {
            document.getElementById('totalGames').textContent = '0';
            document.getElementById('winCount').textContent = '0';
            document.getElementById('winRate').textContent = '0%';
            document.getElementById('totalReward').textContent = '0';
        }

        // 清空历史记录
        function clearHistory() {
            if (!currentAccount) return;

            if (confirm('确定要清空当前钱包的游戏记录吗？')) {
                if (gameHistory[currentAccount]) {
                    delete gameHistory[currentAccount];
                }
                localStorage.setItem('mao_game_history_v2', JSON.stringify(gameHistory));
                updateHistoryDisplay();
                updateStats();
                showNotification('成功', '记录已清空', 'success');
            }
        }

        // 添加活动记录
        function addActivity(title, description) {
            const activityContainer = document.getElementById('recentActivity');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            
            const activityItem = document.createElement('div');
            activityItem.className = 'glass-effect rounded-lg p-3 mb-2 slide-in';
            activityItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-sm font-semibold text-white">${title}</div>
                        <div class="text-xs text-blue-300">${description}</div>
                    </div>
                    <div class="text-xs text-blue-400">${timestamp}</div>
                </div>
            `;

            if (activityContainer.querySelector('.text-center')) {
                activityContainer.innerHTML = '';
            }

            activityContainer.insertBefore(activityItem, activityContainer.firstChild);

            // 只保留最近10条活动
            const activities = activityContainer.children;
            if (activities.length > 10) {
                activityContainer.removeChild(activities[activities.length - 1]);
            }
        }

        // 显示通知
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            icon.textContent = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        // 点击模态框外部关闭
        document.getElementById('resultModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html> 