<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ - ä¿®å¤ç‰ˆ v5.1</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #FFE066, #FF6B9D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .professional-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B6B 0deg 60deg,   /* å®‰æ…°å¥– */
                #4ECDC4 60deg 120deg, /* å°å¥– */
                #45B7D1 120deg 180deg, /* ä¸­å¥– */
                #96CEB4 180deg 240deg, /* å¤§å¥– */
                #FFEAA7 240deg 300deg, /* è¶…çº§å¤§å¥– */
                #DDA0DD 300deg 360deg  /* ç»ˆæå¤§å¥– */
            );
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #FFE066;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .spinning {
            animation: spin 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1800deg); }
        }
        
        .transaction-item {
            transition: all 0.3s ease;
        }
        
        .transaction-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #FFE066;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div class="fixed top-0 left-0 right-0 z-50 glass-effect">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">ğŸ°</div>
                <h1 class="text-xl font-bold gradient-text">MAOè½¬ç›˜æ¸¸æˆ</h1>
            </div>
            <div class="flex items-center space-x-3">
                <div id="networkStatus" class="text-sm">
                    <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                    AlveyChain
                </div>
                <button id="settingsBtn" class="p-2 rounded-lg glass-effect hover:bg-white hover:bg-opacity-10 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 pt-20">
        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- å·¦ä¾§ï¼šé’±åŒ…å’Œä½™é¢ -->
            <div class="space-y-6">
                <!-- é’±åŒ…è¿æ¥ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">ğŸ’¼ é’±åŒ…è¿æ¥</h2>
                    
                    <div id="walletDisconnected" class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <button id="connectWalletBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105">
                            è¿æ¥MetaMaské’±åŒ…
                        </button>
                        <p class="text-sm text-blue-200 mt-3">
                            è¯·ç¡®ä¿å·²å®‰è£…MetaMaské’±åŒ…æ‰©å±•
                        </p>
                    </div>

                    <div id="walletConnected" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                <span class="text-sm text-green-300">å·²è¿æ¥</span>
                            </div>
                            <button id="disconnectBtn" class="text-xs text-red-300 hover:text-red-200">
                                æ–­å¼€è¿æ¥
                            </button>
                        </div>
                        <div class="bg-black bg-opacity-20 rounded-lg p-3">
                            <div class="text-xs text-blue-200 mb-1">é’±åŒ…åœ°å€</div>
                            <div id="walletAddress" class="text-sm font-mono text-white break-all"></div>
                        </div>
                    </div>
                </div>

                <!-- ä»£å¸ä½™é¢ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">ğŸ’° ä»£å¸ä½™é¢</h2>
                    
                    <div class="space-y-4">
                        <div class="stats-card rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">MAOä»£å¸</div>
                                    <div id="maoBalance" class="text-2xl font-bold text-yellow-400">0</div>
                                </div>
                                <div class="text-3xl">ğŸ±</div>
                            </div>
                            <div class="text-xs text-blue-300 mt-2">
                                æ¸¸æˆæ¶ˆè€—ï¼š100 MAO
                            </div>
                        </div>

                        <div class="stats-card rounded-xl p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm text-blue-200">PIä»£å¸</div>
                                    <div id="piBalance" class="text-2xl font-bold text-green-400">0</div>
                                </div>
                                <div class="text-3xl">ğŸ¥§</div>
                            </div>
                            <div class="text-xs text-blue-300 mt-2">
                                æ¸¸æˆæ¶ˆè€—ï¼š1000 PI
                            </div>
                        </div>
                    </div>

                    <button id="refreshBalanceBtn" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm transition-all">
                        ğŸ”„ åˆ·æ–°ä½™é¢
                    </button>
                </div>

                <!-- æ¸¸æˆç»Ÿè®¡ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">ğŸ“Š æ¸¸æˆç»Ÿè®¡</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="totalGames">0</div>
                            <div class="text-xs text-blue-200">æ€»æ¸¸æˆæ•°</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400" id="winCount">0</div>
                            <div class="text-xs text-blue-200">ä¸­å¥–æ¬¡æ•°</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="winRate">0%</div>
                            <div class="text-xs text-blue-200">ä¸­å¥–ç‡</div>
                        </div>
                        <div class="stats-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="totalReward">0</div>
                            <div class="text-xs text-blue-200">æ€»å¥–åŠ±</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šæ¸¸æˆåŒºåŸŸ -->
            <div class="space-y-6">
                <!-- è½¬ç›˜æ¸¸æˆ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-6 text-white text-center">ğŸ° è½¬ç›˜æ¸¸æˆ</h2>
                    
                    <!-- ä»£å¸é€‰æ‹© -->
                    <div class="flex justify-center mb-6">
                        <div class="bg-black bg-opacity-20 rounded-xl p-1 flex">
                            <button id="selectMaoBtn" class="token-btn active px-6 py-3 rounded-lg text-sm font-semibold transition-all">
                                ğŸ± MAO (100)
                            </button>
                            <button id="selectPiBtn" class="token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all">
                                ğŸ¥§ PI (1000)
                            </button>
                        </div>
                    </div>

                    <!-- è½¬ç›˜ -->
                    <div class="relative mx-auto mb-6" style="width: 300px; height: 300px;">
                        <div class="wheel-pointer"></div>
                        <div id="wheel" class="professional-wheel w-full h-full relative overflow-hidden">
                            <!-- è½¬ç›˜æ‰‡å½¢åŒºåŸŸ -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
                                    <div class="text-2xl">ğŸ¯</div>
                                </div>
                            </div>
                            
                            <!-- å¥–åŠ±æ ‡ç­¾ -->
                            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white">å®‰æ…°å¥–</div>
                            <div class="absolute top-1/2 right-4 transform -translate-y-1/2 text-xs font-bold text-white">å°å¥–</div>
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white">ä¸­å¥–</div>
                            <div class="absolute top-1/2 left-4 transform -translate-y-1/2 text-xs font-bold text-white">å¤§å¥–</div>
                            <div class="absolute top-16 right-16 text-xs font-bold text-white">è¶…çº§</div>
                            <div class="absolute top-16 left-16 text-xs font-bold text-white">ç»ˆæ</div>
                        </div>
                    </div>

                    <!-- æ¸¸æˆæŒ‰é’® -->
                    <div class="text-center">
                        <button id="spinBtn" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed">
                            ğŸ² å¼€å§‹æ¸¸æˆ
                        </button>
                        
                        <div id="gameStatus" class="mt-4 text-center">
                            <div class="text-sm text-blue-200">
                                é€‰æ‹©ä»£å¸ç±»å‹ï¼Œç‚¹å‡»å¼€å§‹æ¸¸æˆ
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¥–åŠ±é¢„è§ˆ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">ğŸ† å¥–åŠ±é¢„è§ˆ</h2>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-red-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-red-300 font-semibold">å®‰æ…°å¥– (10%)</div>
                            <div class="text-white" id="consolationReward">0.5å€</div>
                        </div>
                        <div class="bg-teal-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-teal-300 font-semibold">å°å¥– (25%)</div>
                            <div class="text-white" id="smallReward">1å€</div>
                        </div>
                        <div class="bg-blue-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-blue-300 font-semibold">ä¸­å¥– (35%)</div>
                            <div class="text-white" id="mediumReward">2å€</div>
                        </div>
                        <div class="bg-green-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-green-300 font-semibold">å¤§å¥– (20%)</div>
                            <div class="text-white" id="bigReward">5å€</div>
                        </div>
                        <div class="bg-yellow-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-yellow-300 font-semibold">è¶…çº§ (8%)</div>
                            <div class="text-white" id="superReward">10å€</div>
                        </div>
                        <div class="bg-purple-500 bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-purple-300 font-semibold">ç»ˆæ (2%)</div>
                            <div class="text-white" id="ultimateReward">50å€</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šäº¤æ˜“è®°å½• -->
            <div class="space-y-6">
                <!-- äº¤æ˜“è®°å½• -->
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">ğŸ“‹ æˆ‘çš„è®°å½•</h2>
                        <button id="clearHistoryBtn" class="text-xs text-red-300 hover:text-red-200">
                            æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                    
                    <div id="transactionHistory" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                        <div class="text-center py-8 text-blue-200">
                            <div class="text-4xl mb-2">ğŸ®</div>
                            <div class="text-sm">æš‚æ— æ¸¸æˆè®°å½•</div>
                            <div class="text-xs opacity-75 mt-1">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡æ¸¸æˆå§ï¼</div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘æ´»åŠ¨ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">âš¡ å®æ—¶æ´»åŠ¨</h2>
                    
                    <div id="recentActivity" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        <div class="text-center py-4 text-blue-200">
                            <div class="text-sm">æš‚æ— æ´»åŠ¨</div>
                        </div>
                    </div>
                </div>

                <!-- å¸®åŠ©ä¿¡æ¯ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">â“ æ¸¸æˆè¯´æ˜</h2>
                    
                    <div class="space-y-3 text-sm text-blue-200">
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">1.</div>
                            <div>é€‰æ‹©ä»£å¸ç±»å‹ï¼ˆMAOæˆ–PIï¼‰</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">2.</div>
                            <div>ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"æŒ‰é’®</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">3.</div>
                            <div>ç­‰å¾…è½¬ç›˜åœæ­¢è·å¾—å¥–åŠ±</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="text-yellow-400 mt-0.5">4.</div>
                            <div>å¥–åŠ±è‡ªåŠ¨å‘æ”¾åˆ°é’±åŒ…</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-500 bg-opacity-20 rounded-lg">
                        <div class="text-yellow-300 text-xs font-semibold mb-1">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                        <div class="text-yellow-200 text-xs">
                            è¿ç»­å¤±è´¥5æ¬¡å°†è§¦å‘ä¿æŠ¤æœºåˆ¶ï¼Œç¡®ä¿ä¸‹æ¬¡ä¸­å¥–ï¼
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="notification hidden">
        <div class="glass-effect rounded-lg p-4 max-w-sm">
            <div class="flex items-start">
                <div id="notificationIcon" class="mr-3 mt-0.5"></div>
                <div>
                    <div id="notificationTitle" class="font-semibold text-white"></div>
                    <div id="notificationMessage" class="text-sm text-blue-200 mt-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div id="resultModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-filter backdrop-blur-sm"></div>
        <div class="relative h-full flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-8 max-w-md w-full text-center slide-in">
                <div id="resultIcon" class="text-6xl mb-4"></div>
                <h3 id="resultTitle" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="resultMessage" class="text-blue-200 mb-6"></p>
                <div id="resultReward" class="text-3xl font-bold gradient-text mb-6"></div>
                <button id="closeModalBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                    ç»§ç»­æ¸¸æˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentAccount = null;
        let selectedToken = 'MAO';
        let provider = null;
        let signer = null;
        let gameContract = null;
        let maoContract = null;
        let piContract = null;
        let gameHistory = {}; // æ”¹ä¸ºå¯¹è±¡ï¼ŒæŒ‰é’±åŒ…åœ°å€å­˜å‚¨
        let isSpinning = false;

        // æ™ºèƒ½åˆçº¦é…ç½®
        const CONTRACTS = {
            WHEEL_GAME: "0xB677DBcA76061E6301272c83179c8243A4eeB6A5",
            MAO_TOKEN: "0x22f49bcb3dad370a9268ba3fca33cb037ca3d022",
            PI_TOKEN: "0xfd4680e25e05b3435c7f698668d1ce80d2a9f444"
        };

        const ALVEY_NETWORK = {
            chainId: '0xED5',
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: ['https://elves-core1.alvey.io/'],
            blockExplorerUrls: ['https://alveyscan.com/'],
        };

        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "function getConsecutiveLosses(address player) external view returns (uint256)",
            "event GamePlayed(address indexed player, address indexed token, uint256 amount, uint256 randomNumber, uint256 multiplier, uint256 reward, bool isWin)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)"
        ];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadGameHistory();
        });

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            console.log('ğŸš€ åˆå§‹åŒ–ä¸“ä¸šç‰ˆæ¸¸æˆç•Œé¢...');
            
            // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
            
            updateTokenSelection();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é’±åŒ…è¿æ¥
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
            
            // ä»£å¸é€‰æ‹©
            document.getElementById('selectMaoBtn').addEventListener('click', () => selectToken('MAO'));
            document.getElementById('selectPiBtn').addEventListener('click', () => selectToken('PI'));
            
            // æ¸¸æˆæŒ‰é’®
            document.getElementById('spinBtn').addEventListener('click', startGame);
            
            // å…¶ä»–æŒ‰é’®
            document.getElementById('refreshBalanceBtn').addEventListener('click', updateBalances);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            
            // é’±åŒ…è´¦æˆ·å˜åŒ–ç›‘å¬
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showNotification('é”™è¯¯', 'è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) return;

                currentAccount = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 3797) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: ALVEY_NETWORK.chainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [ALVEY_NETWORK],
                            });
                        }
                    }
                }

                // åˆå§‹åŒ–åˆçº¦
                gameContract = new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, signer);
                maoContract = new ethers.Contract(CONTRACTS.MAO_TOKEN, ERC20_ABI, signer);
                piContract = new ethers.Contract(CONTRACTS.PI_TOKEN, ERC20_ABI, signer);

                // æ›´æ–°UI
                updateWalletUI();
                await updateBalances();
                loadGameHistory();

                showNotification('æˆåŠŸ', 'é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                addActivity('é’±åŒ…å·²è¿æ¥', `åœ°å€: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`);

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'è¿æ¥é’±åŒ…å¤±è´¥', 'error');
            }
        }

        // æ–­å¼€é’±åŒ…è¿æ¥
        function disconnectWallet() {
            currentAccount = null;
            provider = null;
            signer = null;
            gameContract = null;
            maoContract = null;
            piContract = null;
            
            updateWalletUI();
            document.getElementById('maoBalance').textContent = '0';
            document.getElementById('piBalance').textContent = '0';
            clearStats();
            
            showNotification('æç¤º', 'é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                await updateBalances();
                loadGameHistory();
                updateWalletUI();
                addActivity('è´¦æˆ·åˆ‡æ¢', `æ–°åœ°å€: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`);
            }
        }

        // æ›´æ–°é’±åŒ…UI
        function updateWalletUI() {
            const disconnected = document.getElementById('walletDisconnected');
            const connected = document.getElementById('walletConnected');
            const walletAddress = document.getElementById('walletAddress');

            if (currentAccount) {
                disconnected.classList.add('hidden');
                connected.classList.remove('hidden');
                walletAddress.textContent = currentAccount;
            } else {
                disconnected.classList.remove('hidden');
                connected.classList.add('hidden');
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            selectedToken = token;
            updateTokenSelection();
        }

        // æ›´æ–°ä»£å¸é€‰æ‹©UI
        function updateTokenSelection() {
            const maoBtn = document.getElementById('selectMaoBtn');
            const piBtn = document.getElementById('selectPiBtn');

            maoBtn.classList.toggle('active', selectedToken === 'MAO');
            piBtn.classList.toggle('active', selectedToken === 'PI');

            // æ›´æ–°æŒ‰é’®æ ·å¼
            if (selectedToken === 'MAO') {
                maoBtn.className = 'token-btn active bg-yellow-600 text-white px-6 py-3 rounded-lg text-sm font-semibold transition-all';
                piBtn.className = 'token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all text-blue-200 hover:bg-white hover:bg-opacity-10';
            } else {
                piBtn.className = 'token-btn active bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-semibold transition-all';
                maoBtn.className = 'token-btn px-6 py-3 rounded-lg text-sm font-semibold transition-all text-blue-200 hover:bg-white hover:bg-opacity-10';
            }
        }

        // æ›´æ–°ä½™é¢
        async function updateBalances() {
            if (!currentAccount || !maoContract || !piContract) return;

            try {
                const maoBalance = await maoContract.balanceOf(currentAccount);
                const piBalance = await piContract.balanceOf(currentAccount);

                document.getElementById('maoBalance').textContent = Math.floor(ethers.utils.formatEther(maoBalance)).toLocaleString();
                document.getElementById('piBalance').textContent = Math.floor(ethers.utils.formatEther(piBalance)).toLocaleString();
            } catch (error) {
                console.error('æ›´æ–°ä½™é¢å¤±è´¥:', error);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (!currentAccount) {
                showNotification('æç¤º', 'è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
                return;
            }

            if (isSpinning) return;

            try {
                isSpinning = true;
                updateGameUI(true);

                const tokenContract = selectedToken === 'MAO' ? maoContract : piContract;
                const tokenAddress = selectedToken === 'MAO' ? CONTRACTS.MAO_TOKEN : CONTRACTS.PI_TOKEN;
                const amount = selectedToken === 'MAO' ? ethers.utils.parseEther('100') : ethers.utils.parseEther('1000');

                // æ£€æŸ¥ä½™é¢
                const balance = await tokenContract.balanceOf(currentAccount);
                if (balance.lt(amount)) {
                    throw new Error(`${selectedToken}ä½™é¢ä¸è¶³`);
                }

                // æ£€æŸ¥æˆæƒ
                const allowance = await tokenContract.allowance(currentAccount, CONTRACTS.WHEEL_GAME);
                if (allowance.lt(amount)) {
                    showGameStatus('æ­£åœ¨æˆæƒä»£å¸...', 'loading');
                    const approveTx = await tokenContract.approve(CONTRACTS.WHEEL_GAME, ethers.utils.parseEther('1000000'));
                    await approveTx.wait();
                }

                // å¼€å§‹è½¬ç›˜åŠ¨ç”»
                startWheelAnimation();
                showGameStatus('è½¬ç›˜è½¬åŠ¨ä¸­...', 'loading');
                addActivity('æ¸¸æˆå¼€å§‹', `ä½¿ç”¨ ${selectedToken === 'MAO' ? '100 MAO' : '1000 PI'}`);

                // å‘é€æ¸¸æˆäº¤æ˜“
                const tx = selectedToken === 'MAO' ? await gameContract.playMAOGame() : await gameContract.playPIGame();
                const receipt = await tx.wait();

                // è§£ææ¸¸æˆç»“æœ
                const gameEvent = receipt.events.find(event => event.event === 'GamePlayed');
                if (gameEvent) {
                    const { randomNumber, multiplier, reward, isWin } = gameEvent.args;
                    
                    setTimeout(() => {
                        showGameResult({
                            randomNumber: randomNumber.toNumber(),
                            multiplier: multiplier.toNumber(),
                            reward: ethers.utils.formatEther(reward),
                            isWin,
                            txHash: tx.hash
                        });
                    }, 4000);
                } else {
                    throw new Error('æ— æ³•è·å–æ¸¸æˆç»“æœ');
                }

            } catch (error) {
                console.error('æ¸¸æˆå¤±è´¥:', error);
                showNotification('æ¸¸æˆå¤±è´¥', error.message, 'error');
                stopWheelAnimation();
                isSpinning = false;
                updateGameUI(false);
            }
        }

        // å¼€å§‹è½¬ç›˜åŠ¨ç”»
        function startWheelAnimation() {
            const wheel = document.getElementById('wheel');
            const randomRotation = 1800 + Math.random() * 1800; // 5-10åœˆ
            wheel.style.transform = `rotate(${randomRotation}deg)`;
        }

        // åœæ­¢è½¬ç›˜åŠ¨ç”»
        function stopWheelAnimation() {
            const wheel = document.getElementById('wheel');
            wheel.style.transform = 'rotate(0deg)';
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æœ
        function showGameResult(result) {
            stopWheelAnimation();
            isSpinning = false;
            updateGameUI(false);

            // ä¿å­˜æ¸¸æˆè®°å½•
            saveGameRecord(result);

            // æ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const reward = document.getElementById('resultReward');

            if (result.isWin) {
                icon.textContent = 'ğŸ‰';
                title.textContent = 'æ­å–œä¸­å¥–ï¼';
                message.textContent = `æ‚¨è·å¾—äº† ${result.multiplier}å€ å¥–åŠ±ï¼`;
                reward.textContent = `+${result.reward} ${selectedToken}`;
                addActivity('æ¸¸æˆä¸­å¥–', `è·å¾— ${result.reward} ${selectedToken}`);
            } else {
                icon.textContent = 'ğŸ˜”';
                title.textContent = 'å¾ˆé—æ†¾';
                message.textContent = 'è¿™æ¬¡æ²¡æœ‰ä¸­å¥–ï¼Œä¸‹æ¬¡ä¸€å®šä¼šæ›´å¥½ï¼';
                reward.textContent = 'æœªä¸­å¥–';
                addActivity('æ¸¸æˆç»“æŸ', 'æœªä¸­å¥–');
            }

            modal.classList.remove('hidden');

            // æ›´æ–°ä½™é¢å’Œç»Ÿè®¡
            setTimeout(() => {
                updateBalances();
                updateStats();
            }, 1000);
        }

        // æ›´æ–°æ¸¸æˆUIçŠ¶æ€
        function updateGameUI(isPlaying) {
            const spinBtn = document.getElementById('spinBtn');
            
            if (isPlaying) {
                spinBtn.disabled = true;
                spinBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            } else {
                spinBtn.disabled = false;
                spinBtn.innerHTML = 'ğŸ² å¼€å§‹æ¸¸æˆ';
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€
        function showGameStatus(message, type = 'info') {
            const statusEl = document.getElementById('gameStatus');
            let iconClass = '';
            
            switch (type) {
                case 'loading':
                    iconClass = '<div class="loading-spinner inline-block mr-2"></div>';
                    break;
                case 'success':
                    iconClass = 'âœ… ';
                    break;
                case 'error':
                    iconClass = 'âŒ ';
                    break;
                default:
                    iconClass = 'â„¹ï¸ ';
            }
            
            statusEl.innerHTML = `<div class="text-sm text-blue-200">${iconClass}${message}</div>`;
        }

        // åŠ è½½æ¸¸æˆå†å²è®°å½•ï¼ˆæŒ‰é’±åŒ…åœ°å€ï¼‰
        function loadGameHistory() {
            try {
                const savedHistory = localStorage.getItem('mao_game_history_v2');
                if (savedHistory) {
                    gameHistory = JSON.parse(savedHistory);
                } else {
                    gameHistory = {};
                }
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆå†å²å¤±è´¥:', error);
                gameHistory = {};
            }
            
            updateHistoryDisplay();
            updateStats();
        }

        // ä¿å­˜æ¸¸æˆè®°å½•ï¼ˆæŒ‰é’±åŒ…åœ°å€ï¼‰
        function saveGameRecord(result) {
            if (!currentAccount) return;

            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-CN'),
                token: selectedToken,
                cost: selectedToken === 'MAO' ? 100 : 1000,
                multiplier: result.multiplier,
                reward: result.reward,
                isWin: result.isWin,
                txHash: result.txHash
            };

            // ä¸ºå½“å‰é’±åŒ…åœ°å€åˆ›å»ºè®°å½•æ•°ç»„
            if (!gameHistory[currentAccount]) {
                gameHistory[currentAccount] = [];
            }

            gameHistory[currentAccount].unshift(record);

            // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
            if (gameHistory[currentAccount].length > 50) {
                gameHistory[currentAccount] = gameHistory[currentAccount].slice(0, 50);
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            try {
                localStorage.setItem('mao_game_history_v2', JSON.stringify(gameHistory));
                updateHistoryDisplay();
                updateStats();
            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆå†å²å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºå½“å‰é’±åŒ…çš„è®°å½•ï¼‰
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('transactionHistory');
            
            if (!currentAccount || !gameHistory[currentAccount] || gameHistory[currentAccount].length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-blue-200">
                        <div class="text-4xl mb-2">ğŸ®</div>
                        <div class="text-sm">æš‚æ— æ¸¸æˆè®°å½•</div>
                        <div class="text-xs opacity-75 mt-1">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡æ¸¸æˆå§ï¼</div>
                    </div>
                `;
                return;
            }

            const records = gameHistory[currentAccount];
            historyContainer.innerHTML = records.map(record => {
                const resultClass = record.isWin ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400';
                const resultIcon = record.isWin ? 'ğŸ‰' : 'ğŸ˜”';
                const resultText = record.isWin ? 
                    `ä¸­å¥– ${record.multiplier}å€ï¼Œè·å¾— ${record.reward} ${record.token}` : 
                    'æœªä¸­å¥–';

                return `
                    <div class="transaction-item glass-effect rounded-lg p-3 ${resultClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${resultIcon}</span>
                                <div>
                                    <div class="text-sm font-semibold text-white">${record.token} æ¸¸æˆ</div>
                                    <div class="text-xs text-blue-300">${record.timestamp}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-yellow-400">-${record.cost}</div>
                                ${record.isWin ? `<div class="text-sm font-semibold text-green-400">+${record.reward}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-xs text-blue-200">${resultText}</div>
                        ${record.txHash ? `<div class="text-xs text-blue-400 mt-1 break-all">TX: ${record.txHash.slice(0, 10)}...${record.txHash.slice(-6)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆåªç»Ÿè®¡å½“å‰é’±åŒ…ï¼‰
        function updateStats() {
            if (!currentAccount || !gameHistory[currentAccount]) {
                clearStats();
                return;
            }

            const records = gameHistory[currentAccount];
            const totalGames = records.length;
            const winCount = records.filter(record => record.isWin).length;
            const winRate = totalGames > 0 ? Math.round((winCount / totalGames) * 100) : 0;
            const totalReward = records
                .filter(record => record.isWin)
                .reduce((sum, record) => sum + parseFloat(record.reward), 0);

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('winCount').textContent = winCount;
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalReward').textContent = totalReward.toFixed(0);
        }

        // æ¸…ç©ºç»Ÿè®¡æ•°æ®
        function clearStats() {
            document.getElementById('totalGames').textContent = '0';
            document.getElementById('winCount').textContent = '0';
            document.getElementById('winRate').textContent = '0%';
            document.getElementById('totalReward').textContent = '0';
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (!currentAccount) return;

            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰é’±åŒ…çš„æ¸¸æˆè®°å½•å—ï¼Ÿ')) {
                if (gameHistory[currentAccount]) {
                    delete gameHistory[currentAccount];
                }
                localStorage.setItem('mao_game_history_v2', JSON.stringify(gameHistory));
                updateHistoryDisplay();
                updateStats();
                showNotification('æˆåŠŸ', 'è®°å½•å·²æ¸…ç©º', 'success');
            }
        }

        // æ·»åŠ æ´»åŠ¨è®°å½•
        function addActivity(title, description) {
            const activityContainer = document.getElementById('recentActivity');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            
            const activityItem = document.createElement('div');
            activityItem.className = 'glass-effect rounded-lg p-3 mb-2 slide-in';
            activityItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-sm font-semibold text-white">${title}</div>
                        <div class="text-xs text-blue-300">${description}</div>
                    </div>
                    <div class="text-xs text-blue-400">${timestamp}</div>
                </div>
            `;

            if (activityContainer.querySelector('.text-center')) {
                activityContainer.innerHTML = '';
            }

            activityContainer.insertBefore(activityItem, activityContainer.firstChild);

            // åªä¿ç•™æœ€è¿‘10æ¡æ´»åŠ¨
            const activities = activityContainer.children;
            if (activities.length > 10) {
                activityContainer.removeChild(activities[activities.length - 1]);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            icon.textContent = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('resultModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html> 