<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” å¼ºåˆ¶æ–°åˆçº¦æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
        }
        .status-box {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        .error {
            border-left-color: #ff4757;
            background: #2c1810;
        }
        .success {
            border-left-color: #2ed573;
            background: #1a2f1a;
        }
        .warning {
            border-left-color: #ffa502;
            background: #2f2410;
        }
        .button {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-size: 1.1em;
        }
        .button:hover {
            background: #5a67d8;
        }
        .code {
            background: #111;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .balance-display {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .balance-item {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }
        .balance-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2ed573;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¼ºåˆ¶æ–°åˆçº¦æµ‹è¯•é¡µé¢</h1>
        
        <div class="status-box warning">
            <h3>âš ï¸ é‡è¦è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢å¼ºåˆ¶ä½¿ç”¨æ–°åˆçº¦ï¼Œç”¨äºæµ‹è¯•è¥é”€é’±åŒ…åˆ†é…æ˜¯å¦æ­£å¸¸ã€‚</p>
            <p>å¦‚æœæ‚¨çœ‹åˆ°æ—§åˆçº¦åœ°å€ï¼Œè¯´æ˜æµè§ˆå™¨ç¼“å­˜æ²¡æœ‰å®Œå…¨æ¸…é™¤ï¼</p>
        </div>
        
        <div class="status-box" id="contractStatus">
            <h3>ğŸ“‹ å½“å‰åˆçº¦çŠ¶æ€</h3>
            <div id="contractInfo">æ£€æŸ¥ä¸­...</div>
        </div>
        
        <div class="status-box" id="walletStatus">
            <h3>ğŸ’° è¥é”€é’±åŒ…çŠ¶æ€</h3>
            <div id="walletInfo">æ£€æŸ¥ä¸­...</div>
        </div>
        
        <div class="status-box">
            <h3>ğŸ® æ¸¸æˆæµ‹è¯•</h3>
            <p>è¿æ¥é’±åŒ…åï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•æ¸¸æˆï¼š</p>
            <button class="button" onclick="connectWallet()">ğŸ”— è¿æ¥é’±åŒ…</button>
            <button class="button" onclick="testMAOGame()" id="testMAOBtn" disabled>ğŸ¯ æµ‹è¯•MAOæ¸¸æˆ</button>
            <button class="button" onclick="testPIGame()" id="testPIBtn" disabled>ğŸ¯ æµ‹è¯•PIæ¸¸æˆ</button>
        </div>
        
        <div class="status-box" id="gameResult">
            <h3>ğŸ“Š æ¸¸æˆç»“æœ</h3>
            <div id="resultInfo">ç­‰å¾…æ¸¸æˆæµ‹è¯•...</div>
        </div>
        
        <div class="status-box">
            <h3>ğŸ”§ ç¼“å­˜æ¸…é™¤æ£€æŸ¥</h3>
            <p>æ—¶é—´æˆ³: <span id="timestamp"></span></p>
            <p>é¡µé¢åŠ è½½æ—¶é—´: <span id="loadTime"></span></p>
            <button class="button" onclick="forceReload()">ğŸ”„ å¼ºåˆ¶é‡æ–°åŠ è½½</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // å¼ºåˆ¶ä½¿ç”¨æ–°åˆçº¦åœ°å€
        const CONTRACTS = {
            WHEEL_GAME: '0xB677DBcA76061E6301272c83179c8243A4eeB6A5', // æ–°åˆçº¦
            MAO_TOKEN: '0x22f49bcb3dad370a9268ba3fca33cb037ca3d022',
            PI_TOKEN: '0xfd4680e25e05b3435c7f698668d1ce80d2a9f444'
        };
        
        const MARKETING_WALLET = '0x861A48051eFaA1876D4B38904516C9F7bbCca36d';
        
        let provider;
        let signer;
        let gameContract;
        let userAddress;
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ—¶é—´æˆ³
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        document.getElementById('loadTime').textContent = Date.now();
        
        // æ£€æŸ¥åˆçº¦çŠ¶æ€
        async function checkContractStatus() {
            try {
                const rpcUrl = 'https://elves-core2.alvey.io/';
                const tempProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                
                const gameABI = [
                    "function marketingWallet() view returns (address)",
                    "function prizePool() view returns (address)"
                ];
                
                const contract = new ethers.Contract(CONTRACTS.WHEEL_GAME, gameABI, tempProvider);
                const marketingWallet = await contract.marketingWallet();
                const prizePool = await contract.prizePool();
                
                const statusDiv = document.getElementById('contractStatus');
                const infoDiv = document.getElementById('contractInfo');
                
                let html = `
                    <div class="code">
                        åˆçº¦åœ°å€: ${CONTRACTS.WHEEL_GAME}<br>
                        è¥é”€é’±åŒ…: ${marketingWallet}<br>
                        å¥–é‡‘æ± : ${prizePool}
                    </div>
                `;
                
                if (marketingWallet.toLowerCase() === MARKETING_WALLET.toLowerCase()) {
                    statusDiv.className = 'status-box success';
                    html += '<p>âœ… è¥é”€é’±åŒ…é…ç½®æ­£ç¡®ï¼</p>';
                } else {
                    statusDiv.className = 'status-box error';
                    html += '<p>âŒ è¥é”€é’±åŒ…é…ç½®é”™è¯¯ï¼</p>';
                }
                
                infoDiv.innerHTML = html;
                
            } catch (error) {
                const statusDiv = document.getElementById('contractStatus');
                const infoDiv = document.getElementById('contractInfo');
                statusDiv.className = 'status-box error';
                infoDiv.innerHTML = `<p>âŒ æ£€æŸ¥åˆçº¦å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ£€æŸ¥é’±åŒ…ä½™é¢
        async function checkWalletBalance() {
            try {
                const rpcUrl = 'https://elves-core2.alvey.io/';
                const tempProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                
                const ERC20_ABI = ["function balanceOf(address owner) view returns (uint256)"];
                
                const maoToken = new ethers.Contract(CONTRACTS.MAO_TOKEN, ERC20_ABI, tempProvider);
                const piToken = new ethers.Contract(CONTRACTS.PI_TOKEN, ERC20_ABI, tempProvider);
                
                const maoBalance = await maoToken.balanceOf(MARKETING_WALLET);
                const piBalance = await piToken.balanceOf(MARKETING_WALLET);
                
                const walletDiv = document.getElementById('walletInfo');
                walletDiv.innerHTML = `
                    <div class="balance-display">
                        <div class="balance-item">
                            <div>MAOä½™é¢</div>
                            <div class="balance-value">${ethers.utils.formatEther(maoBalance)}</div>
                        </div>
                        <div class="balance-item">
                            <div>PIä½™é¢</div>
                            <div class="balance-value">${ethers.utils.formatEther(piBalance)}</div>
                        </div>
                    </div>
                    <div class="code">è¥é”€é’±åŒ…: ${MARKETING_WALLET}</div>
                `;
                
                // å­˜å‚¨åˆå§‹ä½™é¢ç”¨äºæ¯”è¾ƒ
                window.initialMAO = parseFloat(ethers.utils.formatEther(maoBalance));
                window.initialPI = parseFloat(ethers.utils.formatEther(piBalance));
                
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `<p>âŒ æ£€æŸ¥ä½™é¢å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // æ£€æŸ¥ç½‘ç»œ
                    const network = await provider.getNetwork();
                    if (network.chainId !== 3797) {
                        alert('è¯·åˆ‡æ¢åˆ°AlveyChainç½‘ç»œ (Chain ID: 3797)');
                        return;
                    }
                    
                    // åˆ›å»ºåˆçº¦å®ä¾‹
                    const gameABI = [
                        "function playGame(uint8 tokenType, uint256 betAmount) external",
                        "function marketingWallet() view returns (address)"
                    ];
                    
                    gameContract = new ethers.Contract(CONTRACTS.WHEEL_GAME, gameABI, signer);
                    
                    // å¯ç”¨æ¸¸æˆæŒ‰é’®
                    document.getElementById('testMAOBtn').disabled = false;
                    document.getElementById('testPIBtn').disabled = false;
                    
                    alert(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼\nåœ°å€: ${userAddress}\nç½‘ç»œ: AlveyChain`);
                    
                } else {
                    alert('âŒ è¯·å®‰è£…MetaMaské’±åŒ…');
                }
            } catch (error) {
                alert(`âŒ è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}`);
            }
        }
        
        // æµ‹è¯•MAOæ¸¸æˆ
        async function testMAOGame() {
            try {
                const resultDiv = document.getElementById('resultInfo');
                resultDiv.innerHTML = '<p>ğŸ® æ­£åœ¨è¿›è¡ŒMAOæ¸¸æˆæµ‹è¯•...</p>';
                
                const betAmount = ethers.utils.parseEther('100'); // 100 MAO
                const tx = await gameContract.playGame(0, betAmount); // 0 = MAO
                
                resultDiv.innerHTML = '<p>â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...</p>';
                
                const receipt = await tx.wait();
                
                resultDiv.innerHTML = `
                    <p>âœ… MAOæ¸¸æˆå®Œæˆï¼</p>
                    <div class="code">
                        äº¤æ˜“å“ˆå¸Œ: ${receipt.transactionHash}<br>
                        åŒºå—å·: ${receipt.blockNumber}<br>
                        Gasä½¿ç”¨: ${receipt.gasUsed.toString()}
                    </div>
                    <p>ğŸ” æ£€æŸ¥è¥é”€é’±åŒ…ä½™é¢æ˜¯å¦å¢åŠ äº†20 MAO...</p>
                `;
                
                // ç­‰å¾…å‡ ç§’åæ£€æŸ¥ä½™é¢
                setTimeout(checkWalletBalance, 3000);
                
            } catch (error) {
                document.getElementById('resultInfo').innerHTML = `<p>âŒ MAOæ¸¸æˆå¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•PIæ¸¸æˆ
        async function testPIGame() {
            try {
                const resultDiv = document.getElementById('resultInfo');
                resultDiv.innerHTML = '<p>ğŸ® æ­£åœ¨è¿›è¡ŒPIæ¸¸æˆæµ‹è¯•...</p>';
                
                const betAmount = ethers.utils.parseEther('1000'); // 1000 PI
                const tx = await gameContract.playGame(1, betAmount); // 1 = PI
                
                resultDiv.innerHTML = '<p>â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...</p>';
                
                const receipt = await tx.wait();
                
                resultDiv.innerHTML = `
                    <p>âœ… PIæ¸¸æˆå®Œæˆï¼</p>
                    <div class="code">
                        äº¤æ˜“å“ˆå¸Œ: ${receipt.transactionHash}<br>
                        åŒºå—å·: ${receipt.blockNumber}<br>
                        Gasä½¿ç”¨: ${receipt.gasUsed.toString()}
                    </div>
                    <p>ğŸ” æ£€æŸ¥è¥é”€é’±åŒ…ä½™é¢æ˜¯å¦å¢åŠ äº†200 PI...</p>
                `;
                
                // ç­‰å¾…å‡ ç§’åæ£€æŸ¥ä½™é¢
                setTimeout(checkWalletBalance, 3000);
                
            } catch (error) {
                document.getElementById('resultInfo').innerHTML = `<p>âŒ PIæ¸¸æˆå¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // å¼ºåˆ¶é‡æ–°åŠ è½½
        function forceReload() {
            // æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡æ–°åŠ è½½
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°
            window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            checkContractStatus();
            checkWalletBalance();
            
            // æ˜¾ç¤ºé‡è¦æé†’
            setTimeout(function() {
                alert('ğŸ” é‡è¦æé†’ï¼š\n\n' +
                      '1. è¯·ç¡®ä¿æ‚¨å·²ç»æ¸…é™¤äº†æµè§ˆå™¨ç¼“å­˜\n' +
                      '2. æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦ä¸ºæ–°åˆçº¦\n' +
                      '3. è¿æ¥é’±åŒ…åè¿›è¡Œæµ‹è¯•æ¸¸æˆ\n' +
                      '4. è§‚å¯Ÿè¥é”€é’±åŒ…ä½™é¢å˜åŒ–\n\n' +
                      'æ–°åˆçº¦åœ°å€: 0xB677DBcA76061E6301272c83179c8243A4eeB6A5');
            }, 1000);
        });
    </script>
</body>
</html> 