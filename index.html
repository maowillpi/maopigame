<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° MAO Ultimate Wheel Game - v6.4 FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #6366f1, #8b5cf6); min-height: 100vh; font-family: Inter, sans-serif; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .wheel { width: 300px; height: 300px; border-radius: 50%; background: conic-gradient(from 0deg, #ef4444 0deg 180deg, #10b981 180deg 360deg); transition: transform 4s ease; position: relative; }
        .spinning { animation: spin 4s ease; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(1800deg); } }
        .token-btn { padding: 12px 24px; border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .token-btn.active { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: black; }
        .game-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 32px; border-radius: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .loading { width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid #f59e0b; border-radius: 50%; animation: rotate 1s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold text-center mb-8">ğŸ° MAO Ultimate Wheel</h1>
        
        <!-- Wallet Section -->
        <div class="glass rounded-2xl p-6 mb-8">
            <div id="walletDisconnected">
                <button id="connectBtn" class="game-btn mx-auto block">è¿æ¥ MetaMask</button>
            </div>
            <div id="walletConnected" class="hidden">
                <div class="text-center mb-4">
                    <span class="text-green-400">å·²è¿æ¥:</span>
                    <span id="walletAddress" class="font-mono"></span>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-2xl mb-2">ğŸ±</div>
                        <div class="text-yellow-400 text-2xl font-bold" id="maoBalance">0</div>
                        <div class="text-sm">MAO</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-2xl mb-2">ğŸ¥§</div>
                        <div class="text-green-400 text-2xl font-bold" id="piBalance">0</div>
                        <div class="text-sm">PI</div>
                    </div>
                </div>
                
                <!-- Token Selection -->
                <div class="flex justify-center mb-6">
                    <div class="glass rounded-xl p-2 flex gap-2">
                        <button id="selectMao" class="token-btn active">ğŸ± MAO (100)</button>
                        <button id="selectPi" class="token-btn">ğŸ¥§ PI (1000)</button>
                    </div>
                </div>
                
                <!-- Wheel -->
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <div class="wheel" id="wheel">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                                    <span class="text-2xl">ğŸ¯</span>
                                </div>
                            </div>
                        </div>
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2">
                            <div class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-yellow-400"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Button -->
                <div class="text-center">
                    <button id="spinBtn" class="game-btn">ğŸ² å¼€å§‹æ¸¸æˆ</button>
                    <div id="gameStatus" class="mt-4 text-sm">é€‰æ‹©ä»£å¸æ¨¡å¼ï¼Œç‚¹å‡»å¼€å§‹æ¸¸æˆ</div>
                </div>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="glass rounded-2xl p-6">
            <h3 class="text-xl font-semibold mb-4">ğŸ“Š æ¸¸æˆç»Ÿè®¡</h3>
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400" id="totalGames">0</div>
                    <div class="text-sm">æ€»å±€æ•°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400" id="winCount">0</div>
                    <div class="text-sm">èƒœåˆ©æ•°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-400" id="winRate">0%</div>
                    <div class="text-sm">èƒœç‡</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400" id="totalReward">0</div>
                    <div class="text-sm">æ€»å¥–åŠ±</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
        <div class="glass rounded-2xl p-8 max-w-md text-center">
            <div id="resultIcon" class="text-6xl mb-4"></div>
            <h3 id="resultTitle" class="text-2xl font-bold mb-2"></h3>
            <p id="resultMessage" class="mb-4"></p>
            <div id="resultReward" class="text-3xl font-bold text-yellow-400 mb-6"></div>
            <button id="closeModal" class="game-btn">ç»§ç»­æ¸¸æˆ</button>
        </div>
    </div>

    <script>
        // Fixed Game Configuration
        const gameState = {
            wallet: { connected: false, address: null, provider: null, signer: null },
            selectedToken: 'MAO',
            isSpinning: false,
            stats: { totalGames: 0, winCount: 0, totalReward: 0 },
            contracts: { game: null, mao: null, pi: null }
        };

        const addresses = {
            WHEEL_GAME: "0xB677DBcA76061E6301272c83179c8243A4eeB6A5",
            MAO_TOKEN: "0x22f49bcb3dad370a9268ba3fca33cb037ca3d022",
            PI_TOKEN: "0xfd4680e25e05b3435c7f698668d1ce80d2a9f444"
        };

        // FIXED: Complete ABI that handles self-contained rewards without prize pool dependencies
        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "function maoRewards(uint256) external view returns (uint256)",
            "function piRewards(uint256) external view returns (uint256)",
            "function probabilityRanges(uint256) external view returns (uint256)",
            "function getContractBalance(address token) external view returns (uint256)",
            "event GamePlayed(address indexed player, uint8 tokenType, uint256 betAmount, uint256 rewardAmount, uint8 rewardLevel, uint256 randomSeed)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function transfer(address to, uint256 amount) external returns (bool)"
        ];

        // Global utility functions to avoid scope issues
        function formatAddress(addr) {
            return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        }

        function formatNumber(num) {
            return Math.floor(num).toLocaleString();
        }

        function setGameStatus(message) {
            const statusEl = document.getElementById('gameStatus');
            if (statusEl) statusEl.textContent = message;
        }

        function updateTokenSelection() {
            const maoBtn = document.getElementById('selectMao');
            const piBtn = document.getElementById('selectPi');
            
            if (gameState.selectedToken === 'MAO') {
                maoBtn.classList.add('active');
                piBtn.classList.remove('active');
            } else {
                maoBtn.classList.remove('active');
                piBtn.classList.add('active');
            }
        }

        function updateGameUI(isPlaying) {
            const spinBtn = document.getElementById('spinBtn');
            const tokenBtns = document.querySelectorAll('.token-btn');
            
            if (isPlaying) {
                spinBtn.disabled = true;
                spinBtn.innerHTML = '<div class="loading mx-auto"></div>';
                tokenBtns.forEach(btn => btn.disabled = true);
            } else {
                spinBtn.disabled = false;
                spinBtn.innerHTML = 'ğŸ² å¼€å§‹æ¸¸æˆ';
                tokenBtns.forEach(btn => btn.disabled = false);
            }
        }

        function updateStats() {
            const { stats } = gameState;
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('winCount').textContent = stats.winCount;
            document.getElementById('totalReward').textContent = formatNumber(stats.totalReward);
            
            const winRate = stats.totalGames > 0 ? ((stats.winCount / stats.totalGames) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
        }

        function startWheelAnimation() {
            const wheel = document.getElementById('wheel');
            if (wheel) wheel.classList.add('spinning');
        }

        function stopWheelAnimation() {
            const wheel = document.getElementById('wheel');
            if (wheel) wheel.classList.remove('spinning');
        }

        function showResult(result) {
            stopWheelAnimation();
            gameState.isSpinning = false;
            updateGameUI(false);

            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const reward = document.getElementById('resultReward');

            if (result.isWin) {
                icon.textContent = 'ğŸ‰';
                title.textContent = 'æ­å–œä¸­å¥–ï¼';
                message.textContent = `è·å¾— ${result.multiplier}x å€æ•°å¥–åŠ±`;
                reward.textContent = `+${formatNumber(result.reward)} ${gameState.selectedToken}`;
            } else {
                icon.textContent = 'ğŸ˜”';
                title.textContent = 'æœªä¸­å¥–';
                message.textContent = 'è¿™æ¬¡è¿æ°”ä¸ä½³ï¼Œå†è¯•ä¸€æ¬¡å§ï¼';
                reward.textContent = '0 å¥–åŠ±';
            }

            modal.classList.remove('hidden');
            updateBalances();
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£… MetaMask');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts.length) return;

                // Check if on correct network (AlveyChain Mainnet)
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== '0xED5') { // 3797 in hex
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xED5' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0xED5',
                                    chainName: 'AlveyChain Mainnet',
                                    nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
                                    rpcUrls: ['https://elves-core1.alvey.io'],
                                    blockExplorerUrls: ['https://alveyscan.com']
                                }]
                            });
                        }
                    }
                }

                gameState.wallet.address = accounts[0];
                gameState.wallet.provider = new ethers.providers.Web3Provider(window.ethereum);
                gameState.wallet.signer = gameState.wallet.provider.getSigner();
                gameState.wallet.connected = true;

                // Initialize contracts
                gameState.contracts.game = new ethers.Contract(addresses.WHEEL_GAME, WHEEL_GAME_ABI, gameState.wallet.signer);
                gameState.contracts.mao = new ethers.Contract(addresses.MAO_TOKEN, ERC20_ABI, gameState.wallet.signer);
                gameState.contracts.pi = new ethers.Contract(addresses.PI_TOKEN, ERC20_ABI, gameState.wallet.signer);

                updateWalletUI();
                updateBalances();
                loadStats();
                setGameStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼å‡†å¤‡å¼€å§‹æ¸¸æˆ');

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                alert('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        function updateWalletUI() {
            const disconnected = document.getElementById('walletDisconnected');
            const connected = document.getElementById('walletConnected');
            
            if (gameState.wallet.connected) {
                disconnected.classList.add('hidden');
                connected.classList.remove('hidden');
                document.getElementById('walletAddress').textContent = formatAddress(gameState.wallet.address);
            } else {
                disconnected.classList.remove('hidden');
                connected.classList.add('hidden');
            }
        }

        async function updateBalances() {
            if (!gameState.wallet.connected) return;

            try {
                const [maoBalance, piBalance] = await Promise.all([
                    gameState.contracts.mao.balanceOf(gameState.wallet.address),
                    gameState.contracts.pi.balanceOf(gameState.wallet.address)
                ]);

                document.getElementById('maoBalance').textContent = formatNumber(ethers.utils.formatEther(maoBalance));
                document.getElementById('piBalance').textContent = formatNumber(ethers.utils.formatEther(piBalance));
            } catch (error) {
                console.error('æ›´æ–°ä½™é¢å¤±è´¥:', error);
            }
        }

        async function startGame() {
            if (!gameState.wallet.connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            if (gameState.isSpinning) return;

            try {
                gameState.isSpinning = true;
                updateGameUI(true);

                const { selectedToken } = gameState;
                const { game, mao, pi } = gameState.contracts;
                const tokenContract = selectedToken === 'MAO' ? mao : pi;
                const amount = ethers.utils.parseEther(selectedToken === 'MAO' ? '100' : '1000');
                
                setGameStatus('æ£€æŸ¥ä½™é¢ä¸­...');
                const balance = await tokenContract.balanceOf(gameState.wallet.address);
                if (balance.lt(amount)) {
                    throw new Error(`ä½™é¢ä¸è¶³ï¼éœ€è¦ ${selectedToken === 'MAO' ? '100' : '1000'} ${selectedToken}`);
                }

                setGameStatus('æ£€æŸ¥æˆæƒä¸­...');
                const allowance = await tokenContract.allowance(gameState.wallet.address, addresses.WHEEL_GAME);
                
                if (allowance.lt(amount)) {
                    setGameStatus('æˆæƒä»£å¸ä¸­...');
                    const approveTx = await tokenContract.approve(addresses.WHEEL_GAME, ethers.constants.MaxUint256);
                    setGameStatus('ç­‰å¾…æˆæƒç¡®è®¤...');
                    await approveTx.wait();
                }

                setGameStatus('æ”¯ä»˜ä»£å¸ä¸­...');
                const tx = selectedToken === 'MAO' ? await game.playMAOGame() : await game.playPIGame();
                
                startWheelAnimation();
                setGameStatus('è½¬ç›˜è½¬åŠ¨ä¸­...');
                
                const receipt = await tx.wait();
                
                // FIXED: Handle the event properly
                let gameEvent = null;
                for (const log of receipt.logs) {
                    try {
                        const parsed = game.interface.parseLog(log);
                        if (parsed.name === 'GamePlayed') {
                            gameEvent = parsed;
                            break;
                        }
                    } catch (e) {
                        // Skip unparseable logs
                    }
                }
                
                if (gameEvent) {
                    const { args } = gameEvent;
                    const rewardAmount = ethers.utils.formatEther(args.rewardAmount);
                    const isWin = parseFloat(rewardAmount) > 0;
                    
                    const result = {
                        randomNumber: args.randomSeed.toNumber(),
                        multiplier: isWin ? (parseFloat(rewardAmount) / (selectedToken === 'MAO' ? 100 : 1000)).toFixed(2) : 0,
                        reward: rewardAmount,
                        isWin,
                        txHash: tx.hash
                    };
                    
                    setTimeout(() => {
                        showResult(result);
                        addGameStats(result);
                    }, 4000);
                } else {
                    // Fallback: assume game completed successfully
                    setTimeout(() => {
                        const result = {
                            randomNumber: Math.floor(Math.random() * 10000),
                            multiplier: 0,
                            reward: 0,
                            isWin: false,
                            txHash: tx.hash
                        };
                        showResult(result);
                        addGameStats(result);
                    }, 4000);
                }

            } catch (error) {
                console.error('æ¸¸æˆå¤±è´¥:', error);
                alert('æ¸¸æˆå¤±è´¥: ' + error.message);
                stopWheelAnimation();
                gameState.isSpinning = false;
                updateGameUI(false);
                setGameStatus('æ¸¸æˆå‡†å¤‡å°±ç»ª');
            }
        }

        function addGameStats(result) {
            gameState.stats.totalGames++;
            if (result.isWin) {
                gameState.stats.winCount++;
                gameState.stats.totalReward += parseFloat(result.reward);
            }
            updateStats();
            saveStats();
        }

        function saveStats() {
            try {
                localStorage.setItem('maoGameStats', JSON.stringify(gameState.stats));
            } catch (error) {
                console.log('ä¿å­˜ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function loadStats() {
            try {
                const stats = localStorage.getItem('maoGameStats');
                if (stats) {
                    gameState.stats = JSON.parse(stats);
                    updateStats();
                }
            } catch (error) {
                console.log('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Connect wallet button
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', connectWallet);
            }

            // Token selection buttons
            const selectMao = document.getElementById('selectMao');
            const selectPi = document.getElementById('selectPi');
            
            if (selectMao) {
                selectMao.addEventListener('click', () => {
                    gameState.selectedToken = 'MAO';
                    updateTokenSelection();
                    setGameStatus('MAO æ¨¡å¼ - æ¶ˆè€— 100 MAO');
                });
            }
            
            if (selectPi) {
                selectPi.addEventListener('click', () => {
                    gameState.selectedToken = 'PI';
                    updateTokenSelection();
                    setGameStatus('PI æ¨¡å¼ - æ¶ˆè€— 1000 PI');
                });
            }

            // Spin button
            const spinBtn = document.getElementById('spinBtn');
            if (spinBtn) {
                spinBtn.addEventListener('click', startGame);
            }

            // Close modal button
            const closeModal = document.getElementById('closeModal');
            if (closeModal) {
                closeModal.addEventListener('click', () => {
                    const modal = document.getElementById('resultModal');
                    if (modal) modal.classList.add('hidden');
                });
            }

            // Initialize UI
            updateTokenSelection();
            updateStats();
            setGameStatus('MAO æ¨¡å¼ - æ¶ˆè€— 100 MAO');
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });

        // MetaMask event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    gameState.wallet.connected = false;
                    updateWalletUI();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
