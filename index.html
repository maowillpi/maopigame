<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üé∞ MAOËΩ¨ÁõòÊ∏∏Êàè</title>
    <style>
        * { 
            margin: 0; 
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #4f8cff 0%, #a259ff 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
            padding-bottom: 60px;
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
        }
        .lang-btn.active {
            background: rgba(255,224,102,0.3);
            border-color: #FFE066;
        }
        .game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .title {
            font-size: 2.5em;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #FFE066; }
            to { text-shadow: 0 0 30px #fff, 0 0 40px #fff, 0 0 50px #FFE066; }
        }
        .desc {
            font-size: 1.2em;
            margin: 10px 0 30px 0;
            opacity: 0.9;
        }
        .wallet-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .connect-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .balance-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .balance-item {
            text-align: center;
        }
        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .balance-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFE066;
        }
        .game-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .token-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .token-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .token-btn.active {
            background: rgba(255,224,102,0.3);
            border-color: #FFE066;
        }
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 30px auto;
        }
        .svg-wheel {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #FFE066;
            z-index: 10;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }
        .wheel-center-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #FFE066, #FFC107);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        .play-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin: 20px 0;
        }
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .play-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .burned-stats {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 8px 15px;
            display: flex;
            gap: 8px;
            font-size: 11px;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        .result-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #FFE066;
            z-index: 1000;
            text-align: center;
            display: none;
        }
        .result-modal.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .status-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        .insufficient-balance {
            background: rgba(231, 76, 60, 0.9) !important;
        }
        .transaction-success {
            background: rgba(39, 174, 96, 0.9) !important;
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <button class="lang-btn active">‰∏≠Êñá</button>
        <button class="lang-btn">English</button>
    </div>

    <div class="game-container">
        <div class="title">üé∞ MAOËΩ¨ÁõòÊ∏∏Êàè</div>
        <div class="desc">50%‰∏≠Â•ñÁéáÔºåÊúÄÈ´òÂèØ‰∏≠10ÂÄçÂ§ßÂ•ñÔºÅ</div>
        
        <div class="wallet-section">
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">üîó ËøûÊé•Èí±ÂåÖ</button>
            <div class="balance-display" style="display: none;" id="balanceDisplay">
                <div class="balance-item">
                    <div class="balance-label">MAO‰ΩôÈ¢ù</div>
                    <div class="balance-value" id="maoBalance">Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">PI‰ΩôÈ¢ù</div>
                    <div class="balance-value" id="piBalance">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </div>
        
        <div class="game-section" style="display: none;" id="gameSection">
            <div class="token-selector">
                <button class="token-btn active" onclick="selectToken('MAO')">MAO (100)</button>
                <button class="token-btn" onclick="selectToken('PI')">PI (1000)</button>
            </div>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <svg class="svg-wheel" id="wheelSvg" viewBox="0 0 270 270">
                    <circle cx="135" cy="135" r="130" fill="#FF6B6B" stroke="#fff" stroke-width="5"/>
                    <path d="M 135,5 A 130,130 0 0,1 240,85 L 135,135 Z" fill="#4ECDC4"/>
                    <path d="M 240,85 A 130,130 0 0,1 240,185 L 135,135 Z" fill="#FFE066"/>
                    <path d="M 240,185 A 130,130 0 0,1 135,265 L 135,135 Z" fill="#8B5CF6"/>
                    <path d="M 135,265 A 130,130 0 0,1 30,185 L 135,135 Z" fill="#10B981"/>
                    <path d="M 30,185 A 130,130 0 0,1 30,85 L 135,135 Z" fill="#F97316"/>
                    <text x="135" y="50" text-anchor="middle" fill="white" font-size="20">0x</text>
                    <text x="200" y="100" text-anchor="middle" fill="white" font-size="16">1.05x</text>
                    <text x="200" y="170" text-anchor="middle" fill="white" font-size="16">1.25x</text>
                    <text x="135" y="230" text-anchor="middle" fill="white" font-size="20">2x</text>
                    <text x="70" y="170" text-anchor="middle" fill="white" font-size="20">6x</text>
                    <text x="70" y="100" text-anchor="middle" fill="white" font-size="16">10x</text>
                </svg>
                <div class="wheel-center-btn">üé∞</div>
            </div>
            <button class="play-btn" id="playBtn" onclick="playGame()">üéÆ ÂºÄÂßãÊ∏∏Êàè</button>
        </div>
    </div>

    <div class="burned-stats">
        <div>
            <span style="color: #ffeb3b;">MAO:</span>
            <span style="color: white; font-weight: bold;">201,001,230</span>
        </div>
        <div>
            <span style="color: #ffeb3b;">PI:</span>
            <span style="color: white; font-weight: bold;">83,000</span>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <div class="result-modal" id="resultModal">
        <h2 id="resultTitle">üéâ</h2>
        <p id="resultText">ÊÅ≠ÂñúËé∑ÂæóÂ•ñÂä±ÔºÅ</p>
        <button id="closeModalBtn" onclick="closeModal()" style="background: #4ECDC4; color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 15px; cursor: pointer;">Á°ÆÂÆö</button>
    </div>

    <script>
        // ÁøªËØëÊï∞ÊçÆ
        const TRANSLATIONS = {
            'zh': {
                'title': 'üé∞ MAOËΩ¨ÁõòÊ∏∏Êàè',
                'subtitle': '50%‰∏≠Â•ñÁéáÔºåÊúÄÈ´òÂèØ‰∏≠10ÂÄçÂ§ßÂ•ñÔºÅ',
                'connect-wallet': 'üîó ËøûÊé•Èí±ÂåÖ',
                'wallet-connected': '‚úÖ Èí±ÂåÖÂ∑≤ËøûÊé•',
                'connecting': 'üîå ËøûÊé•‰∏≠...',
                'mao-balance': 'MAO‰ΩôÈ¢ù',
                'pi-balance': 'PI‰ΩôÈ¢ù',
                'loading': 'Âä†ËΩΩ‰∏≠...',
                'failed': 'Ëé∑ÂèñÂ§±Ë¥•',
                'start-game': 'üéÆ ÂºÄÂßãÊ∏∏Êàè',
                'gaming': 'üéÆ Ê∏∏Êàè‰∏≠...',
                'connect-wallet-first': 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖÔºÅ',
                'insufficient-balance': '‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÈúÄË¶Å',
                'wallet-connected-success': 'Èí±ÂåÖËøûÊé•ÊàêÂäüÔºÅ',
                'wallet-connect-failed': 'Èí±ÂåÖËøûÊé•Â§±Ë¥•',
                'authorizing': 'Ê≠£Âú®ÊéàÊùÉ‰ª£Â∏Å...',
                'processing': 'Ê≠£Âú®Â§ÑÁêÜÊ∏∏Êàè‰∫§Êòì...',
                'waiting-confirmation': 'Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...',
                'game-complete': 'Ê∏∏ÊàèÂÆåÊàêÔºÅ',
                'congratulations': 'üéâ ÊÅ≠Âñú‰∏≠Â•ñÔºÅ',
                'sorry': 'üòî ÂæàÈÅóÊÜæ',
                'won-prize': 'ÊÅ≠ÂñúÔºÅËé∑Âæó',
                'no-prize': 'ÂæàÈÅóÊÜæÔºåËøôÊ¨°Ê≤°Êúâ‰∏≠Â•ñÔºÅ',
                'close': 'Á°ÆÂÆö',
                'burned-stats': 'Â∑≤ÈîÄÊØÅÁªüËÆ°'
            },
            'en': {
                'title': 'üé∞ MAO Wheel Game',
                'subtitle': '50% win rate, up to 10x prizes!',
                'connect-wallet': 'üîó Connect Wallet',
                'wallet-connected': '‚úÖ Wallet Connected',
                'connecting': 'üîå Connecting...',
                'mao-balance': 'MAO Balance',
                'pi-balance': 'PI Balance',
                'loading': 'Loading...',
                'failed': 'Failed',
                'start-game': 'üéÆ Start Game',
                'gaming': 'üéÆ Playing...',
                'connect-wallet-first': 'Please connect wallet first!',
                'insufficient-balance': 'Insufficient balance! Need',
                'wallet-connected-success': 'Wallet connected successfully!',
                'wallet-connect-failed': 'Failed to connect wallet',
                'authorizing': 'Authorizing tokens...',
                'processing': 'Processing game transaction...',
                'waiting-confirmation': 'Waiting for confirmation...',
                'game-complete': 'Game complete!',
                'congratulations': 'üéâ Congratulations!',
                'sorry': 'üòî Sorry',
                'won-prize': 'Congratulations! Won',
                'no-prize': 'Sorry, no prize this time!',
                'close': 'OK',
                'burned-stats': 'Burned Stats'
            }
        };

        // ÂΩìÂâçËØ≠Ë®Ä
        let currentLang = 'zh';

        // Ëé∑ÂèñÁøªËØëÊñáÊú¨
        function t(key) {
            const keys = key.split('.');
            let value = TRANSLATIONS[currentLang];
            for (const k of keys) {
                value = value[k];
                if (!value) break;
            }
            return value || key;
        }

        // Êõ¥Êñ∞ÁïåÈù¢ËØ≠Ë®Ä
        function updateLanguage() {
            // Êõ¥Êñ∞Ê†áÈ¢òÂíåÊèèËø∞
            document.querySelector('.title').textContent = t('title');
            document.querySelector('.desc').textContent = t('subtitle');
            
            // Êõ¥Êñ∞ËøûÊé•ÊåâÈíÆÊñáÊú¨
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn.textContent.includes('ËøûÊé•Èí±ÂåÖ') || connectBtn.textContent.includes('Connect Wallet')) {
                connectBtn.textContent = t('connect-wallet');
            } else if (connectBtn.textContent.includes('Â∑≤ËøûÊé•') || connectBtn.textContent.includes('Connected')) {
                connectBtn.textContent = t('wallet-connected');
            } else if (connectBtn.textContent.includes('ËøûÊé•‰∏≠') || connectBtn.textContent.includes('Connecting')) {
                connectBtn.textContent = t('connecting');
            }
            
            // Êõ¥Êñ∞‰ΩôÈ¢ùÊ†áÁ≠æ
            const balanceItems = document.querySelectorAll('.balance-display .balance-item');
            if (balanceItems.length >= 2) {
                balanceItems[0].querySelector('.balance-label').textContent = t('mao-balance');
                balanceItems[1].querySelector('.balance-label').textContent = t('pi-balance');
            }
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÊåâÈíÆ
            const playBtn = document.getElementById('playBtn');
            if (playBtn && (playBtn.textContent.includes('ÂºÄÂßãÊ∏∏Êàè') || playBtn.textContent.includes('Start Game'))) {
                playBtn.textContent = t('start-game');
            } else if (playBtn && (playBtn.textContent.includes('Ê∏∏Êàè‰∏≠') || playBtn.textContent.includes('Playing'))) {
                playBtn.textContent = t('gaming');
            }
            
            // Êõ¥Êñ∞ÂÖ≥Èó≠ÊåâÈíÆ
            const closeBtn = document.getElementById('closeModalBtn');
            if (closeBtn) {
                closeBtn.textContent = t('close');
            }
            
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢òÂíåËØ≠Ë®ÄÂ±ûÊÄß
            document.title = t('title');
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
        }

        // ËØ≠Ë®ÄÂàáÊç¢
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const isZh = btn.textContent.includes('‰∏≠Êñá');
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLang = isZh ? 'zh' : 'en';
                    updateLanguage();
                });
            });
            
            // ÂàùÂßãÂåñËØ≠Ë®Ä
            updateLanguage();
        });

        // ÂÖ®Â±ÄÂèòÈáè
        let provider;
        let signer;
        let gameContract;
        let maoContract;
        let piContract;
        let userAddress;
        let selectedToken = 'MAO';
        let isConnected = false;
        let isPlaying = false;

        // ÂêàÁ∫¶ÈÖçÁΩÆ
        const GAME_CONTRACT_ADDRESS = '0xB677DBcA76061E6301272c83179c8243A4eeB6A5';
        const MAO_CONTRACT_ADDRESS = '0xB677DBcA76061E6301272c83179c8243A4eeB6A5'; // ÂÆûÈôÖÁöÑMAO‰ª£Â∏ÅÂêàÁ∫¶Âú∞ÂùÄ
        const PI_CONTRACT_ADDRESS = '0xA9E4FD96B29e4f512a0a75E402C156B04D6E6c35'; // ÂÆûÈôÖÁöÑPI‰ª£Â∏ÅÂêàÁ∫¶Âú∞ÂùÄ
        
        // RPCËäÇÁÇπ
        const RPC_URLS = [
            'https://elves-core1.alvey.io/',
            'https://elves-core2.alvey.io/',
            'https://elves-core3.alvey.io/'
        ];

        // Ê∏∏ÊàèÂêàÁ∫¶ABI
        const GAME_ABI = [
            "function playGame(bool useMAO) external payable",
            "function prizePool() external view returns (uint256)",
            "function marketingWallet() external view returns (address)",
            "event GamePlayed(address indexed player, bool useMAO, uint256 amount, uint256 multiplier, uint256 reward)",
            "event Transfer(address indexed from, address indexed to, uint256 value)"
        ];

        // ERC20‰ª£Â∏ÅABI
        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function transfer(address to, uint256 amount) external returns (bool)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        // Ê∏∏ÊàèË¥πÁî® - Â∞ÜÂú®ethers.jsÂä†ËΩΩÂêéÂàùÂßãÂåñ
        let GAME_COSTS = {};

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ MAOËΩ¨ÁõòÊ∏∏ÊàèÂä†ËΩΩÂÆåÊàê');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøûÊé•Èí±ÂåÖ
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // ÂàùÂßãÂåñÊ∏∏ÊàèË¥πÁî®
        function initializeGameCosts() {
            if (typeof ethers !== 'undefined') {
                GAME_COSTS = {
                    MAO: ethers.utils.parseEther('100'), // 100 MAO
                    PI: ethers.utils.parseEther('1000')  // 1000 PI
                };
                console.log('‚úÖ Ê∏∏ÊàèË¥πÁî®ÂàùÂßãÂåñÂÆåÊàê');
            }
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // ËøûÊé•Èí±ÂåÖ
        async function connectWallet() {
            try {
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = true;
                connectBtn.textContent = t('connecting');

                if (typeof window.ethereum === 'undefined') {
                    throw new Error('ËØ∑ÂÆâË£ÖMetaMaskÈí±ÂåÖÔºÅ');
                }

                console.log('üîå Ê≠£Âú®ËøûÊé•Èí±ÂåÖ...');
                
                // ËØ∑Ê±ÇËøûÊé•Èí±ÂåÖ
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    throw new Error('ËØ∑Âú®Èí±ÂåÖ‰∏≠ÊéàÊùÉËøûÊé•ÔºÅ');
                }

                userAddress = accounts[0];
                console.log('‚úÖ Èí±ÂåÖËøûÊé•ÊàêÂäü:', userAddress);

                // Ëá™Âä®ÈÖçÁΩÆÊ≠£Á°ÆÁöÑÁΩëÁªú
                await autoConfigureNetwork();

                // ÂàùÂßãÂåñproviderÂíåÂêàÁ∫¶
                if (typeof ethers !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // ÂàùÂßãÂåñÂêàÁ∫¶
                    gameContract = new ethers.Contract(GAME_CONTRACT_ADDRESS, GAME_ABI, signer);
                    maoContract = new ethers.Contract(MAO_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                    piContract = new ethers.Contract(PI_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                }

                isConnected = true;
                
                // Êõ¥Êñ∞UI
                connectBtn.textContent = t('wallet-connected');
                document.getElementById('balanceDisplay').style.display = 'flex';
                document.getElementById('gameSection').style.display = 'block';

                // Ëé∑ÂèñÁúüÂÆû‰ΩôÈ¢ù
                await updateBalances();

                showStatusMessage(t('wallet-connected-success'), 'transaction-success');

            } catch (error) {
                console.error('‚ùå Èí±ÂåÖËøûÊé•Â§±Ë¥•:', error);
                showStatusMessage(t('wallet-connect-failed') + ': ' + error.message, 'insufficient-balance');
                
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = false;
                connectBtn.textContent = t('connect-wallet');
            }
        }

        // Ëá™Âä®ÈÖçÁΩÆÁΩëÁªú
        async function autoConfigureNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const alveyChainId = '0xED5'; // 3797 in hex
                
                if (chainId !== alveyChainId) {
                    console.log('üîÑ ÂàáÊç¢Âà∞AlveyÁΩëÁªú...');
                    
                    try {
                        // Â∞ùËØïÂàáÊç¢Âà∞AlveyÁΩëÁªú
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: alveyChainId }],
                        });
                        console.log('‚úÖ ÁΩëÁªúÂàáÊç¢ÊàêÂäü');
                    } catch (switchError) {
                        // Â¶ÇÊûúÁΩëÁªú‰∏çÂ≠òÂú®ÔºåËá™Âä®Ê∑ªÂä†ÁΩëÁªú
                        if (switchError.code === 4902) {
                            console.log('‚ûï Ê∑ªÂä†AlveyÁΩëÁªú...');
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: alveyChainId,
                                    chainName: 'AlveyChain',
                                    nativeCurrency: {
                                        name: 'ALV',
                                        symbol: 'ALV',
                                        decimals: 18
                                    },
                                    rpcUrls: RPC_URLS,
                                    blockExplorerUrls: ['https://alveyscan.com/']
                                }]
                            });
                            console.log('‚úÖ AlveyÁΩëÁªúÊ∑ªÂä†ÊàêÂäü');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    console.log('‚úÖ Â∑≤Âú®Ê≠£Á°ÆÁöÑAlveyÁΩëÁªú');
                }
            } catch (error) {
                console.error('‚ùå ÁΩëÁªúÈÖçÁΩÆÂ§±Ë¥•:', error);
                throw new Error('ÁΩëÁªúÈÖçÁΩÆÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ÂàáÊç¢Âà∞AlveyÁΩëÁªú');
            }
        }

        // Êõ¥Êñ∞‰ΩôÈ¢ù
        async function updateBalances() {
            try {
                if (!isConnected || !maoContract || !piContract) return;

                console.log('üìä Ê≠£Âú®Êõ¥Êñ∞‰ΩôÈ¢ù...');
                
                // Ëé∑ÂèñMAO‰ΩôÈ¢ù
                const maoBalance = await maoContract.balanceOf(userAddress);
                const maoDecimals = await maoContract.decimals();
                const maoFormatted = ethers.utils.formatUnits(maoBalance, maoDecimals);
                
                // Ëé∑ÂèñPI‰ΩôÈ¢ù
                const piBalance = await piContract.balanceOf(userAddress);
                const piDecimals = await piContract.decimals();
                const piFormatted = ethers.utils.formatUnits(piBalance, piDecimals);

                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('maoBalance').textContent = parseFloat(maoFormatted).toLocaleString();
                document.getElementById('piBalance').textContent = parseFloat(piFormatted).toLocaleString();

                console.log('‚úÖ ‰ΩôÈ¢ùÊõ¥Êñ∞ÂÆåÊàê - MAO:', maoFormatted, 'PI:', piFormatted);
                
            } catch (error) {
                console.error('‚ùå ‰ΩôÈ¢ùÊõ¥Êñ∞Â§±Ë¥•:', error);
                document.getElementById('maoBalance').textContent = t('failed');
                document.getElementById('piBalance').textContent = t('failed');
            }
        }

        // ÈÄâÊã©‰ª£Â∏Å
        function selectToken(token) {
            selectedToken = token;
            document.querySelectorAll('.token-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('üéØ ÈÄâÊã©‰ª£Â∏Å:', token);
        }

        // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶Ë∂≥Â§ü
        async function checkSufficientBalance() {
            try {
                const cost = GAME_COSTS[selectedToken];
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const balance = await contract.balanceOf(userAddress);
                
                return balance.gte(cost);
            } catch (error) {
                console.error('Ê£ÄÊü•‰ΩôÈ¢ùÂ§±Ë¥•:', error);
                return false;
            }
        }

        // ÊéàÊùÉ‰ª£Â∏Å
        async function approveToken() {
            try {
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const cost = GAME_COSTS[selectedToken];

                showStatusMessage(t('authorizing'), 'info');
                
                const tx = await contract.approve(GAME_CONTRACT_ADDRESS, cost);
                await tx.wait();

                console.log('‚úÖ ‰ª£Â∏ÅÊéàÊùÉÊàêÂäü');
                return true;
            } catch (error) {
                console.error('‚ùå ‰ª£Â∏ÅÊéàÊùÉÂ§±Ë¥•:', error);
                return false;
            }
        }

        // Ê∏∏ÊàèÈÄªËæë
        async function playGame() {
            if (isPlaying) return;
            
            try {
                if (!isConnected) {
                    showStatusMessage(t('connect-wallet-first'), 'insufficient-balance');
                    return;
                }
                
                // Ê£ÄÊü•‰ΩôÈ¢ù
                const hasSufficientBalance = await checkSufficientBalance();
                if (!hasSufficientBalance) {
                    const cost = selectedToken === 'MAO' ? '100' : '1000';
                    showStatusMessage(`${t('insufficient-balance')} ${cost} ${selectedToken}`, 'insufficient-balance');
                    return;
                }

                isPlaying = true;
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = true;
                playBtn.textContent = t('gaming');

                console.log('üéÆ ÂºÄÂßãÊ∏∏ÊàèÔºå‰ΩøÁî®‰ª£Â∏Å:', selectedToken);

                // Ê£ÄÊü•ÊéàÊùÉ
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const cost = GAME_COSTS[selectedToken];
                const allowance = await contract.allowance(userAddress, GAME_CONTRACT_ADDRESS);
                
                if (allowance.lt(cost)) {
                    const approved = await approveToken();
                    if (!approved) {
                        throw new Error('‰ª£Â∏ÅÊéàÊùÉÂ§±Ë¥•');
                    }
                }

                // ËΩ¨ÁõòÂä®Áîª
                await spinWheel();

                // Ë∞ÉÁî®Êô∫ËÉΩÂêàÁ∫¶
                showStatusMessage(t('processing'), 'info');
                
                const useMAO = selectedToken === 'MAO';
                const tx = await gameContract.playGame(useMAO);
                
                showStatusMessage(t('waiting-confirmation'), 'info');
                const receipt = await tx.wait();
                
                // Ëß£ÊûêÊ∏∏ÊàèÁªìÊûú
                const gameEvent = receipt.events?.find(e => e.event === 'GamePlayed');
                if (gameEvent) {
                    const { multiplier, reward } = gameEvent.args;
                    const multiplierValue = parseFloat(ethers.utils.formatEther(multiplier));
                    const rewardValue = parseFloat(ethers.utils.formatEther(reward));
                    
                    let resultText;
                    if (multiplierValue === 0) {
                        resultText = t('no-prize');
                    } else {
                        resultText = `${t('won-prize')} ${multiplierValue}ÂÄç Â•ñÂä±ÔºÅ\nÂ•ñÂä±: ${rewardValue.toLocaleString()} ${selectedToken}`;
                    }
                    
                    showResult(resultText, multiplierValue);
                } else {
                    showResult(t('game-complete'), 0);
                }

                // Êõ¥Êñ∞‰ΩôÈ¢ù
                await updateBalances();
                
                showStatusMessage(t('game-complete'), 'transaction-success');

            } catch (error) {
                console.error('‚ùå Ê∏∏ÊàèÂ§±Ë¥•:', error);
                
                let errorMessage = t('game-failed');
                if (error.message.includes('insufficient funds')) {
                    errorMessage = '‰ΩôÈ¢ù‰∏çË∂≥ÔºåÊó†Ê≥ïÊîØ‰ªògasË¥πÁî®';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = 'Áî®Êà∑ÂèñÊ∂à‰∫Ü‰∫§Êòì';
                } else if (error.message.includes('execution reverted')) {
                    errorMessage = 'ÂêàÁ∫¶ÊâßË°åÂ§±Ë¥•ÔºåÂèØËÉΩ‰ΩôÈ¢ù‰∏çË∂≥';
                }
                
                showStatusMessage(errorMessage, 'insufficient-balance');
            } finally {
                isPlaying = false;
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = false;
                playBtn.textContent = t('start-game');
            }
        }

        // ËΩ¨ÁõòÂä®Áîª
        async function spinWheel() {
            return new Promise((resolve) => {
                const wheel = document.getElementById('wheelSvg');
                const rotation = 1440 + Math.random() * 360; // 4Âúà + ÈöèÊú∫ËßíÂ∫¶
                
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                setTimeout(resolve, 3000); // 3ÁßíÂä®Áîª
            });
        }

        // ÊòæÁ§∫ÁªìÊûú
        function showResult(text, multiplier) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            
            if (multiplier > 0) {
                title.textContent = t('congratulations');
                title.style.color = '#4ECDC4';
            } else {
                title.textContent = t('sorry');
                title.style.color = '#FF6B6B';
            }
            
            resultText.textContent = text;
            modal.classList.add('show');
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('resultModal').classList.remove('show');
        }

        // ÁõëÂê¨Ë¥¶Êà∑ÂèòÂåñ
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // Áî®Êà∑Êñ≠ÂºÄËøûÊé•
                    isConnected = false;
                    document.getElementById('connectBtn').textContent = t('connect-wallet');
                    document.getElementById('balanceDisplay').style.display = 'none';
                    document.getElementById('gameSection').style.display = 'none';
                } else if (accounts[0] !== userAddress) {
                    // Áî®Êà∑ÂàáÊç¢Ë¥¶Êà∑
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // ÁΩëÁªúÂàáÊç¢ÔºåÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                location.reload();
            });
        }

        // ÈîôËØØÂ§ÑÁêÜÔºåÈò≤Ê≠¢È°µÈù¢Â¥©Ê∫É
        window.addEventListener('error', function(e) {
            console.error('üí• JavaScriptÈîôËØØ:', e.error);
            e.preventDefault();
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('üí• Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:', e.reason);
            e.preventDefault();
        });
    </script>

    <!-- Âä®ÊÄÅÂä†ËΩΩethers.js -->
    <script>
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
        script.async = true;
        script.onload = function() {
            console.log('‚úÖ ethers.js Âä†ËΩΩÊàêÂäü');
            
            // ÂàùÂßãÂåñÊ∏∏ÊàèË¥πÁî®Â∏∏Èáè
            initializeGameCosts();
        };
        script.onerror = function() {
            console.warn('‚ö†Ô∏è ethers.js Âä†ËΩΩÂ§±Ë¥•');
            showStatusMessage('ÁΩëÁªúÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'insufficient-balance');
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 