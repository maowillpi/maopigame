<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ</title>
    <style>
        * { 
            margin: 0; 
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #4f8cff 0%, #a259ff 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
            padding-bottom: 60px;
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
        }
        .lang-btn.active {
            background: rgba(255,224,102,0.3);
            border-color: #FFE066;
        }
        .game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .title {
            font-size: 2.5em;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #FFE066; }
            to { text-shadow: 0 0 30px #fff, 0 0 40px #fff, 0 0 50px #FFE066; }
        }
        .desc {
            font-size: 1.2em;
            margin: 10px 0 30px 0;
            opacity: 0.9;
        }
        .wallet-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .connect-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .balance-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .balance-item {
            text-align: center;
        }
        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .balance-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFE066;
        }
        .game-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .token-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .token-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .token-btn.active {
            background: rgba(255,224,102,0.3);
            border-color: #FFE066;
        }
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 30px auto;
        }
        .svg-wheel {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #FFE066;
            z-index: 10;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }
        .wheel-center-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #FFE066, #FFC107);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        .play-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin: 20px 0;
        }
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .play-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .burned-stats {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 8px 15px;
            display: flex;
            gap: 8px;
            font-size: 11px;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        .result-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #FFE066;
            z-index: 1000;
            text-align: center;
            display: none;
        }
        .result-modal.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .status-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        .insufficient-balance {
            background: rgba(231, 76, 60, 0.9) !important;
        }
        .transaction-success {
            background: rgba(39, 174, 96, 0.9) !important;
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <button class="lang-btn active">ä¸­æ–‡</button>
        <button class="lang-btn">English</button>
    </div>

    <div class="game-container">
        <div class="title">ğŸ° MAOè½¬ç›˜æ¸¸æˆ</div>
        <div class="desc">50%ä¸­å¥–ç‡ï¼Œæœ€é«˜å¯ä¸­10å€å¤§å¥–ï¼</div>
        
        <div class="wallet-section">
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">ğŸ”— è¿æ¥é’±åŒ…</button>
            <div class="balance-display" style="display: none;" id="balanceDisplay">
                <div class="balance-item">
                    <div class="balance-label">MAOä½™é¢</div>
                    <div class="balance-value" id="maoBalance">åŠ è½½ä¸­...</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">PIä½™é¢</div>
                    <div class="balance-value" id="piBalance">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="game-section" style="display: none;" id="gameSection">
            <div class="token-selector">
                <button class="token-btn active" onclick="selectToken('MAO')">MAO (100)</button>
                <button class="token-btn" onclick="selectToken('PI')">PI (1000)</button>
            </div>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <svg class="svg-wheel" id="wheelSvg" viewBox="0 0 270 270">
                    <circle cx="135" cy="135" r="130" fill="#FF6B6B" stroke="#fff" stroke-width="5"/>
                    <path d="M 135,5 A 130,130 0 0,1 240,85 L 135,135 Z" fill="#4ECDC4"/>
                    <path d="M 240,85 A 130,130 0 0,1 240,185 L 135,135 Z" fill="#FFE066"/>
                    <path d="M 240,185 A 130,130 0 0,1 135,265 L 135,135 Z" fill="#8B5CF6"/>
                    <path d="M 135,265 A 130,130 0 0,1 30,185 L 135,135 Z" fill="#10B981"/>
                    <path d="M 30,185 A 130,130 0 0,1 30,85 L 135,135 Z" fill="#F97316"/>
                    <text x="135" y="50" text-anchor="middle" fill="white" font-size="20">0x</text>
                    <text x="200" y="100" text-anchor="middle" fill="white" font-size="16">1.05x</text>
                    <text x="200" y="170" text-anchor="middle" fill="white" font-size="16">1.25x</text>
                    <text x="135" y="230" text-anchor="middle" fill="white" font-size="20">2x</text>
                    <text x="70" y="170" text-anchor="middle" fill="white" font-size="20">6x</text>
                    <text x="70" y="100" text-anchor="middle" fill="white" font-size="16">10x</text>
                </svg>
                <div class="wheel-center-btn">ğŸ°</div>
            </div>
            <button class="play-btn" id="playBtn" onclick="playGame()">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div class="burned-stats">
        <div>
            <span style="color: #ffeb3b;">MAO:</span>
            <span style="color: white; font-weight: bold;">201,001,230</span>
        </div>
        <div>
            <span style="color: #ffeb3b;">PI:</span>
            <span style="color: white; font-weight: bold;">83,000</span>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <div class="result-modal" id="resultModal">
        <h2 id="resultTitle">ğŸ‰</h2>
        <p id="resultText">æ­å–œè·å¾—å¥–åŠ±ï¼</p>
        <button id="closeModalBtn" onclick="closeModal()" style="background: #4ECDC4; color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 15px; cursor: pointer;">ç¡®å®š</button>
    </div>

    <script>
        // ç¿»è¯‘æ•°æ®
        const TRANSLATIONS = {
            'zh': {
                'title': 'ğŸ° MAOè½¬ç›˜æ¸¸æˆ',
                'subtitle': '50%ä¸­å¥–ç‡ï¼Œæœ€é«˜å¯ä¸­10å€å¤§å¥–ï¼',
                'connect-wallet': 'ğŸ”— è¿æ¥é’±åŒ…',
                'wallet-connected': 'âœ… é’±åŒ…å·²è¿æ¥',
                'connecting': 'ğŸ”Œ è¿æ¥ä¸­...',
                'mao-balance': 'MAOä½™é¢',
                'pi-balance': 'PIä½™é¢',
                'loading': 'åŠ è½½ä¸­...',
                'failed': 'è·å–å¤±è´¥',
                'start-game': 'ğŸ® å¼€å§‹æ¸¸æˆ',
                'gaming': 'ğŸ® æ¸¸æˆä¸­...',
                'connect-wallet-first': 'è¯·å…ˆè¿æ¥é’±åŒ…ï¼',
                'insufficient-balance': 'ä½™é¢ä¸è¶³ï¼éœ€è¦',
                'wallet-connected-success': 'é’±åŒ…è¿æ¥æˆåŠŸï¼',
                'wallet-connect-failed': 'é’±åŒ…è¿æ¥å¤±è´¥',
                'authorizing': 'æ­£åœ¨æˆæƒä»£å¸...',
                'processing': 'æ­£åœ¨å¤„ç†æ¸¸æˆäº¤æ˜“...',
                'waiting-confirmation': 'ç­‰å¾…äº¤æ˜“ç¡®è®¤...',
                'game-complete': 'æ¸¸æˆå®Œæˆï¼',
                'congratulations': 'ğŸ‰ æ­å–œä¸­å¥–ï¼',
                'sorry': 'ğŸ˜” å¾ˆé—æ†¾',
                'won-prize': 'æ­å–œï¼è·å¾—',
                'no-prize': 'å¾ˆé—æ†¾ï¼Œè¿™æ¬¡æ²¡æœ‰ä¸­å¥–ï¼',
                'close': 'ç¡®å®š',
                'burned-stats': 'å·²é”€æ¯ç»Ÿè®¡'
            },
            'en': {
                'title': 'ğŸ° MAO Wheel Game',
                'subtitle': '50% win rate, up to 10x prizes!',
                'connect-wallet': 'ğŸ”— Connect Wallet',
                'wallet-connected': 'âœ… Wallet Connected',
                'connecting': 'ğŸ”Œ Connecting...',
                'mao-balance': 'MAO Balance',
                'pi-balance': 'PI Balance',
                'loading': 'Loading...',
                'failed': 'Failed',
                'start-game': 'ğŸ® Start Game',
                'gaming': 'ğŸ® Playing...',
                'connect-wallet-first': 'Please connect wallet first!',
                'insufficient-balance': 'Insufficient balance! Need',
                'wallet-connected-success': 'Wallet connected successfully!',
                'wallet-connect-failed': 'Failed to connect wallet',
                'authorizing': 'Authorizing tokens...',
                'processing': 'Processing game transaction...',
                'waiting-confirmation': 'Waiting for confirmation...',
                'game-complete': 'Game complete!',
                'congratulations': 'ğŸ‰ Congratulations!',
                'sorry': 'ğŸ˜” Sorry',
                'won-prize': 'Congratulations! Won',
                'no-prize': 'Sorry, no prize this time!',
                'close': 'OK',
                'burned-stats': 'Burned Stats'
            }
        };

        // å½“å‰è¯­è¨€
        let currentLang = 'zh';

        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            const keys = key.split('.');
            let value = TRANSLATIONS[currentLang];
            for (const k of keys) {
                value = value[k];
                if (!value) break;
            }
            return value || key;
        }

        // æ›´æ–°ç•Œé¢è¯­è¨€
        function updateLanguage() {
            // æ›´æ–°æ ‡é¢˜å’Œæè¿°
            document.querySelector('.title').textContent = t('title');
            document.querySelector('.desc').textContent = t('subtitle');
            
            // æ›´æ–°è¿æ¥æŒ‰é’®æ–‡æœ¬
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn.textContent.includes('è¿æ¥é’±åŒ…') || connectBtn.textContent.includes('Connect Wallet')) {
                connectBtn.textContent = t('connect-wallet');
            } else if (connectBtn.textContent.includes('å·²è¿æ¥') || connectBtn.textContent.includes('Connected')) {
                connectBtn.textContent = t('wallet-connected');
            } else if (connectBtn.textContent.includes('è¿æ¥ä¸­') || connectBtn.textContent.includes('Connecting')) {
                connectBtn.textContent = t('connecting');
            }
            
            // æ›´æ–°ä½™é¢æ ‡ç­¾
            const balanceItems = document.querySelectorAll('.balance-display .balance-item');
            if (balanceItems.length >= 2) {
                balanceItems[0].querySelector('.balance-label').textContent = t('mao-balance');
                balanceItems[1].querySelector('.balance-label').textContent = t('pi-balance');
            }
            
            // æ›´æ–°æ¸¸æˆæŒ‰é’®
            const playBtn = document.getElementById('playBtn');
            if (playBtn && (playBtn.textContent.includes('å¼€å§‹æ¸¸æˆ') || playBtn.textContent.includes('Start Game'))) {
                playBtn.textContent = t('start-game');
            } else if (playBtn && (playBtn.textContent.includes('æ¸¸æˆä¸­') || playBtn.textContent.includes('Playing'))) {
                playBtn.textContent = t('gaming');
            }
            
            // æ›´æ–°å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('closeModalBtn');
            if (closeBtn) {
                closeBtn.textContent = t('close');
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œè¯­è¨€å±æ€§
            document.title = t('title');
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
        }

        // è¯­è¨€åˆ‡æ¢
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const isZh = btn.textContent.includes('ä¸­æ–‡');
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLang = isZh ? 'zh' : 'en';
                    updateLanguage();
                });
            });
            
            // åˆå§‹åŒ–è¯­è¨€
            updateLanguage();
        });

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let gameContract;
        let maoContract;
        let piContract;
        let userAddress;
        let selectedToken = 'MAO';
        let isConnected = false;
        let isPlaying = false;

        // åˆçº¦é…ç½®
        const GAME_CONTRACT_ADDRESS = '0xB677DBcA76061E6301272c83179c8243A4eeB6A5';
        const MAO_CONTRACT_ADDRESS = '0xB677DBcA76061E6301272c83179c8243A4eeB6A5'; // å®é™…çš„MAOä»£å¸åˆçº¦åœ°å€
        const PI_CONTRACT_ADDRESS = '0xA9E4FD96B29e4f512a0a75E402C156B04D6E6c35'; // å®é™…çš„PIä»£å¸åˆçº¦åœ°å€
        
        // RPCèŠ‚ç‚¹
        const RPC_URLS = [
            'https://elves-core1.alvey.io/',
            'https://elves-core2.alvey.io/',
            'https://elves-core3.alvey.io/'
        ];

        // æ¸¸æˆåˆçº¦ABI
        const GAME_ABI = [
            "function playGame(bool useMAO) external payable",
            "function prizePool() external view returns (uint256)",
            "function marketingWallet() external view returns (address)",
            "event GamePlayed(address indexed player, bool useMAO, uint256 amount, uint256 multiplier, uint256 reward)",
            "event Transfer(address indexed from, address indexed to, uint256 value)"
        ];

        // ERC20ä»£å¸ABI
        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function transfer(address to, uint256 amount) external returns (bool)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        // æ¸¸æˆè´¹ç”¨ - å°†åœ¨ethers.jsåŠ è½½ååˆå§‹åŒ–
        let GAME_COSTS = {};

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ MAOè½¬ç›˜æ¸¸æˆåŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆè´¹ç”¨
        function initializeGameCosts() {
            if (typeof ethers !== 'undefined') {
                GAME_COSTS = {
                    MAO: ethers.utils.parseEther('100'), // 100 MAO
                    PI: ethers.utils.parseEther('1000')  // 1000 PI
                };
                console.log('âœ… æ¸¸æˆè´¹ç”¨åˆå§‹åŒ–å®Œæˆ');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = true;
                connectBtn.textContent = t('connecting');

                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…ï¼');
                }

                console.log('ğŸ”Œ æ­£åœ¨è¿æ¥é’±åŒ…...');
                
                // è¯·æ±‚è¿æ¥é’±åŒ…
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    throw new Error('è¯·åœ¨é’±åŒ…ä¸­æˆæƒè¿æ¥ï¼');
                }

                userAddress = accounts[0];
                console.log('âœ… é’±åŒ…è¿æ¥æˆåŠŸ:', userAddress);

                // è‡ªåŠ¨é…ç½®æ­£ç¡®çš„ç½‘ç»œ
                await autoConfigureNetwork();

                // åˆå§‹åŒ–providerå’Œåˆçº¦
                if (typeof ethers !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // åˆå§‹åŒ–åˆçº¦
                    gameContract = new ethers.Contract(GAME_CONTRACT_ADDRESS, GAME_ABI, signer);
                    maoContract = new ethers.Contract(MAO_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                    piContract = new ethers.Contract(PI_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                }

                isConnected = true;
                
                // æ›´æ–°UI
                connectBtn.textContent = t('wallet-connected');
                document.getElementById('balanceDisplay').style.display = 'flex';
                document.getElementById('gameSection').style.display = 'block';

                // è·å–çœŸå®ä½™é¢
                await updateBalances();

                showStatusMessage(t('wallet-connected-success'), 'transaction-success');

            } catch (error) {
                console.error('âŒ é’±åŒ…è¿æ¥å¤±è´¥:', error);
                showStatusMessage(t('wallet-connect-failed') + ': ' + error.message, 'insufficient-balance');
                
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = false;
                connectBtn.textContent = t('connect-wallet');
            }
        }

        // è‡ªåŠ¨é…ç½®ç½‘ç»œ
        async function autoConfigureNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const alveyChainId = '0xED5'; // 3797 in hex
                
                if (chainId !== alveyChainId) {
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°Alveyç½‘ç»œ...');
                    
                    try {
                        // å°è¯•åˆ‡æ¢åˆ°Alveyç½‘ç»œ
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: alveyChainId }],
                        });
                        console.log('âœ… ç½‘ç»œåˆ‡æ¢æˆåŠŸ');
                    } catch (switchError) {
                        // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ·»åŠ ç½‘ç»œ
                        if (switchError.code === 4902) {
                            console.log('â• æ·»åŠ Alveyç½‘ç»œ...');
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: alveyChainId,
                                    chainName: 'AlveyChain',
                                    nativeCurrency: {
                                        name: 'ALV',
                                        symbol: 'ALV',
                                        decimals: 18
                                    },
                                    rpcUrls: RPC_URLS,
                                    blockExplorerUrls: ['https://alveyscan.com/']
                                }]
                            });
                            console.log('âœ… Alveyç½‘ç»œæ·»åŠ æˆåŠŸ');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    console.log('âœ… å·²åœ¨æ­£ç¡®çš„Alveyç½‘ç»œ');
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œé…ç½®å¤±è´¥:', error);
                throw new Error('ç½‘ç»œé…ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°Alveyç½‘ç»œ');
            }
        }

        // æ›´æ–°ä½™é¢
        async function updateBalances() {
            try {
                if (!isConnected || !maoContract || !piContract) return;

                console.log('ğŸ“Š æ­£åœ¨æ›´æ–°ä½™é¢...');
                
                // è·å–MAOä½™é¢
                const maoBalance = await maoContract.balanceOf(userAddress);
                const maoDecimals = await maoContract.decimals();
                const maoFormatted = ethers.utils.formatUnits(maoBalance, maoDecimals);
                
                // è·å–PIä½™é¢
                const piBalance = await piContract.balanceOf(userAddress);
                const piDecimals = await piContract.decimals();
                const piFormatted = ethers.utils.formatUnits(piBalance, piDecimals);

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('maoBalance').textContent = parseFloat(maoFormatted).toLocaleString();
                document.getElementById('piBalance').textContent = parseFloat(piFormatted).toLocaleString();

                console.log('âœ… ä½™é¢æ›´æ–°å®Œæˆ - MAO:', maoFormatted, 'PI:', piFormatted);
                
            } catch (error) {
                console.error('âŒ ä½™é¢æ›´æ–°å¤±è´¥:', error);
                document.getElementById('maoBalance').textContent = t('failed');
                document.getElementById('piBalance').textContent = t('failed');
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            selectedToken = token;
            document.querySelectorAll('.token-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('ğŸ¯ é€‰æ‹©ä»£å¸:', token);
        }

        // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
        async function checkSufficientBalance() {
            try {
                const cost = GAME_COSTS[selectedToken];
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const balance = await contract.balanceOf(userAddress);
                
                return balance.gte(cost);
            } catch (error) {
                console.error('æ£€æŸ¥ä½™é¢å¤±è´¥:', error);
                return false;
            }
        }

        // æˆæƒä»£å¸
        async function approveToken() {
            try {
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const cost = GAME_COSTS[selectedToken];

                showStatusMessage(t('authorizing'), 'info');
                
                const tx = await contract.approve(GAME_CONTRACT_ADDRESS, cost);
                await tx.wait();

                console.log('âœ… ä»£å¸æˆæƒæˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ ä»£å¸æˆæƒå¤±è´¥:', error);
                return false;
            }
        }

        // æ¸¸æˆé€»è¾‘
        async function playGame() {
            if (isPlaying) return;
            
            try {
                if (!isConnected) {
                    showStatusMessage(t('connect-wallet-first'), 'insufficient-balance');
                    return;
                }
                
                // æ£€æŸ¥ä½™é¢
                const hasSufficientBalance = await checkSufficientBalance();
                if (!hasSufficientBalance) {
                    const cost = selectedToken === 'MAO' ? '100' : '1000';
                    showStatusMessage(`${t('insufficient-balance')} ${cost} ${selectedToken}`, 'insufficient-balance');
                    return;
                }

                isPlaying = true;
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = true;
                playBtn.textContent = t('gaming');

                console.log('ğŸ® å¼€å§‹æ¸¸æˆï¼Œä½¿ç”¨ä»£å¸:', selectedToken);

                // æ£€æŸ¥æˆæƒ
                const contract = selectedToken === 'MAO' ? maoContract : piContract;
                const cost = GAME_COSTS[selectedToken];
                const allowance = await contract.allowance(userAddress, GAME_CONTRACT_ADDRESS);
                
                if (allowance.lt(cost)) {
                    const approved = await approveToken();
                    if (!approved) {
                        throw new Error('ä»£å¸æˆæƒå¤±è´¥');
                    }
                }

                // è½¬ç›˜åŠ¨ç”»
                await spinWheel();

                // è°ƒç”¨æ™ºèƒ½åˆçº¦
                showStatusMessage(t('processing'), 'info');
                
                const useMAO = selectedToken === 'MAO';
                const tx = await gameContract.playGame(useMAO);
                
                showStatusMessage(t('waiting-confirmation'), 'info');
                const receipt = await tx.wait();
                
                // è§£ææ¸¸æˆç»“æœ
                const gameEvent = receipt.events?.find(e => e.event === 'GamePlayed');
                if (gameEvent) {
                    const { multiplier, reward } = gameEvent.args;
                    const multiplierValue = parseFloat(ethers.utils.formatEther(multiplier));
                    const rewardValue = parseFloat(ethers.utils.formatEther(reward));
                    
                    let resultText;
                    if (multiplierValue === 0) {
                        resultText = t('no-prize');
                    } else {
                        resultText = `${t('won-prize')} ${multiplierValue}å€ å¥–åŠ±ï¼\nå¥–åŠ±: ${rewardValue.toLocaleString()} ${selectedToken}`;
                    }
                    
                    showResult(resultText, multiplierValue);
                } else {
                    showResult(t('game-complete'), 0);
                }

                // æ›´æ–°ä½™é¢
                await updateBalances();
                
                showStatusMessage(t('game-complete'), 'transaction-success');

            } catch (error) {
                console.error('âŒ æ¸¸æˆå¤±è´¥:', error);
                
                let errorMessage = t('game-failed');
                if (error.message.includes('insufficient funds')) {
                    errorMessage = 'ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜gasè´¹ç”¨';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.message.includes('execution reverted')) {
                    errorMessage = 'åˆçº¦æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½ä½™é¢ä¸è¶³';
                }
                
                showStatusMessage(errorMessage, 'insufficient-balance');
            } finally {
                isPlaying = false;
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = false;
                playBtn.textContent = t('start-game');
            }
        }

        // è½¬ç›˜åŠ¨ç”»
        async function spinWheel() {
            return new Promise((resolve) => {
                const wheel = document.getElementById('wheelSvg');
                const rotation = 1440 + Math.random() * 360; // 4åœˆ + éšæœºè§’åº¦
                
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                setTimeout(resolve, 3000); // 3ç§’åŠ¨ç”»
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(text, multiplier) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            
            if (multiplier > 0) {
                title.textContent = t('congratulations');
                title.style.color = '#4ECDC4';
            } else {
                title.textContent = t('sorry');
                title.style.color = '#FF6B6B';
            }
            
            resultText.textContent = text;
            modal.classList.add('show');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('resultModal').classList.remove('show');
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // ç”¨æˆ·æ–­å¼€è¿æ¥
                    isConnected = false;
                    document.getElementById('connectBtn').textContent = t('connect-wallet');
                    document.getElementById('balanceDisplay').style.display = 'none';
                    document.getElementById('gameSection').style.display = 'none';
                } else if (accounts[0] !== userAddress) {
                    // ç”¨æˆ·åˆ‡æ¢è´¦æˆ·
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // ç½‘ç»œåˆ‡æ¢ï¼Œé‡æ–°åŠ è½½é¡µé¢
                location.reload();
            });
        }

        // é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢é¡µé¢å´©æºƒ
        window.addEventListener('error', function(e) {
            console.error('ğŸ’¥ JavaScripté”™è¯¯:', e.error);
            e.preventDefault();
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            e.preventDefault();
        });
    </script>

    <!-- åŠ¨æ€åŠ è½½ethers.js -->
    <script>
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
        script.async = true;
        script.onload = function() {
            console.log('âœ… ethers.js åŠ è½½æˆåŠŸ');
            
            // åˆå§‹åŒ–æ¸¸æˆè´¹ç”¨å¸¸é‡
            initializeGameCosts();
        };
        script.onerror = function() {
            console.warn('âš ï¸ ethers.js åŠ è½½å¤±è´¥');
            showStatusMessage('ç½‘ç»œåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'insufficient-balance');
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 