<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ° MAOè½¬ç›˜æ¸¸æˆ - AlveyChain åŒºå—é“¾æ¸¸æˆ v4.1.0 è¥é”€é’±åŒ…ç‰ˆ</title>
    
    <!-- å¼ºåˆ¶ç¼“å­˜æ¸…é™¤ v4.1.0 è¥é”€é’±åŒ…ç‰ˆ -->
    <script>
        const CACHE_VERSION = 'v4.1.0-marketing-' + Date.now();
        console.log('ğŸš€ MAOè½¬ç›˜æ¸¸æˆ v4.1.0 è¥é”€é’±åŒ…ç‰ˆ - å¼ºåˆ¶æ›´æ–°');
        console.log('ğŸ“… ç¼“å­˜ç‰ˆæœ¬:', CACHE_VERSION);
        console.log('ğŸ¯ éƒ¨ç½²æ—¶é—´:', new Date().toLocaleString('zh-CN'));
        
        // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰æ—§ç¼“å­˜
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                    console.log('ğŸ—‘ï¸ æ¸…é™¤Service Worker');
                }
            });
        }
        
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    caches.delete(name);
                    console.log('ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜:', name);
                });
            });
        }
        
        // é¡µé¢ç‰ˆæœ¬æ£€æŸ¥
        const lastVersion = localStorage.getItem('mao_game_version');
        if (lastVersion !== CACHE_VERSION) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°v4.0.1æœ€ç»ˆç‰ˆæœ¬ï¼Œå¼ºåˆ¶æ›´æ–°ç¼“å­˜');
            localStorage.setItem('mao_game_version', CACHE_VERSION);
            
            // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
            console.log('âœ… å·²æ›´æ–°åˆ°MAOè½¬ç›˜æ¸¸æˆv4.0.1æœ€ç»ˆç‰ˆæœ¬ï¼');
            console.log('ğŸŒŸ æ–°åŠŸèƒ½: ä¼˜åŒ–é’±åŒ…è¿æ¥ + ä¿®å¤æŠ•æ³¨é‡‘é¢ + å¢å¼ºè½¬ç›˜ç•Œé¢');
        }
        
        // å¼ºåˆ¶ç¦ç”¨ç¼“å­˜
        if (window.location.search.indexOf('nocache') === -1) {
            const separator = window.location.search ? '&' : '?';
            const newUrl = window.location.href + separator + 'nocache=' + Date.now();
            if (lastVersion && lastVersion !== CACHE_VERSION) {
                console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢æ¸…é™¤ç¼“å­˜');
                window.location.replace(newUrl);
            }
        }
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ethers.js CDN - ä½¿ç”¨æ›´ç¨³å®šçš„ç‰ˆæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .wheel-animation {
            transition: transform 2.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .bounce-animation {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -30px, 0); }
            70% { transform: translate3d(0, -15px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }
        
        .bg-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ğŸ° è¶…çº§ä¸“ä¸šè½¬ç›˜è®¾è®¡ */
        .super-wheel {
            background: conic-gradient(
                from 0deg,
                #FF6B9D 0deg 60deg,    /* è°¢è°¢æƒ é¡¾ - ç²‰çº¢è‰² */
                #4ECDC4 60deg 120deg,  /* å°å¥– - é’ç»¿è‰² */
                #45B7D1 120deg 180deg, /* ä¸­å¥– - è“è‰² */
                #96CEB4 180deg 240deg, /* å¤§å¥– - è–„è·ç»¿ */
                #FFEAA7 240deg 300deg, /* è¶…çº§å¤§å¥– - é‡‘é»„è‰² */
                #DDA0DD 300deg 360deg  /* ç»ˆæå¤§å¥– - ç´«è‰² */
            );
            border: 12px solid #FFD700;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.8),
                inset 0 0 40px rgba(0, 0, 0, 0.3),
                0 0 120px rgba(255, 215, 0, 0.6),
                0 0 200px rgba(255, 255, 255, 0.2);
            position: relative;
            animation: wheelGlow 4s ease-in-out infinite alternate;
            transform-style: preserve-3d;
        }
        
        @keyframes wheelGlow {
            0% { 
                box-shadow: 
                    0 0 60px rgba(255, 215, 0, 0.8),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 120px rgba(255, 215, 0, 0.6);
                transform: rotateX(0deg);
            }
            100% { 
                box-shadow: 
                    0 0 100px rgba(255, 215, 0, 1),
                    inset 0 0 40px rgba(0, 0, 0, 0.3),
                    0 0 160px rgba(255, 215, 0, 0.8);
                transform: rotateX(5deg);
            }
        }
        
        /* è½¬ç›˜å†…åœˆè£…é¥° */
        .super-wheel::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border-radius: 50%;
            border: 6px solid rgba(255, 255, 255, 0.6);
            z-index: 1;
            box-shadow: 
                inset 0 0 30px rgba(255, 255, 255, 0.3),
                0 0 20px rgba(255, 255, 255, 0.5);
            animation: innerRing 3s ease-in-out infinite alternate;
        }

        @keyframes innerRing {
            0% { 
                border-color: rgba(255, 255, 255, 0.6);
                box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
            100% { 
                border-color: rgba(255, 255, 255, 0.9);
                box-shadow: inset 0 0 50px rgba(255, 255, 255, 0.5);
            }
        }
        
        /* è¶…çº§MAO Logoè®¾è®¡ */
        .super-mao-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #ff6b9d);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 900;
            color: white;
            text-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(102, 126, 234, 1),
                0 0 30px rgba(255, 107, 157, 0.8);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.5),
                inset 0 4px 8px rgba(255, 255, 255, 0.4),
                0 0 40px rgba(102, 126, 234, 0.7);
            border: 4px solid rgba(255, 255, 255, 0.7);
            z-index: 20;
            animation: logoFloat 6s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { 
                transform: translate(-50%, -50%) rotateY(0deg) scale(1);
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 0 20px rgba(102, 126, 234, 1);
            }
            50% { 
                transform: translate(-50%, -50%) rotateY(180deg) scale(1.1);
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 0 30px rgba(255, 107, 157, 1);
            }
        }
        
        /* è½¬ç›˜åŒºåŸŸè¶…çº§è®¾è®¡ */
        .super-wheel-section {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 
                0 3px 6px rgba(0, 0, 0, 0.9),
                0 0 15px rgba(255, 255, 255, 0.8);
            z-index: 10;
            transition: all 0.4s ease;
        }
        
        .super-wheel-section:hover {
            transform: scale(1.2);
            z-index: 15;
        }
        
        .super-wheel-section .super-emoji {
            font-size: 48px;
            margin-bottom: 8px;
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 1),
                0 3px 6px rgba(0, 0, 0, 0.8);
            animation: emojiDance 3s ease-in-out infinite;
        }
        
        @keyframes emojiDance {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                text-shadow: 0 0 20px rgba(255, 255, 255, 1);
            }
            25% { 
                transform: translateY(-5px) rotate(5deg);
                text-shadow: 0 0 25px rgba(255, 215, 0, 1);
            }
            75% { 
                transform: translateY(-3px) rotate(-5deg);
                text-shadow: 0 0 25px rgba(255, 107, 157, 1);
            }
        }
        
        .super-wheel-section .super-reward-badge {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95), 
                rgba(255, 215, 0, 0.2),
                rgba(0, 0, 0, 0.95)
            );
            border: 4px solid #FFD700;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 16px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 1),
                0 2px 4px rgba(0, 0, 0, 1);
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                inset 0 2px 4px rgba(255, 255, 255, 0.3),
                0 4px 8px rgba(0, 0, 0, 0.5);
            animation: badgeShine 2s ease-in-out infinite;
        }
        
        @keyframes badgeShine {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                border-color: #FFD700;
            }
            50% { 
                box-shadow: 0 0 35px rgba(255, 215, 0, 1);
                border-color: #FFF;
            }
        }

        .super-wheel-section .probability-display {
            font-size: 12px;
            color: #FFD700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 1);
            margin-top: 4px;
            animation: probabilityPulse 2s ease-in-out infinite;
        }

        @keyframes probabilityPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; text-shadow: 0 0 12px rgba(255, 215, 0, 1); }
        }
        
        /* è¶…çº§æŒ‡é’ˆè®¾è®¡ */
        .super-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            animation: pointerFloat 2s ease-in-out infinite alternate;
        }
        
        @keyframes pointerFloat {
            0% { 
                transform: translateX(-50%) translateY(0px);
                filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.6));
            }
            100% { 
                transform: translateX(-50%) translateY(-5px);
                filter: drop-shadow(0 12px 24px rgba(0, 0, 0, 0.8));
            }
        }
        
        .super-pointer::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 35px solid transparent;
            border-right: 35px solid transparent;
            border-bottom: 70px solid #FFD700;
            display: block;
            position: relative;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
        }
        
        .super-pointer::after {
            content: '';
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #FFD700, #FFA500, #FF6B9D);
            border-radius: 50%;
            border: 6px solid #fff;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(255, 215, 0, 0.8),
                inset 0 2px 4px rgba(255, 255, 255, 0.5);
            animation: pointerGem 3s ease-in-out infinite;
        }

        @keyframes pointerGem {
            0%, 100% { 
                background: radial-gradient(circle, #FFD700, #FFA500);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.8);
            }
            50% { 
                background: radial-gradient(circle, #FF6B9D, #DDA0DD);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 107, 157, 1);
            }
        }
        
        /* è½¬ç›˜åˆ†å‰²çº¿è¶…çº§è®¾è®¡ */
        .super-divider {
            position: absolute;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 1), 
                rgba(255, 215, 0, 0.8),
                rgba(255, 255, 255, 1), 
                transparent
            );
            height: 4px;
            transform-origin: center;
            z-index: 8;
            box-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6);
            animation: dividerShimmer 4s ease-in-out infinite;
        }

        @keyframes dividerShimmer {
            0%, 100% { 
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 1), transparent);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            }
            50% { 
                background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 1), transparent);
                box-shadow: 0 0 15px rgba(255, 215, 0, 1);
            }
        }

        /* è¶…çº§æ¸¸æˆæŒ‰é’® */
        .super-spin-btn {
            width: 140px !important;
            height: 140px !important;
            background: linear-gradient(135deg, #FF6B9D, #4ECDC4, #45B7D1, #FFEAA7) !important;
            background-size: 300% 300% !important;
            border: 6px solid rgba(255, 255, 255, 0.9) !important;
            border-radius: 50% !important;
            position: relative !important;
            overflow: hidden !important;
            animation: superBtnAnimation 4s ease-in-out infinite !important;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 4px 8px rgba(255, 255, 255, 0.3),
                0 0 60px rgba(255, 107, 157, 0.6) !important;
        }

        @keyframes superBtnAnimation {
            0%, 100% { 
                background-position: 0% 50%;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 60px rgba(255, 107, 157, 0.6);
            }
            50% { 
                background-position: 100% 50%;
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 80px rgba(78, 205, 196, 0.8);
            }
        }

        .super-spin-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FFD700, #FF6B9D, #4ECDC4, #DDA0DD);
            border-radius: 50%;
            z-index: -1;
            animation: btnBorderSpin 3s linear infinite;
        }

        @keyframes btnBorderSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .super-spin-btn:hover {
            transform: scale(1.1) !important;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.5),
                inset 0 4px 8px rgba(255, 255, 255, 0.4),
                0 0 100px rgba(255, 215, 0, 1) !important;
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #FFD700, transparent);
            border-radius: 50%;
            animation: particleFloat 6s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0% { 
                transform: translateY(0px) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(-400px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gradient min-h-screen">
    
    <!-- å¤´éƒ¨ -->
    <div class="glass-effect sticky top-0 z-50 px-4 py-3 text-center">
        <h1 class="text-xl font-bold text-white">ğŸ° MAOè½¬ç›˜æ¸¸æˆ <span class="text-yellow-400 text-sm">v4.0.1</span></h1>
        <p class="text-xs text-blue-200">AlveyChain åŒºå—é“¾æ¸¸æˆ Â· æœ€ç»ˆç‰ˆ</p>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="px-4 py-4 space-y-4 pb-20" id="app">
        
        <!-- è¿æ¥é’±åŒ…ç•Œé¢ -->
        <div id="walletConnect" class="text-center space-y-6">
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-6xl mb-4 bounce-animation">ğŸ°</div>
                <h2 class="text-2xl font-bold text-white mb-3">æ¬¢è¿æ¥åˆ°MAOè½¬ç›˜</h2>
                <p class="text-blue-200 text-sm mb-6">è¿æ¥æ‚¨çš„é’±åŒ…å¼€å§‹è½¬ç›˜ä¹‹æ—…</p>
                <button 
                    id="connectBtn" 
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                    ğŸ”— è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ
                </button>
            </div>
            
            <!-- å¥–åŠ±é¢„è§ˆ -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">ğŸ’° å…¨æ–°ä¼˜åŒ–å¥–åŠ±ç³»ç»Ÿï¼</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ</div>
                        <div class="text-yellow-400 font-bold">å°å¥– 8%</div>
                        <div class="text-white text-xs">150 MAO</div>
                        <div class="text-green-400 text-xs">æœ‰ç›ˆåˆ©ï¼</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ†</div>
                        <div class="text-yellow-400 font-bold">ä¸­å¥– 4%</div>
                        <div class="text-white text-xs">400 MAO</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ’</div>
                        <div class="text-yellow-400 font-bold">å¤§å¥– 2%</div>
                        <div class="text-white text-xs">800 MAO</div>
                    </div>
                    <div class="glass-effect rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ’°</div>
                        <div class="text-yellow-400 font-bold">ç»ˆæå¤§å¥–</div>
                        <div class="text-white text-xs">3000 MAO</div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <p class="text-xs text-green-300">
                        ğŸ‰ 15%è¶…é«˜ä¸­å¥–ç‡ Â· å°å¥–æœ‰ç›ˆåˆ© Â· å³æ—¶åˆ°è´¦ï¼
                    </p>
                </div>
            </div>

            <!-- æ¸¸æˆè¯´æ˜ -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">ğŸ“– æ¸¸æˆè¯´æ˜</h3>
                <ul class="text-blue-200 text-sm space-y-2">
                    <li>â€¢ æ¯æ¬¡æ¸¸æˆæ¶ˆè€— 100 MAO æˆ– 10,000 PI</li>
                    <li>â€¢ çœŸå®åˆçº¦å¥–åŠ±ç³»ç»Ÿï¼Œ15%ä¸­å¥–ç‡</li>
                    <li>â€¢ å°å¥–æœ‰ç›ˆåˆ©æ„Ÿï¼Œæœ€é«˜å¥–åŠ±30å€ï¼ˆ3000 MAO / 300K PIï¼‰</li>
                    <li>â€¢ åŸºäºAlveyChainæ™ºèƒ½åˆçº¦ï¼Œå…¬å¹³é€æ˜</li>
                    <li>â€¢ æ”¯æŒTPé’±åŒ…ã€Trust Walletç­‰ä¸»æµé’±åŒ…</li>
                    <li>â€¢ å¥–åŠ±è‡ªåŠ¨è½¬è´¦ï¼Œå³æ—¶åˆ°è´¦</li>
                </ul>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameInterface" class="space-y-4" style="display: none;">
            
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="glass-effect rounded-xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-blue-200 text-xs">é’±åŒ…åœ°å€</p>
                        <p class="text-white text-sm font-mono" id="userAddress">æœªè¿æ¥</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-200 text-xs">å½“å‰ä½™é¢</p>
                        <p class="text-white font-bold text-lg" id="userBalance">0 MAO</p>
                    </div>
                </div>
                
                <!-- ä½™é¢åˆ·æ–°æŒ‰é’® -->
                <button 
                    id="refreshBalanceBtn"
                    class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200 transform hover:scale-105"
                    onclick="refreshBalanceManually()"
                >
                    ğŸ”„ åˆ·æ–°ä½™é¢
                </button>
            </div>

            <!-- ä»£å¸é€‰æ‹© -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">é€‰æ‹©æ¸¸æˆä»£å¸</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        id="maoBtn" 
                        class="token-btn py-4 px-4 rounded-xl font-semibold transition-all bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg scale-105"
                        data-token="MAO"
                    >
                        <div class="text-lg">MAO</div>
                        <div class="text-xs mt-1">100 MAO/æ¬¡</div>
                        <div class="text-xs text-yellow-400" id="maoBalance">ä½™é¢: 0</div>
                    </button>
                    <button 
                        id="piBtn" 
                        class="token-btn py-4 px-4 rounded-xl font-semibold transition-all bg-white/20 text-blue-200 hover:bg-white/30"
                        data-token="PI"
                    >
                        <div class="text-lg">PI</div>
                        <div class="text-xs mt-1">10,000 PI/æ¬¡</div>
                        <div class="text-xs text-yellow-400" id="piBalance">ä½™é¢: 0</div>
                    </button>
                </div>
            </div>

            <!-- è½¬ç›˜æ¸¸æˆ -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-white font-bold text-center mb-4 text-lg">ğŸ° è¶…çº§å¹¸è¿è½¬ç›˜</h3>
                
                <!-- è¶…çº§ä¸“ä¸šè½¬ç›˜ -->
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div 
                            id="wheel"
                            class="w-96 h-96 rounded-full super-wheel wheel-animation shadow-2xl relative overflow-hidden"
                        >
                            <!-- ç²’å­æ•ˆæœå®¹å™¨ -->
                            <div class="particles" id="particleContainer"></div>
                            
                            <!-- è½¬ç›˜å¥–é¡¹åŒºåŸŸ - è¶…çº§è®¾è®¡ -->
                            <!-- åŒºåŸŸ1: è°¢è°¢æƒ é¡¾ (0-60åº¦) -->
                            <div class="super-wheel-section absolute top-8 left-1/2 transform -translate-x-1/2 text-center">
                                <div class="super-emoji">ğŸ˜Š</div>
                                <div class="text-sm font-bold mb-2">è°¢è°¢æƒ é¡¾</div>
                                <div class="probability-display">58%</div>
                                <div class="super-reward-badge" id="reward0">0</div>
                            </div>
                            
                            <!-- åŒºåŸŸ2: å°å¥– (60-120åº¦) -->
                            <div class="super-wheel-section absolute top-12 right-8 transform text-center">
                                <div class="super-emoji">ğŸ</div>
                                <div class="text-sm font-bold mb-2">å°å¥–</div>
                                <div class="probability-display">22%</div>
                                <div class="super-reward-badge" id="reward1">105</div>
                            </div>
                            
                            <!-- åŒºåŸŸ3: ä¸­å¥– (120-180åº¦) -->
                            <div class="super-wheel-section absolute bottom-12 right-8 transform text-center">
                                <div class="super-emoji">ğŸ†</div>
                                <div class="text-sm font-bold mb-2">ä¸­å¥–</div>
                                <div class="probability-display">12%</div>
                                <div class="super-reward-badge" id="reward2">150</div>
                            </div>
                            
                            <!-- åŒºåŸŸ4: å¤§å¥– (180-240åº¦) -->
                            <div class="super-wheel-section absolute bottom-8 left-1/2 transform -translate-x-1/2 text-center">
                                <div class="super-emoji">ğŸ’</div>
                                <div class="text-sm font-bold mb-2">å¤§å¥–</div>
                                <div class="probability-display">6%</div>
                                <div class="super-reward-badge" id="reward3">250</div>
                            </div>
                            
                            <!-- åŒºåŸŸ5: è¶…çº§å¤§å¥– (240-300åº¦) -->
                            <div class="super-wheel-section absolute bottom-12 left-8 transform text-center">
                                <div class="super-emoji">ğŸŒŸ</div>
                                <div class="text-sm font-bold mb-2">è¶…çº§</div>
                                <div class="probability-display">1.5%</div>
                                <div class="super-reward-badge" id="reward4">400</div>
                            </div>
                            
                            <!-- åŒºåŸŸ6: ç»ˆæå¤§å¥– (300-360åº¦) -->
                            <div class="super-wheel-section absolute top-12 left-8 transform text-center">
                                <div class="super-emoji">ğŸ’°</div>
                                <div class="text-sm font-bold mb-2">ç»ˆæ</div>
                                <div class="probability-display">0.5%</div>
                                <div class="super-reward-badge" id="reward5">700</div>
                            </div>
                            
                            <!-- è¶…çº§åˆ†å‰²çº¿ -->
                            <div class="super-divider top-0 left-1/2 w-full transform -translate-x-1/2"></div>
                            <div class="super-divider top-1/2 left-0 w-full transform -translate-y-1/2 rotate-60"></div>
                            <div class="super-divider top-1/2 left-0 w-full transform -translate-y-1/2 rotate-120"></div>
                            
                            <!-- è¶…çº§MAO Logo -->
                            <div class="super-mao-logo">
                                MAO
                            </div>
                        </div>
                        
                        <!-- è¶…çº§æŒ‡é’ˆ -->
                        <div class="super-pointer"></div>
                        
                        <!-- è¶…çº§æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 translate-y-24 z-30">
                            <button
                                id="spinBtn"
                                class="super-spin-btn font-bold text-lg transition-all duration-300 transform hover:scale-110 text-white"
                            >
                                <div class="relative z-10">
                                    <div class="text-4xl mb-2">ğŸ²</div>
                                    <div class="text-sm font-bold">å¼€å§‹æ¸¸æˆ</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆçŠ¶æ€å’Œè¿ç»­æ¸¸æˆæ§åˆ¶ -->
                <div class="glass-effect rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <p class="text-blue-200 text-sm mb-2">
                            æœ¬è½®æŠ•æ³¨: <span class="text-yellow-400 font-bold text-lg" id="betAmount">10,000 PI</span>
                        </p>
                        <div class="flex justify-center gap-3 mb-3">
                            <div class="text-center">
                                <div class="text-xs text-blue-300">æ¸¸æˆæ¬¡æ•°</div>
                                <div class="text-yellow-400 font-bold" id="gameCount">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-blue-300">æ€»æŠ•æ³¨</div>
                                <div class="text-yellow-400 font-bold" id="totalBet">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-blue-300">æ€»å¥–åŠ±</div>
                                <div class="text-green-400 font-bold" id="totalReward">0</div>
                            </div>
                        </div>
                        <div id="lastResult" class="hidden bg-black/30 rounded-lg p-3">
                            <p class="text-green-400 text-sm" id="resultText"></p>
                        </div>
                    </div>
                </div>

                <!-- å¥–åŠ±éªŒè¯åŒºåŸŸ -->
                <div class="glass-effect rounded-lg p-3 mb-4">
                    <h4 class="text-white font-semibold text-center mb-2 text-sm">ğŸ’° å¥–åŠ±è‡ªåŠ¨è½¬è´¦éªŒè¯</h4>
                    <div class="text-xs text-blue-200 text-center mb-2">
                        æ™ºèƒ½åˆçº¦å°†è‡ªåŠ¨å°†å¥–åŠ±è½¬å…¥æ‚¨çš„é’±åŒ…åœ°å€
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-blue-300">æ¸¸æˆå‰ä½™é¢:</span>
                        <span class="text-white" id="balanceBefore">-</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-blue-300">æ¸¸æˆåä½™é¢:</span>
                        <span class="text-green-400" id="balanceAfter">-</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-blue-300">å¥–åŠ±å·®é¢:</span>
                        <span class="text-yellow-400 font-bold" id="balanceDiff">-</span>
                    </div>
                </div>

                <!-- æˆæƒ/æ¸¸æˆæŒ‰é’® - ç¡®ä¿å¯è§ -->
                <div class="space-y-3">
                    <button
                        id="approveBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg text-base"
                    >
                        ğŸ”“ æˆæƒ PI ä»£å¸
                    </button>
                    
                    <div class="flex gap-3">
                    <button
                        id="startGameBtn" 
                            class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl text-base transition-all duration-200 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        ğŸ® å¼€å§‹æ¸¸æˆ
                    </button>
                        <button 
                            id="continuousBtn" 
                            class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-3 px-6 rounded-xl text-base transition-all duration-200 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            ğŸ”„ è¿ç»­æ¸¸æˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆè®°å½• -->
            <div class="glass-effect rounded-xl p-4">
                <h3 class="text-white font-semibold mb-3 text-center">ğŸ® æ¸¸æˆè®°å½•</h3>
                <div id="gameHistory" class="text-center py-8">
                    <p class="text-blue-200">æš‚æ— æ¸¸æˆè®°å½•</p>
                    <p class="text-xs text-blue-300 mt-1">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡æ¸¸æˆå§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="fixed bottom-0 left-0 right-0 glass-effect p-3 text-center">
        <p class="text-blue-200 text-xs">
            åŸºäº AlveyChain æ™ºèƒ½åˆçº¦ Â· å…¬å¹³é€æ˜ Â· ç«‹å³åˆ°è´¦
        </p>
    </div>

    <!-- JavaScript -->
    <script>
        // ç­‰å¾…ethers.jsåŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            // æ£€æŸ¥ethersæ˜¯å¦æ­£ç¡®åŠ è½½
            if (typeof ethers === 'undefined') {
                console.error('ethers.jsæœªæ­£ç¡®åŠ è½½');
                alert('æ­£åœ¨åŠ è½½åŒºå—é“¾åº“ï¼Œè¯·ç¨å€™é‡è¯•...');
                setTimeout(() => location.reload(), 2000);
                return;
            }
            
            console.log('ethers.jsåŠ è½½æˆåŠŸ:', ethers.version);
        });

        // æ™ºèƒ½åˆçº¦é…ç½®
        const CONTRACTS = {
            WHEEL_GAME: "0xB677DBcA76061E6301272c83179c8243A4eeB6A5",
            MAO_TOKEN: "0x22f49bcb3dad370a9268ba3fca33cb037ca3d022",
            PI_TOKEN: "0xfd4680e25e05b3435c7f698668d1ce80d2a9f444"
        };

        const ALVEY_NETWORK = {
            chainId: '0xED5', // 3797 decimal
            chainName: 'AlveyChain Mainnet',
            nativeCurrency: { name: 'ALV', symbol: 'ALV', decimals: 18 },
            rpcUrls: [
                'https://elves-core1.alvey.io/',
                'https://elves-core2.alvey.io/',
                'https://elves-core3.alvey.io/'
            ],
            blockExplorerUrls: ['https://alveyscan.com/'],
        };

        const WHEEL_GAME_ABI = [
            "function playMAOGame() external",
            "function playPIGame() external",
            "event GamePlayed(address indexed player, uint8 tokenType, uint256 betAmount, uint256 rewardAmount, uint8 rewardLevel, uint256 randomSeed)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const REWARDS = [
            { name: 'è°¢è°¢æƒ é¡¾', mao: 0, pi: 0, emoji: 'ğŸ˜Š', probability: '58%' },
            { name: 'å°å¥–', mao: 105, pi: 1050, emoji: 'ğŸ', probability: '22%' },
            { name: 'ä¸­å¥–', mao: 150, pi: 1500, emoji: 'ğŸ†', probability: '12%' },
            { name: 'å¤§å¥–', mao: 250, pi: 2500, emoji: 'ğŸ’', probability: '6%' },
            { name: 'è¶…çº§å¤§å¥–', mao: 400, pi: 4000, emoji: 'ğŸŒŸ', probability: '1.5%' },
            { name: 'ç»ˆæå¤§å¥–', mao: 700, pi: 7000, emoji: 'ğŸ’°', probability: '0.5%' }
        ];

        // ğŸš€ ä¼˜åŒ–çš„å…¨å±€çŠ¶æ€ç®¡ç†
        let walletConnectionCache = {
            provider: null,
            signer: null,
            contracts: {},
            lastConnected: null,
            networkVerified: false
        };

        let connectionTimeout = null;

        // æ¸¸æˆçŠ¶æ€
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let contracts = {};
        let selectedToken = 'MAO';
        let isSpinning = false;
        let isApproved = false;
        let balances = { MAO: '0', PI: '0' };
        let gameStats = { count: 0, totalBet: 0, totalReward: 0 };
        let isContinuousMode = false;

        // DOM å…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const walletConnect = document.getElementById('walletConnect');
        const gameInterface = document.getElementById('gameInterface');
        const spinBtn = document.getElementById('spinBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const continuousBtn = document.getElementById('continuousBtn');
        const approveBtn = document.getElementById('approveBtn');
        const wheel = document.getElementById('wheel');
        const userAddress = document.getElementById('userAddress');
        const userBalance = document.getElementById('userBalance');
        const maoBalance = document.getElementById('maoBalance');
        const piBalance = document.getElementById('piBalance');
        const betAmount = document.getElementById('betAmount');
        const lastResult = document.getElementById('lastResult');
        const resultText = document.getElementById('resultText');
        const maoBtn = document.getElementById('maoBtn');
        const piBtn = document.getElementById('piBtn');

        // æ–°å¢æ¸¸æˆç»Ÿè®¡å…ƒç´ 
        const gameCount = document.getElementById('gameCount');
        const totalBet = document.getElementById('totalBet');
        const totalReward = document.getElementById('totalReward');
        const balanceBefore = document.getElementById('balanceBefore');
        const balanceAfter = document.getElementById('balanceAfter');
        const balanceDiff = document.getElementById('balanceDiff');

        // è½¬ç›˜å¥–åŠ±æ˜¾ç¤ºå…ƒç´ 
        const reward0 = document.getElementById('reward0');
        const reward1 = document.getElementById('reward1');
        const reward2 = document.getElementById('reward2');
        const reward3 = document.getElementById('reward3');
        const reward4 = document.getElementById('reward4');
        const reward5 = document.getElementById('reward5');

        // æ›´æ–°è½¬ç›˜æ˜¾ç¤º - ä¿®å¤ï¼šä½¿ç”¨åˆçº¦ä¸­çš„çœŸå®å¥–åŠ±é‡‘é¢
        function updateWheelRewards() {
            // åˆçº¦ä¸­çš„çœŸå®å¥–åŠ±é‡‘é¢
            const maoRewards = [0, 105, 150, 250, 400, 700];  // æ–°åˆçº¦ä¸­çš„å®é™…MAOå¥–åŠ±
            const piRewards = [0, 1050, 1500, 2500, 4000, 7000];  // æ–°åˆçº¦ä¸­çš„å®é™…PIå¥–åŠ±
            
            // æ›´æ–°è½¬ç›˜ä¸Šçš„å¥–åŠ±æ˜¾ç¤º
            [reward0, reward1, reward2, reward3, reward4, reward5].forEach((element, index) => {
                if (selectedToken === 'MAO') {
                    element.textContent = maoRewards[index].toLocaleString();
                } else {
                    // PIä»£å¸æ˜¾ç¤ºKå•ä½
                    const value = piRewards[index];
                    element.textContent = value >= 1000 ? `${(value/1000).toLocaleString()}K` : value.toString();
                }
            });
        }

        // è¿æ¥é’±åŒ… - ä¼˜åŒ–ç‰ˆæœ¬
        async function connectWallet() {
            try {
                // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                if (connectionTimeout) {
                    clearTimeout(connectionTimeout);
                }

                // æ˜¾ç¤ºè¿æ¥è¿›åº¦
                showConnectionProgress();

                // ğŸƒâ€â™‚ï¸ å¿«é€Ÿæ£€æŸ¥ - ä¼˜å…ˆçº§æ£€æŸ¥
                if (typeof ethers === 'undefined') {
                    updateProgress('æ­£åœ¨åŠ è½½åŒºå—é“¾åº“...', 10);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    if (typeof ethers === 'undefined') {
                        alert('åŒºå—é“¾åº“åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...');
                        setTimeout(() => location.reload(), 1000);
                        return;
                    }
                }

                if (!window.ethereum) {
                    hideConnectionProgress();
                    alert('è¯·ä½¿ç”¨æ”¯æŒWeb3çš„é’±åŒ…æµè§ˆå™¨ï¼\næ¨èä½¿ç”¨ï¼šTPé’±åŒ…ã€Trust Walletã€MetaMaskç­‰');
                    return;
                }

                updateProgress('æ­£åœ¨è¿æ¥é’±åŒ…...', 20);

                // ğŸš€ å¹¶è¡Œæ£€æŸ¥ç½‘ç»œå’Œè·å–è´¦æˆ·
                const [chainId, existingAccounts] = await Promise.all([
                    window.ethereum.request({ method: 'eth_chainId' }),
                    window.ethereum.request({ method: 'eth_accounts' }).catch(() => [])
                ]);

                updateProgress('éªŒè¯ç½‘ç»œé…ç½®...', 40);

                // ğŸ”„ æ™ºèƒ½ç½‘ç»œå¤„ç†
                if (chainId !== ALVEY_NETWORK.chainId) {
                    updateProgress('åˆ‡æ¢åˆ°AlveyChainç½‘ç»œ...', 50);
                    await switchToAlveyNetworkOptimized();
                    walletConnectionCache.networkVerified = true;
                } else if (!walletConnectionCache.networkVerified) {
                    walletConnectionCache.networkVerified = true;
                }

                updateProgress('è¯·æ±‚è´¦æˆ·æˆæƒ...', 70);

                // ğŸ”— æ™ºèƒ½è´¦æˆ·è¿æ¥
                let accounts;
                if (existingAccounts.length > 0) {
                    accounts = existingAccounts;
                } else {
                    accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts',
                    });
                }

                if (accounts.length === 0) {
                    hideConnectionProgress();
                    alert('æœªè·å¾—è´¦æˆ·æˆæƒ');
                    return;
                }

                updateProgress('åˆå§‹åŒ–åŒºå—é“¾è¿æ¥...', 80);

                // ğŸï¸ å¿«é€Ÿæä¾›è€…åˆå§‹åŒ–
                const newAccount = accounts[0];
                let needsFullInit = !walletConnectionCache.provider || 
                                  walletConnectionCache.lastConnected !== newAccount;

                if (needsFullInit) {
                    // å¹¶è¡Œåˆå§‹åŒ–æä¾›è€…å’Œåˆçº¦
                    const [provider, contractsData] = await Promise.all([
                        Promise.resolve(new ethers.providers.Web3Provider(window.ethereum)),
                        initializeContractsOptimized(newAccount)
                    ]);

                    const signer = provider.getSigner();
                    
                    // æ›´æ–°ç¼“å­˜
                    walletConnectionCache = {
                        provider,
                        signer,
                        contracts: contractsData,
                        lastConnected: newAccount,
                        networkVerified: true
                    };
                } else {
                    // ä½¿ç”¨ç¼“å­˜çš„è¿æ¥
                    console.log('ğŸš€ ä½¿ç”¨ç¼“å­˜çš„é’±åŒ…è¿æ¥');
                }

                currentAccount = newAccount;
                provider = walletConnectionCache.provider;
                signer = walletConnectionCache.signer;
                contracts = walletConnectionCache.contracts;

                updateProgress('åŠ è½½ç”¨æˆ·æ•°æ®...', 90);

                // ğŸ”„ å¹¶è¡ŒåŠ è½½ç”¨æˆ·æ•°æ®å’Œç³»ç»Ÿæ£€æŸ¥
                await Promise.all([
                    loadBalancesOptimized(),
                    checkApprovalOptimized(),
                    initParticleEffectAsync(),
                    performSystemChecks()
                ]);

                updateProgress('å®Œæˆè¿æ¥!', 100);

                // ğŸ¨ æ›´æ–°ç•Œé¢
                userAddress.textContent = currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
                updateWheelRewards();
                
                // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                walletConnect.style.display = 'none';
                gameInterface.style.display = 'block';

                // å»¶è¿Ÿéšè—è¿›åº¦æ¡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
                setTimeout(hideConnectionProgress, 500);

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…é”™è¯¯:', error);
                hideConnectionProgress();
                
                // ğŸ”„ æ™ºèƒ½é”™è¯¯å¤„ç†
                if (error.code === 4001) {
                    alert('ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚');
                } else if (error.code === -32002) {
                    alert('é’±åŒ…è¿æ¥è¯·æ±‚å·²å‘é€ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤');
                } else {
                    alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
                }
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                connectBtn.textContent = 'ğŸ”— è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ';
                connectBtn.disabled = false;
            }
        }

        // ğŸš€ ä¼˜åŒ–çš„ç½‘ç»œåˆ‡æ¢
        async function switchToAlveyNetworkOptimized() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ALVEY_NETWORK.chainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [ALVEY_NETWORK],
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // ğŸï¸ ä¼˜åŒ–çš„åˆçº¦åˆå§‹åŒ–
        async function initializeContractsOptimized(account) {
            try {
                // åªæœ‰åœ¨éœ€è¦æ—¶æ‰åˆ›å»ºæ–°çš„åˆçº¦å®ä¾‹
                if (walletConnectionCache.contracts.wheelGame && 
                    walletConnectionCache.lastConnected === account) {
                    return walletConnectionCache.contracts;
                }

                const tempProvider = new ethers.providers.Web3Provider(window.ethereum);
                const tempSigner = tempProvider.getSigner();

                const contractsData = {
                    wheelGame: new ethers.Contract(CONTRACTS.WHEEL_GAME, WHEEL_GAME_ABI, tempSigner),
                    maoToken: new ethers.Contract(CONTRACTS.MAO_TOKEN, ERC20_ABI, tempSigner),
                    piToken: new ethers.Contract(CONTRACTS.PI_TOKEN, ERC20_ABI, tempSigner)
                };

                return contractsData;
            } catch (error) {
                console.error('åˆå§‹åŒ–åˆçº¦é”™è¯¯:', error);
                throw error;
            }
        }

        // ğŸ’¡ è¶…çº§ç®€åŒ–çš„ä½™é¢åŠ è½½ - åŠ å¼ºé”™è¯¯å¤„ç†
        async function loadBalancesOptimized() {
            try {
                console.log('ğŸ” å¼€å§‹åŠ è½½ä½™é¢...');

                if (!currentAccount) {
                    console.log('âŒ æ— è´¦æˆ·ï¼Œè·³è¿‡');
                    return;
                }

                if (!contracts.maoToken || !contracts.piToken) {
                    console.log('âŒ åˆçº¦æœªåˆå§‹åŒ–ï¼Œè·³è¿‡');
                    return;
                }

                console.log('ï¿½ï¿½ è°ƒç”¨ balanceOf...');

                // æ·»åŠ åˆçº¦åœ°å€éªŒè¯
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // é¦–å…ˆéªŒè¯åˆçº¦æ˜¯å¦å­˜åœ¨
                console.log('ğŸ” éªŒè¯åˆçº¦åœ°å€...');
                const [maoCode, piCode] = await Promise.all([
                    provider.getCode(CONTRACTS.MAO_TOKEN),
                    provider.getCode(CONTRACTS.PI_TOKEN)
                ]);
                
                if (maoCode === '0x') {
                    throw new Error(`MAOåˆçº¦åœ°å€æ— æ•ˆ: ${CONTRACTS.MAO_TOKEN}`);
                }
                
                if (piCode === '0x') {
                    throw new Error(`PIåˆçº¦åœ°å€æ— æ•ˆ: ${CONTRACTS.PI_TOKEN}`);
                }
                
                console.log('âœ… åˆçº¦åœ°å€éªŒè¯é€šè¿‡');

                // å°±æ˜¯è¿™ä¹ˆç®€å•ï¼è°ƒç”¨åˆçº¦çš„ balanceOf å‡½æ•°
                const [maoBalanceWei, piBalanceWei] = await Promise.all([
                    contracts.maoToken.balanceOf(currentAccount),
                    contracts.piToken.balanceOf(currentAccount)
                ]);

                // æ ¼å¼åŒ– - æ¢å¤18ä½å°æ•°ï¼Œå› ä¸ºæ¸¸æˆä¹‹å‰èƒ½æ­£å¸¸è¿è¡Œ
                balances.MAO = ethers.utils.formatUnits(maoBalanceWei, 18);
                balances.PI = ethers.utils.formatUnits(piBalanceWei, 18);

                console.log('âœ… ä½™é¢è·å–æˆåŠŸ:', {
                    MAO: balances.MAO,
                    PI: balances.PI
                });

                // æ›´æ–°æ˜¾ç¤º
                maoBalance.textContent = `ä½™é¢: ${parseFloat(balances.MAO).toLocaleString()}`;
                piBalance.textContent = `ä½™é¢: ${parseFloat(balances.PI).toLocaleString()}`;
                updateCurrentBalance();

            } catch (error) {
                console.error('âŒ ä½™é¢è·å–å¤±è´¥:', error);
                
                // è¯¦ç»†çš„é”™è¯¯å¤„ç†
                let errorMessage = '';
                if (error.message.includes('åˆçº¦åœ°å€æ— æ•ˆ')) {
                    errorMessage = `âš ï¸ åˆçº¦åœ°å€é—®é¢˜: ${error.message}\n\nè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦éƒ¨ç½²åœ¨AlveyChainç½‘ç»œä¸Šã€‚`;
                } else if (error.code === 'CALL_EXCEPTION') {
                    errorMessage = `âš ï¸ åˆçº¦è°ƒç”¨å¤±è´¥\n\nå¯èƒ½åŸå› :\n1. åˆçº¦åœ°å€ä¸å­˜åœ¨\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n3. åˆçº¦æœªéƒ¨ç½²åœ¨AlveyChain\n\nå»ºè®®è®¿é—® https://alveyscan.com/ éªŒè¯åˆçº¦åœ°å€`;
                } else if (error.code === 'NETWORK_ERROR') {
                    errorMessage = `âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥:\n1. AlveyChainç½‘ç»œè¿æ¥\n2. RPCèŠ‚ç‚¹çŠ¶æ€\n3. ç½‘ç»œåˆ‡æ¢æ˜¯å¦æ­£ç¡®`;
                } else {
                    errorMessage = `ä½™é¢è·å–å¤±è´¥: ${error.message}`;
                }
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                showBalanceError(errorMessage);
                
                // è®¾ç½®é»˜è®¤å€¼é¿å…ç•Œé¢å¼‚å¸¸
                balances.MAO = '0';
                balances.PI = '0';
                maoBalance.textContent = 'ä½™é¢: 0';
                piBalance.textContent = 'ä½™é¢: 0';
                updateCurrentBalance();
            }
        }

        // æ˜¾ç¤ºä½™é¢è°ƒè¯•ä¿¡æ¯
        function showBalanceDebugInfo() {
            const debugInfo = `ğŸ” ä½™é¢è°ƒè¯•ä¿¡æ¯\n\n` +
                `ğŸ“ å½“å‰è´¦æˆ·: ${currentAccount}\n` +
                `ğŸŒ ç½‘ç»œ: AlveyChain (Chain ID: 3797)\n` +
                `ğŸ“Š MAOä½™é¢: ${balances.MAO}\n` +
                `ğŸ“Š PIä½™é¢: ${balances.PI}\n\n` +
                `ğŸ”— åˆçº¦åœ°å€:\n` +
                `â€¢ MAO: ${CONTRACTS.MAO_TOKEN}\n` +
                `â€¢ PI: ${CONTRACTS.PI_TOKEN}\n\n` +
                `ğŸ’¡ å¯èƒ½åŸå› :\n` +
                `â€¢ è´¦æˆ·ç¡®å®æ²¡æœ‰ä»£å¸\n` +
                `â€¢ ç½‘ç»œè¿æ¥é—®é¢˜\n` +
                `â€¢ åˆçº¦åœ°å€ä¸æ­£ç¡®\n` +
                `â€¢ RPCèŠ‚ç‚¹å“åº”æ…¢\n\n` +
                `ğŸ”§ å»ºè®®æ“ä½œ:\n` +
                `â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\n` +
                `â€¢ åˆ·æ–°é¡µé¢é‡è¯•\n` +
                `â€¢ åœ¨AlveyScanæŸ¥çœ‹è´¦æˆ·ä½™é¢`;
            
            console.log(debugInfo);
        }

        // æ˜¾ç¤ºä½™é¢é”™è¯¯ä¿¡æ¯
        function showBalanceError(message) {
            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯é™é»˜å¤±è´¥
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-20 left-4 right-4 bg-red-500/80 text-white p-3 rounded-lg text-sm z-50';
            errorDiv.innerHTML = `
                <div class="font-bold">âš ï¸ ä½™é¢åŠ è½½å¤±è´¥</div>
                <div class="mt-1">${message}</div>
                <button onclick="this.parentNode.remove(); loadBalancesOptimized();" class="mt-2 bg-white/20 px-3 py-1 rounded text-xs">
                    ğŸ”„ é‡è¯•
                </button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // ğŸ”“ ä¼˜åŒ–çš„æˆæƒæ£€æŸ¥
        async function checkApprovalOptimized() {
            try {
                if (!currentAccount || !contracts.maoToken || !contracts.piToken) return;

                const [maoAllowance, piAllowance] = await Promise.all([
                    contracts.maoToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME),
                    contracts.piToken.allowance(currentAccount, CONTRACTS.WHEEL_GAME)
                ]);

                const maoApproved = maoAllowance.gt(0);
                const piApproved = piAllowance.gt(0);
                isApproved = maoApproved && piApproved;

                // æ‰¹é‡æ›´æ–°DOM
                requestAnimationFrame(() => {
                    if (isApproved) {
                        approveBtn.style.display = 'none';
                        spinBtn.disabled = false;
                        startGameBtn.disabled = false;
                        continuousBtn.disabled = false;
                    } else {
                        approveBtn.style.display = 'block';
                        approveBtn.textContent = 'ğŸ”“ æˆæƒ MAO & PI ä»£å¸';
                    }
                });

            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒé”™è¯¯:', error);
            }
        }

        // ğŸ† å¼‚æ­¥ç²’å­æ•ˆæœåˆå§‹åŒ–
        async function initParticleEffectAsync() {
            return new Promise(resolve => {
                setTimeout(() => {
                    initParticleEffect();
                    resolve();
                }, 100);
            });
        }

        // ğŸ“Š è¿æ¥è¿›åº¦æ˜¾ç¤º
        function showConnectionProgress() {
            connectBtn.style.display = 'none';
            
            // åˆ›å»ºè¿›åº¦æ¡å®¹å™¨
            const progressContainer = document.createElement('div');
            progressContainer.id = 'connectionProgress';
            progressContainer.innerHTML = `
                <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 text-center">
                    <div class="mb-4">
                        <div class="animate-spin w-12 h-12 mx-auto border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    </div>
                    <div class="text-white font-semibold mb-2" id="progressText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                    <div class="bg-white/20 rounded-full h-2 mb-2">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="text-blue-200 text-sm" id="progressPercent">0%</div>
                </div>
            `;
            
            const walletConnectDiv = document.getElementById('walletConnect');
            walletConnectDiv.appendChild(progressContainer);
        }

        function updateProgress(text, percent) {
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressText) progressText.textContent = text;
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressPercent) progressPercent.textContent = percent + '%';
        }

        function hideConnectionProgress() {
            const progressContainer = document.getElementById('connectionProgress');
            if (progressContainer) {
                progressContainer.remove();
            }
            connectBtn.style.display = 'block';
            connectBtn.textContent = 'ğŸ”— è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ';
            connectBtn.disabled = false;
        }

        // ğŸ”„ é¢„åŠ è½½ä¼˜åŒ– - åœ¨é¡µé¢ç©ºé—²æ—¶é¢„çƒ­è¿æ¥
        function preloadWalletConnection() {
            if (window.ethereum && !currentAccount) {
                // é™é»˜æ£€æŸ¥å·²è¿æ¥è´¦æˆ·
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            console.log('ğŸš€ æ£€æµ‹åˆ°å·²è¿æ¥è´¦æˆ·ï¼Œå‡†å¤‡å¿«é€Ÿè¿æ¥');
                            // é¢„åŠ è½½åˆçº¦å®ä¾‹
                            initializeContractsOptimized(accounts[0]).catch(() => {});
                        }
                    })
                    .catch(() => {});
            }
        }

        // ğŸ† ç²’å­æ•ˆæœç³»ç»Ÿ
        function initParticleEffect() {
            const particleContainer = document.getElementById('particleContainer');
            if (!particleContainer) return;

            // åˆ›å»ºåˆå§‹ç²’å­
            for (let i = 0; i < 20; i++) {
                createParticle();
            }

            // å®šæœŸåˆ›å»ºæ–°ç²’å­
            setInterval(createParticle, 300);
        }

        function createParticle() {
            const particleContainer = document.getElementById('particleContainer');
            if (!particleContainer) return;

            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // éšæœºä½ç½®
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 2 + 's';
            particle.style.animationDuration = (3 + Math.random() * 3) + 's';
            
            // éšæœºé¢œè‰²
            const colors = ['#FFD700', '#FF6B9D', '#4ECDC4', '#45B7D1', '#FFEAA7', '#DDA0DD'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            particle.style.background = `radial-gradient(circle, ${color}, transparent)`;
            
            particleContainer.appendChild(particle);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 6000);
        }

        // ğŸ° å¢å¼ºè½¬ç›˜åŠ¨ç”»
        function enhancedSpinAnimation(finalAngle) {
            const wheelElement = document.getElementById('wheel');
            if (!wheelElement) return;

            // åˆ›å»ºçˆ†ç‚¸ç²’å­æ•ˆæœ
            createSpinParticles();
            
            // æ·»åŠ éœ‡åŠ¨æ•ˆæœ
            wheelElement.style.animation = 'none';
            wheelElement.style.transform = `rotate(${finalAngle}deg)`;
            
            // è½¬ç›˜å‘å…‰æ•ˆæœ
            wheelElement.style.boxShadow = `
                0 0 100px rgba(255, 215, 0, 1),
                inset 0 0 40px rgba(0, 0, 0, 0.3),
                0 0 200px rgba(255, 215, 0, 0.8),
                0 0 300px rgba(255, 255, 255, 0.4)
            `;
            
            // æ¢å¤æ­£å¸¸å…‰æ•ˆ
            setTimeout(() => {
                wheelElement.style.boxShadow = '';
            }, 3000);
        }

        function createSpinParticles() {
            const wheelElement = document.getElementById('wheel');
            if (!wheelElement) return;

            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '8px';
                particle.style.height = '8px';
                particle.style.borderRadius = '50%';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '30';
                
                const colors = ['#FFD700', '#FF6B9D', '#4ECDC4', '#45B7D1', '#FFEAA7'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                // ä»è½¬ç›˜ä¸­å¿ƒçˆ†ç‚¸
                const angle = (i / 50) * 360;
                const radius = 150 + Math.random() * 100;
                const x = Math.cos(angle * Math.PI / 180) * radius;
                const y = Math.sin(angle * Math.PI / 180) * radius;
                
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.transform = 'translate(-50%, -50%)';
                
                wheelElement.appendChild(particle);
                
                // åŠ¨ç”»
                particle.animate([
                    { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                    { transform: `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(1)`, opacity: 0.8 },
                    { transform: `translate(calc(-50% + ${x * 1.5}px), calc(-50% + ${y * 1.5}px)) scale(0)`, opacity: 0 }
                ], {
                    duration: 1500,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                };
            }
        }

        // åŠ è½½ä½™é¢
        async function loadBalances() {
            try {
                const [maoBalanceWei, piBalanceWei] = await Promise.all([
                    contracts.maoToken.balanceOf(currentAccount),
                    contracts.piToken.balanceOf(currentAccount)
                ]);

                balances.MAO = ethers.utils.formatUnits(maoBalanceWei, 18);
                balances.PI = ethers.utils.formatUnits(piBalanceWei, 18);

                maoBalance.textContent = `ä½™é¢: ${parseFloat(balances.MAO).toLocaleString()}`;
                piBalance.textContent = `ä½™é¢: ${parseFloat(balances.PI).toLocaleString()}`;
                
                updateCurrentBalance();
            } catch (error) {
                console.error('åŠ è½½ä½™é¢é”™è¯¯:', error);
            }
        }

        // æ›´æ–°å½“å‰ä½™é¢æ˜¾ç¤º
        function updateCurrentBalance() {
            userBalance.textContent = `${parseFloat(balances[selectedToken]).toLocaleString()} ${selectedToken}`;
        }

        // æ›´æ–°æ¸¸æˆç»Ÿè®¡
        function updateGameStats() {
            gameCount.textContent = gameStats.count;
            totalBet.textContent = `${gameStats.totalBet} ${selectedToken}`;
            totalReward.textContent = `${gameStats.totalReward} ${selectedToken}`;
        }

        // æ£€æŸ¥æˆæƒçŠ¶æ€ - ä¿®å¤ï¼šåˆçº¦ä½¿ç”¨18ä½å°æ•°è®¡ç®—ï¼Œä½†ä»£å¸æ˜¯9ä½å°æ•°
        async function checkApproval() {
            try {
                const tokenContract = selectedToken === 'MAO' ? contracts.maoToken : contracts.piToken;
                const allowance = await tokenContract.allowance(currentAccount, CONTRACTS.WHEEL_GAME);
                
                // åˆçº¦æœŸæœ›çš„æ˜¯18ä½å°æ•°çš„æˆæƒé‡‘é¢ï¼Œä½†ä»£å¸å®é™…æ˜¯9ä½å°æ•°
                const required = selectedToken === 'MAO' ? 
                    ethers.utils.parseUnits('100', 18) :      // åˆçº¦ä¸­çš„ 100 * 10**18
                    ethers.utils.parseUnits('10000', 18);     // åˆçº¦ä¸­çš„ 10000 * 10**18
                
                isApproved = allowance.gte(required);
                updateApproveButton();
            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒé”™è¯¯:', error);
            }
        }

        // æ›´æ–°æˆæƒæŒ‰é’®
        function updateApproveButton() {
            if (isApproved) {
                approveBtn.style.display = 'none';
                startGameBtn.disabled = false;
                continuousBtn.disabled = false;
                spinBtn.disabled = false;
                spinBtn.innerHTML = '<div class="text-2xl">ğŸ²</div><div class="text-[10px]">å¼€å§‹æ¸¸æˆ</div>';
            } else {
                approveBtn.style.display = 'block';
                approveBtn.textContent = `ğŸ”“ æˆæƒ ${selectedToken} ä»£å¸`;
                startGameBtn.disabled = true;
                continuousBtn.disabled = true;
                spinBtn.disabled = true;
                spinBtn.innerHTML = '<div class="text-2xl">ğŸ”’</div><div class="text-[10px]">éœ€è¦æˆæƒ</div>';
            }
        }

        // æˆæƒä»£å¸
        async function approveTokens() {
            try {
                approveBtn.textContent = 'æˆæƒä¸­...';
                approveBtn.disabled = true;

                const tokenContract = selectedToken === 'MAO' ? contracts.maoToken : contracts.piToken;
                const tx = await tokenContract.approve(CONTRACTS.WHEEL_GAME, ethers.constants.MaxUint256);
                await tx.wait();

                isApproved = true;
                updateApproveButton();
                alert('ä»£å¸æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆäº†ã€‚');
            } catch (error) {
                console.error('æˆæƒé”™è¯¯:', error);
                alert('æˆæƒå¤±è´¥: ' + error.message);
                approveBtn.textContent = `ğŸ”“ æˆæƒ ${selectedToken} ä»£å¸`;
                approveBtn.disabled = false;
            }
        }

        // è®°å½•æ¸¸æˆå‰ä½™é¢
        async function recordBalanceBefore() {
            const currentBalance = parseFloat(balances[selectedToken]);
            balanceBefore.textContent = `${currentBalance.toFixed(2)} ${selectedToken}`;
            return currentBalance;
        }

        // è®°å½•æ¸¸æˆåä½™é¢å¹¶æ˜¾ç¤ºå·®é¢
        async function recordBalanceAfter(beforeBalance) {
            await loadBalances();
            const afterBalance = parseFloat(balances[selectedToken]);
            const diff = afterBalance - beforeBalance;
            
            balanceAfter.textContent = `${afterBalance.toFixed(2)} ${selectedToken}`;
            balanceDiff.textContent = diff > 0 ? `+${diff.toFixed(2)} ${selectedToken}` : `${diff.toFixed(2)} ${selectedToken}`;
            
            return diff;
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (isSpinning || !isApproved) {
                if (!isApproved) {
                    alert('è¯·å…ˆæˆæƒä»£å¸ï¼');
                }
                return;
            }

            try {
                isSpinning = true;
                
                // è®°å½•æ¸¸æˆå‰ä½™é¢
                const beforeBalance = await recordBalanceBefore();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                spinBtn.innerHTML = '<div class="animate-spin text-2xl">ğŸ°</div><div class="text-[10px]">è½¬åŠ¨ä¸­</div>';
                spinBtn.disabled = true;
                startGameBtn.textContent = 'ğŸ° è½¬ç›˜è¿è¡Œä¸­...';
                startGameBtn.disabled = true;
                continuousBtn.disabled = true;

                // æ£€æŸ¥ä½™é¢
                const required = selectedToken === 'MAO' ? 100 : 10000;  // ä¿®å¤ï¼šPIæŠ•æ³¨é‡‘é¢æ˜¯10000
                if (parseFloat(balances[selectedToken]) < required) {
                    alert(`ä½™é¢ä¸è¶³ï¼éœ€è¦è‡³å°‘ ${required} ${selectedToken}`);
                    resetGameButtons();
                    return;
                }
                
                // å¼€å§‹è½¬ç›˜åŠ¨ç”» - ä½¿ç”¨å¢å¼ºåŠ¨ç”»
                const randomSpins = 2160 + Math.random() * 360; // 6åœˆ + éšæœºè§’åº¦
                
                // å…ˆè§¦å‘çˆ†ç‚¸ç²’å­æ•ˆæœ
                createSpinParticles();
                
                // è½¬ç›˜æ—‹è½¬
                wheel.style.transform = `rotate(${randomSpins}deg)`;

                // è°ƒç”¨æ™ºèƒ½åˆçº¦
                const gameFunction = selectedToken === 'MAO' ? 'playMAOGame' : 'playPIGame';
                const tx = await contracts.wheelGame[gameFunction]();
                const receipt = await tx.wait();

                // è§£æç»“æœ
                let rewardLevel = 0;
                for (const log of receipt.logs) {
                    try {
                        const parsed = contracts.wheelGame.interface.parseLog(log);
                        if (parsed.name === 'GamePlayed') {
                            rewardLevel = parsed.args.rewardLevel.toNumber();
                            break;
                        }
                    } catch (e) {}
                }

                // è°ƒæ•´è½¬ç›˜åˆ°æœ€ç»ˆä½ç½®å¹¶åº”ç”¨å¢å¼ºåŠ¨ç”»
                const finalAngle = rewardLevel * 60; // 360/6 = 60åº¦æ¯ä¸ªåŒºåŸŸ
                const finalRotation = randomSpins - (randomSpins % 360) + finalAngle;
                
                // ä½¿ç”¨å¢å¼ºåŠ¨ç”»
                setTimeout(() => {
                    enhancedSpinAnimation(finalRotation);
                }, 2000);

                // æ˜¾ç¤ºç»“æœ
                setTimeout(async () => {
                    const reward = REWARDS[rewardLevel];
                    const amount = selectedToken === 'MAO' ? reward.mao : reward.pi;
                    
                    // æ›´æ–°æ¸¸æˆç»Ÿè®¡
                    gameStats.count++;
                    gameStats.totalBet += required;
                    gameStats.totalReward += amount;
                    updateGameStats();

                    // è®°å½•æ¸¸æˆåä½™é¢
                    const balanceDiff = await recordBalanceAfter(beforeBalance);
                    
                    resultText.textContent = `${reward.emoji} ç»“æœ: ${reward.name}`;
                    if (amount > 0) {
                        resultText.textContent += ` (+${amount} ${selectedToken})`;
                        
                        // ä¸­å¥–æ—¶åˆ›å»ºåº†ç¥ç²’å­
                        createCelebrationParticles();
                        
                        // éªŒè¯å¥–åŠ±æ˜¯å¦æ­£ç¡®è½¬å…¥
                        if (Math.abs(balanceDiff - (amount - required)) < 0.0001) {
                            alert(`ğŸ‰ æ­å–œï¼è·å¾— ${reward.name}ï¼\nå¥–åŠ±: ${amount} ${selectedToken}\nâœ… å¥–åŠ±å·²è‡ªåŠ¨è½¬å…¥æ‚¨çš„é’±åŒ…ï¼`);
                        } else {
                            alert(`ğŸ‰ æ­å–œï¼è·å¾— ${reward.name}ï¼\nå¥–åŠ±: ${amount} ${selectedToken}\nâš ï¸ å¥–åŠ±è½¬è´¦å¯èƒ½éœ€è¦æ—¶é—´ç¡®è®¤`);
                        }
                    } else {
                        alert('ğŸ˜… è°¢è°¢æƒ é¡¾ï¼ç»§ç»­åŠªåŠ›ï¼');
                    }
                    
                    lastResult.classList.remove('hidden');
                    
                    // é‡ç½®æŒ‰é’®
                    resetGameButtons();
                    
                    // è¿ç»­æ¸¸æˆæ¨¡å¼
                    if (isContinuousMode && parseFloat(balances[selectedToken]) >= required) {
                        setTimeout(() => {
                            if (isContinuousMode) {
                                startGame();
                            }
                        }, 3000);
                    }
                }, 4500);

            } catch (error) {
                console.error('æ¸¸æˆé”™è¯¯:', error);
                alert('æ¸¸æˆå¤±è´¥: ' + error.message);
                resetGameButtons();
            }
        }

        // è¿ç»­æ¸¸æˆæ¨¡å¼
        function toggleContinuousMode() {
            isContinuousMode = !isContinuousMode;
            
            if (isContinuousMode) {
                continuousBtn.textContent = 'â¹ï¸ åœæ­¢è¿ç»­';
                continuousBtn.className = continuousBtn.className.replace('from-orange-600 to-red-600', 'from-red-600 to-red-700');
                alert('è¿ç»­æ¸¸æˆæ¨¡å¼å·²å¼€å¯ï¼\næ¸¸æˆå°†è‡ªåŠ¨è¿ç»­è¿›è¡Œï¼Œç›´åˆ°ä½™é¢ä¸è¶³æˆ–æ‰‹åŠ¨åœæ­¢ã€‚');
                startGame();
            } else {
                continuousBtn.textContent = 'ğŸ”„ è¿ç»­æ¸¸æˆ';
                continuousBtn.className = continuousBtn.className.replace('from-red-600 to-red-700', 'from-orange-600 to-red-600');
                alert('è¿ç»­æ¸¸æˆæ¨¡å¼å·²å…³é—­ï¼');
            }
        }

        // é‡ç½®æ¸¸æˆæŒ‰é’®çŠ¶æ€
        function resetGameButtons() {
            isSpinning = false;
            spinBtn.innerHTML = '<div class="text-2xl">ğŸ²</div><div class="text-[10px]">å¼€å§‹æ¸¸æˆ</div>';
            spinBtn.disabled = !isApproved;
            startGameBtn.textContent = 'ğŸ® å¼€å§‹æ¸¸æˆ';
            startGameBtn.disabled = !isApproved;
            
            if (!isContinuousMode) {
                continuousBtn.disabled = !isApproved;
            }
        }

        // é€‰æ‹©ä»£å¸
        function selectToken(token) {
            if (isContinuousMode) {
                alert('è¯·å…ˆåœæ­¢è¿ç»­æ¸¸æˆæ¨¡å¼å†åˆ‡æ¢ä»£å¸ï¼');
                return;
            }
            
            selectedToken = token;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            maoBtn.className = 'token-btn py-4 px-4 rounded-xl font-semibold transition-all ' + 
                (token === 'MAO' ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg scale-105' : 'bg-white/20 text-blue-200 hover:bg-white/30');
            piBtn.className = 'token-btn py-4 px-4 rounded-xl font-semibold transition-all ' + 
                (token === 'PI' ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-lg scale-105' : 'bg-white/20 text-blue-200 hover:bg-white/30');
            
            // æ›´æ–°æŠ•æ³¨é‡‘é¢æ˜¾ç¤º
            betAmount.textContent = token === 'MAO' ? '100 MAO' : '10,000 PI';  // ä¿®å¤ï¼šæ¢å¤æ­£ç¡®çš„PIæŠ•æ³¨é‡‘é¢
            
            // æ›´æ–°è½¬ç›˜å¥–åŠ±æ˜¾ç¤º
            updateWheelRewards();
            
            // æ›´æ–°ä½™é¢æ˜¾ç¤º
                    updateCurrentBalance();
                    
            // é‡æ–°æ£€æŸ¥æˆæƒ
            if (currentAccount) {
                checkApproval();
            }
        }

        // äº‹ä»¶ç›‘å¬
        connectBtn.addEventListener('click', connectWallet);
        approveBtn.addEventListener('click', approveTokens);
        spinBtn.addEventListener('click', startGame);
        startGameBtn.addEventListener('click', startGame);
        continuousBtn.addEventListener('click', toggleContinuousMode);
        maoBtn.addEventListener('click', () => selectToken('MAO'));
        piBtn.addEventListener('click', () => selectToken('PI'));

        // è‡ªåŠ¨è¿æ¥å·²è¿æ¥çš„é’±åŒ… - ä¼˜åŒ–ç‰ˆæœ¬
        window.addEventListener('load', async () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ™ºèƒ½è¿æ¥æ£€æµ‹');
            
            // ğŸ”„ é¢„åŠ è½½é’±åŒ…è¿æ¥
            setTimeout(preloadWalletConnection, 1000);
            
            if (window.ethereum) {
                try {
                    // ğŸš€ å¿«é€Ÿæ£€æŸ¥å·²è¿æ¥è´¦æˆ·
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('ğŸš€ æ£€æµ‹åˆ°å·²è¿æ¥è´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥ä¸­...');
                        
                        // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿï¼Œç¡®ä¿UIå®Œå…¨åŠ è½½
                        setTimeout(async () => {
                            await connectWallet();
                        }, 500);
                    } else {
                        console.log('ğŸ“± ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è¿æ¥é’±åŒ…');
                        // é¢„çƒ­è¿æ¥ç»„ä»¶
                        setTimeout(preloadWalletConnection, 2000);
                    }
                } catch (error) {
                    console.log('è‡ªåŠ¨è¿æ¥å¤±è´¥:', error);
                    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
                }
            } else {
                console.log('âš ï¸ æœªæ£€æµ‹åˆ°Web3é’±åŒ…');
            }
        });

        // ğŸ”„ æ™ºèƒ½è´¦æˆ·ç›‘å¬ - å‡å°‘é‡è½½
        if (window.ethereum) {
            let accountChangeTimeout;
            
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('ğŸ‘¤ è´¦æˆ·å˜åŒ–æ£€æµ‹:', accounts);
                
                // é˜²æŠ–å¤„ç†ï¼Œé¿å…å¿«é€Ÿåˆ‡æ¢å¯¼è‡´çš„å¤šæ¬¡é‡è½½
                clearTimeout(accountChangeTimeout);
                accountChangeTimeout = setTimeout(() => {
                    if (accounts.length === 0) {
                        console.log('ğŸšª ç”¨æˆ·æ–­å¼€è¿æ¥ï¼Œé‡ç½®ç•Œé¢');
                        // æ¸…é™¤ç¼“å­˜
                        walletConnectionCache = {
                            provider: null,
                            signer: null,
                            contracts: {},
                            lastConnected: null,
                            networkVerified: false
                        };
                        location.reload();
                    } else if (accounts[0] !== currentAccount) {
                        console.log('ğŸ”„ è´¦æˆ·åˆ‡æ¢ï¼Œæ›´æ–°è¿æ¥');
                        // æ›´æ–°åˆ°æ–°è´¦æˆ·
                        connectWallet();
                    }
                }, 300);
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('ğŸŒ ç½‘ç»œå˜åŒ–æ£€æµ‹:', chainId);
                
                if (chainId !== ALVEY_NETWORK.chainId) {
                    console.log('âš ï¸ ç½‘ç»œä¸åŒ¹é…ï¼Œéœ€è¦åˆ‡æ¢');
                    walletConnectionCache.networkVerified = false;
                }
                
                // å¦‚æœå½“å‰å·²è¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥è€Œä¸æ˜¯é‡è½½é¡µé¢
                if (currentAccount) {
                    connectWallet();
                } else {
                    location.reload();
                }
            });
        }

        // ğŸš€ é¡µé¢å¯è§æ€§ä¼˜åŒ– - å½“é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentAccount) {
                console.log('ğŸ‘ï¸ é¡µé¢é‡æ–°å¯è§ï¼Œåˆ·æ–°æ•°æ®');
                // å»¶è¿Ÿåˆ·æ–°ï¼Œé¿å…å½±å“ç”¨æˆ·äº¤äº’
                setTimeout(() => {
                    Promise.all([
                        loadBalancesOptimized(),
                        checkApprovalOptimized()
                    ]).catch(console.error);
                }, 1000);
            }
        });

        // ğŸŠ åº†ç¥ç²’å­æ•ˆæœ
        function createCelebrationParticles() {
            const gameInterface = document.getElementById('gameInterface');
            if (!gameInterface) return;

            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.width = Math.random() * 8 + 4 + 'px';
                particle.style.height = particle.style.width;
                particle.style.borderRadius = '50%';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '1000';
                
                const colors = ['#FFD700', '#FF6B9D', '#4ECDC4', '#45B7D1', '#FFEAA7', '#DDA0DD', '#FF6347', '#00CED1'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.boxShadow = `0 0 10px ${particle.style.background}`;
                
                // ä»å±å¹•ä¸­å¿ƒçˆ†ç‚¸
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.transform = 'translate(-50%, -50%)';
                
                document.body.appendChild(particle);
                
                // çˆ†ç‚¸åŠ¨ç”»
                const angle = (i / 100) * 360;
                const velocity = 100 + Math.random() * 200;
                const x = Math.cos(angle * Math.PI / 180) * velocity;
                const y = Math.sin(angle * Math.PI / 180) * velocity;
                
                particle.animate([
                    { 
                        transform: 'translate(-50%, -50%) scale(0)', 
                        opacity: 1 
                    },
                    { 
                        transform: `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(1)`, 
                        opacity: 0.8 
                    },
                    { 
                        transform: `translate(calc(-50% + ${x}px), calc(-50% + ${y + 200}px)) scale(0)`, 
                        opacity: 0 
                    }
                ], {
                    duration: 2000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                };
            }
        }

        // ğŸŒŸ å¢å¼ºè½¬ç›˜æ‚¬åœæ•ˆæœ
        function addWheelInteractivity() {
            const wheelSections = document.querySelectorAll('.super-wheel-section');
            wheelSections.forEach(section => {
                section.addEventListener('mouseenter', () => {
                    section.style.transform = 'scale(1.3)';
                    section.style.zIndex = '15';
                    
                    // æ·»åŠ å…‰æ•ˆ
                    const emoji = section.querySelector('.super-emoji');
                    if (emoji) {
                        emoji.style.textShadow = '0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 255, 255, 0.8)';
                    }
                });
                
                section.addEventListener('mouseleave', () => {
                    section.style.transform = 'scale(1)';
                    section.style.zIndex = '10';
                    
                    const emoji = section.querySelector('.super-emoji');
                    if (emoji) {
                        emoji.style.textShadow = '';
                    }
                });
            });
        }

        // ğŸµ éŸ³æ•ˆå¢å¼ºï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
        function playSpinSound() {
            // å¯ä»¥æ·»åŠ éŸ³æ•ˆä»£ç 
            console.log('ğŸµ è½¬ç›˜éŸ³æ•ˆæ’­æ”¾');
        }

        function playWinSound() {
            // å¯ä»¥æ·»åŠ ä¸­å¥–éŸ³æ•ˆä»£ç 
            console.log('ğŸ‰ ä¸­å¥–éŸ³æ•ˆæ’­æ”¾');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¢å¼ºåŠŸèƒ½
        window.addEventListener('load', function() {
            // æ£€æŸ¥ethersæ˜¯å¦æ­£ç¡®åŠ è½½
            if (typeof ethers === 'undefined') {
                console.error('ethers.jsæœªæ­£ç¡®åŠ è½½');
                alert('æ­£åœ¨åŠ è½½åŒºå—é“¾åº“ï¼Œè¯·ç¨å€™é‡è¯•...');
                setTimeout(() => location.reload(), 2000);
                return;
            }
            
            console.log('ethers.jsåŠ è½½æˆåŠŸ:', ethers.version);
            
            // å»¶è¿Ÿæ·»åŠ äº¤äº’æ•ˆæœï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                addWheelInteractivity();
            }, 1000);
        });

        // æ‰‹åŠ¨åˆ·æ–°ä½™é¢åŠŸèƒ½
        async function refreshBalanceManually() {
            const refreshBtn = document.getElementById('refreshBalanceBtn');
            const originalText = refreshBtn.textContent;
            
            try {
                refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
                refreshBtn.disabled = true;
                
                console.log('ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ä½™é¢åˆ·æ–°');
                
                // å¼ºåˆ¶é‡æ–°åŠ è½½ä½™é¢
                await loadBalancesOptimized();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-20 left-4 right-4 bg-green-500/80 text-white p-3 rounded-lg text-sm z-50';
                successDiv.innerHTML = `
                    <div class="font-bold">âœ… ä½™é¢åˆ·æ–°æˆåŠŸ</div>
                    <div class="mt-1">MAO: ${parseFloat(balances.MAO).toFixed(4)} | PI: ${parseFloat(balances.PI).toFixed(4)}</div>
                `;
                
                document.body.appendChild(successDiv);
                
                // 2ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('æ‰‹åŠ¨åˆ·æ–°ä½™é¢å¤±è´¥:', error);
                alert('åˆ·æ–°ä½™é¢å¤±è´¥: ' + error.message);
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        // éªŒè¯åˆçº¦åœ°å€æœ‰æ•ˆæ€§
        async function verifyContractAddresses() {
            try {
                console.log('ğŸ” éªŒè¯åˆçº¦åœ°å€æœ‰æ•ˆæ€§...');
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // æ£€æŸ¥æ¯ä¸ªåˆçº¦åœ°å€æ˜¯å¦æœ‰ä»£ç 
                const checks = await Promise.all([
                    provider.getCode(CONTRACTS.MAO_TOKEN),
                    provider.getCode(CONTRACTS.PI_TOKEN),
                    provider.getCode(CONTRACTS.WHEEL_GAME)
                ]);
                
                const maoValid = checks[0] !== '0x';
                const piValid = checks[1] !== '0x';
                const wheelValid = checks[2] !== '0x';
                
                console.log('ğŸ“‹ åˆçº¦åœ°å€éªŒè¯ç»“æœ:', {
                    MAO_TOKEN: { address: CONTRACTS.MAO_TOKEN, valid: maoValid },
                    PI_TOKEN: { address: CONTRACTS.PI_TOKEN, valid: piValid },
                    WHEEL_GAME: { address: CONTRACTS.WHEEL_GAME, valid: wheelValid }
                });
                
                if (!maoValid || !piValid || !wheelValid) {
                    const errorMsg = `âš ï¸ åˆçº¦åœ°å€éªŒè¯å¤±è´¥:\n` +
                        `MAO Token: ${maoValid ? 'âœ…' : 'âŒ'} ${CONTRACTS.MAO_TOKEN}\n` +
                        `PI Token: ${piValid ? 'âœ…' : 'âŒ'} ${CONTRACTS.PI_TOKEN}\n` +
                        `Wheel Game: ${wheelValid ? 'âœ…' : 'âŒ'} ${CONTRACTS.WHEEL_GAME}`;
                    
                    console.error(errorMsg);
                    return false;
                }
                
                return true;
                
            } catch (error) {
                console.error('åˆçº¦åœ°å€éªŒè¯å¤±è´¥:', error);
                return false;
            }
        }
        
        // ç½‘ç»œçŠ¶æ€æ£€æŸ¥
        async function checkNetworkStatus() {
            try {
                console.log('ğŸŒ æ£€æŸ¥ç½‘ç»œçŠ¶æ€...');
                
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const isCorrectNetwork = chainId === ALVEY_NETWORK.chainId;
                
                console.log('ç½‘ç»œçŠ¶æ€:', {
                    å½“å‰ç½‘ç»œ: chainId,
                    æ­£ç¡®ç½‘ç»œ: ALVEY_NETWORK.chainId,
                    åŒ¹é…: isCorrectNetwork
                });
                
                if (!isCorrectNetwork) {
                    console.warn('âš ï¸ ç½‘ç»œä¸åŒ¹é…ï¼Œå½“å‰:', chainId, 'éœ€è¦:', ALVEY_NETWORK.chainId);
                    return false;
                }
                
                // æµ‹è¯•RPCè¿æ¥
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const blockNumber = await provider.getBlockNumber();
                
                console.log('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå½“å‰åŒºå—:', blockNumber);
                return true;
                
            } catch (error) {
                console.error('âŒ ç½‘ç»œçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ” ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥
        async function performSystemChecks() {
            try {
                console.log('ğŸ” å¼€å§‹ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥...');
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
                const [networkOk, contractsOk] = await Promise.all([
                    checkNetworkStatus(),
                    verifyContractAddresses()
                ]);
                
                if (!networkOk) {
                    showSystemWarning('ç½‘ç»œè¿æ¥å¼‚å¸¸', 'è¯·æ£€æŸ¥AlveyChainç½‘ç»œè¿æ¥çŠ¶æ€');
                }
                
                if (!contractsOk) {
                    showSystemWarning('åˆçº¦åœ°å€æ— æ•ˆ', 'éƒ¨åˆ†æ™ºèƒ½åˆçº¦åœ°å€å¯èƒ½æœ‰é—®é¢˜');
                }
                
                console.log('âœ… ç³»ç»Ÿæ£€æŸ¥å®Œæˆ:', { networkOk, contractsOk });
                
            } catch (error) {
                console.error('ç³»ç»Ÿæ£€æŸ¥å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç³»ç»Ÿè­¦å‘Š
        function showSystemWarning(title, message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'fixed top-20 left-4 right-4 bg-yellow-500/80 text-white p-3 rounded-lg text-sm z-50';
            warningDiv.innerHTML = `
                <div class="font-bold">âš ï¸ ${title}</div>
                <div class="mt-1">${message}</div>
                <button onclick="this.parentNode.remove();" class="mt-2 bg-white/20 px-3 py-1 rounded text-xs">
                    çŸ¥é“äº†
                </button>
            `;
            
            document.body.appendChild(warningDiv);
            
            // 10ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.parentNode.removeChild(warningDiv);
                }
            }, 10000);
        }
    </script>
</body>
</html> 